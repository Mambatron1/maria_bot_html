<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="cache-control" content="no-cache">
    <meta name="cache-bust" content="nbtender-fixed-v2">
    <meta name="version" content="nbtender-fixed-2024">
    <title>NBtender ‚Äî Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –≤–∏–¥–æ–≤ –∫–µ—à–∞
        (function() {
            // –û—á–∏—Å—Ç–∫–∞ localStorage
            try { localStorage.clear(); } catch(e) {}
            
            // –û—á–∏—Å—Ç–∫–∞ sessionStorage  
            try { sessionStorage.clear(); } catch(e) {}
            
            // –û—á–∏—Å—Ç–∫–∞ Service Worker –∫–µ—à–∞
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    for(let registration of registrations) {
                        registration.unregister();
                    }
                });
            }
             
            // –û—á–∏—Å—Ç–∫–∞ Cache API
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    for (let name of names) {
                        caches.delete(name);
                    }
                });
            }
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∏–ª–µ–π
            const timestamp = new Date().getTime();
            const links = document.querySelectorAll('link[rel="stylesheet"]');
            links.forEach(link => {
                const href = link.href.split('?')[0];
                link.href = href + '?v=' + timestamp;
            });
        })();
    </script>
    <style>
        :root {
            --bg: #eff6ff;
            --ink: #0f172a;
            --muted: #64748b;
            --graphite-700: #474A51;
            --navy-700: #1e3a5f;
            --navy-600: #274b7a;
            --accent: #4338ca;
            --danger: #ef4444;

            --fs-base: 16px;
            --btn-h: 52px;
            --radius: 14px;
            --pad: 16px;
            --dot: 8px;

            --shadow: 0 6px 18px rgba(2, 6, 23, .12);
            --shadow-strong: 0 10px 26px rgba(2, 6, 23, .18);
        }

        body { 
            margin: 0; 
            font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; 
            background: #eff6ff; 
            color: var(--ink); 
            font-size: var(--fs-base); 
            min-height: 100vh;
        }

        .wrap { 
            max-width: 440px; 
            margin: 0 auto; 
            padding: var(--pad) var(--pad) var(--pad); 
            box-sizing: border-box; 
            min-height: 100vh;
        }

        header { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            margin-bottom: 8px; 
        }

        .avatar { 
            width: 44px; 
            height: 44px; 
            border-radius: 50%; 
            background: #d1d5db; 
            overflow: hidden; 
        }

        .title { 
            font-weight: 700; 
            font-size: 17px; 
        }

        .subtitle { 
            font-size: 12px; 
            color: var(--muted); 
        }

        .stack { 
            display: grid; 
            gap: 10px; 
            margin: 8px 0 16px; 
        }

        .card { 
            background: var(--graphite-700); 
            color: #f1f5f9; 
            border-radius: var(--radius); 
            padding: 12px 14px; 
            box-shadow: var(--shadow); 
        }

        .card h3 { 
            margin: 0 0 4px; 
            font-size: 14px; 
            font-weight: 800; 
            letter-spacing: .2px; 
        }

        .card p { 
            margin: 0; 
            font-size: 13px; 
            color: #cbd5e1; 
        }

        .actions { 
            display: grid; 
            gap: 12px; 
        }

        .btn { 
            position: relative; 
            height: var(--btn-h); 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px;
            border: 0; 
            border-radius: var(--radius); 
            background: var(--navy-700); 
            color: #eef2ff; 
            font-size: 15px; 
            font-weight: 700; 
            box-shadow: var(--shadow); 
            cursor: pointer; 
            padding: 0 16px; 
            text-align: center;
            min-width: 280px;
            max-width: 350px;
            width: 100%;
            box-sizing: border-box;
        }

        .btn:after { 
            content:""; 
            position:absolute; 
            inset:0; 
            border-radius: inherit; 
            pointer-events:none;
            background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,0) 40%); 
        }

        .btn:hover { 
            background: var(--navy-600); 
            box-shadow: var(--shadow-strong); 
        }

        .btn:active { 
            transform: translateY(1px); 
        }

        .dot { 
            display:inline-block; 
            width: var(--dot); 
            height: var(--dot); 
            border-radius: 50%; 
        }

        .dot-holiday{ background:#f59e0b; }
        .dot-mode{ background:#10b981; }
        .dot-absence{ background:#ef4444; }
        .dot-sick{ background:#8b5cf6; }
        .dot-crocotime{ background:#eab308; }

        .btn-accent { 
            background: var(--accent); 
        }

        /* SOS –∫–Ω–æ–ø–∫–∞ –≤ –æ–±—â–µ–º —Å—Ç–∏–ª–µ - –∫–∞–∫ –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ */

        .footer { 
            text-align:center; 
            margin-top: 10px; 
            color:#94a3b8; 
            font-size:12px; 
        }

        .compact .wrap { 
            padding: var(--pad) var(--pad) 96px; 
        }

        .compact .card { 
            padding: 12px 14px; 
        }

        .compact .btn { 
            height: var(--btn-h); 
            font-size: 15px; 
        }

        .compact .title { 
            font-size: 17px; 
        }

        .compact header { 
            gap: 12px; 
        }

        .compact .avatar { 
            width: 44px; 
            height: 44px; 
        }

        /* Modal styles for back buttons */
        .back-button {
            background: none;
            border: none;
            color: var(--ink);
            font-size: 24px;
            padding: 8px;
            cursor: pointer;
            border-radius: var(--radius);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        .back-button:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .back-button:active {
            background: rgba(0, 0, 0, 0.1);
            transform: scale(0.95);
        }

        .modal-header {
            display: flex;
            align-items: center;
            padding: 16px;
            background: var(--bg);
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .modal-title {
            flex: 1;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            color: var(--ink);
            margin: 0;
        }

        .modal-content {
            background: var(--bg);
            min-height: 100vh;
            padding-bottom: 100px;
        }

        /* –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é - –≥–æ–ª—É–±–æ–π —Ñ–æ–Ω –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
        #app {
            background: #eff6ff;
            min-height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ - –≥–æ–ª—É–±–æ–π —Ñ–æ–Ω –∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ */
        #work-mode-modal,
        #absence-modal, 
        #sick-leave-modal,
        #admin-menu-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #eff6ff;
            z-index: 1000;
            overflow-y: auto;
        }

        /* –í—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É */
        #work-mode-modal .wrap,
        #absence-modal .wrap,
        #sick-leave-modal .wrap,
        #admin-menu-modal .wrap {
            max-width: 440px;
            margin: 0 auto;
            padding: var(--pad) var(--pad) var(--pad);
            box-sizing: border-box;
            min-height: 100vh;
        }

        /* –í—Å–µ –∫–Ω–æ–ø–∫–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π —à–∏—Ä–∏–Ω—ã - —É–∂–µ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø—Ä–∞–≤–∏–ª–µ .btn */
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∫–Ω–æ–ø–æ–∫ - —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ */
        .actions {
            display: grid;
            gap: 12px;
            justify-items: center;
        }
    </style>
</head>
<body>
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤–µ—Ä—Å–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∏ -->
    <div style="position: fixed; top: 10px; right: 10px; background: var(--accent); color: white; padding: 4px 8px; border-radius: 8px; font-size: 10px; z-index: 9999;">
        NBtender COLORED CARDS
    </div>
    
    <div class="wrap">
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>–ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å...</p>
        </div>

        <div id="error" class="error" style="display: none;">
            <p>–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö</p>
        </div>

        <div id="app" style="display: none;">
            <header>
                <div class="avatar" id="avatar"></div>
                <div>
                    <div class="title">–ü—Ä–∏–≤–µ—Ç, <span id="name">Aleksei</span></div>
                    <div class="subtitle">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                </div>
            </header>

            <div class="stack">
                <div class="card" style="background: #065f46;"><h3>–°–µ–≥–æ–¥–Ω—è</h3><p id="today-status">–£–¥–∞–ª—ë–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞</p></div>
                <div class="card" style="background: #ea580c;"><h3>–°–ª–µ–¥—É—é—â–∏–π –æ—Ç–ø—É—Å–∫</h3><p id="next-vacation">–û—Ç–ø—É—Å–∫ –Ω–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω</p></div>
                <div class="card" style="background: #3730a3;"><h3>–í —ç—Ç–æ—Ç –¥–µ–Ω—å</h3><p id="today-message">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Maria Bot!</p></div>
            </div>

            <div class="actions">
                <button class="btn" onclick="handleAction('vacation')"><span class="dot dot-holiday"></span><span>–ú–æ–π –æ—Ç–ø—É—Å–∫</span></button>
                <button class="btn" onclick="handleAction('work_mode')"><span class="dot dot-mode"></span><span>–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã</span></button>
                <button class="btn" onclick="handleAction('absence')"><span class="dot dot-absence"></span><span>–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ</span></button>
                <button class="btn" onclick="handleAction('sick_leave')"><span class="dot dot-sick"></span><span>–ë–æ–ª—å–Ω–∏—á–Ω—ã–π</span></button>
                <button class="btn" onclick="handleAction('crocotime')"><span class="dot dot-crocotime"></span><span>–ú–æ–π Crocotime</span></button>
                <button class="btn" onclick="handleAction('sos')"><span class="dot dot-absence"></span><span>–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å</span></button>
                <button class="btn btn-accent" id="admin-btn" onclick="handleAction('admin')" style="display: none;">–ú–µ–Ω—é –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</button>
            </div>
            <div class="footer">@NBtender_bot</div>
        </div>

        <!-- Work Mode Modal -->
        <div id="work-mode-modal" style="display: none;">
            <div class="wrap">
                <header style="margin-bottom: 20px;">
                    <button onclick="showMainApp()" class="back-button" style="background: none; border: none; color: var(--ink); font-size: 24px; padding: 8px; cursor: pointer; border-radius: var(--radius);">‚Üê</button>
                    <div style="flex: 1; text-align: center;">
                        <div class="title" style="margin: 0;">–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã</div>
                    </div>
                    <div style="width: 40px;"></div>
                </header>

                <div class="stack" style="margin-bottom: 20px;">
                    <div class="card">
                        <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã</h3>
                        <p>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤–∞—à —Ç–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã</p>
                    </div>
                </div>

                <div id="work-modes" class="actions">
                    <!-- –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>

                <div id="period-section" class="stack" style="display: none; margin-top: 20px;">
                    <div class="card">
                        <h3>–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥</h3>
                        <p>–£–∫–∞–∂–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–µ–π—Å—Ç–≤–∏—è —Ä–µ–∂–∏–º–∞</p>
                    </div>
                </div>

                <div id="work-periods" class="actions" style="display: none;">
                    <!-- –ü–µ—Ä–∏–æ–¥—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>

                <div id="custom-period" class="stack" style="display: none; margin-top: 20px;">
                    <div class="card">
                        <h3>–£–∫–∞–∂–∏—Ç–µ –ø–µ—Ä–∏–æ–¥</h3>
                        <div style="margin-top: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 14px;">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</label>
                            <input type="date" id="start-date" style="width: 100%; padding: 12px; border-radius: var(--radius); border: 1px solid #4a5568; background: #2d3748; color: #e2e8f0; margin-bottom: 15px; font-size: 14px;">
                            
                            <label style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 14px;">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label>
                            <input type="date" id="end-date" style="width: 100%; padding: 12px; border-radius: var(--radius); border: 1px solid #4a5568; background: #2d3748; color: #e2e8f0; margin-bottom: 20px; font-size: 14px;">
                        </div>
                    </div>
                    <button onclick="submitWorkMode()" class="btn btn-accent" style="width: 100%;">
                        <span>‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</span>
                    </button>
                </div>

                <div id="confirmation-section" class="stack" style="display: none; margin-top: 20px;">
                    <div class="card">
                        <h3>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
                        <p id="confirmation-text"><!-- –¢–µ–∫—Å—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è --></p>
                    </div>
                    <div class="actions">
                        <button onclick="confirmWorkMode()" class="btn btn-accent">
                            <span>‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</span>
                        </button>
                        <button onclick="showMainApp()" class="btn" style="background: var(--muted);">
                            <span>‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Absence Modal -->
        <div id="absence-modal" style="display: none;">
            <div class="wrap">
                <header style="margin-bottom: 20px;">
                    <button onclick="showMainApp()" class="back-button" style="background: none; border: none; color: var(--ink); font-size: 24px; padding: 8px; cursor: pointer; border-radius: var(--radius);">‚Üê</button>
                    <div style="flex: 1; text-align: center;">
                        <div class="title" style="margin: 0;">–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ</div>
                    </div>
                    <div style="width: 40px;"></div>
                </header>

                <div class="stack" style="margin-bottom: 20px;">
                    <div class="card" style="background: var(--danger); color: white;">
                        <h3>‚ö†Ô∏è –í–∞–∂–Ω–æ!</h3>
                        <p><strong>–°–ù–ê–ß–ê–õ–ê –°–û–ì–õ–ê–°–£–ô –° –†–£–ö–û–í–û–î–ò–¢–ï–õ–ï–ú, –ß–¢–û–ë–´ –û–ù –ó–ù–ê–õ, –ß–¢–û –¢–´ –û–¢–°–£–¢–°–¢–í–£–ï–®–¨!</strong></p>
                    </div>

                    <div class="card" id="absence-date-section">
                        <h3>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</h3>
                        <p>–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –≤–∞—à–µ–≥–æ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è</p>
                    </div>
                </div>

                <div id="absence-dates" class="actions">
                    <!-- –î–∞—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>

                <div class="info-card" id="absence-time-section" style="display: none;">
                    <div class="card-header">
                        <span class="card-icon">‚è∞</span>
                        <span class="card-title">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</span>
                    </div>
                </div>

                <div id="absence-times" class="action-buttons" style="display: none;">
                    <!-- –í—Ä–µ–º–µ–Ω–∞ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>

                <div id="absence-custom-date" style="display: none; margin-top: 20px;">
                    <div class="info-card">
                        <div class="card-header">
                            <span class="card-icon">üìÖ</span>
                            <span class="card-title">–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É</span>
                        </div>
                        <div style="margin-top: 15px;">
                            <input type="date" id="absence-date" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; margin-bottom: 15px;">
                            
                            <button onclick="selectAbsenceCustomDate()" style="width: 100%; padding: 15px; background: linear-gradient(45deg, #4ecdc4, #44a08d); border: none; border-radius: 8px; color: white; font-weight: bold;">
                                ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
                            </button>
                        </div>
                    </div>
                </div>

                <div id="absence-custom-time" style="display: none; margin-top: 20px;">
                    <div class="info-card">
                        <div class="card-header">
                            <span class="card-icon">‚è∞</span>
                            <span class="card-title">–£–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è</span>
                        </div>
                        <div style="margin-top: 15px;">
                            <label style="display: block; margin-bottom: 10px; color: rgba(255,255,255,0.8);">–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞:</label>
                            <input type="time" id="absence-start-time" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; margin-bottom: 15px;">
                            
                            <label style="display: block; margin-bottom: 10px; color: rgba(255,255,255,0.8);">–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label>
                            <input type="time" id="absence-end-time" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; margin-bottom: 15px;">
                            
                            <button onclick="submitAbsence()" style="width: 100%; padding: 15px; background: linear-gradient(45deg, #4ecdc4, #44a08d); border: none; border-radius: 8px; color: white; font-weight: bold;">
                                ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
                            </button>
                        </div>
                    </div>
                </div>

                <div id="absence-confirmation-section" style="display: none;">
                    <div class="info-card">
                        <div class="card-header">
                            <span class="card-icon">‚úÖ</span>
                            <span class="card-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</span>
                        </div>
                        <div class="card-content" id="absence-confirmation-text">
                            <!-- –¢–µ–∫—Å—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
                        </div>
                        <div style="margin-top: 15px;">
                            <button onclick="submitAbsence()" style="width: 100%; padding: 15px; background: linear-gradient(45deg, #4ecdc4, #44a08d); border: none; border-radius: 8px; color: white; font-weight: bold; margin-bottom: 10px;">
                                ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
                            </button>
                            <button onclick="showMainApp()" style="width: 100%; padding: 15px; background: rgba(255,255,255,0.2); border: none; border-radius: 8px; color: white; font-weight: bold;">
                                ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SOS Modal -->
        <div id="sos-modal" class="modal-content" style="display: none;">
            <div class="modal-header">
                <button onclick="showMainApp()" class="back-button">‚Üê</button>
                <h2 class="modal-title">SOS - –°–æ–æ–±—â–∏—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ</h2>
                <div style="width: 40px;"></div> <!-- spacer for centering -->
            </div>

            <div class="info-cards">
                <div class="info-card">
                    <div class="card-header">
                        <span class="card-icon">‚ö°</span>
                        <span class="card-title">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø—Ä–æ–±–ª–µ–º—ã</span>
                    </div>
                </div>

                <div id="sos-issue-types" class="action-buttons">
                    <!-- –¢–∏–ø—ã –ø—Ä–æ–±–ª–µ–º –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ "–ú–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è" -->
                <div class="info-card" style="margin-top: 20px;">
                    <button onclick="showSosMenuModal()" class="action-button" style="width: 100%; padding: 15px; background: linear-gradient(45deg, #667eea, #764ba2); border: none; border-radius: 8px; color: white; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span style="font-size: 20px;">üìã</span>
                        <span>–ú–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è</span>
                    </button>
                </div>

                <div class="info-card" id="sos-anonymity-section" style="display: none;">
                    <div class="card-header">
                        <span class="card-icon">üïµÔ∏è</span>
                        <span class="card-title">–ö–∞–∫ –≤—ã —Ö–æ—Ç–∏—Ç–µ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è?</span>
                    </div>
                </div>

                <div id="sos-anonymity-options" class="action-buttons" style="display: none;">
                    <!-- –û–ø—Ü–∏–∏ –∞–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>

                <div id="sos-pseudonym-section" style="display: none; margin-top: 20px;">
                    <div class="info-card">
                        <div class="card-header">
                            <span class="card-icon">üé≠</span>
                            <span class="card-title">–£–∫–∞–∂–∏—Ç–µ –ø—Å–µ–≤–¥–æ–Ω–∏–º</span>
                        </div>
                        <div style="margin-top: 15px;">
                            <input type="text" id="sos-pseudonym" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Å–µ–≤–¥–æ–Ω–∏–º" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; margin-bottom: 15px;">
                            
                            <button onclick="selectSosPseudonym()" style="width: 100%; padding: 15px; background: linear-gradient(45deg, #4ecdc4, #44a08d); border: none; border-radius: 8px; color: white; font-weight: bold;">
                                ‚úÖ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
                            </button>
                        </div>
                    </div>
                </div>

                <div id="sos-description-section" style="display: none; margin-top: 20px;">
                    <div class="info-card">
                        <div class="card-header">
                            <span class="card-icon">üìù</span>
                            <span class="card-title">–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É</span>
                        </div>
                        <div style="margin-top: 15px;">
                            <textarea id="sos-description" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É (–º–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤)" style="width: 100%; height: 120px; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; margin-bottom: 15px; resize: vertical; font-family: inherit;"></textarea>
                            
                            <button onclick="submitSos()" style="width: 100%; padding: 15px; background: linear-gradient(45deg, #ff4757, #ff3742); border: none; border-radius: 8px; color: white; font-weight: bold;">
                                üö® –û–¢–ü–†–ê–í–ò–¢–¨ SOS
                            </button>
                        </div>
                    </div>
                </div>

                <div id="sos-confirmation-section" style="display: none;">
                    <div class="info-card">
                        <div class="card-header">
                            <span class="card-icon">‚úÖ</span>
                            <span class="card-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</span>
                        </div>
                        <div class="card-content" id="sos-confirmation-text">
                            <!-- –¢–µ–∫—Å—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
                        </div>
                        <div style="margin-top: 15px;">
                            <button onclick="submitSos()" style="width: 100%; padding: 15px; background: linear-gradient(45deg, #ff4757, #ff3742); border: none; border-radius: 8px; color: white; font-weight: bold; margin-bottom: 10px;">
                                üö® –û–¢–ü–†–ê–í–ò–¢–¨ SOS
                            </button>
                            <button onclick="showMainApp()" style="width: 100%; padding: 15px; background: rgba(255,255,255,0.2); border: none; border-radius: 8px; color: white; font-weight: bold;">
                                ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sick Leave Modal -->
        <div id="sick-leave-modal" style="display: none;">
            <div class="wrap">
                <header style="margin-bottom: 20px;">
                    <button onclick="showMainApp()" class="back-button" style="background: none; border: none; color: var(--ink); font-size: 24px; padding: 8px; cursor: pointer; border-radius: var(--radius);">‚Üê</button>
                    <div style="flex: 1; text-align: center;">
                        <div class="title" style="margin: 0;">üè• –ë–æ–ª—å–Ω–∏—á–Ω—ã–π –ª–∏—Å—Ç</div>
                    </div>
                    <div style="width: 40px;"></div>
                </header>

                <div class="stack" style="margin-bottom: 20px;">
                    <div class="card" style="background: #8b5cf6; color: white;">
                        <h3>üòî –ú–Ω–µ –æ—á–µ–Ω—å –∂–∞–ª—å, —á—Ç–æ —Ç—ã –∑–∞–±–æ–ª–µ–ª(–∞)</h3>
                        <p>–î–∞–≤–∞–π –≤–Ω–µ—Å–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –±–æ–ª—å–Ω–∏—á–Ω–æ–º—É –ª–∏—Å—Ç—É (–≠–õ–ù)</p>
                    </div>

                    <div class="card">
                        <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –±–æ–ª—å–Ω–∏—á–Ω–æ–≥–æ</h3>
                        <p>–£–∫–∞–∂–∏—Ç–µ —Ç–∏–ø –≤–∞—à–µ–≥–æ –±–æ–ª—å–Ω–∏—á–Ω–æ–≥–æ –ª–∏—Å—Ç–∞</p>
                    </div>
                </div>

                <div id="sick-leave-types" class="actions">
                    <!-- –¢–∏–ø—ã –±–æ–ª—å–Ω–∏—á–Ω–æ–≥–æ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>

                <div id="sick-leave-form-section" class="stack" style="display: none; margin-top: 20px;">
                    <div class="card">
                        <h3>üìù –î–∞–Ω–Ω—ã–µ –±–æ–ª—å–Ω–∏—á–Ω–æ–≥–æ</h3>
                        <div style="margin-top: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 14px;">–ù–æ–º–µ—Ä –≠–õ–ù:</label>
                            <input type="text" id="sick-leave-number" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–≥–æ –ª–∏—Å—Ç–∫–∞ –Ω–µ—Ç—Ä—É–¥–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏" style="width: 100%; padding: 12px; border-radius: var(--radius); border: 1px solid #4a5568; background: #2d3748; color: #e2e8f0; margin-bottom: 15px; font-size: 14px;">
                            
                            <label style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 14px;">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</label>
                            <input type="date" id="sick-leave-start-date" style="width: 100%; padding: 12px; border-radius: var(--radius); border: 1px solid #4a5568; background: #2d3748; color: #e2e8f0; margin-bottom: 15px; font-size: 14px;">
                            
                            <label style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 14px;">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label>
                            <input type="date" id="sick-leave-end-date" style="width: 100%; padding: 12px; border-radius: var(--radius); border: 1px solid #4a5568; background: #2d3748; color: #e2e8f0; margin-bottom: 20px; font-size: 14px;">
                        </div>
                    </div>
                    
                    <div class="actions" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                        <button onclick="setSickLeaveDate('today')" class="btn" style="height: 40px; font-size: 13px;">
                            <span>–°–µ–≥–æ–¥–Ω—è</span>
                        </button>
                        <button onclick="setSickLeaveDate('yesterday')" class="btn" style="height: 40px; font-size: 13px;">
                            <span>–í—á–µ—Ä–∞</span>
                        </button>
                        <button onclick="setSickLeaveDate('week_ago')" class="btn" style="height: 40px; font-size: 13px;">
                            <span>–ù–µ–¥–µ–ª—é –Ω–∞–∑–∞–¥</span>
                        </button>
                    </div>
                    
                    <button onclick="submitSickLeave()" class="btn" style="background: #8b5cf6; width: 100%;">
                        <span>üè• –°–û–•–†–ê–ù–ò–¢–¨ –ë–û–õ–¨–ù–ò–ß–ù–´–ô</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- SOS Menu Modal -->
        <div id="sos-menu-modal" style="display: none;">
            <div class="header">
                <button onclick="showSosModal()" style="background: none; border: none; color: white; font-size: 24px; float: left;">‚Üê</button>
                <h2 style="text-align: center; margin: 0;">üö® SOS - –ú–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è</h2>
            </div>

            <div class="info-cards">
                <div class="info-card">
                    <div class="card-header">
                        <span class="card-icon">üìã</span>
                        <span class="card-title">–í–∞—à–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è</span>
                    </div>
                    <div class="card-content">
                        –ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –¥–∏–∞–ª–æ–≥–∏ –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ
                    </div>
                </div>



                <div id="sos-issues-list" style="margin-top: 20px;">
                    <!-- –°–ø–∏—Å–æ–∫ –æ–±—Ä–∞—â–µ–Ω–∏–π –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
        </div>

        <!-- My Issue Dialog Modal -->
        <div id="my-issue-dialog-modal" style="display: none;">
            <div class="header">
                <button onclick="closeMyIssueDialog()" style="background: none; border: none; color: white; font-size: 24px; float: left;">‚Üê</button>
                <h2 style="text-align: center; margin: 0;">üí¨ –ú–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ</h2>
            </div>

            <div id="my-issue-dialog-scroll" style="padding: 20px; height: calc(100vh - 140px); overflow-y: auto;">
                <div id="my-issue-dialog-content">
                    <div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">
                        –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∏–∞–ª–æ–≥–∞...
                    </div>
                </div>
            </div>
            
            <div style="position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.8); padding: 15px;">
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="my-response-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç..." onkeypress="handleMyResponseEnterKey(event)" style="flex: 1; padding: 10px; border: none; border-radius: 6px; background: rgba(255,255,255,0.1); color: white;">
                    <button onclick="sendMyResponse()" style="background: #2ed573; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- Employees Management Modal -->
        <div id="employees-management-modal" style="display: none;">
            <div class="header">
                <button onclick="showAdminMenuModal()" style="background: none; border: none; color: white; font-size: 24px; float: left;">‚Üê</button>
                <h2 style="text-align: center; margin: 0;">üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏</h2>
            </div>

            <div style="padding: 20px; height: calc(100vh - 80px); overflow-y: auto;">
                <div class="action-buttons" style="margin-bottom: 20px;">
                    <button onclick="showAddEmployeeModal()" class="action-button" style="background: linear-gradient(45deg, #2ed573, #17c0eb);">
                        <span class="icon">‚ûï</span>–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                    </button>
                </div>
                
                <!-- –ü–æ–ª–µ –ø–æ–∏—Å–∫–∞ -->
                <div style="margin-bottom: 20px;">
                    <div class="info-card">
                        <div class="card-header">
                            <span class="card-icon">üîç</span>
                            <span class="card-title">–ü–æ–∏—Å–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</span>
                        </div>
                        <div class="card-content">
                            <input type="text" id="employee-search" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è, —Ñ–∞–º–∏–ª–∏—é –∏–ª–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞..." 
                                   oninput="filterEmployees()" 
                                   style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); 
                                          background: rgba(255,255,255,0.1); color: white; font-size: 16px;">
                            <div id="search-results-count" style="margin-top: 8px; font-size: 12px; color: rgba(255,255,255,0.6);">
                                <!-- –°—á–µ—Ç—á–∏–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="employees-list">
                    <div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">
                        –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤...
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Employee Modal -->
        <div id="add-employee-modal" style="display: none;">
            <div class="header">
                <button onclick="showEmployeesManagement()" style="background: none; border: none; color: white; font-size: 24px; float: left;">‚Üê</button>
                <h2 style="text-align: center; margin: 0;">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h2>
            </div>

            <div style="padding: 20px;">
                <div class="info-card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <span class="card-icon">‚ÑπÔ∏è</span>
                        <span class="card-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</span>
                    </div>
                    <div class="card-content">
                        –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –≤ —Å–∏—Å—Ç–µ–º—É. –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–Ω —Å–º–æ–∂–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ –±–æ—Ç–µ –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞.
                    </div>
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: white; font-weight: bold;">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</label>
                    <input type="tel" id="add-phone" placeholder="+7XXXXXXXXXX" 
                           style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); 
                                  background: rgba(255,255,255,0.1); color: white; font-size: 16px;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: white; font-weight: bold;">–ò–º—è:</label>
                    <input type="text" id="add-first-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è" 
                           style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); 
                                  background: rgba(255,255,255,0.1); color: white; font-size: 16px;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: white; font-weight: bold;">–§–∞–º–∏–ª–∏—è:</label>
                    <input type="text" id="add-last-name" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é" 
                           style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); 
                                  background: rgba(255,255,255,0.1); color: white; font-size: 16px;">
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; color: white; cursor: pointer;">
                        <input type="checkbox" id="add-is-admin" style="margin-right: 10px; transform: scale(1.2);">
                        <span style="font-weight: bold;">–ü—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</span>
                    </label>
                </div>

                <div class="action-buttons">
                    <button onclick="addEmployee()" class="action-button" style="background: linear-gradient(45deg, #2ed573, #17c0eb);">
                        <span class="icon">‚úÖ</span>–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                    </button>
                </div>
            </div>
        </div>

        <!-- Edit Employee Modal -->
        <div id="edit-employee-modal" style="display: none;">
            <div class="header">
                <button onclick="showEmployeesManagement()" style="background: none; border: none; color: white; font-size: 24px; float: left;">‚Üê</button>
                <h2 style="text-align: center; margin: 0;">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h2>
            </div>

            <div style="padding: 20px;">
                <div class="info-card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <span class="card-icon">‚ö†Ô∏è</span>
                        <span class="card-title">–í–Ω–∏–º–∞–Ω–∏–µ</span>
                    </div>
                    <div class="card-content">
                        –ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –ø–æ–≤–ª–∏—è–µ—Ç –Ω–∞ –µ–≥–æ –¥–æ—Å—Ç—É–ø –∫ —Å–∏—Å—Ç–µ–º–µ
                    </div>
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: white; font-weight: bold;">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</label>
                    <input type="tel" id="edit-phone" readonly 
                           style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); 
                                  background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.7); font-size: 16px;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: white; font-weight: bold;">–ò–º—è:</label>
                    <input type="text" id="edit-first-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è" 
                           style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); 
                                  background: rgba(255,255,255,0.1); color: white; font-size: 16px;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: white; font-weight: bold;">–§–∞–º–∏–ª–∏—è:</label>
                    <input type="text" id="edit-last-name" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é" 
                           style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); 
                                  background: rgba(255,255,255,0.1); color: white; font-size: 16px;">
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; color: white; cursor: pointer;">
                        <input type="checkbox" id="edit-is-admin" style="margin-right: 10px; transform: scale(1.2);">
                        <span style="font-weight: bold;">–ü—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</span>
                    </label>
                </div>

                <div class="action-buttons">
                    <button onclick="saveEmployeeChanges()" class="action-button" style="background: linear-gradient(45deg, #ffa500, #ff6b6b);">
                        <span class="icon">üíæ</span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    </button>
                </div>
            </div>
        </div>

        <!-- Issues Management Modal -->
        <div id="issues-management-modal" style="display: none;">
            <div class="header">
                <button onclick="showAdminMenuModal()" style="background: none; border: none; color: white; font-size: 24px; float: left;">‚Üê</button>
                <h2 style="text-align: center; margin: 0;">üí¨ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏</h2>
            </div>

            <div style="padding: 20px; height: calc(100vh - 80px); overflow-y: auto;">
                <div id="issues-list">
                    <div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">
                        –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π...
                    </div>
                </div>
            </div>
        </div>

        <!-- Issue Dialog Modal -->
        <div id="issue-dialog-modal" style="display: none;">
            <div class="header">
                <button onclick="closeIssueDialog()" style="background: none; border: none; color: white; font-size: 24px; float: left;">‚Üê</button>
                <h2 style="text-align: center; margin: 0;">üí¨ –î–∏–∞–ª–æ–≥ —Å –æ–±—Ä–∞—â–µ–Ω–∏–µ–º</h2>
            </div>

            <div id="issue-dialog-scroll" style="padding: 20px; height: calc(100vh - 140px); overflow-y: auto;">
                <div id="issue-dialog-content">
                    <div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">
                        –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∏–∞–ª–æ–≥–∞...
                    </div>
                </div>
            </div>
            
            <div style="position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.8); padding: 15px;">
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="admin-response-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç..." onkeypress="handleEnterKey(event)" style="flex: 1; padding: 10px; border: none; border-radius: 6px; background: rgba(255,255,255,0.1); color: white;">
                    <button onclick="sendAdminResponse()" style="background: #2ed573; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- Broadcast Message Modal -->
        <div id="broadcast-modal" style="display: none;">
            <div class="header">
                <button onclick="showAdminMenuModal()" style="background: none; border: none; color: white; font-size: 24px; float: left;">‚Üê</button>
                <h2 style="text-align: center; margin: 0;">üì¢ –†–∞—Å—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π</h2>
            </div>

            <div style="padding: 20px;">
                <div class="info-card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <span class="card-icon">‚ö†Ô∏è</span>
                        <span class="card-title">–í–Ω–∏–º–∞–Ω–∏–µ</span>
                    </div>
                    <div class="card-content">
                        –°–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤—Å–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –≤ —Å–∏—Å—Ç–µ–º–µ
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; color: white; font-weight: bold;">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:</label>
                    <textarea id="broadcast-message" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏..." 
                              style="width: 100%; height: 150px; padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.3); 
                                     background: rgba(255,255,255,0.1); color: white; font-size: 16px; resize: vertical;"></textarea>
                </div>

                <div class="action-buttons">
                    <button onclick="sendBroadcastMessage()" class="action-button" style="background: linear-gradient(45deg, #ff6b6b, #ee5a52);">
                        <span class="icon">üì§</span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º
                    </button>
                </div>
            </div>
        </div>

        <!-- Admin Menu Modal -->
        <div id="admin-menu-modal" style="display: none;">
            <div class="wrap">
                <header>
                    <button onclick="showMainApp()" class="back-button">‚Üê</button>
                    <div>
                        <div class="title">üëë –ú–µ–Ω—é –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</div>
                        <div class="subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π</div>
                    </div>
                </header>

                <div class="stack">
                    <div class="card">
                        <h3>üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                        <div id="admin-stats-content">
                            <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</p>
                        </div>
                    </div>
                </div>

                <div class="actions">
                    <button onclick="showEmployeesManagement()" class="btn">
                        <span class="dot" style="background: #10b981;"></span>
                        <span>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏</span>
                    </button>
                    <button onclick="showIssuesManagement()" class="btn">
                        <span class="dot" style="background: #f59e0b;"></span>
                        <span>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏</span>
                    </button>
                    <button onclick="sendStatsToChannel()" class="btn">
                        <span class="dot" style="background: #3b82f6;"></span>
                        <span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ –∫–∞–Ω–∞–ª</span>
                    </button>
                    <button onclick="showBroadcastMessage()" class="btn">
                        <span class="dot" style="background: #ef4444;"></span>
                        <span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Issue Chat Modal -->
        <div id="issue-chat-modal" style="display: none;">
            <div class="header">
                <button onclick="showSosMenuModal()" style="background: none; border: none; color: white; font-size: 24px; float: left;">‚Üê</button>
                <h2 style="text-align: center; margin: 0;" id="chat-title">üí¨ –ß–∞—Ç –ø–æ –æ–±—Ä–∞—â–µ–Ω–∏—é</h2>
            </div>

            <div style="padding: 20px; height: calc(100vh - 120px); display: flex; flex-direction: column;">
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–±—Ä–∞—â–µ–Ω–∏–∏ -->
                <div class="info-card" id="issue-info" style="margin-bottom: 15px;">
                    <div class="card-header">
                        <span class="card-icon">üìã</span>
                        <span class="card-title" id="issue-title">–û–±—Ä–∞—â–µ–Ω–∏–µ</span>
                    </div>
                    <div class="card-content" id="issue-description">
                        <!-- –û–ø–∏—Å–∞–Ω–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏—è -->
                    </div>
                </div>

                <!-- –û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π -->
                <div id="chat-messages" style="flex: 1; overflow-y: auto; background: rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                    <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>

                <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è -->
                <div id="chat-input-area" style="display: flex; gap: 10px;">
                    <input type="text" id="chat-message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="flex: 1; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
                    <button onclick="sendChatMessage()" style="padding: 12px 20px; background: linear-gradient(45deg, #4ecdc4, #44a08d); border: none; border-radius: 8px; color: white; font-weight: bold;">
                        üì§
                    </button>
                </div>
                
                <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–∫—Ä—ã—Ç–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏ -->
                <div id="chat-closed-message" style="display: none; text-align: center; padding: 15px; background: rgba(255, 71, 87, 0.2); border-radius: 8px; color: #ff4757;">
                    <div style="font-size: 16px; font-weight: bold; margin-bottom: 5px;">üî¥ –û–±—Ä–∞—â–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ</div>
                    <div style="font-size: 14px;">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∑–∞–≤–µ—Ä—à–∏–ª —ç—Ç–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ. –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Web App
        tg.ready();
        tg.expand();
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É Telegram
        document.body.style.backgroundColor = tg.themeParams.bg_color || '#667eea';

        async function showAdminMenuModal() {
            try {
                // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
                document.getElementById('app').style.display = 'none';
                document.getElementById('employees-management-modal').style.display = 'none';
                document.getElementById('issues-management-modal').style.display = 'none';
                document.getElementById('broadcast-modal').style.display = 'none';
                document.getElementById('add-employee-modal').style.display = 'none';
                document.getElementById('edit-employee-modal').style.display = 'none';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–¥–º–∏–Ω-–º–µ–Ω—é
                document.getElementById('admin-menu-modal').style.display = 'block';
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                await loadAdminStats();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                tg.showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–¥–º–∏–Ω-–º–µ–Ω—é');
            }
        }
        
        async function loadAdminStats() {
            try {
                const response = await fetch(`http://localhost:5000/api/admin/stats?initData=${encodeURIComponent(tg.initData)}`, {
                    method: 'GET'
                });

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
                }

                const data = await response.json();
                const stats = data.stats;
                
                const statsContent = document.getElementById('admin-stats-content');
                statsContent.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px;">
                        <div style="text-align: center; padding: 8px; background: rgba(16, 185, 129, 0.1); border-radius: var(--radius); border: 1px solid rgba(16, 185, 129, 0.2);">
                            <div style="font-size: 20px; font-weight: bold; color: #10b981;">${stats.total_employees}</div>
                            <div style="font-size: 11px; color: var(--muted);">–í—Å–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: rgba(245, 158, 11, 0.1); border-radius: var(--radius); border: 1px solid rgba(245, 158, 11, 0.2);">
                            <div style="font-size: 20px; font-weight: bold; color: #f59e0b;">${stats.active_issues}</div>
                            <div style="font-size: 11px; color: var(--muted);">–ê–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: rgba(59, 130, 246, 0.1); border-radius: var(--radius); border: 1px solid rgba(59, 130, 246, 0.2);">
                            <div style="font-size: 20px; font-weight: bold; color: #3b82f6;">${stats.issues_this_week}</div>
                            <div style="font-size: 11px; color: var(--muted);">–û–±—Ä–∞—â–µ–Ω–∏–π –∑–∞ –Ω–µ–¥–µ–ª—é</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: var(--radius); border: 1px solid rgba(239, 68, 68, 0.2);">
                            <div style="font-size: 20px; font-weight: bold; color: #ef4444;">${stats.current_sick_leaves}</div>
                            <div style="font-size: 11px; color: var(--muted);">–ù–∞ –±–æ–ª—å–Ω–∏—á–Ω–æ–º</div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                document.getElementById('admin-stats-content').innerHTML = '<p style="color: var(--muted);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</p>';
            }
        }
        
        async function showEmployeesManagement() {
            try {
                // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
                document.getElementById('admin-menu-modal').style.display = 'none';
                document.getElementById('add-employee-modal').style.display = 'none';
                document.getElementById('edit-employee-modal').style.display = 'none';
                document.getElementById('issues-management-modal').style.display = 'none';
                document.getElementById('broadcast-modal').style.display = 'none';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏
                document.getElementById('employees-management-modal').style.display = 'block';
                await loadEmployeesList();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                tg.showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤');
            }
        }
        
        async function loadEmployeesList() {
            try {
                const response = await fetch(`http://localhost:5000/api/admin/employees?initData=${encodeURIComponent(tg.initData)}`, {
                    method: 'GET'
                });

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤');
                }

                const data = await response.json();
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞
                allEmployees = data.employees;
                filteredEmployees = [...allEmployees];
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
                document.getElementById('employee-search').value = '';
                
                displayEmployeesList(filteredEmployees);
                updateSearchResultsCount();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                document.getElementById('employees-list').innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div>';
            }
        }
        
        function displayEmployeesList(employees) {
            const container = document.getElementById('employees-list');
            if (!employees || employees.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }
            
            container.innerHTML = '';
            employees.forEach(emp => {
                const empDiv = document.createElement('div');
                empDiv.className = 'info-card';
                empDiv.style.marginBottom = '15px';
                
                const statusIcon = emp.is_blocked ? 'üî¥' : 'üü¢';
                const statusText = emp.is_blocked ? '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '–ê–∫—Ç–∏–≤–µ–Ω';
                const statusColor = emp.is_blocked ? '#ff4757' : '#2ed573';
                const adminBadge = emp.is_admin ? '<span style="background: #ffa500; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 10px;">–ê–î–ú–ò–ù</span>' : '';
                
                empDiv.innerHTML = `
                    <div class="card-header">
                        <span class="card-icon">üë§</span>
                        <span class="card-title">${emp.first_name} ${emp.last_name}${adminBadge}</span>
                        <span style="float: right; font-size: 12px; color: ${statusColor};">${statusIcon} ${statusText}</span>
                    </div>
                    <div class="card-content">
                        <div style="font-size: 14px; margin-bottom: 10px;">üìû ${emp.phone}</div>
                        ${emp.chat_id ? '<div style="font-size: 12px; color: rgba(255,255,255,0.6);">‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ –±–æ—Ç–µ</div>' : '<div style="font-size: 12px; color: rgba(255,255,255,0.6);">‚ö†Ô∏è –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –≤ –±–æ—Ç–µ</div>'}
                        <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="toggleEmployeeBlock('${emp.phone}', ${!emp.is_blocked})" 
                                    style="padding: 8px 16px; background: ${emp.is_blocked ? '#2ed573' : '#ff4757'}; border: none; border-radius: 6px; color: white; font-size: 12px; cursor: pointer;">
                                ${emp.is_blocked ? '‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : 'üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'}
                            </button>
                            <button onclick="editEmployee('${emp.phone}', '${emp.first_name}', '${emp.last_name}', ${emp.is_admin})" 
                                    style="padding: 8px 16px; background: #ffa500; border: none; border-radius: 6px; color: white; font-size: 12px; cursor: pointer;">
                                ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                            <button onclick="deleteEmployee('${emp.phone}', '${emp.first_name}', '${emp.last_name}')" 
                                    style="padding: 8px 16px; background: #ff4757; border: none; border-radius: 6px; color: white; font-size: 12px; cursor: pointer;">
                                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(empDiv);
            });
        }
        
        async function toggleEmployeeBlock(phone, isBlocked) {
            try {
                const response = await fetch('/api/admin/employee/block', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        employee_phone: phone,
                        is_blocked: isBlocked
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    tg.showAlert(result.message);
                    await loadEmployeesList(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
                } else {
                    tg.showAlert('–û—à–∏–±–∫–∞: ' + result.error);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                tg.showAlert('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞');
            }
        }
        
        async function showIssuesManagement() {
            console.log('showIssuesManagement –≤—ã–∑–≤–∞–Ω–∞');
            try {
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
                stopDialogAutoRefresh();
                
                // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
                document.getElementById('admin-menu-modal').style.display = 'none';
                document.getElementById('employees-management-modal').style.display = 'none';
                document.getElementById('broadcast-modal').style.display = 'none';
                document.getElementById('issue-dialog-modal').style.display = 'none';
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –æ—Ç–≤–µ—Ç–∞
                const responseInput = document.getElementById('admin-response-input');
                if (responseInput) {
                    responseInput.value = '';
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏
                document.getElementById('issues-management-modal').style.display = 'block';
                console.log('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–∫–∞–∑–∞–Ω–æ, –≤—ã–∑—ã–≤–∞–µ–º loadIssuesList');
                
                // –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–Ω–æ–≤–æ
                if (!issuesListCache) {
                    await loadIssuesList();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                tg.showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π');
            }
        }
        
        async function loadIssuesList(forceReload = false) {
            const container = document.getElementById('issues-list');
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –∫—ç—à –∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
            if (issuesListCache && !forceReload) {
                displayCachedIssuesList();
                return;
            }
            
            // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—Ä–∞–∑—É
            container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π...</div>';
            
            try {
                const response = await fetch(`/api/admin/issues/all?initData=${encodeURIComponent(tg.initData)}`, {
                    method: 'GET'
                });

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π');
                }

                const data = await response.json();
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
                issuesListCache = data.issues;
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º
                displayCachedIssuesList();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤ loadIssuesList:', error);
                document.getElementById('issues-list').innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π</div>';
            }
        }
        
        function displayCachedIssuesList() {
            const container = document.getElementById('issues-list');
            const data = { issues: issuesListCache };
            
            setTimeout(() => {
                setTimeout(() => {
                        // –°–æ–∑–¥–∞–µ–º –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π
                        let html = '<div style="padding: 20px;">';
                        
                        data.issues.forEach(issue => {
                            let statusIcon = 'üü°';
                            let statusText = '–ê–∫—Ç–∏–≤–Ω–æ';
                            let statusColor = '#ffa500';
                            if (issue.status === 'closed') {
                                statusIcon = 'üî¥';
                                statusText = '–ó–∞–∫—Ä—ã—Ç–æ';
                                statusColor = '#ff4757';
                            } else if (issue.status === 'resolved') {
                                statusIcon = 'üü¢';
                                statusText = '–†–µ—à–µ–Ω–æ';
                                statusColor = '#2ed573';
                            }
                            
                            const typeIcon = issue.type === 'personal' ? 'üíî' : 'üñ•';
                            const typeText = issue.type === 'personal' ? '–õ–∏—á–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞' : '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞';
                            const anonymityText = issue.is_anonymous ? ` (${issue.pseudonym || '–ê–Ω–æ–Ω–∏–º–Ω–æ'})` : '';
                            
                            html += '<div style="background: rgba(255,255,255,0.1); margin: 15px 0; padding: 15px; border-radius: 8px;">';
                            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">';
                            html += '<div style="font-weight: bold;">' + typeIcon + ' –û–±—Ä–∞—â–µ–Ω–∏–µ #' + issue.id + anonymityText + '</div>';
                            html += '<div style="font-size: 12px; color: ' + statusColor + ';">' + statusIcon + ' ' + statusText + '</div>';
                            html += '</div>';
                            html += '<div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-bottom: 5px;">' + typeText + '</div>';
                            html += '<div style="font-size: 14px; margin-bottom: 8px;">' + issue.description + '</div>';
                            html += '<div style="font-size: 12px; color: rgba(255,255,255,0.6);">–û—Ç: ' + issue.employee_name + '</div>';
                            html += '<div style="font-size: 12px; color: rgba(255,255,255,0.6);">–°–æ–∑–¥–∞–Ω–æ: ' + new Date(issue.created_at).toLocaleString('ru-RU') + '</div>';
                            
                            if (issue.last_response_preview) {
                                html += '<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.2);">';
                                html += '<div style="font-size: 12px; color: rgba(255,255,255,0.6);">–ü–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç:</div>';
                                html += '<div style="font-size: 13px; color: rgba(255,255,255,0.8);">' + issue.last_response_preview + '</div>';
                                html += '</div>';
                            }
                            
                            html += '<div style="margin-top: 15px; text-align: center;">';
                            if (issue.status === 'closed') {
                                // –î–ª—è –∑–∞–∫—Ä—ã—Ç—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π - –∫–Ω–æ–ø–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                                html += '<button onclick="openIssueDialog(' + issue.id + ')" style="background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 12px; cursor: pointer;">üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä</button>';
                            } else {
                                // –î–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π - –∫–Ω–æ–ø–∫–∏ –æ—Ç–≤–µ—Ç–∏—Ç—å –∏ –∑–∞–∫—Ä—ã—Ç—å
                                html += '<button onclick="openIssueDialog(' + issue.id + ')" style="background: #2ed573; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 12px; cursor: pointer; margin-right: 10px;">üí¨ –û—Ç–≤–µ—Ç–∏—Ç—å</button>';
                                html += '<button onclick="closeIssue(' + issue.id + ')" style="background: #ff4757; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 12px; cursor: pointer;">‚úÖ –ó–∞–∫—Ä—ã—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ</button>';
                            }
                            html += '</div>';
                            
                            html += '</div>';
                        });
                        
                        html += '</div>';
                        container.innerHTML = html;
                    }, 1000);
                }, 1000);
        }
        
        function displayIssuesList(issues) {
            try {
                const container = document.getElementById('issues-list');
                
                if (!issues || issues.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">–û–±—Ä–∞—â–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                    return;
                }

                container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">–®–∞–≥ 4: –û—Ç–æ–±—Ä–∞–∂–∞–µ–º ' + issues.length + ' –æ–±—Ä–∞—â–µ–Ω–∏–π...</div>';
            
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
            setTimeout(() => {
                container.innerHTML = '';
            issues.forEach(issue => {
                const issueDiv = document.createElement('div');
                issueDiv.className = 'info-card';
                issueDiv.style.marginBottom = '15px';
                
                let statusIcon = 'üü°';
                let statusText = '–ê–∫—Ç–∏–≤–Ω–æ';
                let statusColor = '#ffa500';
                if (issue.status === 'closed') {
                    statusIcon = 'üî¥';
                    statusText = '–ó–∞–∫—Ä—ã—Ç–æ';
                    statusColor = '#ff4757';
                } else if (issue.status === 'resolved') {
                    statusIcon = 'üü¢';
                    statusText = '–†–µ—à–µ–Ω–æ';
                    statusColor = '#2ed573';
                }
                
                const typeIcon = issue.type === 'personal' ? 'üíî' : 'üñ•';
                const typeText = issue.type === 'personal' ? '–õ–∏—á–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞' : '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞';
                const anonymityText = issue.is_anonymous ? ` (${issue.pseudonym || '–ê–Ω–æ–Ω–∏–º–Ω–æ'})` : '';
                
                let lastMessageInfo = '';
                if (issue.last_response_preview) {
                    lastMessageInfo = `
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.2);">
                            <div style="font-size: 12px; color: rgba(255,255,255,0.6);">–ü–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç:</div>
                            <div style="font-size: 13px; color: rgba(255,255,255,0.8);">${issue.last_response_preview}</div>
                        </div>
                    `;
                }
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
                let buttonsHtml = '';
                if (issue.status === 'closed') {
                    // –î–ª—è –∑–∞–∫—Ä—ã—Ç—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π - –∫–Ω–æ–ø–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                    buttonsHtml = `
                        <button onclick="openIssueDialog(${issue.id})" 
                                style="padding: 8px 16px; background: #667eea; border: none; border-radius: 6px; color: white; font-size: 12px; cursor: pointer;">
                            üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä
                        </button>
                    `;
                } else {
                    // –î–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π - –∫–Ω–æ–ø–∫–∏ –æ—Ç–≤–µ—Ç–∏—Ç—å –∏ –∑–∞–∫—Ä—ã—Ç—å
                    buttonsHtml = `
                        <button onclick="openIssueDialog(${issue.id})" 
                                style="padding: 8px 16px; background: #2ed573; border: none; border-radius: 6px; color: white; font-size: 12px; cursor: pointer; margin-right: 10px;">
                            üí¨ –û—Ç–≤–µ—Ç–∏—Ç—å
                        </button>
                        <button onclick="closeIssue(${issue.id})" 
                                style="padding: 8px 16px; background: #ff4757; border: none; border-radius: 6px; color: white; font-size: 12px; cursor: pointer;">
                            ‚úÖ –ó–∞–∫—Ä—ã—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ
                        </button>
                    `;
                }

                issueDiv.innerHTML = `
                    <div class="card-header">
                        <span class="card-icon">${typeIcon}</span>
                        <span class="card-title">–û–±—Ä–∞—â–µ–Ω–∏–µ #${issue.id}${anonymityText}</span>
                        <span style="float: right; font-size: 12px; color: ${statusColor};">${statusIcon} ${statusText}</span>
                    </div>
                    <div class="card-content">
                        <div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-bottom: 5px;">${typeText}</div>
                        <div style="font-size: 14px; margin-bottom: 8px;">${issue.description}</div>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.6);">
                            üë§ ${issue.employee_name} ‚Ä¢ üìÖ ${new Date(issue.created_at).toLocaleString('ru-RU')}
                            ${issue.response_count > 0 ? ` ‚Ä¢ üí¨ ${issue.response_count} –æ—Ç–≤–µ—Ç–æ–≤` : ''}
                        </div>
                        ${lastMessageInfo}
                        <div style="margin-top: 15px;">
                            ${buttonsHtml}
                        </div>
                    </div>
                `;
                container.appendChild(issueDiv);
            });
            }, 1000);
            
            } catch (error) {
                const container = document.getElementById('issues-list');
                container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">–û—à–∏–±–∫–∞ –≤ displayIssuesList: ' + error.message + '</div>';
            }
        }
        
        let currentIssueId = null;
        let issuesListCache = null;
        
        async function openIssueDialog(issueId) {
            try {
                currentIssueId = issueId;
                
                // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ–∫–Ω–∞
                document.getElementById('app').style.display = 'none';
                document.getElementById('issues-management-modal').style.display = 'none';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–∏–∞–ª–æ–≥–∞ —Å –æ–±—Ä–∞—â–µ–Ω–∏–µ–º
                document.getElementById('issue-dialog-modal').style.display = 'block';
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
                await loadIssueDialog(issueId);
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
                startDialogAutoRefresh();
                
                // –û—Ç–º–µ—á–∞–µ–º –æ—Ç–≤–µ—Ç—ã –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
                await markResponsesAsRead(issueId);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–∏–∞–ª–æ–≥–∞:', error);
                tg.showAlert('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–∏–∞–ª–æ–≥–∞ —Å –æ–±—Ä–∞—â–µ–Ω–∏–µ–º');
            }
        }
        
        async function loadIssueDialog(issueId) {
            try {
                const container = document.getElementById('issue-dialog-content');
                container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∏–∞–ª–æ–≥–∞...</div>';
                
                const response = await fetch(`/api/admin/issue/${issueId}/dialog?initData=${encodeURIComponent(tg.initData)}`, {
                    method: 'GET'
                });

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–ª–æ–≥–∞');
                }

                const data = await response.json();
                displayIssueDialog(data);
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—á–µ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —É–º–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                currentDialogMessagesCount = data.responses ? data.responses.length : 0;
                lastDialogData = data;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–ª–æ–≥–∞:', error);
                document.getElementById('issue-dialog-content').innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–ª–æ–≥–∞</div>';
            }
        }
        
        function displayIssueDialog(data) {
            const container = document.getElementById('issue-dialog-content');
            const issue = data.issue;
            const responses = data.responses || [];
            
            let html = '<div style="margin-bottom: 20px;">';
            
            // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–±—Ä–∞—â–µ–Ω–∏–∏
            const typeIcon = issue.type === 'personal' ? 'üíî' : 'üñ•';
            const typeText = issue.type === 'personal' ? '–õ–∏—á–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞' : '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞';
            const anonymityText = issue.is_anonymous ? ` (${issue.pseudonym || '–ê–Ω–æ–Ω–∏–º–Ω–æ'})` : '';
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            let statusIcon = 'üü°';
            let statusText = '–ê–∫—Ç–∏–≤–Ω–æ';
            let statusColor = '#ffa500';
            if (issue.status === 'closed') {
                statusIcon = 'üî¥';
                statusText = '–ó–∞–∫—Ä—ã—Ç–æ';
                statusColor = '#ff4757';
            } else if (issue.status === 'resolved') {
                statusIcon = 'üü¢';
                statusText = '–†–µ—à–µ–Ω–æ';
                statusColor = '#2ed573';
            }
            
            html += '<div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">';
            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">';
            html += '<div style="font-weight: bold;">' + typeIcon + ' –û–±—Ä–∞—â–µ–Ω–∏–µ #' + issue.id + anonymityText + '</div>';
            html += '<div style="font-size: 12px; color: ' + statusColor + ';">' + statusIcon + ' ' + statusText + '</div>';
            html += '</div>';
            html += '<div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-bottom: 5px;">' + typeText + '</div>';
            html += '<div style="font-size: 14px; margin-bottom: 8px;">' + issue.description + '</div>';
            html += '<div style="font-size: 12px; color: rgba(255,255,255,0.6);">–û—Ç: ' + issue.employee_name + '</div>';
            html += '<div style="font-size: 12px; color: rgba(255,255,255,0.6);">–°–æ–∑–¥–∞–Ω–æ: ' + new Date(issue.created_at).toLocaleString('ru-RU') + '</div>';
            
            // –ï—Å–ª–∏ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–∞
            if (issue.status === 'closed') {
                html += '<div style="margin-top: 10px; padding: 10px; background: rgba(255, 71, 87, 0.2); border-radius: 6px; font-size: 12px; color: rgba(255,255,255,0.8);">';
                html += 'üîí –≠—Ç–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ. –í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é, –Ω–æ –Ω–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã –¥–æ–±–∞–≤–ª—è—Ç—å –∑–∞–ø—Ä–µ—â–µ–Ω–æ.';
                html += '</div>';
            }
            
            html += '</div>';
            
            // –ò—Å—Ç–æ—Ä–∏—è –æ—Ç–≤–µ—Ç–æ–≤
            if (responses.length > 0) {
                html += '<div class="dialog-messages" style="margin-bottom: 20px; max-height: 300px; overflow-y: auto;">';
                html += '<div style="font-weight: bold; margin-bottom: 15px;">–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞:</div>';
                
                responses.forEach(response => {
                    const isAdmin = response.responder_phone === 'admin';
                    const bgColor = isAdmin ? 'rgba(46, 213, 115, 0.2)' : 'rgba(255, 255, 255, 0.1)';
                    const align = isAdmin ? 'margin-left: 20px;' : 'margin-right: 20px;';
                    
                    html += '<div style="background: ' + bgColor + '; padding: 12px; border-radius: 8px; margin-bottom: 10px; ' + align + '">';
                    html += '<div style="font-size: 14px; margin-bottom: 5px;">' + response.response_text + '</div>';
                    html += '<div style="font-size: 11px; color: rgba(255,255,255,0.6); text-align: right;">';
                    html += (isAdmin ? 'üë®‚Äçüíº –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : 'üë§ –°–æ—Ç—Ä—É–¥–Ω–∏–∫') + ' ‚Ä¢ ' + new Date(response.created_at).toLocaleString('ru-RU');
                    html += '</div>';
                    html += '</div>';
                });
                
                html += '</div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
            
            // –£–ø—Ä–∞–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å—é –ø–æ–ª—è –≤–≤–æ–¥–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞ –æ–±—Ä–∞—â–µ–Ω–∏—è
            const inputContainer = document.querySelector('#issue-dialog-modal div[style*="position: fixed"]');
            if (inputContainer) {
                if (issue.status === 'closed') {
                    // –î–ª—è –∑–∞–∫—Ä—ã—Ç—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π –¥–µ–ª–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                    inputContainer.style.opacity = '0.6';
                    const input = document.getElementById('admin-response-input');
                    const button = inputContainer.querySelector('button');
                    if (input) {
                        input.placeholder = '–û–±—Ä–∞—â–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ - –æ—Ç–≤–µ—Ç—ã –∑–∞–ø—Ä–µ—â–µ–Ω—ã';
                        input.style.background = 'rgba(255, 71, 87, 0.2)';
                    }
                    if (button) {
                        button.style.background = '#ff4757';
                        button.innerHTML = '‚ö†Ô∏è –û—Ç–≤–µ—Ç–∏—Ç—å';
                    }
                } else {
                    // –î–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ã—á–Ω—ã–π –≤–∏–¥
                    inputContainer.style.opacity = '1';
                    const input = document.getElementById('admin-response-input');
                    const button = inputContainer.querySelector('button');
                    if (input) {
                        input.placeholder = '–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç...';
                        input.style.background = 'rgba(255,255,255,0.1)';
                    }
                    if (button) {
                        button.style.background = '#2ed573';
                        button.innerHTML = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
                    }
                }
            }
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑ –∫ –ø–æ—Å–ª–µ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏—è–º
            setTimeout(() => {
                const scrollableContainer = document.getElementById('issue-dialog-scroll');
                if (scrollableContainer) {
                    console.log('–ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∞–¥–º–∏–Ω—Å–∫–∏–π –¥–∏–∞–ª–æ–≥ –≤–Ω–∏–∑');
                    scrollableContainer.scrollTop = scrollableContainer.scrollHeight;
                } else {
                    console.log('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä issue-dialog-scroll –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }
            }, 100);
        }
        
        async function sendAdminResponse() {
            try {
                const input = document.getElementById('admin-response-input');
                const responseText = input.value.trim();
                
                if (!responseText) {
                    tg.showAlert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞');
                    return;
                }
                
                const response = await fetch(`/api/admin/issue/${currentIssueId}/respond`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        response_text: responseText
                    })
                });

                if (!response.ok) {
                    if (response.status === 403) {
                        const errorData = await response.json();
                        if (errorData.error === 'Cannot respond to closed issue') {
                            tg.showAlert('–ù–µ–ª—å–∑—è –æ—Ç–≤–µ—á–∞—Ç—å –≤ –∑–∞–∫—Ä—ã—Ç–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ');
                            return;
                        }
                    }
                    throw new Error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞');
                }

                // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –¥–∏–∞–ª–æ–≥ –ª–æ–∫–∞–ª—å–Ω–æ
                addMessageToDialog(responseText, true, false);
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                input.value = '';
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—ç—à —Å–ø–∏—Å–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π (—Ç–∞–∫ –∫–∞–∫ –¥–æ–±–∞–≤–∏–ª—Å—è –Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç)
                issuesListCache = null;
                
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π (–¥–æ–±–∞–≤–∏–ª–∏ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
                currentDialogMessagesCount++;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞:', error);
                tg.showAlert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞');
            }
        }
        
        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendAdminResponse();
            }
        }
        
        async function closeIssue(issueId) {
            try {
                const response = await fetch(`/api/admin/issue/${issueId}/close`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    tg.showAlert(result.message);
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—ç—à –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
                    issuesListCache = null;
                    await loadIssuesList(true); // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
                } else {
                    tg.showAlert('–û—à–∏–±–∫–∞: ' + result.error);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                tg.showAlert('–û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –æ–±—Ä–∞—â–µ–Ω–∏—è');
            }
        }
        
        async function sendStatsToChannel() {
            try {
                const response = await fetch('/api/admin/send-stats', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    tg.showAlert(result.message);
                } else {
                    tg.showAlert('–û—à–∏–±–∫–∞: ' + result.error);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                tg.showAlert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
            }
        }
        
        function showBroadcastMessage() {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
            document.getElementById('admin-menu-modal').style.display = 'none';
            document.getElementById('employees-management-modal').style.display = 'none';
            document.getElementById('issues-management-modal').style.display = 'none';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–∞—Å—Å—ã–ª–∫–∏
            document.getElementById('broadcast-modal').style.display = 'block';
            document.getElementById('broadcast-message').value = '';
        }
        
        async function sendBroadcastMessage() {
            try {
                const messageText = document.getElementById('broadcast-message').value.trim();
                
                if (!messageText) {
                    tg.showAlert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è');
                    return;
                }
                
                const response = await fetch('/api/admin/broadcast', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        message: messageText
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    tg.showAlert(result.message);
                    document.getElementById('broadcast-message').value = '';
                    showAdminMenuModal(); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –∞–¥–º–∏–Ω-–º–µ–Ω—é
                } else {
                    tg.showAlert('–û—à–∏–±–∫–∞: ' + result.error);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                tg.showAlert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
            }
        }
        
        function showAddEmployeeModal() {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
            document.getElementById('employees-management-modal').style.display = 'none';
            document.getElementById('edit-employee-modal').style.display = 'none';
            document.getElementById('admin-menu-modal').style.display = 'none';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
            document.getElementById('add-employee-modal').style.display = 'block';
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
            document.getElementById('add-phone').value = '';
            document.getElementById('add-first-name').value = '';
            document.getElementById('add-last-name').value = '';
            document.getElementById('add-is-admin').checked = false;
        }
        
        async function addEmployee() {
            try {
                const phoneNumber = document.getElementById('add-phone').value.trim();
                const firstName = document.getElementById('add-first-name').value.trim();
                const lastName = document.getElementById('add-last-name').value.trim();
                const isAdmin = document.getElementById('add-is-admin').checked;
                
                if (!phoneNumber || !firstName || !lastName) {
                    tg.showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                    return;
                }
                
                const response = await fetch('/api/admin/employee/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        phone_number: phoneNumber,
                        first_name: firstName,
                        last_name: lastName,
                        is_admin: isAdmin
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    tg.showAlert(result.message);
                    showEmployeesManagement(); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Å–ø–∏—Å–∫—É –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ
                } else {
                    tg.showAlert('–û—à–∏–±–∫–∞: ' + result.error);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                tg.showAlert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞');
            }
        }
        
        function editEmployee(phone, firstName, lastName, isAdmin) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
            document.getElementById('employees-management-modal').style.display = 'none';
            document.getElementById('add-employee-modal').style.display = 'none';
            document.getElementById('admin-menu-modal').style.display = 'none';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            document.getElementById('edit-employee-modal').style.display = 'block';
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è
            document.getElementById('edit-phone').value = phone;
            document.getElementById('edit-first-name').value = firstName;
            document.getElementById('edit-last-name').value = lastName;
            document.getElementById('edit-is-admin').checked = isAdmin;
        }
        
        async function saveEmployeeChanges() {
            try {
                const phoneNumber = document.getElementById('edit-phone').value.trim();
                const firstName = document.getElementById('edit-first-name').value.trim();
                const lastName = document.getElementById('edit-last-name').value.trim();
                const isAdmin = document.getElementById('edit-is-admin').checked;
                
                if (!firstName || !lastName) {
                    tg.showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                    return;
                }
                
                const response = await fetch('/api/admin/employee/edit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        phone_number: phoneNumber,
                        first_name: firstName,
                        last_name: lastName,
                        is_admin: isAdmin
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    tg.showAlert(result.message);
                    showEmployeesManagement(); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Å–ø–∏—Å–∫—É –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ
                } else {
                    tg.showAlert('–û—à–∏–±–∫–∞: ' + result.error);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                tg.showAlert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π');
            }
        }
        
        async function deleteEmployee(phone, firstName, lastName) {
            try {
                // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
                if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ ${firstName} ${lastName}?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å. –ë—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞: —Ä–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è, –±–æ–ª—å–Ω–∏—á–Ω—ã–µ, –æ–±—Ä–∞—â–µ–Ω–∏—è.`)) {
                    return;
                }
                
                const response = await fetch('/api/admin/employee/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        phone_number: phone
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    tg.showAlert(result.message);
                    await loadEmployeesList(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                } else {
                    tg.showAlert('–û—à–∏–±–∫–∞: ' + result.error);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                tg.showAlert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞');
            }
        }
        
        function filterEmployees() {
            const searchTerm = document.getElementById('employee-search').value.toLowerCase().trim();
            
            if (!searchTerm) {
                // –ï—Å–ª–∏ –ø–æ–∏—Å–∫ –ø—É—Å—Ç–æ–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                filteredEmployees = [...allEmployees];
            } else {
                // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –∏–º–µ–Ω–∏, —Ñ–∞–º–∏–ª–∏–∏ –∏–ª–∏ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞
                filteredEmployees = allEmployees.filter(emp => {
                    const fullName = `${emp.first_name} ${emp.last_name}`.toLowerCase();
                    const phone = emp.phone.toLowerCase();
                    
                    return fullName.includes(searchTerm) || 
                           emp.first_name.toLowerCase().includes(searchTerm) ||
                           emp.last_name.toLowerCase().includes(searchTerm) ||
                           phone.includes(searchTerm);
                });
            }
            
            displayEmployeesList(filteredEmployees);
            updateSearchResultsCount();
        }
        
        function updateSearchResultsCount() {
            const searchTerm = document.getElementById('employee-search').value.trim();
            const countElement = document.getElementById('search-results-count');
            
            if (!searchTerm) {
                countElement.textContent = `–í—Å–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: ${allEmployees.length}`;
                countElement.style.color = 'rgba(255,255,255,0.6)';
            } else {
                if (filteredEmployees.length === 0) {
                    countElement.textContent = '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
                    countElement.style.color = 'rgba(255, 71, 87, 0.8)';
                } else if (filteredEmployees.length === 1) {
                    countElement.textContent = '–ù–∞–π–¥–µ–Ω 1 —Å–æ—Ç—Ä—É–¥–Ω–∏–∫';
                    countElement.style.color = 'rgba(46, 213, 115, 0.8)';
                } else {
                    countElement.textContent = `–ù–∞–π–¥–µ–Ω–æ ${filteredEmployees.length} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤`;
                    countElement.style.color = 'rgba(46, 213, 115, 0.8)';
                }
            }
        }
        
        async function loadUserAvatar() {
            try {
                const user = tg.initDataUnsafe?.user;
                console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', user);
                console.log('–ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ tg.initDataUnsafe:', tg.initDataUnsafe);
                console.log('tg.initData:', tg.initData);
                
                if (!user) {
                    console.log('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                    return;
                }
                
                const avatarEl = document.getElementById('avatar');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ photo_url –≤ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç Telegram
                if (user.photo_url) {
                    console.log('–ù–∞–π–¥–µ–Ω–∞ –∞–≤–∞—Ç–∞—Ä–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö Telegram:', user.photo_url);
                    avatarEl.innerHTML = `<img src="${user.photo_url}" alt="Avatar">`;
                    return;
                }
                
                // –ï—Å–ª–∏ –Ω–µ—Ç photo_url, –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —á–µ—Ä–µ–∑ tg.initDataUnsafe
                const initData = tg.initDataUnsafe;
                if (initData && initData.user && initData.user.photo_url) {
                    console.log('–ù–∞–π–¥–µ–Ω–∞ –∞–≤–∞—Ç–∞—Ä–∫–∞ –≤ initDataUnsafe:', initData.user.photo_url);
                    avatarEl.innerHTML = `<img src="${initData.user.photo_url}" alt="Avatar">`;
                    return;
                }
                
                // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —á–µ—Ä–µ–∑ Flask API
                console.log('–ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä–∫—É —á–µ—Ä–µ–∑ API...');
                try {
                    const apiResponse = await fetch(`http://localhost:5000/api/user-avatar?user_id=${user.id}`, {
                        method: 'GET'
                    });
                    
                    console.log('–û—Ç–≤–µ—Ç API –∞–≤–∞—Ç–∞—Ä–∫–∏:', apiResponse.status);
                    
                    if (apiResponse.ok) {
                        const apiData = await apiResponse.json();
                        console.log('–î–∞–Ω–Ω—ã–µ –∞–≤–∞—Ç–∞—Ä–∫–∏ –æ—Ç API:', apiData);
                        
                        if (apiData.avatar_url) {
                            console.log('–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É –æ—Ç API:', apiData.avatar_url);
                            avatarEl.innerHTML = `<img src="${apiData.avatar_url}" alt="Avatar">`;
                            return;
                        }
                    }
                } catch (apiError) {
                    console.log('–û—à–∏–±–∫–∞ API –∞–≤–∞—Ç–∞—Ä–∫–∏:', apiError);
                }
                
                // –ï—Å–ª–∏ API –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–π –∫—Ä—É–≥ —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º
                console.log('–ê–≤–∞—Ç–∞—Ä–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–π –∫—Ä—É–≥');
                avatarEl.innerHTML = '';
                avatarEl.textContent = '';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∫–∏:', error);
                // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–π –∫—Ä—É–≥
                const avatarEl = document.getElementById('avatar');
                avatarEl.innerHTML = '';
                avatarEl.textContent = '';
            }
        }
         
        async function loadUserData() {
            try {
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º API –≤—ã–∑–æ–≤ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const response = await fetch('http://localhost:5000/api/user-info', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData
                    })
                });

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                }

                const data = await response.json();
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ
                currentUserData = data;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                document.getElementById('name').textContent = data.user.first_name || 'Aleksei';
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª—ã)
                loadUserAvatar();
                
                // –î–ª—è –¥–µ–º–æ-—Ä–µ–∂–∏–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–∞–∑–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                const workStatusEl = document.getElementById('work-status');
                if (workStatusEl) workStatusEl.textContent = '–£–¥–∞–ª–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞';
                
                const vacationInfoEl = document.getElementById('vacation-info');
                if (vacationInfoEl) vacationInfoEl.textContent = '–û—Ç–ø—É—Å–∫ –Ω–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω';
                
                const dailyFactEl = document.getElementById('daily-fact');
                if (dailyFactEl) dailyFactEl.textContent = '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Maria Bot!';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–¥–º–∏–Ω—Å–∫–æ–µ –º–µ–Ω—é, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
                if (data.user.is_admin) {
                    const adminBtnEl = document.getElementById('admin-btn');
                    if (adminBtnEl) adminBtnEl.style.display = 'inline-flex';
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                document.getElementById('loading').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
            }
        }

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã
        let selectedMode = null;
        let selectedPeriod = null;
        let workModeOptions = null;
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è
        let absenceOptions = null;
        let selectedAbsenceDate = null;
        let selectedAbsenceTime = null;
        let customAbsenceDate = null;
        let customAbsenceStartTime = null;
        let customAbsenceEndTime = null;
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è SOS
        let sosOptions = null;
        let selectedIssueType = null;
        let selectedAnonymity = null;
        let sosPseudonym = null;
        let sosDescription = null;
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –±–æ–ª—å–Ω–∏—á–Ω–æ–≥–æ
        let sickLeaveOptions = null;
        let selectedLeaveType = null;
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —á–∞—Ç–∞
        let chatRefreshInterval = null;
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
        let allEmployees = [];
        let filteredEmployees = [];

        async function handleAction(action) {
            try {
                if (action === 'vacation') {
                    tg.showAlert('–§—É–Ω–∫—Ü–∏—è "–ú–æ–π –æ—Ç–ø—É—Å–∫" –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
                    return;
                }
                
                if (action === 'work_mode') {
                    await showWorkModeModal();
                    return;
                }
                
                if (action === 'absence') {
                    await showAbsenceModal();
                    return;
                }
                
                if (action === 'sick_leave') {
                    await showSickLeaveModal();
                    return;
                }
                
                if (action === 'crocotime') {
                    tg.showAlert('–§—É–Ω–∫—Ü–∏—è "–ú–æ–π Crocotime" –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
                    return;
                }
                
                if (action === 'admin' || action === 'admin_menu') {
                    await showAdminMenuModal();
                    return;
                }
                
                if (action === 'sos') {
                    await showSosModal();
                    return;
                }
                
                if (action === 'sos_menu') {
                    await showSosMenuModal();
                    return;
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                tg.showAlert('–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å...');
                
                const response = await fetch('/api/actions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        action: action
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    if (result.redirect) {
                        if (result.action === 'work_mode') {
                            await showWorkModeModal();
                        } else if (result.action === 'absence') {
                            await showAbsenceModal();
                        } else if (result.action === 'sos') {
                            await showSosModal();
                        } else if (result.action === 'sos_menu') {
                            await showSosMenuModal();
                        } else if (result.action === 'sick_leave') {
                            await showSickLeaveModal();
                        } else if (result.action === 'admin_menu') {
                            await showAdminMenuModal();
                        }
                    } else {
                        tg.showAlert(result.message || '–î–µ–π—Å—Ç–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ');
                    }
                } else {
                    tg.showAlert('–û—à–∏–±–∫–∞: ' + result.error);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                tg.showAlert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –¥–µ–π—Å—Ç–≤–∏—è');
            }
        }
        
        async function showSosModal() {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–ø—Ü–∏–∏ SOS
                const response = await fetch('http://localhost:5000/api/sos', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                }

                sosOptions = await response.json();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                document.getElementById('app').style.display = 'none';
                document.getElementById('sos-menu-modal').style.display = 'none';
                document.getElementById('sos-modal').style.display = 'block';
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∏–ø—ã –ø—Ä–æ–±–ª–µ–º
                const typesContainer = document.getElementById('sos-issue-types');
                typesContainer.innerHTML = '';
                
                sosOptions.issue_types.forEach(type => {
                    const button = document.createElement('button');
                    button.className = 'action-button';
                    button.id = `issue-type-${type.id}`;
                    button.innerHTML = `<span class="icon">${type.name.split(' ')[0]}</span>${type.name.substring(2)}`;
                    button.onclick = () => selectIssueType(type.id);
                    typesContainer.appendChild(button);
                });
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                selectedIssueType = null;
                selectedAnonymity = null;
                sosPseudonym = null;
                sosDescription = null;
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
                setTimeout(() => {
                    const allButtons = document.querySelectorAll('#sos-issue-types .action-button, #sos-anonymity-options .action-button');
                    allButtons.forEach(btn => {
                        btn.style.background = '';
                        btn.style.boxShadow = '';
                        btn.style.transform = '';
                    });
                }, 100);
                
                // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–µ–∫—Ü–∏–∏
                document.getElementById('sos-anonymity-section').style.display = 'none';
                document.getElementById('sos-anonymity-options').style.display = 'none';
                document.getElementById('sos-pseudonym-section').style.display = 'none';
                document.getElementById('sos-description-section').style.display = 'none';
                document.getElementById('sos-confirmation-section').style.display = 'none';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                tg.showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            }
        }
        
        function selectIssueType(typeId) {
            selectedIssueType = typeId;
            
            // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ —Ç–∏–ø–æ–≤ –ø—Ä–æ–±–ª–µ–º
            const allTypeButtons = document.querySelectorAll('#sos-issue-types .action-button');
            allTypeButtons.forEach(btn => {
                btn.style.background = '';
                btn.style.boxShadow = '';
                btn.style.transform = '';
            });
            
            // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É
            const selectedButton = document.getElementById(`issue-type-${typeId}`);
            if (selectedButton) {
                selectedButton.style.background = 'linear-gradient(45deg, #ff6b6b, #ee5a24)';
                selectedButton.style.boxShadow = '0 0 20px rgba(255, 107, 107, 0.5)';
                selectedButton.style.transform = 'scale(1.05)';
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –≤—ã–±–æ—Ä–∞ –∞–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç–∏
            document.getElementById('sos-anonymity-section').style.display = 'block';
            document.getElementById('sos-anonymity-options').style.display = 'grid';
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ–ø—Ü–∏–∏ –∞–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç–∏
            const anonymityContainer = document.getElementById('sos-anonymity-options');
            anonymityContainer.innerHTML = '';
            
            sosOptions.anonymity_options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'action-button';
                button.id = `anonymity-${option.id}`;
                button.innerHTML = `<span class="icon">${option.name.split(' ')[0]}</span>${option.name.substring(2)}`;
                button.onclick = () => selectAnonymity(option.id);
                anonymityContainer.appendChild(button);
            });
        }
        
        function selectAnonymity(anonymityId) {
            selectedAnonymity = anonymityId;
            
            // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –∞–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç–∏
            const allAnonymityButtons = document.querySelectorAll('#sos-anonymity-options .action-button');
            allAnonymityButtons.forEach(btn => {
                btn.style.background = '';
                btn.style.boxShadow = '';
                btn.style.transform = '';
            });
            
            // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É
            const selectedButton = document.getElementById(`anonymity-${anonymityId}`);
            if (selectedButton) {
                selectedButton.style.background = 'linear-gradient(45deg, #5f27cd, #341f97)';
                selectedButton.style.boxShadow = '0 0 20px rgba(95, 39, 205, 0.5)';
                selectedButton.style.transform = 'scale(1.05)';
            }
            
            if (anonymityId === 'anonymous') {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ –ø—Å–µ–≤–¥–æ–Ω–∏–º–∞
                document.getElementById('sos-pseudonym-section').style.display = 'block';
                document.getElementById('sos-description-section').style.display = 'none';
            } else {
                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º —Å—Ä–∞–∑—É –∫ –æ–ø–∏—Å–∞–Ω–∏—é
                document.getElementById('sos-pseudonym-section').style.display = 'none';
                document.getElementById('sos-description-section').style.display = 'block';
            }
        }
        
        function selectSosPseudonym() {
            const pseudonymInput = document.getElementById('sos-pseudonym');
            sosPseudonym = pseudonymInput.value.trim();
            
            if (!sosPseudonym) {
                tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –ø—Å–µ–≤–¥–æ–Ω–∏–º');
                return;
            }
            
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –æ–ø–∏—Å–∞–Ω–∏—é
            document.getElementById('sos-pseudonym-section').style.display = 'none';
            document.getElementById('sos-description-section').style.display = 'block';
        }
        
        async function submitSos() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
                const descriptionInput = document.getElementById('sos-description');
                sosDescription = descriptionInput.value.trim();
                
                if (!sosDescription) {
                    tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É');
                    return;
                }
                
                if (sosDescription.length < 10) {
                    tg.showAlert('–û–ø–∏—Å–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤');
                    return;
                }
                
                const response = await fetch('http://localhost:5000/api/sos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        issue_type: selectedIssueType,
                        anonymity: selectedAnonymity,
                        description: sosDescription,
                        pseudonym: sosPseudonym || ''
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    tg.showAlert(result.message);
                    // –ï—Å–ª–∏ –æ–±—Ä–∞—â–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á–∞—Ç
                    if (result.issue_id) {
                        setTimeout(() => {
                            showIssueChat(result.issue_id);
                        }, 1000);
                    } else {
                        showMainApp();
                    }
                } else {
                    tg.showAlert('–û—à–∏–±–∫–∞: ' + result.error);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                tg.showAlert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ');
            }
        }
        
        async function showSickLeaveModal() {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–ø—Ü–∏–∏ –±–æ–ª—å–Ω–∏—á–Ω–æ–≥–æ
                const response = await fetch('http://localhost:5000/api/sick-leave', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                }

                sickLeaveOptions = await response.json();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                document.getElementById('app').style.display = 'none';
                document.getElementById('sick-leave-modal').style.display = 'block';
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∏–ø—ã –±–æ–ª—å–Ω–∏—á–Ω–æ–≥–æ
                const typesContainer = document.getElementById('sick-leave-types');
                typesContainer.innerHTML = '';
                
                sickLeaveOptions.leave_types.forEach(type => {
                    const button = document.createElement('button');
                    button.className = 'btn';
                    button.innerHTML = `<span class="dot dot-sick"></span><span>${type.name}</span>`;
                    button.onclick = () => selectLeaveType(type.id);
                    typesContainer.appendChild(button);
                });
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                selectedLeaveType = null;
                document.getElementById('sick-leave-form-section').style.display = 'none';
                
                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                document.getElementById('sick-leave-number').value = '';
                document.getElementById('sick-leave-start-date').value = '';
                document.getElementById('sick-leave-end-date').value = '';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                tg.showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            }
        }
        
        function selectLeaveType(typeId) {
            selectedLeaveType = typeId;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('sick-leave-form-section').style.display = 'block';
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('sick-leave-start-date').value = today;
            document.getElementById('sick-leave-end-date').value = today;
        }
        
        function setSickLeaveDate(dateType) {
            const startDateInput = document.getElementById('sick-leave-start-date');
            const endDateInput = document.getElementById('sick-leave-end-date');
            
            let dateValue = '';
            
            if (dateType === 'today') {
                dateValue = sickLeaveOptions.date_suggestions.today;
            } else if (dateType === 'yesterday') {
                dateValue = sickLeaveOptions.date_suggestions.yesterday;
            } else if (dateType === 'week_ago') {
                dateValue = sickLeaveOptions.date_suggestions.week_ago;
            }
            
            startDateInput.value = dateValue;
            
            // –ï—Å–ª–∏ –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–ª–∏ –º–µ–Ω—å—à–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ—ë —Ä–∞–≤–Ω–æ–π –¥–∞—Ç–µ –Ω–∞—á–∞–ª–∞
            if (!endDateInput.value || endDateInput.value < dateValue) {
                endDateInput.value = dateValue;
            }
        }
        
        async function submitSickLeave() {
            try {
                const leaveNumber = document.getElementById('sick-leave-number').value.trim();
                const startDate = document.getElementById('sick-leave-start-date').value;
                const endDate = document.getElementById('sick-leave-end-date').value;
                
                if (!leaveNumber) {
                    tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≠–õ–ù');
                    return;
                }
                
                if (!startDate || !endDate) {
                    tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—ã –±–æ–ª—å–Ω–∏—á–Ω–æ–≥–æ');
                    return;
                }
                
                if (startDate > endDate) {
                    tg.showAlert('–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–∑–∂–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è');
                    return;
                }
                
                const response = await fetch('http://localhost:5000/api/sick-leave', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        leave_type: selectedLeaveType,
                        leave_number: leaveNumber,
                        start_date: startDate,
                        end_date: endDate
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    tg.showAlert(result.message);
                    showMainApp();
                } else {
                    tg.showAlert('–û—à–∏–±–∫–∞: ' + result.error);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                tg.showAlert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
            }
        }
        
        async function showAbsenceModal() {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–ø—Ü–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è
                const response = await fetch('http://localhost:5000/api/absence', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                }

                absenceOptions = await response.json();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                document.getElementById('app').style.display = 'none';
                document.getElementById('absence-modal').style.display = 'block';
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞—Ç—ã
                const datesContainer = document.getElementById('absence-dates');
                datesContainer.innerHTML = '';
                
                absenceOptions.dates.forEach(date => {
                    const button = document.createElement('button');
                    button.className = 'btn';
                    button.innerHTML = `<span class="dot dot-absence"></span><span>${date.name}</span>`;
                    button.onclick = () => selectAbsenceDate(date.id, date.date);
                    datesContainer.appendChild(button);
                });
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                selectedAbsenceDate = null;
                selectedAbsenceTime = null;
                customAbsenceDate = null;
                customAbsenceStartTime = null;
                customAbsenceEndTime = null;
                
                // –°–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                document.getElementById('absence-time-section').style.display = 'none';
                document.getElementById('absence-times').style.display = 'none';
                document.getElementById('absence-custom-date').style.display = 'none';
                document.getElementById('absence-custom-time').style.display = 'none';
                document.getElementById('absence-confirmation-section').style.display = 'none';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                tg.showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            }
        }
        
        function selectAbsenceDate(dateId, dateValue) {
            selectedAbsenceDate = dateId;
            
            if (dateId === 'custom') {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ –¥–∞—Ç—ã
                document.getElementById('absence-custom-date').style.display = 'block';
                document.getElementById('absence-time-section').style.display = 'none';
                document.getElementById('absence-times').style.display = 'none';
            } else {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏
                document.getElementById('absence-time-section').style.display = 'block';
                document.getElementById('absence-times').style.display = 'grid';
                document.getElementById('absence-custom-date').style.display = 'none';
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—Ä–µ–º–µ–Ω–∞
                const timesContainer = document.getElementById('absence-times');
                timesContainer.innerHTML = '';
                
                absenceOptions.times.forEach(time => {
                    const button = document.createElement('button');
                    button.className = 'action-button';
                    button.innerHTML = `<span class="icon">‚è∞</span>${time.name.substring(2)}`;
                    button.onclick = () => selectAbsenceTime(time.id, time.start, time.end);
                    timesContainer.appendChild(button);
                });
            }
        }
        
        function selectAbsenceCustomDate() {
            const dateInput = document.getElementById('absence-date');
            customAbsenceDate = dateInput.value;
            
            if (!customAbsenceDate) {
                tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É');
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏
            document.getElementById('absence-time-section').style.display = 'block';
            document.getElementById('absence-times').style.display = 'grid';
            document.getElementById('absence-custom-date').style.display = 'none';
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—Ä–µ–º–µ–Ω–∞
            const timesContainer = document.getElementById('absence-times');
            timesContainer.innerHTML = '';
            
            absenceOptions.times.forEach(time => {
                const button = document.createElement('button');
                button.className = 'action-button';
                button.innerHTML = `<span class="icon">‚è∞</span>${time.name.substring(2)}`;
                button.onclick = () => selectAbsenceTime(time.id, time.start, time.end);
                timesContainer.appendChild(button);
            });
        }
        
        function selectAbsenceTime(timeId, startTime, endTime) {
            selectedAbsenceTime = timeId;
            
            if (timeId === 'custom') {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—è –¥–ª—è –≤–≤–æ–¥–∞ –≤—Ä–µ–º–µ–Ω–∏
                document.getElementById('absence-custom-time').style.display = 'block';
                document.getElementById('absence-confirmation-section').style.display = 'none';
            } else {
                customAbsenceStartTime = startTime;
                customAbsenceEndTime = endTime;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
                showAbsenceConfirmation();
            }
        }
        
        function showAbsenceConfirmation() {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∞—Ç—É
            let dateText = '';
            let dateValue = '';
            
            if (selectedAbsenceDate === 'custom') {
                const date = new Date(customAbsenceDate);
                dateText = date.toLocaleDateString('ru-RU');
                dateValue = customAbsenceDate;
            } else {
                const dateOption = absenceOptions.dates.find(d => d.id === selectedAbsenceDate);
                dateText = dateOption.name.substring(dateOption.name.indexOf('(') + 1, dateOption.name.indexOf(')'));
                dateValue = dateOption.date;
            }
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—Ä–µ–º—è
            let timeText = '';
            let startTimeValue = '';
            let endTimeValue = '';
            
            if (selectedAbsenceTime === 'custom') {
                startTimeValue = document.getElementById('absence-start-time').value;
                endTimeValue = document.getElementById('absence-end-time').value;
                timeText = `${startTimeValue} - ${endTimeValue}`;
            } else {
                const timeOption = absenceOptions.times.find(t => t.id === selectedAbsenceTime);
                timeText = timeOption.name.substring(timeOption.name.indexOf('(') + 1, timeOption.name.indexOf(')'));
                startTimeValue = customAbsenceStartTime;
                endTimeValue = customAbsenceEndTime;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
            document.getElementById('absence-confirmation-text').innerHTML = 
                `–î–∞—Ç–∞: <strong>${dateText}</strong><br>–í—Ä–µ–º—è: <strong>${timeText}</strong>`;
            
            document.getElementById('absence-custom-time').style.display = 'none';
            document.getElementById('absence-confirmation-section').style.display = 'block';
        }
        
        async function submitAbsence() {
            try {
                // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ —Å–≤–æ–µ –≤—Ä–µ–º—è, –ø–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –ø–æ–ª–µ–π
                if (selectedAbsenceTime === 'custom') {
                    customAbsenceStartTime = document.getElementById('absence-start-time').value;
                    customAbsenceEndTime = document.getElementById('absence-end-time').value;
                    
                    if (!customAbsenceStartTime || !customAbsenceEndTime) {
                        tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è');
                        return;
                    }
                }
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∞—Ç—É
                let dateValue = '';
                
                if (selectedAbsenceDate === 'custom') {
                    dateValue = customAbsenceDate;
                }
                
                const response = await fetch('http://localhost:5000/api/absence', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        date_option: selectedAbsenceDate,
                        custom_date: dateValue,
                        time_option: selectedAbsenceTime,
                        start_time: customAbsenceStartTime,
                        end_time: customAbsenceEndTime
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    tg.showAlert(result.message);
                    showMainApp();
                } else {
                    tg.showAlert('–û—à–∏–±–∫–∞: ' + result.error);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                tg.showAlert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
            }
        }

        async function showWorkModeModal() {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–ø—Ü–∏–∏ —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã
                const response = await fetch('http://localhost:5000/api/work-mode', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                }

                workModeOptions = await response.json();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                document.getElementById('app').style.display = 'none';
                document.getElementById('work-mode-modal').style.display = 'block';
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ä–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã
                const modesContainer = document.getElementById('work-modes');
                modesContainer.innerHTML = '';
                
                workModeOptions.modes.forEach(mode => {
                    const button = document.createElement('button');
                    button.className = 'btn';
                    button.innerHTML = `<span class="dot dot-mode"></span><span>${mode.name}</span>`;
                    button.onclick = () => selectWorkMode(mode.id);
                    modesContainer.appendChild(button);
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                tg.showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            }
        }

        function selectWorkMode(mode) {
            selectedMode = mode;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –≤—ã–±–æ—Ä–∞ –ø–µ—Ä–∏–æ–¥–∞
            document.getElementById('period-section').style.display = 'block';
            document.getElementById('work-periods').style.display = 'grid';
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–µ—Ä–∏–æ–¥—ã
            const periodsContainer = document.getElementById('work-periods');
            periodsContainer.innerHTML = '';
            
            workModeOptions.periods.forEach(period => {
                const button = document.createElement('button');
                button.className = 'btn';
                button.innerHTML = `<span class="dot dot-holiday"></span><span>${period.name}</span>`;
                button.onclick = () => selectPeriod(period.id);
                periodsContainer.appendChild(button);
            });
        }

        function selectPeriod(period) {
            selectedPeriod = period;
            
            if (period === 'custom') {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—è –¥–ª—è –≤–≤–æ–¥–∞ –¥–∞—Ç
                document.getElementById('custom-period').style.display = 'block';
                document.getElementById('confirmation-section').style.display = 'none';
            } else {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
                showConfirmation();
            }
        }

        function showConfirmation() {
            const modeText = workModeOptions.modes.find(m => m.id === selectedMode).name;
            const periodText = workModeOptions.periods.find(p => p.id === selectedPeriod).name;
            
            document.getElementById('confirmation-text').innerHTML = 
                `–†–µ–∂–∏–º: <strong>${modeText}</strong><br>–ü–µ—Ä–∏–æ–¥: <strong>${periodText}</strong>`;
            
            document.getElementById('custom-period').style.display = 'none';
            document.getElementById('confirmation-section').style.display = 'block';
        }

        async function submitWorkMode() {
            try {
                let startDate = null;
                let endDate = null;
                
                if (selectedPeriod === 'custom') {
                    startDate = document.getElementById('start-date').value;
                    endDate = document.getElementById('end-date').value;
                    
                    if (!startDate || !endDate) {
                        tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—ã');
                        return;
                    }
                }
                
                const response = await fetch('http://localhost:5000/api/work-mode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        mode: selectedMode,
                        period: selectedPeriod,
                        start_date: startDate,
                        end_date: endDate
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    tg.showAlert(result.message);
                    showMainApp();
                } else {
                    tg.showAlert('–û—à–∏–±–∫–∞: ' + result.error);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                tg.showAlert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
                        }
        }
        
        async function showSosMenuModal() {
            try {
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
                stopDialogAutoRefresh();
                
                // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
                document.getElementById('app').style.display = 'none';
                document.getElementById('sos-modal').style.display = 'none';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–µ–Ω—é SOS
                document.getElementById('sos-menu-modal').style.display = 'block';
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –æ–±—Ä–∞—â–µ–Ω–∏–π
                await loadMyIssues();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                tg.showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é SOS');
            }
        }
        
        async function loadMyIssues() {
            try {
                const response = await fetch(`http://localhost:5000/api/my-issues?initData=${encodeURIComponent(tg.initData)}`, {
                    method: 'GET'
                });

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π');
                }

                const data = await response.json();
                displayMyIssuesList(data.issues);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                document.getElementById('sos-issues-list').innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π</div>';
            }
        }
        
        function displayMyIssuesList(issues) {
            const container = document.getElementById('sos-issues-list');
            
            if (!issues || issues.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π</div>';
                return;
            }
            
            let html = '<div style="padding: 10px;">';
            
            issues.forEach(issue => {
                let statusIcon = 'üü°';
                let statusText = '–ê–∫—Ç–∏–≤–Ω–æ';
                let statusColor = '#ffa500';
                if (issue.status === 'closed') {
                    statusIcon = 'üî¥';
                    statusText = '–ó–∞–∫—Ä—ã—Ç–æ';
                    statusColor = '#ff4757';
                } else if (issue.status === 'resolved') {
                    statusIcon = 'üü¢';
                    statusText = '–†–µ—à–µ–Ω–æ';
                    statusColor = '#2ed573';
                }
                
                const typeIcon = issue.type === 'personal' ? 'üíî' : 'üñ•';
                const typeText = issue.type === 'personal' ? '–õ–∏—á–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞' : '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞';
                const anonymityText = issue.is_anonymous ? ` (${issue.pseudonym || '–ê–Ω–æ–Ω–∏–º–Ω–æ'})` : '';
                
                // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
                const newResponsesBadge = issue.has_new_responses ? 
                    '<span style="background: #ff4757; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: 5px;">–ù–û–í–´–ï –û–¢–í–ï–¢–´</span>' : '';
                
                // –î–ª—è –∑–∞–∫—Ä—ã—Ç—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π —É–±–∏—Ä–∞–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∫–ª–∏–∫–∞
                const clickHandler = issue.status === 'closed' ? '' : 'onclick="openMyIssueDialog(' + issue.id + ')"';
                const cursorStyle = issue.status === 'closed' ? 'cursor: not-allowed; opacity: 0.6;' : 'cursor: pointer;';
                
                html += '<div style="background: rgba(255,255,255,0.1); margin: 10px 0; padding: 15px; border-radius: 8px; ' + cursorStyle + '" ' + clickHandler + '>';
                html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">';
                html += '<div style="font-weight: bold;">' + typeIcon + ' –û–±—Ä–∞—â–µ–Ω–∏–µ #' + issue.id + anonymityText + newResponsesBadge + '</div>';
                html += '<div style="font-size: 12px; color: ' + statusColor + ';">' + statusIcon + ' ' + statusText + '</div>';
                html += '</div>';
                html += '<div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-bottom: 5px;">' + typeText + '</div>';
                html += '<div style="font-size: 14px; margin-bottom: 8px;">' + issue.description + '</div>';
                
                if (issue.status === 'closed') {
                    html += '<div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-bottom: 5px;">üîí –û–±—Ä–∞—â–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ - –ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</div>';
                }
                
                html += '<div style="font-size: 12px; color: rgba(255,255,255,0.6);">–°–æ–∑–¥–∞–Ω–æ: ' + new Date(issue.created_at).toLocaleString('ru-RU') + '</div>';
                
                if (issue.admin_response_count > 0) {
                    html += '<div style="font-size: 12px; color: rgba(255,255,255,0.6);">–û—Ç–≤–µ—Ç–æ–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: ' + issue.admin_response_count + '</div>';
                }
                
                if (issue.last_admin_response_preview) {
                    html += '<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.2);">';
                    html += '<div style="font-size: 12px; color: rgba(255,255,255,0.6);">–ü–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:</div>';
                    html += '<div style="font-size: 13px; color: rgba(255,255,255,0.8);">' + issue.last_admin_response_preview + '</div>';
                    html += '</div>';
                }
                
                html += '</div>';
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        let currentMyIssueId = null;
        let dialogRefreshInterval = null;
        let currentDialogMessagesCount = 0;
        let lastDialogData = null;
        let currentUserData = null;
        let dialogOpenedFromNotification = false;
        
        function startDialogAutoRefresh() {
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            if (dialogRefreshInterval) {
                clearInterval(dialogRefreshInterval);
            }
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
            dialogRefreshInterval = setInterval(async () => {
                try {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–æ–π –¥–∏–∞–ª–æ–≥ –æ—Ç–∫—Ä—ã—Ç
                    if (currentMyIssueId && document.getElementById('my-issue-dialog-modal').style.display === 'block') {
                        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –¥–∏–∞–ª–æ–≥ - —É–º–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                        await smartUpdateDialog(currentMyIssueId, true);
                    } else if (currentIssueId && document.getElementById('issue-dialog-modal').style.display === 'block') {
                        // –ê–¥–º–∏–Ω—Å–∫–∏–π –¥–∏–∞–ª–æ–≥ - —É–º–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                        await smartUpdateDialog(currentIssueId, false);
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞:', error);
                }
            }, 3000);
        }
        
        function stopDialogAutoRefresh() {
            if (dialogRefreshInterval) {
                clearInterval(dialogRefreshInterval);
                dialogRefreshInterval = null;
            }
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
            currentDialogMessagesCount = 0;
            lastDialogData = null;
        }
        
        // –£–º–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞ - –¥–æ–±–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function smartUpdateDialog(issueId, isUserDialog = true) {
            try {
                const apiUrl = isUserDialog 
                    ? `/api/my-issue/${issueId}/dialog?initData=${encodeURIComponent(tg.initData)}`
                    : `/api/admin/issue/${issueId}/dialog?initData=${encodeURIComponent(tg.initData)}`;
                
                const response = await fetch(apiUrl, { method: 'GET' });
                
                if (!response.ok) {
                    return;
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
                const newMessagesCount = data.responses ? data.responses.length : 0;
                
                if (newMessagesCount === currentDialogMessagesCount) {
                    // –ù–µ—Ç –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º
                    return;
                }
                
                if (currentDialogMessagesCount === 0 || !lastDialogData) {
                    // –ü–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–ª–∏ –ø–æ–ª–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                    if (isUserDialog) {
                        displayMyIssueDialog(data);
                    } else {
                        displayIssueDialog(data);
                    }
                    currentDialogMessagesCount = newMessagesCount;
                    lastDialogData = data;
                    return;
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                if (newMessagesCount > currentDialogMessagesCount) {
                    const newMessages = data.responses.slice(currentDialogMessagesCount);
                    appendNewMessages(newMessages, isUserDialog, data.issue.employee_phone);
                    currentDialogMessagesCount = newMessagesCount;
                    lastDialogData = data;
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–º–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞:', error);
            }
        }
        
        // –î–æ–±–∞–≤–ª—è–µ—Ç –æ–¥–Ω–æ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –¥–∏–∞–ª–æ–≥
        function addMessageToDialog(messageText, isFromCurrentUser, isUserDialog) {
            const containerId = isUserDialog ? 'my-issue-dialog-content' : 'issue-dialog-content';
            const container = document.getElementById(containerId);
            
            if (!container) return;
            
            // –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
            let messagesContainer = container.querySelector('.dialog-messages');
            if (!messagesContainer) {
                // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ –≤ –∫–æ–Ω—Ü–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                messagesContainer = document.createElement('div');
                messagesContainer.className = 'dialog-messages';
                messagesContainer.style.cssText = 'margin-bottom: 20px; max-height: 300px; overflow-y: auto;';
                container.appendChild(messagesContainer);
            }
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            const messageDiv = document.createElement('div');
            const currentTime = new Date().toLocaleString('ru-RU');
            
            if (isUserDialog) {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –¥–∏–∞–ª–æ–≥
                const bgColor = isFromCurrentUser ? 'rgba(255, 255, 255, 0.1)' : 'rgba(46, 213, 115, 0.2)';
                const align = isFromCurrentUser ? 'margin-right: 20px;' : 'margin-left: 20px;';
                const senderText = isFromCurrentUser ? 'üë§ –í—ã' : 'üë®‚Äçüíº –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
                
                messageDiv.style.cssText = `background: ${bgColor}; padding: 12px; border-radius: 8px; margin-bottom: 10px; ${align}`;
                messageDiv.innerHTML = `
                    <div style="font-size: 14px; margin-bottom: 5px;">${messageText}</div>
                    <div style="font-size: 11px; color: rgba(255,255,255,0.6); text-align: right;">
                        ${senderText} ‚Ä¢ ${currentTime}
                    </div>
                `;
            } else {
                // –ê–¥–º–∏–Ω—Å–∫–∏–π –¥–∏–∞–ª–æ–≥
                const bgColor = isFromCurrentUser ? 'rgba(46, 213, 115, 0.2)' : 'rgba(255, 255, 255, 0.1)';
                const align = isFromCurrentUser ? 'margin-left: 20px;' : 'margin-right: 20px;';
                const senderText = isFromCurrentUser ? 'üë®‚Äçüíº –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : 'üë§ –°–æ—Ç—Ä—É–¥–Ω–∏–∫';
                
                messageDiv.style.cssText = `background: ${bgColor}; padding: 12px; border-radius: 8px; margin-bottom: 10px; ${align}`;
                messageDiv.innerHTML = `
                    <div style="font-size: 14px; margin-bottom: 5px;">${messageText}</div>
                    <div style="font-size: 11px; color: rgba(255,255,255,0.6); text-align: right;">
                        ${senderText} ‚Ä¢ ${currentTime}
                    </div>
                `;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω–µ—Ü
            messagesContainer.appendChild(messageDiv);
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
            setTimeout(() => {
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –≤–∏–¥–∏–º—É—é –æ–±–ª–∞—Å—Ç—å
                messageDiv.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'end',
                    inline: 'nearest'
                });
            }, 100);
        }

        // –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–æ–Ω–µ—Ü –¥–∏–∞–ª–æ–≥–∞
        function appendNewMessages(newMessages, isUserDialog, employeePhone) {
            const containerId = isUserDialog ? 'my-issue-dialog-content' : 'issue-dialog-content';
            const container = document.getElementById(containerId);
            
            if (!container) return;
            
            // –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
            let messagesContainer = container.querySelector('.dialog-messages');
            if (!messagesContainer) {
                // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
                messagesContainer = document.createElement('div');
                messagesContainer.className = 'dialog-messages';
                container.appendChild(messagesContainer);
            }
            
            newMessages.forEach(response => {
                const messageDiv = document.createElement('div');
                const isFromEmployee = response.responder_phone === employeePhone;
                const messageClass = isFromEmployee ? 'user-message' : 'admin-message';
                
                messageDiv.className = `message ${messageClass}`;
                messageDiv.style.cssText = `
                    margin: 10px 0;
                    padding: 12px 15px;
                    border-radius: 12px;
                    max-width: 80%;
                    word-wrap: break-word;
                    ${isFromEmployee ? 
                        'background: linear-gradient(45deg, #667eea, #764ba2); color: white; margin-left: auto; text-align: right;' : 
                        'background: rgba(255,255,255,0.1); color: white; margin-right: auto;'
                    }
                `;
                
                const senderName = isFromEmployee ? '–°–æ—Ç—Ä—É–¥–Ω–∏–∫' : '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
                const messageTime = new Date(response.created_at).toLocaleString('ru-RU');
                
                messageDiv.innerHTML = `
                    <div style="font-size: 12px; opacity: 0.7; margin-bottom: 5px;">
                        üë§ ${senderName} ‚Ä¢ ${messageTime}
                    </div>
                    <div>${response.response_text}</div>
                `;
                
                messagesContainer.appendChild(messageDiv);
            });
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        async function openMyIssueDialog(issueId) {
            try {
                currentMyIssueId = issueId;
                
                // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ–∫–Ω–∞
                document.getElementById('app').style.display = 'none';
                document.getElementById('sos-menu-modal').style.display = 'none';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–∏–∞–ª–æ–≥–∞
                document.getElementById('my-issue-dialog-modal').style.display = 'block';
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
                await loadMyIssueDialog(issueId);
                
                // –û—Ç–º–µ—á–∞–µ–º –æ—Ç–≤–µ—Ç—ã –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
                await markResponsesAsRead(issueId);
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
                startDialogAutoRefresh();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–∏–∞–ª–æ–≥–∞:', error);
                tg.showAlert('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–∏–∞–ª–æ–≥–∞ —Å –æ–±—Ä–∞—â–µ–Ω–∏–µ–º');
            }
        }
        
        async function loadMyIssueDialog(issueId) {
            try {
                const container = document.getElementById('my-issue-dialog-content');
                container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∏–∞–ª–æ–≥–∞...</div>';
                
                const response = await fetch(`/api/my-issue/${issueId}/dialog?initData=${encodeURIComponent(tg.initData)}`, {
                    method: 'GET'
                });

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–ª–æ–≥–∞');
                }

                const data = await response.json();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞—â–µ–Ω–∏—è - –µ—Å–ª–∏ –∑–∞–∫—Ä—ã—Ç–æ, –±–ª–æ–∫–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                if (data.issue && data.issue.status === 'closed') {
                    container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">' +
                        '<div style="font-size: 18px; margin-bottom: 10px;">üîí</div>' +
                        '<div>–≠—Ç–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ</div>' +
                        '<div style="font-size: 14px; margin-top: 10px; color: rgba(255,255,255,0.5);">–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∑–∞–∫—Ä—ã—Ç–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ</div>' +
                        '</div>';
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –¥–ª—è –∑–∞–∫—Ä—ã—Ç—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π
                    const inputContainer = document.querySelector('#my-issue-dialog-modal div[style*="position: fixed"]');
                    if (inputContainer) {
                        inputContainer.style.display = 'none';
                    }
                    return;
                }
                
                displayMyIssueDialog(data);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π
                const inputContainer = document.querySelector('#my-issue-dialog-modal div[style*="position: fixed"]');
                if (inputContainer) {
                    inputContainer.style.display = 'block';
                }
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—á–µ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —É–º–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                currentDialogMessagesCount = data.responses ? data.responses.length : 0;
                lastDialogData = data;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–ª–æ–≥–∞:', error);
                document.getElementById('my-issue-dialog-content').innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–ª–æ–≥–∞</div>';
            }
        }
        
        function displayMyIssueDialog(data) {
            const container = document.getElementById('my-issue-dialog-content');
            const issue = data.issue;
            const responses = data.responses || [];
            
            let html = '<div style="margin-bottom: 20px;">';
            
            // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–±—Ä–∞—â–µ–Ω–∏–∏
            const typeIcon = issue.type === 'personal' ? 'üíî' : 'üñ•';
            const typeText = issue.type === 'personal' ? '–õ–∏—á–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞' : '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞';
            const anonymityText = issue.is_anonymous ? ` (${issue.pseudonym || '–ê–Ω–æ–Ω–∏–º–Ω–æ'})` : '';
            
            html += '<div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">';
            html += '<div style="font-weight: bold; margin-bottom: 10px;">' + typeIcon + ' –û–±—Ä–∞—â–µ–Ω–∏–µ #' + issue.id + anonymityText + '</div>';
            html += '<div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-bottom: 5px;">' + typeText + '</div>';
            html += '<div style="font-size: 14px; margin-bottom: 8px;">' + issue.description + '</div>';
            html += '<div style="font-size: 12px; color: rgba(255,255,255,0.6);">–°–æ–∑–¥–∞–Ω–æ: ' + new Date(issue.created_at).toLocaleString('ru-RU') + '</div>';
            html += '</div>';
            
            // –ò—Å—Ç–æ—Ä–∏—è –æ—Ç–≤–µ—Ç–æ–≤
            if (responses.length > 0) {
                html += '<div class="dialog-messages" style="margin-bottom: 20px; max-height: 300px; overflow-y: auto;">';
                html += '<div style="font-weight: bold; margin-bottom: 15px;">–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞:</div>';
                
                responses.forEach(response => {
                    const isAdmin = response.responder_phone === 'admin';
                    const bgColor = isAdmin ? 'rgba(46, 213, 115, 0.2)' : 'rgba(255, 255, 255, 0.1)';
                    const align = isAdmin ? 'margin-left: 20px;' : 'margin-right: 20px;';
                    
                    html += '<div style="background: ' + bgColor + '; padding: 12px; border-radius: 8px; margin-bottom: 10px; ' + align + '">';
                    html += '<div style="font-size: 14px; margin-bottom: 5px;">' + response.response_text + '</div>';
                    html += '<div style="font-size: 11px; color: rgba(255,255,255,0.6); text-align: right;">';
                    html += (isAdmin ? 'üë®‚Äçüíº –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : 'üë§ –í—ã') + ' ‚Ä¢ ' + new Date(response.created_at).toLocaleString('ru-RU');
                    html += '</div>';
                    html += '</div>';
                });
                
                html += '</div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑ –∫ –ø–æ—Å–ª–µ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏—è–º
            setTimeout(() => {
                const scrollableContainer = document.getElementById('my-issue-dialog-scroll');
                if (scrollableContainer) {
                    console.log('–ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–Ω–∏–∑');
                    scrollableContainer.scrollTop = scrollableContainer.scrollHeight;
                } else {
                    console.log('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä my-issue-dialog-scroll –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }
            }, 100);
        }
        
        async function sendMyResponse() {
            try {
                const input = document.getElementById('my-response-input');
                const responseText = input.value.trim();
                
                if (!responseText) {
                    tg.showAlert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞');
                    return;
                }
                
                const response = await fetch(`/api/my-issue/${currentMyIssueId}/respond`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        response_text: responseText
                    })
                });

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞');
                }

                // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –¥–∏–∞–ª–æ–≥ –ª–æ–∫–∞–ª—å–Ω–æ
                addMessageToDialog(responseText, true, true);
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                input.value = '';
                
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π (–¥–æ–±–∞–≤–∏–ª–∏ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
                currentDialogMessagesCount++;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞:', error);
                tg.showAlert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞');
            }
        }
        
        function handleMyResponseEnterKey(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendMyResponse();
            }
        }
        
        
        async function showIssueChat(issueId) {
            try {
                currentIssueId = issueId;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —á–∞—Ç–∞
                const response = await fetch(`/api/issue-chat/${issueId}?initData=${encodeURIComponent(tg.initData)}`, {
                    method: 'GET'
                });

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞');
                }

                const chatData = await response.json();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞
                document.getElementById('app').style.display = 'none';
                document.getElementById('work-mode-modal').style.display = 'none';
                document.getElementById('absence-modal').style.display = 'none';
                document.getElementById('sos-modal').style.display = 'none';
                document.getElementById('sos-menu-modal').style.display = 'none';
                document.getElementById('sick-leave-modal').style.display = 'none';
                document.getElementById('issue-chat-modal').style.display = 'block';
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–±—Ä–∞—â–µ–Ω–∏–∏
                const issue = chatData.issue;
                document.getElementById('chat-title').textContent = `üí¨ –û–±—Ä–∞—â–µ–Ω–∏–µ #${issue.id}`;
                
                let issueTypeText = issue.type === 'personal' ? 'üíî –õ–∏—á–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞' : 'üñ• –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞';
                if (issue.is_anonymous) {
                    issueTypeText += ' (–∞–Ω–æ–Ω–∏–º–Ω–æ)';
                    if (issue.pseudonym) {
                        issueTypeText += ` - ${issue.pseudonym}`;
                    }
                }
                
                document.getElementById('issue-title').textContent = issueTypeText;
                document.getElementById('issue-description').textContent = issue.description;
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
                displayChatMessages(chatData.messages);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞—â–µ–Ω–∏—è
                if (issue.status === 'closed') {
                    // –û–±—Ä–∞—â–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ - —Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                    document.getElementById('chat-input-area').style.display = 'none';
                    document.getElementById('chat-closed-message').style.display = 'block';
                } else {
                    // –û–±—Ä–∞—â–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                    document.getElementById('chat-input-area').style.display = 'flex';
                    document.getElementById('chat-closed-message').style.display = 'none';
                    
                    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞
                    if (chatRefreshInterval) {
                        clearInterval(chatRefreshInterval);
                    }
                    chatRefreshInterval = setInterval(() => {
                        refreshChat();
                    }, 3000); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                tg.showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞');
            }
        }
        
        function displayChatMessages(messages) {
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = '';
            
            messages.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.style.marginBottom = '15px';
                
                const isFromAdmin = message.from_admin;
                const alignment = isFromAdmin ? 'left' : 'right';
                const bgColor = isFromAdmin ? 'rgba(74, 144, 226, 0.3)' : 'rgba(76, 205, 196, 0.3)';
                const textAlign = isFromAdmin ? 'left' : 'right';
                
                messageDiv.innerHTML = `
                    <div style="text-align: ${textAlign};">
                        <div style="display: inline-block; max-width: 70%; padding: 10px 15px; background: ${bgColor}; border-radius: 12px; text-align: left;">
                            <div style="font-weight: bold; margin-bottom: 5px; color: rgba(255,255,255,0.8); font-size: 12px;">
                                ${isFromAdmin ? 'üë®‚Äçüíº –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : 'üë§ –í—ã'}
                            </div>
                            <div style="color: white;">
                                ${message.text}
                            </div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 5px;">
                                ${new Date(message.timestamp).toLocaleString('ru-RU')}
                            </div>
                        </div>
                    </div>
                `;
                
                messagesContainer.appendChild(messageDiv);
            });
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        async function refreshChat() {
            if (!currentIssueId) return;
            
            try {
                const response = await fetch(`/api/issue-chat/${currentIssueId}?initData=${encodeURIComponent(tg.initData)}`, {
                    method: 'GET'
                });

                if (response.ok) {
                    const chatData = await response.json();
                    displayChatMessages(chatData.messages);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–∞—Ç–∞:', error);
            }
        }
        
        async function sendChatMessage() {
            if (!currentIssueId) return;
            
            const messageInput = document.getElementById('chat-message-input');
            const messageText = messageInput.value.trim();
            
            if (!messageText) {
                tg.showAlert('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
                return;
            }
            
            try {
                const response = await fetch(`/api/issue-chat/${currentIssueId}/message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        message: messageText
                    })
                });

                if (response.ok) {
                    messageInput.value = '';
                    // –û–±–Ω–æ–≤–ª—è–µ–º —á–∞—Ç
                    await refreshChat();
                } else {
                    const result = await response.json();
                    tg.showAlert('–û—à–∏–±–∫–∞: ' + result.error);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                tg.showAlert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è');
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–µ—à–∞
        if (window.performance && window.performance.navigation.type === 1) {
            // –°—Ç—Ä–∞–Ω–∏—Ü–∞ –±—ã–ª–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω–∞ - –æ—á–∏—â–∞–µ–º –∫–µ—à
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                });
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –¥–∏–∑–∞–π–Ω–∞ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                const indicator = document.getElementById('design-indicator');
                if (indicator) {
                    indicator.style.opacity = '0';
                    indicator.style.transition = 'opacity 0.5s ease';
                    setTimeout(() => indicator.style.display = 'none', 500);
                }
            }, 3000);
            const messageInput = document.getElementById('chat-message-input');
            if (messageInput) {
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendChatMessage();
                    }
                });
            }
            
            // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω—ã
            // checkNewResponsesOnLoad();
            // setInterval(checkNewResponsesOnLoad, 30000);
        });
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        async function checkNewResponsesOnLoad() {
            try {
                console.log('–ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã...');
                const response = await fetch(`/api/check-new-responses?initData=${encodeURIComponent(tg.initData)}`, {
                    method: 'GET'
                });

                if (!response.ok) {
                    console.log('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤:', response.status);
                    return; // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å
                }

                const data = await response.json();
                console.log('–û—Ç–≤–µ—Ç API check-new-responses:', data);
                
                if (data.success && data.total_count > 0) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º popup —Å –Ω–æ–≤—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏
                    let message;
                    
                    if (data.issues_with_new_responses.length === 1) {
                        // –û–¥–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ
                        const issue = data.issues_with_new_responses[0];
                        const typeIcon = issue.issue_type === 'personal' ? 'üíî' : 'üñ•';
                        message = `${typeIcon} –û–±—Ä–∞—â–µ–Ω–∏–µ #${issue.issue_id}\n`;
                        message += `${issue.description}\n\n`;
                        message += `–ù–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: ${issue.new_responses_count}`;
                    } else {
                        // –ù–µ—Å–∫–æ–ª—å–∫–æ –æ–±—Ä–∞—â–µ–Ω–∏–π
                        message = `–£ –≤–∞—Å ${data.total_count} –Ω–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –æ–±—Ä–∞—â–µ–Ω–∏—è:\n\n`;
                        
                        data.issues_with_new_responses.forEach(issue => {
                            const typeIcon = issue.issue_type === 'personal' ? 'üíî' : 'üñ•';
                            message += `${typeIcon} –û–±—Ä–∞—â–µ–Ω–∏–µ #${issue.issue_id}\n`;
                            message += `${issue.description}\n`;
                            message += `–ù–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: ${issue.new_responses_count}\n\n`;
                        });
                    }
                    
                    const buttonText = data.issues_with_new_responses.length === 1 ? '–û—Ç–∫—Ä—ã—Ç—å –¥–∏–∞–ª–æ–≥' : '–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ';
                    
                    tg.showPopup({
                        title: 'üì© –ù–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã!',
                        message: message,
                        buttons: [
                            {id: 'view', type: 'default', text: buttonText},
                            {id: 'later', type: 'cancel', text: '–ü–æ–∑–∂–µ'}
                        ]
                    }, function(buttonId) {
                        if (buttonId === 'view') {
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                            const isAdmin = currentUserData && currentUserData.user && currentUserData.user.is_admin;
                            
                            if (isAdmin) {
                                // –ê–¥–º–∏–Ω –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏
                                if (data.issues_with_new_responses.length === 1) {
                                    const issueId = data.issues_with_new_responses[0].issue_id;
                                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ –¥–∏–∞–ª–æ–≥ –æ—Ç–∫—Ä—ã—Ç –∏–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                                    dialogOpenedFromNotification = true;
                                    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –∞–¥–º–∏–Ω—Å–∫–∏–π –¥–∏–∞–ª–æ–≥
                                    openIssueDialog(issueId);
                                } else {
                                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏
                                    showIssuesManagement();
                                }
                            } else {
                                // –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Å–≤–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è
                                if (data.issues_with_new_responses.length === 1) {
                                    const issueId = data.issues_with_new_responses[0].issue_id;
                                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ –¥–∏–∞–ª–æ–≥ –æ—Ç–∫—Ä—ã—Ç –∏–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                                    dialogOpenedFromNotification = true;
                                    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –¥–∏–∞–ª–æ–≥
                                    openMyIssueDialog(issueId);
                                } else {
                                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ "–ú–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è"
                                    showSosMenuModal();
                                }
                            }
                        }
                    });
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤:', error);
                // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            }
        }
        
        // –û—Ç–º–µ—Ç–∏—Ç—å –æ—Ç–≤–µ—Ç—ã –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
        async function markResponsesAsRead(issueId) {
            try {
                console.log('–û—Ç–º–µ—á–∞–µ–º –æ—Ç–≤–µ—Ç—ã –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏—è:', issueId);
                const response = await fetch(`/api/mark-responses-read/${issueId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData
                    })
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ—Ç–∫–∏ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ:', error);
            }
        }
        
        function closeMyIssueDialog() {
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
            stopDialogAutoRefresh();
            
            // –°–∫—Ä—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥
            document.getElementById('my-issue-dialog-modal').style.display = 'none';
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –æ—Ç–≤–µ—Ç–∞
            const responseInput = document.getElementById('my-response-input');
            if (responseInput) {
                responseInput.value = '';
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–∫—É–¥–∞ –±—ã–ª –æ—Ç–∫—Ä—ã—Ç –¥–∏–∞–ª–æ–≥
            if (dialogOpenedFromNotification) {
                // –ï—Å–ª–∏ –∏–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –≥–ª–∞–≤–Ω–æ–º—É —ç–∫—Ä–∞–Ω—É
                dialogOpenedFromNotification = false;
                showMainApp();
            } else {
                // –ï—Å–ª–∏ –∏–∑ —Å–ø–∏—Å–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Å–ø–∏—Å–∫—É
                showSosMenuModal();
            }
        }
        
        function closeIssueDialog() {
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
            stopDialogAutoRefresh();
            
            // –°–∫—Ä—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥
            document.getElementById('issue-dialog-modal').style.display = 'none';
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –æ—Ç–≤–µ—Ç–∞
            const responseInput = document.getElementById('admin-response-input');
            if (responseInput) {
                responseInput.value = '';
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–∫—É–¥–∞ –±—ã–ª –æ—Ç–∫—Ä—ã—Ç –¥–∏–∞–ª–æ–≥
            if (dialogOpenedFromNotification) {
                // –ï—Å–ª–∏ –∏–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –≥–ª–∞–≤–Ω–æ–º—É —ç–∫—Ä–∞–Ω—É
                dialogOpenedFromNotification = false;
                showMainApp();
            } else {
                // –ï—Å–ª–∏ –∏–∑ —Å–ø–∏—Å–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Å–ø–∏—Å–∫—É
                showIssuesManagement();
            }
        }

        function showSosMenuModal() {
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
            stopDialogAutoRefresh();
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ–∫–Ω–∞
            document.getElementById('app').style.display = 'none';
            document.getElementById('sos-modal').style.display = 'none';
            document.getElementById('my-issue-dialog-modal').style.display = 'none';
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –æ—Ç–≤–µ—Ç–∞
            const responseInput = document.getElementById('my-response-input');
            if (responseInput) {
                responseInput.value = '';
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º SOS –º–µ–Ω—é "–ú–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è"
            document.getElementById('sos-menu-modal').style.display = 'block';
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –æ–±—Ä–∞—â–µ–Ω–∏–π
            loadMyIssues();
        }
        
        function showMainApp() {
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
            stopDialogAutoRefresh();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
            const modals = [
                'work-mode-modal', 'absence-modal', 'sos-modal', 'sos-menu-modal',
                'sick-leave-modal', 'issue-chat-modal', 'admin-menu-modal'
            ];
            
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal && modal.style.display !== 'none') {
                    modal.classList.add('animate-slide-out');
                    setTimeout(() => {
                        modal.style.display = 'none';
                        modal.classList.remove('animate-slide-out');
                    }, 300);
                } else if (modal) {
                    modal.style.display = 'none';
                }
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
            const app = document.getElementById('app');
            app.style.display = 'block';
            app.classList.add('animate-fade-in');
            document.getElementById('employees-management-modal').style.display = 'none';
            document.getElementById('issues-management-modal').style.display = 'none';
            document.getElementById('broadcast-modal').style.display = 'none';
            document.getElementById('add-employee-modal').style.display = 'none';
            document.getElementById('edit-employee-modal').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞
            if (chatRefreshInterval) {
                clearInterval(chatRefreshInterval);
                chatRefreshInterval = null;
            }
            currentIssueId = null;
            
            // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã
            selectedMode = null;
            selectedPeriod = null;
            document.getElementById('period-section').style.display = 'none';
            document.getElementById('work-periods').style.display = 'none';
            document.getElementById('custom-period').style.display = 'none';
            document.getElementById('confirmation-section').style.display = 'none';
            
            // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è
            selectedAbsenceDate = null;
            selectedAbsenceTime = null;
            customAbsenceDate = null;
            customAbsenceStartTime = null;
            customAbsenceEndTime = null;
            
            // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è SOS
            selectedIssueType = null;
            selectedAnonymity = null;
            sosPseudonym = null;
            sosDescription = null;
            
            // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–æ–ª—å–Ω–∏—á–Ω–æ–≥–æ
            selectedLeaveType = null;
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadUserData();

        // –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω
        (function(){
            function applyCompact() {
                const w = window.innerWidth; 
                const h = window.innerHeight;
                // –£–±–∏—Ä–∞–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º - –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—ã–π —Ä–∞–∑–º–µ—Ä
                const compact = false;
                document.body.classList.toggle('compact', compact);
                document.documentElement.style.setProperty('--vh', `${h * 0.01}px`);
            }
            window.addEventListener('resize', applyCompact, { passive: true });
            applyCompact();
        })();
    </script>
</body>
</html>
