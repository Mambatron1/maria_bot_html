<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="cache-control" content="no-cache">
    <meta name="cache-bust" content="nbtender-fixed-v2">
    <meta name="version" content="nbtender-fixed-2024">
    <title>NBtender — Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // Принудительная очистка всех видов кеша
        (function() {
            // Очистка localStorage
            try { localStorage.clear(); } catch(e) {}
            
            // Очистка sessionStorage  
            try { sessionStorage.clear(); } catch(e) {}
            
            // Очистка Service Worker кеша
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    for(let registration of registrations) {
                        registration.unregister();
                    }
                });
            }
             
            // Очистка Cache API
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    for (let name of names) {
                        caches.delete(name);
                    }
                });
            }
            
            // Принудительная перезагрузка стилей
            const timestamp = new Date().getTime();
            const links = document.querySelectorAll('link[rel="stylesheet"]');
            links.forEach(link => {
                const href = link.href.split('?')[0];
                link.href = href + '?v=' + timestamp;
            });
        })();
    </script>
    <style>
        :root {
            --bg: #eff6ff;
            --ink: #0f172a;
            --muted: #64748b;
            --graphite-700: #474A51;
            --navy-700: #1e3a5f;
            --navy-600: #274b7a;
            --accent: #4338ca;
            --danger: #ef4444;

            --fs-base: 16px;
            --btn-h: 52px;
            --radius: 14px;
            --pad: 16px;
            --dot: 8px;

            --shadow: 0 6px 18px rgba(2, 6, 23, .12);
            --shadow-strong: 0 10px 26px rgba(2, 6, 23, .18);
        }

        body { 
            margin: 0; 
            font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; 
            background: #eff6ff; 
            color: var(--ink); 
            font-size: var(--fs-base); 
            min-height: 100vh;
        }

        .wrap { 
            max-width: 440px; 
            margin: 0 auto; 
            padding: var(--pad) var(--pad) var(--pad); 
            box-sizing: border-box; 
            min-height: 100vh;
        }

        header { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            margin-bottom: 8px; 
        }

        .avatar { 
            width: 44px; 
            height: 44px; 
            border-radius: 50%; 
            background: #d1d5db; 
            overflow: hidden; 
        }

        .title { 
            font-weight: 700; 
            font-size: 17px; 
        }

        .subtitle { 
            font-size: 12px; 
            color: var(--muted); 
        }

        .stack { 
            display: grid; 
            gap: 10px; 
            margin: 8px 0 16px; 
        }

        .card { 
            background: var(--graphite-700); 
            color: #f1f5f9; 
            border-radius: var(--radius); 
            padding: 12px 14px; 
            box-shadow: var(--shadow); 
        }

        .card h3 { 
            margin: 0 0 4px; 
            font-size: 14px; 
            font-weight: 800; 
            letter-spacing: .2px; 
        }

        .card p { 
            margin: 0; 
            font-size: 13px; 
            color: #cbd5e1; 
        }

        .actions { 
            display: grid; 
            gap: 12px; 
        }

        .btn { 
            position: relative; 
            height: var(--btn-h); 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px;
            border: 0; 
            border-radius: var(--radius); 
            background: var(--navy-700); 
            color: #eef2ff; 
            font-size: 15px; 
            font-weight: 700; 
            box-shadow: var(--shadow); 
            cursor: pointer; 
            padding: 0 16px; 
            text-align: center;
            min-width: 280px;
            max-width: 350px;
            width: 100%;
            box-sizing: border-box;
        }

        .btn:after { 
            content:""; 
            position:absolute; 
            inset:0; 
            border-radius: inherit; 
            pointer-events:none;
            background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,0) 40%); 
        }

        .btn:hover { 
            background: var(--navy-600); 
            box-shadow: var(--shadow-strong); 
        }

        .btn:active { 
            transform: translateY(1px); 
        }

        .dot { 
            display:inline-block; 
            width: var(--dot); 
            height: var(--dot); 
            border-radius: 50%; 
        }

        .dot-holiday{ background:#f59e0b; }
        .dot-mode{ background:#10b981; }
        .dot-absence{ background:#ef4444; }
        .dot-sick{ background:#8b5cf6; }
        .dot-crocotime{ background:#eab308; }

        .btn-accent { 
            background: var(--accent); 
        }

        /* SOS кнопка в общем стиле - как все остальные */

        .footer { 
            text-align:center; 
            margin-top: 10px; 
            color:#94a3b8; 
            font-size:12px; 
        }

        .compact .wrap { 
            padding: var(--pad) var(--pad) 96px; 
        }

        .compact .card { 
            padding: 12px 14px; 
        }

        .compact .btn { 
            height: var(--btn-h); 
            font-size: 15px; 
        }

        .compact .title { 
            font-size: 17px; 
        }

        .compact header { 
            gap: 12px; 
        }

        .compact .avatar { 
            width: 44px; 
            height: 44px; 
        }

        /* Modal styles for back buttons */
        .back-button {
            background: none;
            border: none;
            color: var(--ink);
            font-size: 24px;
            padding: 8px;
            cursor: pointer;
            border-radius: var(--radius);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        .back-button:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .back-button:active {
            background: rgba(0, 0, 0, 0.1);
            transform: scale(0.95);
        }

        .modal-header {
            display: flex;
            align-items: center;
            padding: 16px;
            background: var(--bg);
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .modal-title {
            flex: 1;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            color: var(--ink);
            margin: 0;
        }

        .modal-content {
            background: var(--bg);
            min-height: 100vh;
            padding-bottom: 100px;
        }

        /* Главное меню - голубой фон на весь экран */
        #app {
            background: #eff6ff;
            min-height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
        }

        /* Модальные окна - голубой фон и фиксированная структура */
        #work-mode-modal,
        #absence-modal, 
        #sick-leave-modal,
        #admin-menu-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #eff6ff;
            z-index: 1000;
            overflow-y: auto;
        }

        /* Все модальные окна имеют одинаковую структуру */
        #work-mode-modal .wrap,
        #absence-modal .wrap,
        #sick-leave-modal .wrap,
        #admin-menu-modal .wrap {
            max-width: 440px;
            margin: 0 auto;
            padding: var(--pad) var(--pad) var(--pad);
            box-sizing: border-box;
            min-height: 100vh;
        }

        /* Все кнопки одинаковой ширины - уже в основном правиле .btn */
        
        /* Контейнеры кнопок - центрированные */
        .actions {
            display: grid;
            gap: 12px;
            justify-items: center;
        }
    </style>
</head>
<body>
    <!-- Индикатор версии для провери -->
    <div style="position: fixed; top: 10px; right: 10px; background: var(--accent); color: white; padding: 4px 8px; border-radius: 8px; font-size: 10px; z-index: 9999;">
        NBtender COLORED CARDS
    </div>
    
    <div class="wrap">
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Загружаем ваш профиль...</p>
        </div>

        <div id="error" class="error" style="display: none;">
            <p>Произошла ошибка при загрузке данных</p>
        </div>

        <div id="app" style="display: none;">
            <header>
                <div class="avatar" id="avatar"></div>
                <div>
                    <div class="title">Привет, <span id="name">Aleksei</span></div>
                    <div class="subtitle">Пользователь</div>
                </div>
            </header>

            <div class="stack">
                <div class="card" style="background: #065f46;"><h3>Сегодня</h3><p id="today-status">Удалённая работа</p></div>
                <div class="card" style="background: #ea580c;"><h3>Следующий отпуск</h3><p id="next-vacation">Отпуск не запланирован</p></div>
                <div class="card" style="background: #3730a3;"><h3>В этот день</h3><p id="today-message">Добро пожаловать в Maria Bot!</p></div>
            </div>

            <div class="actions">
                <button class="btn" onclick="handleAction('vacation')"><span class="dot dot-holiday"></span><span>Мой отпуск</span></button>
                <button class="btn" onclick="handleAction('work_mode')"><span class="dot dot-mode"></span><span>Режим работы</span></button>
                <button class="btn" onclick="handleAction('absence')"><span class="dot dot-absence"></span><span>Отсутствие</span></button>
                <button class="btn" onclick="handleAction('sick_leave')"><span class="dot dot-sick"></span><span>Больничный</span></button>
                <button class="btn" onclick="handleAction('crocotime')"><span class="dot dot-crocotime"></span><span>Мой Crocotime</span></button>
                <button class="btn" onclick="handleAction('sos')"><span class="dot dot-absence"></span><span>Нужна помощь</span></button>
                <button class="btn btn-accent" id="admin-btn" onclick="handleAction('admin')" style="display: none;">Меню администратора</button>
            </div>
            <div class="footer">@NBtender_bot</div>
        </div>

        <!-- Work Mode Modal -->
        <div id="work-mode-modal" style="display: none;">
            <div class="wrap">
                <header style="margin-bottom: 20px;">
                    <button onclick="showMainApp()" class="back-button" style="background: none; border: none; color: var(--ink); font-size: 24px; padding: 8px; cursor: pointer; border-radius: var(--radius);">←</button>
                    <div style="flex: 1; text-align: center;">
                        <div class="title" style="margin: 0;">Режим работы</div>
                    </div>
                    <div style="width: 40px;"></div>
                </header>

                <div class="stack" style="margin-bottom: 20px;">
                    <div class="card">
                        <h3>Выберите режим работы</h3>
                        <p>Установите ваш текущий режим работы</p>
                    </div>
                </div>

                <div id="work-modes" class="actions">
                    <!-- Режимы работы будут загружены динамически -->
                </div>

                <div id="period-section" class="stack" style="display: none; margin-top: 20px;">
                    <div class="card">
                        <h3>Выберите период</h3>
                        <p>Укажите период действия режима</p>
                    </div>
                </div>

                <div id="work-periods" class="actions" style="display: none;">
                    <!-- Периоды будут загружены динамически -->
                </div>

                <div id="custom-period" class="stack" style="display: none; margin-top: 20px;">
                    <div class="card">
                        <h3>Укажите период</h3>
                        <div style="margin-top: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 14px;">Дата начала:</label>
                            <input type="date" id="start-date" style="width: 100%; padding: 12px; border-radius: var(--radius); border: 1px solid #4a5568; background: #2d3748; color: #e2e8f0; margin-bottom: 15px; font-size: 14px;">
                            
                            <label style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 14px;">Дата окончания:</label>
                            <input type="date" id="end-date" style="width: 100%; padding: 12px; border-radius: var(--radius); border: 1px solid #4a5568; background: #2d3748; color: #e2e8f0; margin-bottom: 20px; font-size: 14px;">
                        </div>
                    </div>
                    <button onclick="submitWorkMode()" class="btn btn-accent" style="width: 100%;">
                        <span>✅ Подтвердить</span>
                    </button>
                </div>

                <div id="confirmation-section" class="stack" style="display: none; margin-top: 20px;">
                    <div class="card">
                        <h3>Подтверждение</h3>
                        <p id="confirmation-text"><!-- Текст подтверждения --></p>
                    </div>
                    <div class="actions">
                        <button onclick="confirmWorkMode()" class="btn btn-accent">
                            <span>✅ Подтвердить</span>
                        </button>
                        <button onclick="showMainApp()" class="btn" style="background: var(--muted);">
                            <span>❌ Отменить</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Absence Modal -->
        <div id="absence-modal" style="display: none;">
            <div class="wrap">
                <header style="margin-bottom: 20px;">
                    <button onclick="showMainApp()" class="back-button" style="background: none; border: none; color: var(--ink); font-size: 24px; padding: 8px; cursor: pointer; border-radius: var(--radius);">←</button>
                    <div style="flex: 1; text-align: center;">
                        <div class="title" style="margin: 0;">Отсутствие</div>
                    </div>
                    <div style="width: 40px;"></div>
                </header>

                <div class="stack" style="margin-bottom: 20px;">
                    <div class="card" style="background: var(--danger); color: white;">
                        <h3>⚠️ Важно!</h3>
                        <p><strong>СНАЧАЛА СОГЛАСУЙ С РУКОВОДИТЕЛЕМ, ЧТОБЫ ОН ЗНАЛ, ЧТО ТЫ ОТСУТСТВУЕШЬ!</strong></p>
                    </div>

                    <div class="card" id="absence-date-section">
                        <h3>Выберите дату</h3>
                        <p>Укажите дату вашего отсутствия</p>
                    </div>
                </div>

                <div id="absence-dates" class="actions">
                    <!-- Даты будут загружены динамически -->
                </div>

                <div class="info-card" id="absence-time-section" style="display: none;">
                    <div class="card-header">
                        <span class="card-icon">⏰</span>
                        <span class="card-title">Выберите время</span>
                    </div>
                </div>

                <div id="absence-times" class="action-buttons" style="display: none;">
                    <!-- Времена будут загружены динамически -->
                </div>

                <div id="absence-custom-date" style="display: none; margin-top: 20px;">
                    <div class="info-card">
                        <div class="card-header">
                            <span class="card-icon">📅</span>
                            <span class="card-title">Укажите дату</span>
                        </div>
                        <div style="margin-top: 15px;">
                            <input type="date" id="absence-date" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; margin-bottom: 15px;">
                            
                            <button onclick="selectAbsenceCustomDate()" style="width: 100%; padding: 15px; background: linear-gradient(45deg, #4ecdc4, #44a08d); border: none; border-radius: 8px; color: white; font-weight: bold;">
                                ✅ Подтвердить
                            </button>
                        </div>
                    </div>
                </div>

                <div id="absence-custom-time" style="display: none; margin-top: 20px;">
                    <div class="info-card">
                        <div class="card-header">
                            <span class="card-icon">⏰</span>
                            <span class="card-title">Укажите время</span>
                        </div>
                        <div style="margin-top: 15px;">
                            <label style="display: block; margin-bottom: 10px; color: rgba(255,255,255,0.8);">Время начала:</label>
                            <input type="time" id="absence-start-time" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; margin-bottom: 15px;">
                            
                            <label style="display: block; margin-bottom: 10px; color: rgba(255,255,255,0.8);">Время окончания:</label>
                            <input type="time" id="absence-end-time" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; margin-bottom: 15px;">
                            
                            <button onclick="submitAbsence()" style="width: 100%; padding: 15px; background: linear-gradient(45deg, #4ecdc4, #44a08d); border: none; border-radius: 8px; color: white; font-weight: bold;">
                                ✅ Подтвердить
                            </button>
                        </div>
                    </div>
                </div>

                <div id="absence-confirmation-section" style="display: none;">
                    <div class="info-card">
                        <div class="card-header">
                            <span class="card-icon">✅</span>
                            <span class="card-title">Подтверждение</span>
                        </div>
                        <div class="card-content" id="absence-confirmation-text">
                            <!-- Текст подтверждения -->
                        </div>
                        <div style="margin-top: 15px;">
                            <button onclick="submitAbsence()" style="width: 100%; padding: 15px; background: linear-gradient(45deg, #4ecdc4, #44a08d); border: none; border-radius: 8px; color: white; font-weight: bold; margin-bottom: 10px;">
                                ✅ Подтвердить
                            </button>
                            <button onclick="showMainApp()" style="width: 100%; padding: 15px; background: rgba(255,255,255,0.2); border: none; border-radius: 8px; color: white; font-weight: bold;">
                                ❌ Отменить
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SOS Modal -->
        <div id="sos-modal" class="modal-content" style="display: none;">
            <div class="modal-header">
                <button onclick="showMainApp()" class="back-button">←</button>
                <h2 class="modal-title">SOS - Сообщить о проблеме</h2>
                <div style="width: 40px;"></div> <!-- spacer for centering -->
            </div>

            <div class="info-cards">
                <div class="info-card">
                    <div class="card-header">
                        <span class="card-icon">⚡</span>
                        <span class="card-title">Выберите тип проблемы</span>
                    </div>
                </div>

                <div id="sos-issue-types" class="action-buttons">
                    <!-- Типы проблем будут загружены динамически -->
                </div>

                <!-- Кнопка "Мои обращения" -->
                <div class="info-card" style="margin-top: 20px;">
                    <button onclick="showSosMenuModal()" class="action-button" style="width: 100%; padding: 15px; background: linear-gradient(45deg, #667eea, #764ba2); border: none; border-radius: 8px; color: white; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span style="font-size: 20px;">📋</span>
                        <span>Мои обращения</span>
                    </button>
                </div>

                <div class="info-card" id="sos-anonymity-section" style="display: none;">
                    <div class="card-header">
                        <span class="card-icon">🕵️</span>
                        <span class="card-title">Как вы хотите обратиться?</span>
                    </div>
                </div>

                <div id="sos-anonymity-options" class="action-buttons" style="display: none;">
                    <!-- Опции анонимности будут загружены динамически -->
                </div>

                <div id="sos-pseudonym-section" style="display: none; margin-top: 20px;">
                    <div class="info-card">
                        <div class="card-header">
                            <span class="card-icon">🎭</span>
                            <span class="card-title">Укажите псевдоним</span>
                        </div>
                        <div style="margin-top: 15px;">
                            <input type="text" id="sos-pseudonym" placeholder="Введите псевдоним" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; margin-bottom: 15px;">
                            
                            <button onclick="selectSosPseudonym()" style="width: 100%; padding: 15px; background: linear-gradient(45deg, #4ecdc4, #44a08d); border: none; border-radius: 8px; color: white; font-weight: bold;">
                                ✅ Продолжить
                            </button>
                        </div>
                    </div>
                </div>

                <div id="sos-description-section" style="display: none; margin-top: 20px;">
                    <div class="info-card">
                        <div class="card-header">
                            <span class="card-icon">📝</span>
                            <span class="card-title">Опишите проблему</span>
                        </div>
                        <div style="margin-top: 15px;">
                            <textarea id="sos-description" placeholder="Подробно опишите вашу проблему (минимум 10 символов)" style="width: 100%; height: 120px; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; margin-bottom: 15px; resize: vertical; font-family: inherit;"></textarea>
                            
                            <button onclick="submitSos()" style="width: 100%; padding: 15px; background: linear-gradient(45deg, #ff4757, #ff3742); border: none; border-radius: 8px; color: white; font-weight: bold;">
                                🚨 ОТПРАВИТЬ SOS
                            </button>
                        </div>
                    </div>
                </div>

                <div id="sos-confirmation-section" style="display: none;">
                    <div class="info-card">
                        <div class="card-header">
                            <span class="card-icon">✅</span>
                            <span class="card-title">Подтверждение</span>
                        </div>
                        <div class="card-content" id="sos-confirmation-text">
                            <!-- Текст подтверждения -->
                        </div>
                        <div style="margin-top: 15px;">
                            <button onclick="submitSos()" style="width: 100%; padding: 15px; background: linear-gradient(45deg, #ff4757, #ff3742); border: none; border-radius: 8px; color: white; font-weight: bold; margin-bottom: 10px;">
                                🚨 ОТПРАВИТЬ SOS
                            </button>
                            <button onclick="showMainApp()" style="width: 100%; padding: 15px; background: rgba(255,255,255,0.2); border: none; border-radius: 8px; color: white; font-weight: bold;">
                                ❌ Отменить
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sick Leave Modal -->
        <div id="sick-leave-modal" style="display: none;">
            <div class="wrap">
                <header style="margin-bottom: 20px;">
                    <button onclick="showMainApp()" class="back-button" style="background: none; border: none; color: var(--ink); font-size: 24px; padding: 8px; cursor: pointer; border-radius: var(--radius);">←</button>
                    <div style="flex: 1; text-align: center;">
                        <div class="title" style="margin: 0;">🏥 Больничный лист</div>
                    </div>
                    <div style="width: 40px;"></div>
                </header>

                <div class="stack" style="margin-bottom: 20px;">
                    <div class="card" style="background: #8b5cf6; color: white;">
                        <h3>😔 Мне очень жаль, что ты заболел(а)</h3>
                        <p>Давай внесем данные по больничному листу (ЭЛН)</p>
                    </div>

                    <div class="card">
                        <h3>Выберите тип больничного</h3>
                        <p>Укажите тип вашего больничного листа</p>
                    </div>
                </div>

                <div id="sick-leave-types" class="actions">
                    <!-- Типы больничного будут загружены динамически -->
                </div>

                <div id="sick-leave-form-section" class="stack" style="display: none; margin-top: 20px;">
                    <div class="card">
                        <h3>📝 Данные больничного</h3>
                        <div style="margin-top: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 14px;">Номер ЭЛН:</label>
                            <input type="text" id="sick-leave-number" placeholder="Введите номер электронного листка нетрудоспособности" style="width: 100%; padding: 12px; border-radius: var(--radius); border: 1px solid #4a5568; background: #2d3748; color: #e2e8f0; margin-bottom: 15px; font-size: 14px;">
                            
                            <label style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 14px;">Дата начала:</label>
                            <input type="date" id="sick-leave-start-date" style="width: 100%; padding: 12px; border-radius: var(--radius); border: 1px solid #4a5568; background: #2d3748; color: #e2e8f0; margin-bottom: 15px; font-size: 14px;">
                            
                            <label style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 14px;">Дата окончания:</label>
                            <input type="date" id="sick-leave-end-date" style="width: 100%; padding: 12px; border-radius: var(--radius); border: 1px solid #4a5568; background: #2d3748; color: #e2e8f0; margin-bottom: 20px; font-size: 14px;">
                        </div>
                    </div>
                    
                    <div class="actions" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                        <button onclick="setSickLeaveDate('today')" class="btn" style="height: 40px; font-size: 13px;">
                            <span>Сегодня</span>
                        </button>
                        <button onclick="setSickLeaveDate('yesterday')" class="btn" style="height: 40px; font-size: 13px;">
                            <span>Вчера</span>
                        </button>
                        <button onclick="setSickLeaveDate('week_ago')" class="btn" style="height: 40px; font-size: 13px;">
                            <span>Неделю назад</span>
                        </button>
                    </div>
                    
                    <button onclick="submitSickLeave()" class="btn" style="background: #8b5cf6; width: 100%;">
                        <span>🏥 СОХРАНИТЬ БОЛЬНИЧНЫЙ</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- SOS Menu Modal -->
        <div id="sos-menu-modal" style="display: none;">
            <div class="header">
                <button onclick="showSosModal()" style="background: none; border: none; color: white; font-size: 24px; float: left;">←</button>
                <h2 style="text-align: center; margin: 0;">🚨 SOS - Мои обращения</h2>
            </div>

            <div class="info-cards">
                <div class="info-card">
                    <div class="card-header">
                        <span class="card-icon">📋</span>
                        <span class="card-title">Ваши обращения</span>
                    </div>
                    <div class="card-content">
                        Здесь вы можете продолжить диалоги или создать новое обращение
                    </div>
                </div>



                <div id="sos-issues-list" style="margin-top: 20px;">
                    <!-- Список обращений будет загружен динамически -->
                </div>
            </div>
        </div>

        <!-- My Issue Dialog Modal -->
        <div id="my-issue-dialog-modal" style="display: none;">
            <div class="header">
                <button onclick="closeMyIssueDialog()" style="background: none; border: none; color: white; font-size: 24px; float: left;">←</button>
                <h2 style="text-align: center; margin: 0;">💬 Мое обращение</h2>
            </div>

            <div id="my-issue-dialog-scroll" style="padding: 20px; height: calc(100vh - 140px); overflow-y: auto;">
                <div id="my-issue-dialog-content">
                    <div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">
                        Загрузка диалога...
                    </div>
                </div>
            </div>
            
            <div style="position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.8); padding: 15px;">
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="my-response-input" placeholder="Введите ответ..." onkeypress="handleMyResponseEnterKey(event)" style="flex: 1; padding: 10px; border: none; border-radius: 6px; background: rgba(255,255,255,0.1); color: white;">
                    <button onclick="sendMyResponse()" style="background: #2ed573; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">Отправить</button>
                </div>
            </div>
        </div>

        <!-- Employees Management Modal -->
        <div id="employees-management-modal" style="display: none;">
            <div class="header">
                <button onclick="showAdminMenuModal()" style="background: none; border: none; color: white; font-size: 24px; float: left;">←</button>
                <h2 style="text-align: center; margin: 0;">👥 Управление сотрудниками</h2>
            </div>

            <div style="padding: 20px; height: calc(100vh - 80px); overflow-y: auto;">
                <div class="action-buttons" style="margin-bottom: 20px;">
                    <button onclick="showAddEmployeeModal()" class="action-button" style="background: linear-gradient(45deg, #2ed573, #17c0eb);">
                        <span class="icon">➕</span>Добавить сотрудника
                    </button>
                </div>
                
                <!-- Поле поиска -->
                <div style="margin-bottom: 20px;">
                    <div class="info-card">
                        <div class="card-header">
                            <span class="card-icon">🔍</span>
                            <span class="card-title">Поиск сотрудников</span>
                        </div>
                        <div class="card-content">
                            <input type="text" id="employee-search" placeholder="Введите имя, фамилию или номер телефона..." 
                                   oninput="filterEmployees()" 
                                   style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); 
                                          background: rgba(255,255,255,0.1); color: white; font-size: 16px;">
                            <div id="search-results-count" style="margin-top: 8px; font-size: 12px; color: rgba(255,255,255,0.6);">
                                <!-- Счетчик результатов поиска -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="employees-list">
                    <div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">
                        Загрузка списка сотрудников...
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Employee Modal -->
        <div id="add-employee-modal" style="display: none;">
            <div class="header">
                <button onclick="showEmployeesManagement()" style="background: none; border: none; color: white; font-size: 24px; float: left;">←</button>
                <h2 style="text-align: center; margin: 0;">➕ Добавить сотрудника</h2>
            </div>

            <div style="padding: 20px;">
                <div class="info-card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <span class="card-icon">ℹ️</span>
                        <span class="card-title">Информация</span>
                    </div>
                    <div class="card-content">
                        Добавьте нового сотрудника в систему. После добавления он сможет авторизоваться в боте по номеру телефона.
                    </div>
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: white; font-weight: bold;">Номер телефона:</label>
                    <input type="tel" id="add-phone" placeholder="+7XXXXXXXXXX" 
                           style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); 
                                  background: rgba(255,255,255,0.1); color: white; font-size: 16px;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: white; font-weight: bold;">Имя:</label>
                    <input type="text" id="add-first-name" placeholder="Введите имя" 
                           style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); 
                                  background: rgba(255,255,255,0.1); color: white; font-size: 16px;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: white; font-weight: bold;">Фамилия:</label>
                    <input type="text" id="add-last-name" placeholder="Введите фамилию" 
                           style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); 
                                  background: rgba(255,255,255,0.1); color: white; font-size: 16px;">
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; color: white; cursor: pointer;">
                        <input type="checkbox" id="add-is-admin" style="margin-right: 10px; transform: scale(1.2);">
                        <span style="font-weight: bold;">Права администратора</span>
                    </label>
                </div>

                <div class="action-buttons">
                    <button onclick="addEmployee()" class="action-button" style="background: linear-gradient(45deg, #2ed573, #17c0eb);">
                        <span class="icon">✅</span>Добавить сотрудника
                    </button>
                </div>
            </div>
        </div>

        <!-- Edit Employee Modal -->
        <div id="edit-employee-modal" style="display: none;">
            <div class="header">
                <button onclick="showEmployeesManagement()" style="background: none; border: none; color: white; font-size: 24px; float: left;">←</button>
                <h2 style="text-align: center; margin: 0;">✏️ Редактировать сотрудника</h2>
            </div>

            <div style="padding: 20px;">
                <div class="info-card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <span class="card-icon">⚠️</span>
                        <span class="card-title">Внимание</span>
                    </div>
                    <div class="card-content">
                        Изменение данных сотрудника повлияет на его доступ к системе
                    </div>
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: white; font-weight: bold;">Номер телефона:</label>
                    <input type="tel" id="edit-phone" readonly 
                           style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); 
                                  background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.7); font-size: 16px;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: white; font-weight: bold;">Имя:</label>
                    <input type="text" id="edit-first-name" placeholder="Введите имя" 
                           style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); 
                                  background: rgba(255,255,255,0.1); color: white; font-size: 16px;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: white; font-weight: bold;">Фамилия:</label>
                    <input type="text" id="edit-last-name" placeholder="Введите фамилию" 
                           style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); 
                                  background: rgba(255,255,255,0.1); color: white; font-size: 16px;">
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; color: white; cursor: pointer;">
                        <input type="checkbox" id="edit-is-admin" style="margin-right: 10px; transform: scale(1.2);">
                        <span style="font-weight: bold;">Права администратора</span>
                    </label>
                </div>

                <div class="action-buttons">
                    <button onclick="saveEmployeeChanges()" class="action-button" style="background: linear-gradient(45deg, #ffa500, #ff6b6b);">
                        <span class="icon">💾</span>Сохранить изменения
                    </button>
                </div>
            </div>
        </div>

        <!-- Issues Management Modal -->
        <div id="issues-management-modal" style="display: none;">
            <div class="header">
                <button onclick="showAdminMenuModal()" style="background: none; border: none; color: white; font-size: 24px; float: left;">←</button>
                <h2 style="text-align: center; margin: 0;">💬 Управление обращениями</h2>
            </div>

            <div style="padding: 20px; height: calc(100vh - 80px); overflow-y: auto;">
                <div id="issues-list">
                    <div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">
                        Загрузка списка обращений...
                    </div>
                </div>
            </div>
        </div>

        <!-- Issue Dialog Modal -->
        <div id="issue-dialog-modal" style="display: none;">
            <div class="header">
                <button onclick="closeIssueDialog()" style="background: none; border: none; color: white; font-size: 24px; float: left;">←</button>
                <h2 style="text-align: center; margin: 0;">💬 Диалог с обращением</h2>
            </div>

            <div id="issue-dialog-scroll" style="padding: 20px; height: calc(100vh - 140px); overflow-y: auto;">
                <div id="issue-dialog-content">
                    <div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">
                        Загрузка диалога...
                    </div>
                </div>
            </div>
            
            <div style="position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.8); padding: 15px;">
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="admin-response-input" placeholder="Введите ответ..." onkeypress="handleEnterKey(event)" style="flex: 1; padding: 10px; border: none; border-radius: 6px; background: rgba(255,255,255,0.1); color: white;">
                    <button onclick="sendAdminResponse()" style="background: #2ed573; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">Отправить</button>
                </div>
            </div>
        </div>

        <!-- Broadcast Message Modal -->
        <div id="broadcast-modal" style="display: none;">
            <div class="header">
                <button onclick="showAdminMenuModal()" style="background: none; border: none; color: white; font-size: 24px; float: left;">←</button>
                <h2 style="text-align: center; margin: 0;">📢 Рассылка сообщений</h2>
            </div>

            <div style="padding: 20px;">
                <div class="info-card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <span class="card-icon">⚠️</span>
                        <span class="card-title">Внимание</span>
                    </div>
                    <div class="card-content">
                        Сообщение будет отправлено всем сотрудникам, зарегистрированным в системе
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; color: white; font-weight: bold;">Текст сообщения:</label>
                    <textarea id="broadcast-message" placeholder="Введите сообщение для рассылки..." 
                              style="width: 100%; height: 150px; padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.3); 
                                     background: rgba(255,255,255,0.1); color: white; font-size: 16px; resize: vertical;"></textarea>
                </div>

                <div class="action-buttons">
                    <button onclick="sendBroadcastMessage()" class="action-button" style="background: linear-gradient(45deg, #ff6b6b, #ee5a52);">
                        <span class="icon">📤</span>Отправить всем
                    </button>
                </div>
            </div>
        </div>

        <!-- Admin Menu Modal -->
        <div id="admin-menu-modal" style="display: none;">
            <div class="wrap">
                <header>
                    <button onclick="showMainApp()" class="back-button">←</button>
                    <div>
                        <div class="title">👑 Меню администратора</div>
                        <div class="subtitle">Управление системой</div>
                    </div>
                </header>

                <div class="stack">
                    <div class="card">
                        <h3>📊 Общая статистика</h3>
                        <div id="admin-stats-content">
                            <p>Загрузка статистики...</p>
                        </div>
                    </div>
                </div>

                <div class="actions">
                    <button onclick="showEmployeesManagement()" class="btn">
                        <span class="dot" style="background: #10b981;"></span>
                        <span>Управление сотрудниками</span>
                    </button>
                    <button onclick="showIssuesManagement()" class="btn">
                        <span class="dot" style="background: #f59e0b;"></span>
                        <span>Управление обращениями</span>
                    </button>
                    <button onclick="sendStatsToChannel()" class="btn">
                        <span class="dot" style="background: #3b82f6;"></span>
                        <span>Отправить статистику в канал</span>
                    </button>
                    <button onclick="showBroadcastMessage()" class="btn">
                        <span class="dot" style="background: #ef4444;"></span>
                        <span>Отправить сообщение всем</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Issue Chat Modal -->
        <div id="issue-chat-modal" style="display: none;">
            <div class="header">
                <button onclick="showSosMenuModal()" style="background: none; border: none; color: white; font-size: 24px; float: left;">←</button>
                <h2 style="text-align: center; margin: 0;" id="chat-title">💬 Чат по обращению</h2>
            </div>

            <div style="padding: 20px; height: calc(100vh - 120px); display: flex; flex-direction: column;">
                <!-- Информация об обращении -->
                <div class="info-card" id="issue-info" style="margin-bottom: 15px;">
                    <div class="card-header">
                        <span class="card-icon">📋</span>
                        <span class="card-title" id="issue-title">Обращение</span>
                    </div>
                    <div class="card-content" id="issue-description">
                        <!-- Описание обращения -->
                    </div>
                </div>

                <!-- Область сообщений -->
                <div id="chat-messages" style="flex: 1; overflow-y: auto; background: rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                    <!-- Сообщения будут загружены динамически -->
                </div>

                <!-- Поле ввода сообщения -->
                <div id="chat-input-area" style="display: flex; gap: 10px;">
                    <input type="text" id="chat-message-input" placeholder="Введите сообщение..." style="flex: 1; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
                    <button onclick="sendChatMessage()" style="padding: 12px 20px; background: linear-gradient(45deg, #4ecdc4, #44a08d); border: none; border-radius: 8px; color: white; font-weight: bold;">
                        📤
                    </button>
                </div>
                
                <!-- Сообщение о закрытом обращении -->
                <div id="chat-closed-message" style="display: none; text-align: center; padding: 15px; background: rgba(255, 71, 87, 0.2); border-radius: 8px; color: #ff4757;">
                    <div style="font-size: 16px; font-weight: bold; margin-bottom: 5px;">🔴 Обращение закрыто</div>
                    <div style="font-size: 14px;">Администратор завершил это обращение. Вы не можете отправлять новые сообщения.</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        
        // Инициализируем Web App
        tg.ready();
        tg.expand();
        
        // Применяем тему Telegram
        document.body.style.backgroundColor = tg.themeParams.bg_color || '#667eea';

        async function showAdminMenuModal() {
            try {
                // Скрываем все модальные окна
                document.getElementById('app').style.display = 'none';
                document.getElementById('employees-management-modal').style.display = 'none';
                document.getElementById('issues-management-modal').style.display = 'none';
                document.getElementById('broadcast-modal').style.display = 'none';
                document.getElementById('add-employee-modal').style.display = 'none';
                document.getElementById('edit-employee-modal').style.display = 'none';
                
                // Показываем админ-меню
                document.getElementById('admin-menu-modal').style.display = 'block';
                
                // Загружаем статистику
                await loadAdminStats();
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Ошибка загрузки админ-меню');
            }
        }
        
        async function loadAdminStats() {
            try {
                const response = await fetch(`http://localhost:5000/api/admin/stats?initData=${encodeURIComponent(tg.initData)}`, {
                    method: 'GET'
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки статистики');
                }

                const data = await response.json();
                const stats = data.stats;
                
                const statsContent = document.getElementById('admin-stats-content');
                statsContent.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px;">
                        <div style="text-align: center; padding: 8px; background: rgba(16, 185, 129, 0.1); border-radius: var(--radius); border: 1px solid rgba(16, 185, 129, 0.2);">
                            <div style="font-size: 20px; font-weight: bold; color: #10b981;">${stats.total_employees}</div>
                            <div style="font-size: 11px; color: var(--muted);">Всего сотрудников</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: rgba(245, 158, 11, 0.1); border-radius: var(--radius); border: 1px solid rgba(245, 158, 11, 0.2);">
                            <div style="font-size: 20px; font-weight: bold; color: #f59e0b;">${stats.active_issues}</div>
                            <div style="font-size: 11px; color: var(--muted);">Активных обращений</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: rgba(59, 130, 246, 0.1); border-radius: var(--radius); border: 1px solid rgba(59, 130, 246, 0.2);">
                            <div style="font-size: 20px; font-weight: bold; color: #3b82f6;">${stats.issues_this_week}</div>
                            <div style="font-size: 11px; color: var(--muted);">Обращений за неделю</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: var(--radius); border: 1px solid rgba(239, 68, 68, 0.2);">
                            <div style="font-size: 20px; font-weight: bold; color: #ef4444;">${stats.current_sick_leaves}</div>
                            <div style="font-size: 11px; color: var(--muted);">На больничном</div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Ошибка:', error);
                document.getElementById('admin-stats-content').innerHTML = '<p style="color: var(--muted);">Ошибка загрузки статистики</p>';
            }
        }
        
        async function showEmployeesManagement() {
            try {
                // Скрываем все модальные окна
                document.getElementById('admin-menu-modal').style.display = 'none';
                document.getElementById('add-employee-modal').style.display = 'none';
                document.getElementById('edit-employee-modal').style.display = 'none';
                document.getElementById('issues-management-modal').style.display = 'none';
                document.getElementById('broadcast-modal').style.display = 'none';
                
                // Показываем управление сотрудниками
                document.getElementById('employees-management-modal').style.display = 'block';
                await loadEmployeesList();
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Ошибка загрузки списка сотрудников');
            }
        }
        
        async function loadEmployeesList() {
            try {
                const response = await fetch(`http://localhost:5000/api/admin/employees?initData=${encodeURIComponent(tg.initData)}`, {
                    method: 'GET'
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки сотрудников');
                }

                const data = await response.json();
                
                // Сохраняем всех сотрудников для поиска
                allEmployees = data.employees;
                filteredEmployees = [...allEmployees];
                
                // Очищаем поле поиска
                document.getElementById('employee-search').value = '';
                
                displayEmployeesList(filteredEmployees);
                updateSearchResultsCount();
                
            } catch (error) {
                console.error('Ошибка:', error);
                document.getElementById('employees-list').innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">Ошибка загрузки сотрудников</div>';
            }
        }
        
        function displayEmployeesList(employees) {
            const container = document.getElementById('employees-list');
            if (!employees || employees.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">Сотрудники не найдены</div>';
                return;
            }
            
            container.innerHTML = '';
            employees.forEach(emp => {
                const empDiv = document.createElement('div');
                empDiv.className = 'info-card';
                empDiv.style.marginBottom = '15px';
                
                const statusIcon = emp.is_blocked ? '🔴' : '🟢';
                const statusText = emp.is_blocked ? 'Заблокирован' : 'Активен';
                const statusColor = emp.is_blocked ? '#ff4757' : '#2ed573';
                const adminBadge = emp.is_admin ? '<span style="background: #ffa500; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 10px;">АДМИН</span>' : '';
                
                empDiv.innerHTML = `
                    <div class="card-header">
                        <span class="card-icon">👤</span>
                        <span class="card-title">${emp.first_name} ${emp.last_name}${adminBadge}</span>
                        <span style="float: right; font-size: 12px; color: ${statusColor};">${statusIcon} ${statusText}</span>
                    </div>
                    <div class="card-content">
                        <div style="font-size: 14px; margin-bottom: 10px;">📞 ${emp.phone}</div>
                        ${emp.chat_id ? '<div style="font-size: 12px; color: rgba(255,255,255,0.6);">✅ Зарегистрирован в боте</div>' : '<div style="font-size: 12px; color: rgba(255,255,255,0.6);">⚠️ Не авторизован в боте</div>'}
                        <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="toggleEmployeeBlock('${emp.phone}', ${!emp.is_blocked})" 
                                    style="padding: 8px 16px; background: ${emp.is_blocked ? '#2ed573' : '#ff4757'}; border: none; border-radius: 6px; color: white; font-size: 12px; cursor: pointer;">
                                ${emp.is_blocked ? '✅ Разблокировать' : '🔒 Заблокировать'}
                            </button>
                            <button onclick="editEmployee('${emp.phone}', '${emp.first_name}', '${emp.last_name}', ${emp.is_admin})" 
                                    style="padding: 8px 16px; background: #ffa500; border: none; border-radius: 6px; color: white; font-size: 12px; cursor: pointer;">
                                ✏️ Редактировать
                            </button>
                            <button onclick="deleteEmployee('${emp.phone}', '${emp.first_name}', '${emp.last_name}')" 
                                    style="padding: 8px 16px; background: #ff4757; border: none; border-radius: 6px; color: white; font-size: 12px; cursor: pointer;">
                                🗑️ Удалить
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(empDiv);
            });
        }
        
        async function toggleEmployeeBlock(phone, isBlocked) {
            try {
                const response = await fetch('/api/admin/employee/block', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        employee_phone: phone,
                        is_blocked: isBlocked
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    tg.showAlert(result.message);
                    await loadEmployeesList(); // Перезагружаем список
                } else {
                    tg.showAlert('Ошибка: ' + result.error);
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Ошибка изменения статуса сотрудника');
            }
        }
        
        async function showIssuesManagement() {
            console.log('showIssuesManagement вызвана');
            try {
                // Останавливаем автообновление диалога
                stopDialogAutoRefresh();
                
                // Скрываем все модальные окна
                document.getElementById('admin-menu-modal').style.display = 'none';
                document.getElementById('employees-management-modal').style.display = 'none';
                document.getElementById('broadcast-modal').style.display = 'none';
                document.getElementById('issue-dialog-modal').style.display = 'none';
                
                // Очищаем поле ввода ответа
                const responseInput = document.getElementById('admin-response-input');
                if (responseInput) {
                    responseInput.value = '';
                }
                
                // Показываем управление обращениями
                document.getElementById('issues-management-modal').style.display = 'block';
                console.log('Модальное окно показано, вызываем loadIssuesList');
                
                // Если список уже загружен, не загружаем заново
                if (!issuesListCache) {
                    await loadIssuesList();
                }
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Ошибка загрузки списка обращений');
            }
        }
        
        async function loadIssuesList(forceReload = false) {
            const container = document.getElementById('issues-list');
            
            // Если есть кэш и не требуется принудительная перезагрузка
            if (issuesListCache && !forceReload) {
                displayCachedIssuesList();
                return;
            }
            
            // Очищаем контейнер сразу
            container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">Загрузка обращений...</div>';
            
            try {
                const response = await fetch(`/api/admin/issues/all?initData=${encodeURIComponent(tg.initData)}`, {
                    method: 'GET'
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки обращений');
                }

                const data = await response.json();
                
                // Сохраняем в кэш
                issuesListCache = data.issues;
                
                // Отображаем
                displayCachedIssuesList();
                
            } catch (error) {
                console.error('Ошибка в loadIssuesList:', error);
                document.getElementById('issues-list').innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">Ошибка загрузки обращений</div>';
            }
        }
        
        function displayCachedIssuesList() {
            const container = document.getElementById('issues-list');
            const data = { issues: issuesListCache };
            
            setTimeout(() => {
                setTimeout(() => {
                        // Создаем полный список всех обращений
                        let html = '<div style="padding: 20px;">';
                        
                        data.issues.forEach(issue => {
                            let statusIcon = '🟡';
                            let statusText = 'Активно';
                            let statusColor = '#ffa500';
                            if (issue.status === 'closed') {
                                statusIcon = '🔴';
                                statusText = 'Закрыто';
                                statusColor = '#ff4757';
                            } else if (issue.status === 'resolved') {
                                statusIcon = '🟢';
                                statusText = 'Решено';
                                statusColor = '#2ed573';
                            }
                            
                            const typeIcon = issue.type === 'personal' ? '💔' : '🖥';
                            const typeText = issue.type === 'personal' ? 'Личная проблема' : 'Техническая проблема';
                            const anonymityText = issue.is_anonymous ? ` (${issue.pseudonym || 'Анонимно'})` : '';
                            
                            html += '<div style="background: rgba(255,255,255,0.1); margin: 15px 0; padding: 15px; border-radius: 8px;">';
                            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">';
                            html += '<div style="font-weight: bold;">' + typeIcon + ' Обращение #' + issue.id + anonymityText + '</div>';
                            html += '<div style="font-size: 12px; color: ' + statusColor + ';">' + statusIcon + ' ' + statusText + '</div>';
                            html += '</div>';
                            html += '<div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-bottom: 5px;">' + typeText + '</div>';
                            html += '<div style="font-size: 14px; margin-bottom: 8px;">' + issue.description + '</div>';
                            html += '<div style="font-size: 12px; color: rgba(255,255,255,0.6);">От: ' + issue.employee_name + '</div>';
                            html += '<div style="font-size: 12px; color: rgba(255,255,255,0.6);">Создано: ' + new Date(issue.created_at).toLocaleString('ru-RU') + '</div>';
                            
                            if (issue.last_response_preview) {
                                html += '<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.2);">';
                                html += '<div style="font-size: 12px; color: rgba(255,255,255,0.6);">Последний ответ:</div>';
                                html += '<div style="font-size: 13px; color: rgba(255,255,255,0.8);">' + issue.last_response_preview + '</div>';
                                html += '</div>';
                            }
                            
                            html += '<div style="margin-top: 15px; text-align: center;">';
                            if (issue.status === 'closed') {
                                // Для закрытых обращений - кнопка просмотра
                                html += '<button onclick="openIssueDialog(' + issue.id + ')" style="background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 12px; cursor: pointer;">👁️ Просмотр</button>';
                            } else {
                                // Для активных обращений - кнопки ответить и закрыть
                                html += '<button onclick="openIssueDialog(' + issue.id + ')" style="background: #2ed573; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 12px; cursor: pointer; margin-right: 10px;">💬 Ответить</button>';
                                html += '<button onclick="closeIssue(' + issue.id + ')" style="background: #ff4757; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 12px; cursor: pointer;">✅ Закрыть обращение</button>';
                            }
                            html += '</div>';
                            
                            html += '</div>';
                        });
                        
                        html += '</div>';
                        container.innerHTML = html;
                    }, 1000);
                }, 1000);
        }
        
        function displayIssuesList(issues) {
            try {
                const container = document.getElementById('issues-list');
                
                if (!issues || issues.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">Обращения не найдены</div>';
                    return;
                }

                container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">Шаг 4: Отображаем ' + issues.length + ' обращений...</div>';
            
            // Небольшая задержка для показа сообщения
            setTimeout(() => {
                container.innerHTML = '';
            issues.forEach(issue => {
                const issueDiv = document.createElement('div');
                issueDiv.className = 'info-card';
                issueDiv.style.marginBottom = '15px';
                
                let statusIcon = '🟡';
                let statusText = 'Активно';
                let statusColor = '#ffa500';
                if (issue.status === 'closed') {
                    statusIcon = '🔴';
                    statusText = 'Закрыто';
                    statusColor = '#ff4757';
                } else if (issue.status === 'resolved') {
                    statusIcon = '🟢';
                    statusText = 'Решено';
                    statusColor = '#2ed573';
                }
                
                const typeIcon = issue.type === 'personal' ? '💔' : '🖥';
                const typeText = issue.type === 'personal' ? 'Личная проблема' : 'Техническая проблема';
                const anonymityText = issue.is_anonymous ? ` (${issue.pseudonym || 'Анонимно'})` : '';
                
                let lastMessageInfo = '';
                if (issue.last_response_preview) {
                    lastMessageInfo = `
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.2);">
                            <div style="font-size: 12px; color: rgba(255,255,255,0.6);">Последний ответ:</div>
                            <div style="font-size: 13px; color: rgba(255,255,255,0.8);">${issue.last_response_preview}</div>
                        </div>
                    `;
                }
                
                // Определяем кнопки в зависимости от статуса
                let buttonsHtml = '';
                if (issue.status === 'closed') {
                    // Для закрытых обращений - кнопка просмотра
                    buttonsHtml = `
                        <button onclick="openIssueDialog(${issue.id})" 
                                style="padding: 8px 16px; background: #667eea; border: none; border-radius: 6px; color: white; font-size: 12px; cursor: pointer;">
                            👁️ Просмотр
                        </button>
                    `;
                } else {
                    // Для активных обращений - кнопки ответить и закрыть
                    buttonsHtml = `
                        <button onclick="openIssueDialog(${issue.id})" 
                                style="padding: 8px 16px; background: #2ed573; border: none; border-radius: 6px; color: white; font-size: 12px; cursor: pointer; margin-right: 10px;">
                            💬 Ответить
                        </button>
                        <button onclick="closeIssue(${issue.id})" 
                                style="padding: 8px 16px; background: #ff4757; border: none; border-radius: 6px; color: white; font-size: 12px; cursor: pointer;">
                            ✅ Закрыть обращение
                        </button>
                    `;
                }

                issueDiv.innerHTML = `
                    <div class="card-header">
                        <span class="card-icon">${typeIcon}</span>
                        <span class="card-title">Обращение #${issue.id}${anonymityText}</span>
                        <span style="float: right; font-size: 12px; color: ${statusColor};">${statusIcon} ${statusText}</span>
                    </div>
                    <div class="card-content">
                        <div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-bottom: 5px;">${typeText}</div>
                        <div style="font-size: 14px; margin-bottom: 8px;">${issue.description}</div>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.6);">
                            👤 ${issue.employee_name} • 📅 ${new Date(issue.created_at).toLocaleString('ru-RU')}
                            ${issue.response_count > 0 ? ` • 💬 ${issue.response_count} ответов` : ''}
                        </div>
                        ${lastMessageInfo}
                        <div style="margin-top: 15px;">
                            ${buttonsHtml}
                        </div>
                    </div>
                `;
                container.appendChild(issueDiv);
            });
            }, 1000);
            
            } catch (error) {
                const container = document.getElementById('issues-list');
                container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">Ошибка в displayIssuesList: ' + error.message + '</div>';
            }
        }
        
        let currentIssueId = null;
        let issuesListCache = null;
        
        async function openIssueDialog(issueId) {
            try {
                currentIssueId = issueId;
                
                // Скрываем все окна
                document.getElementById('app').style.display = 'none';
                document.getElementById('issues-management-modal').style.display = 'none';
                
                // Показываем модальное окно диалога с обращением
                document.getElementById('issue-dialog-modal').style.display = 'block';
                
                // Загружаем историю диалога
                await loadIssueDialog(issueId);
                
                // Запускаем автообновление диалога
                startDialogAutoRefresh();
                
                // Отмечаем ответы как прочитанные
                await markResponsesAsRead(issueId);
                
            } catch (error) {
                console.error('Ошибка открытия диалога:', error);
                tg.showAlert('Ошибка открытия диалога с обращением');
            }
        }
        
        async function loadIssueDialog(issueId) {
            try {
                const container = document.getElementById('issue-dialog-content');
                container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">Загрузка диалога...</div>';
                
                const response = await fetch(`/api/admin/issue/${issueId}/dialog?initData=${encodeURIComponent(tg.initData)}`, {
                    method: 'GET'
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки диалога');
                }

                const data = await response.json();
                displayIssueDialog(data);
                
                // Инициализируем счетчик сообщений для умного обновления
                currentDialogMessagesCount = data.responses ? data.responses.length : 0;
                lastDialogData = data;
                
            } catch (error) {
                console.error('Ошибка загрузки диалога:', error);
                document.getElementById('issue-dialog-content').innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">Ошибка загрузки диалога</div>';
            }
        }
        
        function displayIssueDialog(data) {
            const container = document.getElementById('issue-dialog-content');
            const issue = data.issue;
            const responses = data.responses || [];
            
            let html = '<div style="margin-bottom: 20px;">';
            
            // Информация об обращении
            const typeIcon = issue.type === 'personal' ? '💔' : '🖥';
            const typeText = issue.type === 'personal' ? 'Личная проблема' : 'Техническая проблема';
            const anonymityText = issue.is_anonymous ? ` (${issue.pseudonym || 'Анонимно'})` : '';
            
            // Определяем статус
            let statusIcon = '🟡';
            let statusText = 'Активно';
            let statusColor = '#ffa500';
            if (issue.status === 'closed') {
                statusIcon = '🔴';
                statusText = 'Закрыто';
                statusColor = '#ff4757';
            } else if (issue.status === 'resolved') {
                statusIcon = '🟢';
                statusText = 'Решено';
                statusColor = '#2ed573';
            }
            
            html += '<div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">';
            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">';
            html += '<div style="font-weight: bold;">' + typeIcon + ' Обращение #' + issue.id + anonymityText + '</div>';
            html += '<div style="font-size: 12px; color: ' + statusColor + ';">' + statusIcon + ' ' + statusText + '</div>';
            html += '</div>';
            html += '<div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-bottom: 5px;">' + typeText + '</div>';
            html += '<div style="font-size: 14px; margin-bottom: 8px;">' + issue.description + '</div>';
            html += '<div style="font-size: 12px; color: rgba(255,255,255,0.6);">От: ' + issue.employee_name + '</div>';
            html += '<div style="font-size: 12px; color: rgba(255,255,255,0.6);">Создано: ' + new Date(issue.created_at).toLocaleString('ru-RU') + '</div>';
            
            // Если обращение закрыто, показываем предупреждение для админа
            if (issue.status === 'closed') {
                html += '<div style="margin-top: 10px; padding: 10px; background: rgba(255, 71, 87, 0.2); border-radius: 6px; font-size: 12px; color: rgba(255,255,255,0.8);">';
                html += '🔒 Это обращение закрыто. Вы можете просматривать историю, но новые ответы добавлять запрещено.';
                html += '</div>';
            }
            
            html += '</div>';
            
            // История ответов
            if (responses.length > 0) {
                html += '<div class="dialog-messages" style="margin-bottom: 20px; max-height: 300px; overflow-y: auto;">';
                html += '<div style="font-weight: bold; margin-bottom: 15px;">История диалога:</div>';
                
                responses.forEach(response => {
                    const isAdmin = response.responder_phone === 'admin';
                    const bgColor = isAdmin ? 'rgba(46, 213, 115, 0.2)' : 'rgba(255, 255, 255, 0.1)';
                    const align = isAdmin ? 'margin-left: 20px;' : 'margin-right: 20px;';
                    
                    html += '<div style="background: ' + bgColor + '; padding: 12px; border-radius: 8px; margin-bottom: 10px; ' + align + '">';
                    html += '<div style="font-size: 14px; margin-bottom: 5px;">' + response.response_text + '</div>';
                    html += '<div style="font-size: 11px; color: rgba(255,255,255,0.6); text-align: right;">';
                    html += (isAdmin ? '👨‍💼 Администратор' : '👤 Сотрудник') + ' • ' + new Date(response.created_at).toLocaleString('ru-RU');
                    html += '</div>';
                    html += '</div>';
                });
                
                html += '</div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
            
            // Управляем видимостью поля ввода в зависимости от статуса обращения
            const inputContainer = document.querySelector('#issue-dialog-modal div[style*="position: fixed"]');
            if (inputContainer) {
                if (issue.status === 'closed') {
                    // Для закрытых обращений делаем поле ввода полупрозрачным и добавляем предупреждение
                    inputContainer.style.opacity = '0.6';
                    const input = document.getElementById('admin-response-input');
                    const button = inputContainer.querySelector('button');
                    if (input) {
                        input.placeholder = 'Обращение закрыто - ответы запрещены';
                        input.style.background = 'rgba(255, 71, 87, 0.2)';
                    }
                    if (button) {
                        button.style.background = '#ff4757';
                        button.innerHTML = '⚠️ Ответить';
                    }
                } else {
                    // Для активных обращений возвращаем обычный вид
                    inputContainer.style.opacity = '1';
                    const input = document.getElementById('admin-response-input');
                    const button = inputContainer.querySelector('button');
                    if (input) {
                        input.placeholder = 'Введите ответ...';
                        input.style.background = 'rgba(255,255,255,0.1)';
                    }
                    if (button) {
                        button.style.background = '#2ed573';
                        button.innerHTML = 'Отправить';
                    }
                }
            }
            
            // Прокручиваем вниз к последним сообщениям
            setTimeout(() => {
                const scrollableContainer = document.getElementById('issue-dialog-scroll');
                if (scrollableContainer) {
                    console.log('Прокручиваем админский диалог вниз');
                    scrollableContainer.scrollTop = scrollableContainer.scrollHeight;
                } else {
                    console.log('Контейнер issue-dialog-scroll не найден');
                }
            }, 100);
        }
        
        async function sendAdminResponse() {
            try {
                const input = document.getElementById('admin-response-input');
                const responseText = input.value.trim();
                
                if (!responseText) {
                    tg.showAlert('Введите текст ответа');
                    return;
                }
                
                const response = await fetch(`/api/admin/issue/${currentIssueId}/respond`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        response_text: responseText
                    })
                });

                if (!response.ok) {
                    if (response.status === 403) {
                        const errorData = await response.json();
                        if (errorData.error === 'Cannot respond to closed issue') {
                            tg.showAlert('Нельзя отвечать в закрытое обращение');
                            return;
                        }
                    }
                    throw new Error('Ошибка отправки ответа');
                }

                // Добавляем сообщение в диалог локально
                addMessageToDialog(responseText, true, false);
                
                // Очищаем поле ввода
                input.value = '';
                
                // Сбрасываем кэш списка обращений (так как добавился новый ответ)
                issuesListCache = null;
                
                // Увеличиваем счетчик сообщений (добавили новое сообщение)
                currentDialogMessagesCount++;
                
            } catch (error) {
                console.error('Ошибка отправки ответа:', error);
                tg.showAlert('Ошибка отправки ответа');
            }
        }
        
        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendAdminResponse();
            }
        }
        
        async function closeIssue(issueId) {
            try {
                const response = await fetch(`/api/admin/issue/${issueId}/close`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    tg.showAlert(result.message);
                    // Сбрасываем кэш и перезагружаем список
                    issuesListCache = null;
                    await loadIssuesList(true); // Принудительная перезагрузка
                } else {
                    tg.showAlert('Ошибка: ' + result.error);
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Ошибка закрытия обращения');
            }
        }
        
        async function sendStatsToChannel() {
            try {
                const response = await fetch('/api/admin/send-stats', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    tg.showAlert(result.message);
                } else {
                    tg.showAlert('Ошибка: ' + result.error);
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Ошибка отправки статистики');
            }
        }
        
        function showBroadcastMessage() {
            // Скрываем все модальные окна
            document.getElementById('admin-menu-modal').style.display = 'none';
            document.getElementById('employees-management-modal').style.display = 'none';
            document.getElementById('issues-management-modal').style.display = 'none';
            
            // Показываем модальное окно рассылки
            document.getElementById('broadcast-modal').style.display = 'block';
            document.getElementById('broadcast-message').value = '';
        }
        
        async function sendBroadcastMessage() {
            try {
                const messageText = document.getElementById('broadcast-message').value.trim();
                
                if (!messageText) {
                    tg.showAlert('Введите текст сообщения');
                    return;
                }
                
                const response = await fetch('/api/admin/broadcast', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        message: messageText
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    tg.showAlert(result.message);
                    document.getElementById('broadcast-message').value = '';
                    showAdminMenuModal(); // Возвращаемся в админ-меню
                } else {
                    tg.showAlert('Ошибка: ' + result.error);
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Ошибка отправки сообщения');
            }
        }
        
        function showAddEmployeeModal() {
            // Скрываем все модальные окна
            document.getElementById('employees-management-modal').style.display = 'none';
            document.getElementById('edit-employee-modal').style.display = 'none';
            document.getElementById('admin-menu-modal').style.display = 'none';
            
            // Показываем модальное окно добавления
            document.getElementById('add-employee-modal').style.display = 'block';
            
            // Очищаем поля
            document.getElementById('add-phone').value = '';
            document.getElementById('add-first-name').value = '';
            document.getElementById('add-last-name').value = '';
            document.getElementById('add-is-admin').checked = false;
        }
        
        async function addEmployee() {
            try {
                const phoneNumber = document.getElementById('add-phone').value.trim();
                const firstName = document.getElementById('add-first-name').value.trim();
                const lastName = document.getElementById('add-last-name').value.trim();
                const isAdmin = document.getElementById('add-is-admin').checked;
                
                if (!phoneNumber || !firstName || !lastName) {
                    tg.showAlert('Заполните все поля');
                    return;
                }
                
                const response = await fetch('/api/admin/employee/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        phone_number: phoneNumber,
                        first_name: firstName,
                        last_name: lastName,
                        is_admin: isAdmin
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    tg.showAlert(result.message);
                    showEmployeesManagement(); // Возвращаемся к списку и обновляем его
                } else {
                    tg.showAlert('Ошибка: ' + result.error);
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Ошибка добавления сотрудника');
            }
        }
        
        function editEmployee(phone, firstName, lastName, isAdmin) {
            // Скрываем все модальные окна
            document.getElementById('employees-management-modal').style.display = 'none';
            document.getElementById('add-employee-modal').style.display = 'none';
            document.getElementById('admin-menu-modal').style.display = 'none';
            
            // Показываем модальное окно редактирования
            document.getElementById('edit-employee-modal').style.display = 'block';
            
            // Заполняем поля
            document.getElementById('edit-phone').value = phone;
            document.getElementById('edit-first-name').value = firstName;
            document.getElementById('edit-last-name').value = lastName;
            document.getElementById('edit-is-admin').checked = isAdmin;
        }
        
        async function saveEmployeeChanges() {
            try {
                const phoneNumber = document.getElementById('edit-phone').value.trim();
                const firstName = document.getElementById('edit-first-name').value.trim();
                const lastName = document.getElementById('edit-last-name').value.trim();
                const isAdmin = document.getElementById('edit-is-admin').checked;
                
                if (!firstName || !lastName) {
                    tg.showAlert('Заполните все поля');
                    return;
                }
                
                const response = await fetch('/api/admin/employee/edit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        phone_number: phoneNumber,
                        first_name: firstName,
                        last_name: lastName,
                        is_admin: isAdmin
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    tg.showAlert(result.message);
                    showEmployeesManagement(); // Возвращаемся к списку и обновляем его
                } else {
                    tg.showAlert('Ошибка: ' + result.error);
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Ошибка сохранения изменений');
            }
        }
        
        async function deleteEmployee(phone, firstName, lastName) {
            try {
                // Подтверждение удаления
                if (!confirm(`Вы уверены, что хотите удалить сотрудника ${firstName} ${lastName}?\n\nЭто действие нельзя отменить. Будут удалены все данные сотрудника: режимы работы, отсутствия, больничные, обращения.`)) {
                    return;
                }
                
                const response = await fetch('/api/admin/employee/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        phone_number: phone
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    tg.showAlert(result.message);
                    await loadEmployeesList(); // Обновляем список
                } else {
                    tg.showAlert('Ошибка: ' + result.error);
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Ошибка удаления сотрудника');
            }
        }
        
        function filterEmployees() {
            const searchTerm = document.getElementById('employee-search').value.toLowerCase().trim();
            
            if (!searchTerm) {
                // Если поиск пустой, показываем всех сотрудников
                filteredEmployees = [...allEmployees];
            } else {
                // Фильтруем по имени, фамилии или номеру телефона
                filteredEmployees = allEmployees.filter(emp => {
                    const fullName = `${emp.first_name} ${emp.last_name}`.toLowerCase();
                    const phone = emp.phone.toLowerCase();
                    
                    return fullName.includes(searchTerm) || 
                           emp.first_name.toLowerCase().includes(searchTerm) ||
                           emp.last_name.toLowerCase().includes(searchTerm) ||
                           phone.includes(searchTerm);
                });
            }
            
            displayEmployeesList(filteredEmployees);
            updateSearchResultsCount();
        }
        
        function updateSearchResultsCount() {
            const searchTerm = document.getElementById('employee-search').value.trim();
            const countElement = document.getElementById('search-results-count');
            
            if (!searchTerm) {
                countElement.textContent = `Всего сотрудников: ${allEmployees.length}`;
                countElement.style.color = 'rgba(255,255,255,0.6)';
            } else {
                if (filteredEmployees.length === 0) {
                    countElement.textContent = 'Сотрудники не найдены';
                    countElement.style.color = 'rgba(255, 71, 87, 0.8)';
                } else if (filteredEmployees.length === 1) {
                    countElement.textContent = 'Найден 1 сотрудник';
                    countElement.style.color = 'rgba(46, 213, 115, 0.8)';
                } else {
                    countElement.textContent = `Найдено ${filteredEmployees.length} сотрудников`;
                    countElement.style.color = 'rgba(46, 213, 115, 0.8)';
                }
            }
        }
        
        async function loadUserAvatar() {
            try {
                const user = tg.initDataUnsafe?.user;
                console.log('Загрузка аватарки для пользователя:', user);
                console.log('Полные данные tg.initDataUnsafe:', tg.initDataUnsafe);
                console.log('tg.initData:', tg.initData);
                
                if (!user) {
                    console.log('Нет данных пользователя');
                    return;
                }
                
                const avatarEl = document.getElementById('avatar');
                
                // Проверяем, есть ли photo_url в данных пользователя от Telegram
                if (user.photo_url) {
                    console.log('Найдена аватарка в данных Telegram:', user.photo_url);
                    avatarEl.innerHTML = `<img src="${user.photo_url}" alt="Avatar">`;
                    return;
                }
                
                // Если нет photo_url, пытаемся получить через tg.initDataUnsafe
                const initData = tg.initDataUnsafe;
                if (initData && initData.user && initData.user.photo_url) {
                    console.log('Найдена аватарка в initDataUnsafe:', initData.user.photo_url);
                    avatarEl.innerHTML = `<img src="${initData.user.photo_url}" alt="Avatar">`;
                    return;
                }
                
                // Пытаемся загрузить через Flask API
                console.log('Пытаемся загрузить аватарку через API...');
                try {
                    const apiResponse = await fetch(`http://localhost:5000/api/user-avatar?user_id=${user.id}`, {
                        method: 'GET'
                    });
                    
                    console.log('Ответ API аватарки:', apiResponse.status);
                    
                    if (apiResponse.ok) {
                        const apiData = await apiResponse.json();
                        console.log('Данные аватарки от API:', apiData);
                        
                        if (apiData.avatar_url) {
                            console.log('Устанавливаем аватарку от API:', apiData.avatar_url);
                            avatarEl.innerHTML = `<img src="${apiData.avatar_url}" alt="Avatar">`;
                            return;
                        }
                    }
                } catch (apiError) {
                    console.log('Ошибка API аватарки:', apiError);
                }
                
                // Если API не сработал, оставляем пустой круг с градиентом
                console.log('Аватарка не найдена, оставляем пустой круг');
                avatarEl.innerHTML = '';
                avatarEl.textContent = '';
                
            } catch (error) {
                console.error('Ошибка загрузки аватарки:', error);
                // В случае ошибки оставляем пустой круг
                const avatarEl = document.getElementById('avatar');
                avatarEl.innerHTML = '';
                avatarEl.textContent = '';
            }
        }
         
        async function loadUserData() {
            try {
                // Возвращаем API вызов для получения данных пользователя
                const response = await fetch('http://localhost:5000/api/user-info', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData
                    })
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки данных');
                }

                const data = await response.json();
                
                // Сохраняем данные пользователя глобально
                currentUserData = data;
                
                // Обновляем интерфейс
                document.getElementById('name').textContent = data.user.first_name || 'Aleksei';
                
                // Загружаем аватарку пользователя (или показываем инициалы)
                loadUserAvatar();
                
                // Для демо-режима показываем базовую информацию
                const workStatusEl = document.getElementById('work-status');
                if (workStatusEl) workStatusEl.textContent = 'Удаленная работа';
                
                const vacationInfoEl = document.getElementById('vacation-info');
                if (vacationInfoEl) vacationInfoEl.textContent = 'Отпуск не запланирован';
                
                const dailyFactEl = document.getElementById('daily-fact');
                if (dailyFactEl) dailyFactEl.textContent = 'Добро пожаловать в Maria Bot!';
                
                // Показываем админское меню, если пользователь администратор
                if (data.user.is_admin) {
                    const adminBtnEl = document.getElementById('admin-btn');
                    if (adminBtnEl) adminBtnEl.style.display = 'inline-flex';
                }
                
                // Показываем приложение
                document.getElementById('loading').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                
            } catch (error) {
                console.error('Ошибка:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
            }
        }

        // Переменные для режима работы
        let selectedMode = null;
        let selectedPeriod = null;
        let workModeOptions = null;
        
        // Переменные для отсутствия
        let absenceOptions = null;
        let selectedAbsenceDate = null;
        let selectedAbsenceTime = null;
        let customAbsenceDate = null;
        let customAbsenceStartTime = null;
        let customAbsenceEndTime = null;
        
        // Переменные для SOS
        let sosOptions = null;
        let selectedIssueType = null;
        let selectedAnonymity = null;
        let sosPseudonym = null;
        let sosDescription = null;
        
        // Переменные для больничного
        let sickLeaveOptions = null;
        let selectedLeaveType = null;
        
        // Переменные для чата
        let chatRefreshInterval = null;
        
        // Переменные для поиска сотрудников
        let allEmployees = [];
        let filteredEmployees = [];

        async function handleAction(action) {
            try {
                if (action === 'vacation') {
                    tg.showAlert('Функция "Мой отпуск" в разработке');
                    return;
                }
                
                if (action === 'work_mode') {
                    await showWorkModeModal();
                    return;
                }
                
                if (action === 'absence') {
                    await showAbsenceModal();
                    return;
                }
                
                if (action === 'sick_leave') {
                    await showSickLeaveModal();
                    return;
                }
                
                if (action === 'crocotime') {
                    tg.showAlert('Функция "Мой Crocotime" в разработке');
                    return;
                }
                
                if (action === 'admin' || action === 'admin_menu') {
                    await showAdminMenuModal();
                    return;
                }
                
                if (action === 'sos') {
                    await showSosModal();
                    return;
                }
                
                if (action === 'sos_menu') {
                    await showSosMenuModal();
                    return;
                }
                
                // Показываем индикатор загрузки
                tg.showAlert('Обрабатываем запрос...');
                
                const response = await fetch('/api/actions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        action: action
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    if (result.redirect) {
                        if (result.action === 'work_mode') {
                            await showWorkModeModal();
                        } else if (result.action === 'absence') {
                            await showAbsenceModal();
                        } else if (result.action === 'sos') {
                            await showSosModal();
                        } else if (result.action === 'sos_menu') {
                            await showSosMenuModal();
                        } else if (result.action === 'sick_leave') {
                            await showSickLeaveModal();
                        } else if (result.action === 'admin_menu') {
                            await showAdminMenuModal();
                        }
                    } else {
                        tg.showAlert(result.message || 'Действие выполнено');
                    }
                } else {
                    tg.showAlert('Ошибка: ' + result.error);
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Произошла ошибка при выполнении действия');
            }
        }
        
        async function showSosModal() {
            try {
                // Загружаем опции SOS
                const response = await fetch('http://localhost:5000/api/sos', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки данных');
                }

                sosOptions = await response.json();
                
                // Показываем модальное окно
                document.getElementById('app').style.display = 'none';
                document.getElementById('sos-menu-modal').style.display = 'none';
                document.getElementById('sos-modal').style.display = 'block';
                
                // Заполняем типы проблем
                const typesContainer = document.getElementById('sos-issue-types');
                typesContainer.innerHTML = '';
                
                sosOptions.issue_types.forEach(type => {
                    const button = document.createElement('button');
                    button.className = 'action-button';
                    button.id = `issue-type-${type.id}`;
                    button.innerHTML = `<span class="icon">${type.name.split(' ')[0]}</span>${type.name.substring(2)}`;
                    button.onclick = () => selectIssueType(type.id);
                    typesContainer.appendChild(button);
                });
                
                // Сбрасываем состояние
                selectedIssueType = null;
                selectedAnonymity = null;
                sosPseudonym = null;
                sosDescription = null;
                
                // Сбрасываем выделение всех кнопок
                setTimeout(() => {
                    const allButtons = document.querySelectorAll('#sos-issue-types .action-button, #sos-anonymity-options .action-button');
                    allButtons.forEach(btn => {
                        btn.style.background = '';
                        btn.style.boxShadow = '';
                        btn.style.transform = '';
                    });
                }, 100);
                
                // Скрываем все секции
                document.getElementById('sos-anonymity-section').style.display = 'none';
                document.getElementById('sos-anonymity-options').style.display = 'none';
                document.getElementById('sos-pseudonym-section').style.display = 'none';
                document.getElementById('sos-description-section').style.display = 'none';
                document.getElementById('sos-confirmation-section').style.display = 'none';
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Ошибка загрузки данных');
            }
        }
        
        function selectIssueType(typeId) {
            selectedIssueType = typeId;
            
            // Убираем выделение со всех кнопок типов проблем
            const allTypeButtons = document.querySelectorAll('#sos-issue-types .action-button');
            allTypeButtons.forEach(btn => {
                btn.style.background = '';
                btn.style.boxShadow = '';
                btn.style.transform = '';
            });
            
            // Выделяем выбранную кнопку
            const selectedButton = document.getElementById(`issue-type-${typeId}`);
            if (selectedButton) {
                selectedButton.style.background = 'linear-gradient(45deg, #ff6b6b, #ee5a24)';
                selectedButton.style.boxShadow = '0 0 20px rgba(255, 107, 107, 0.5)';
                selectedButton.style.transform = 'scale(1.05)';
            }
            
            // Показываем секцию выбора анонимности
            document.getElementById('sos-anonymity-section').style.display = 'block';
            document.getElementById('sos-anonymity-options').style.display = 'grid';
            
            // Заполняем опции анонимности
            const anonymityContainer = document.getElementById('sos-anonymity-options');
            anonymityContainer.innerHTML = '';
            
            sosOptions.anonymity_options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'action-button';
                button.id = `anonymity-${option.id}`;
                button.innerHTML = `<span class="icon">${option.name.split(' ')[0]}</span>${option.name.substring(2)}`;
                button.onclick = () => selectAnonymity(option.id);
                anonymityContainer.appendChild(button);
            });
        }
        
        function selectAnonymity(anonymityId) {
            selectedAnonymity = anonymityId;
            
            // Убираем выделение со всех кнопок анонимности
            const allAnonymityButtons = document.querySelectorAll('#sos-anonymity-options .action-button');
            allAnonymityButtons.forEach(btn => {
                btn.style.background = '';
                btn.style.boxShadow = '';
                btn.style.transform = '';
            });
            
            // Выделяем выбранную кнопку
            const selectedButton = document.getElementById(`anonymity-${anonymityId}`);
            if (selectedButton) {
                selectedButton.style.background = 'linear-gradient(45deg, #5f27cd, #341f97)';
                selectedButton.style.boxShadow = '0 0 20px rgba(95, 39, 205, 0.5)';
                selectedButton.style.transform = 'scale(1.05)';
            }
            
            if (anonymityId === 'anonymous') {
                // Показываем поле для ввода псевдонима
                document.getElementById('sos-pseudonym-section').style.display = 'block';
                document.getElementById('sos-description-section').style.display = 'none';
            } else {
                // Переходим сразу к описанию
                document.getElementById('sos-pseudonym-section').style.display = 'none';
                document.getElementById('sos-description-section').style.display = 'block';
            }
        }
        
        function selectSosPseudonym() {
            const pseudonymInput = document.getElementById('sos-pseudonym');
            sosPseudonym = pseudonymInput.value.trim();
            
            if (!sosPseudonym) {
                tg.showAlert('Пожалуйста, введите псевдоним');
                return;
            }
            
            // Переходим к описанию
            document.getElementById('sos-pseudonym-section').style.display = 'none';
            document.getElementById('sos-description-section').style.display = 'block';
        }
        
        async function submitSos() {
            try {
                // Получаем описание
                const descriptionInput = document.getElementById('sos-description');
                sosDescription = descriptionInput.value.trim();
                
                if (!sosDescription) {
                    tg.showAlert('Пожалуйста, опишите проблему');
                    return;
                }
                
                if (sosDescription.length < 10) {
                    tg.showAlert('Описание должно содержать минимум 10 символов');
                    return;
                }
                
                const response = await fetch('http://localhost:5000/api/sos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        issue_type: selectedIssueType,
                        anonymity: selectedAnonymity,
                        description: sosDescription,
                        pseudonym: sosPseudonym || ''
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    tg.showAlert(result.message);
                    // Если обращение создано, показываем чат
                    if (result.issue_id) {
                        setTimeout(() => {
                            showIssueChat(result.issue_id);
                        }, 1000);
                    } else {
                        showMainApp();
                    }
                } else {
                    tg.showAlert('Ошибка: ' + result.error);
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Произошла ошибка при отправке');
            }
        }
        
        async function showSickLeaveModal() {
            try {
                // Загружаем опции больничного
                const response = await fetch('http://localhost:5000/api/sick-leave', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки данных');
                }

                sickLeaveOptions = await response.json();
                
                // Показываем модальное окно
                document.getElementById('app').style.display = 'none';
                document.getElementById('sick-leave-modal').style.display = 'block';
                
                // Заполняем типы больничного
                const typesContainer = document.getElementById('sick-leave-types');
                typesContainer.innerHTML = '';
                
                sickLeaveOptions.leave_types.forEach(type => {
                    const button = document.createElement('button');
                    button.className = 'btn';
                    button.innerHTML = `<span class="dot dot-sick"></span><span>${type.name}</span>`;
                    button.onclick = () => selectLeaveType(type.id);
                    typesContainer.appendChild(button);
                });
                
                // Сбрасываем состояние
                selectedLeaveType = null;
                document.getElementById('sick-leave-form-section').style.display = 'none';
                
                // Очищаем форму
                document.getElementById('sick-leave-number').value = '';
                document.getElementById('sick-leave-start-date').value = '';
                document.getElementById('sick-leave-end-date').value = '';
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Ошибка загрузки данных');
            }
        }
        
        function selectLeaveType(typeId) {
            selectedLeaveType = typeId;
            
            // Показываем форму
            document.getElementById('sick-leave-form-section').style.display = 'block';
            
            // Устанавливаем сегодняшнюю дату по умолчанию
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('sick-leave-start-date').value = today;
            document.getElementById('sick-leave-end-date').value = today;
        }
        
        function setSickLeaveDate(dateType) {
            const startDateInput = document.getElementById('sick-leave-start-date');
            const endDateInput = document.getElementById('sick-leave-end-date');
            
            let dateValue = '';
            
            if (dateType === 'today') {
                dateValue = sickLeaveOptions.date_suggestions.today;
            } else if (dateType === 'yesterday') {
                dateValue = sickLeaveOptions.date_suggestions.yesterday;
            } else if (dateType === 'week_ago') {
                dateValue = sickLeaveOptions.date_suggestions.week_ago;
            }
            
            startDateInput.value = dateValue;
            
            // Если дата окончания не установлена или меньше даты начала, устанавливаем её равной дате начала
            if (!endDateInput.value || endDateInput.value < dateValue) {
                endDateInput.value = dateValue;
            }
        }
        
        async function submitSickLeave() {
            try {
                const leaveNumber = document.getElementById('sick-leave-number').value.trim();
                const startDate = document.getElementById('sick-leave-start-date').value;
                const endDate = document.getElementById('sick-leave-end-date').value;
                
                if (!leaveNumber) {
                    tg.showAlert('Пожалуйста, введите номер ЭЛН');
                    return;
                }
                
                if (!startDate || !endDate) {
                    tg.showAlert('Пожалуйста, укажите даты больничного');
                    return;
                }
                
                if (startDate > endDate) {
                    tg.showAlert('Дата начала не может быть позже даты окончания');
                    return;
                }
                
                const response = await fetch('http://localhost:5000/api/sick-leave', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        leave_type: selectedLeaveType,
                        leave_number: leaveNumber,
                        start_date: startDate,
                        end_date: endDate
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    tg.showAlert(result.message);
                    showMainApp();
                } else {
                    tg.showAlert('Ошибка: ' + result.error);
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Произошла ошибка при сохранении');
            }
        }
        
        async function showAbsenceModal() {
            try {
                // Загружаем опции отсутствия
                const response = await fetch('http://localhost:5000/api/absence', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки данных');
                }

                absenceOptions = await response.json();
                
                // Показываем модальное окно
                document.getElementById('app').style.display = 'none';
                document.getElementById('absence-modal').style.display = 'block';
                
                // Заполняем даты
                const datesContainer = document.getElementById('absence-dates');
                datesContainer.innerHTML = '';
                
                absenceOptions.dates.forEach(date => {
                    const button = document.createElement('button');
                    button.className = 'btn';
                    button.innerHTML = `<span class="dot dot-absence"></span><span>${date.name}</span>`;
                    button.onclick = () => selectAbsenceDate(date.id, date.date);
                    datesContainer.appendChild(button);
                });
                
                // Сбрасываем состояние
                selectedAbsenceDate = null;
                selectedAbsenceTime = null;
                customAbsenceDate = null;
                customAbsenceStartTime = null;
                customAbsenceEndTime = null;
                
                // Скрываем секции времени и подтверждения
                document.getElementById('absence-time-section').style.display = 'none';
                document.getElementById('absence-times').style.display = 'none';
                document.getElementById('absence-custom-date').style.display = 'none';
                document.getElementById('absence-custom-time').style.display = 'none';
                document.getElementById('absence-confirmation-section').style.display = 'none';
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Ошибка загрузки данных');
            }
        }
        
        function selectAbsenceDate(dateId, dateValue) {
            selectedAbsenceDate = dateId;
            
            if (dateId === 'custom') {
                // Показываем поле для ввода даты
                document.getElementById('absence-custom-date').style.display = 'block';
                document.getElementById('absence-time-section').style.display = 'none';
                document.getElementById('absence-times').style.display = 'none';
            } else {
                // Показываем секцию выбора времени
                document.getElementById('absence-time-section').style.display = 'block';
                document.getElementById('absence-times').style.display = 'grid';
                document.getElementById('absence-custom-date').style.display = 'none';
                
                // Заполняем времена
                const timesContainer = document.getElementById('absence-times');
                timesContainer.innerHTML = '';
                
                absenceOptions.times.forEach(time => {
                    const button = document.createElement('button');
                    button.className = 'action-button';
                    button.innerHTML = `<span class="icon">⏰</span>${time.name.substring(2)}`;
                    button.onclick = () => selectAbsenceTime(time.id, time.start, time.end);
                    timesContainer.appendChild(button);
                });
            }
        }
        
        function selectAbsenceCustomDate() {
            const dateInput = document.getElementById('absence-date');
            customAbsenceDate = dateInput.value;
            
            if (!customAbsenceDate) {
                tg.showAlert('Пожалуйста, выберите дату');
                return;
            }
            
            // Показываем секцию выбора времени
            document.getElementById('absence-time-section').style.display = 'block';
            document.getElementById('absence-times').style.display = 'grid';
            document.getElementById('absence-custom-date').style.display = 'none';
            
            // Заполняем времена
            const timesContainer = document.getElementById('absence-times');
            timesContainer.innerHTML = '';
            
            absenceOptions.times.forEach(time => {
                const button = document.createElement('button');
                button.className = 'action-button';
                button.innerHTML = `<span class="icon">⏰</span>${time.name.substring(2)}`;
                button.onclick = () => selectAbsenceTime(time.id, time.start, time.end);
                timesContainer.appendChild(button);
            });
        }
        
        function selectAbsenceTime(timeId, startTime, endTime) {
            selectedAbsenceTime = timeId;
            
            if (timeId === 'custom') {
                // Показываем поля для ввода времени
                document.getElementById('absence-custom-time').style.display = 'block';
                document.getElementById('absence-confirmation-section').style.display = 'none';
            } else {
                customAbsenceStartTime = startTime;
                customAbsenceEndTime = endTime;
                
                // Показываем подтверждение
                showAbsenceConfirmation();
            }
        }
        
        function showAbsenceConfirmation() {
            // Определяем дату
            let dateText = '';
            let dateValue = '';
            
            if (selectedAbsenceDate === 'custom') {
                const date = new Date(customAbsenceDate);
                dateText = date.toLocaleDateString('ru-RU');
                dateValue = customAbsenceDate;
            } else {
                const dateOption = absenceOptions.dates.find(d => d.id === selectedAbsenceDate);
                dateText = dateOption.name.substring(dateOption.name.indexOf('(') + 1, dateOption.name.indexOf(')'));
                dateValue = dateOption.date;
            }
            
            // Определяем время
            let timeText = '';
            let startTimeValue = '';
            let endTimeValue = '';
            
            if (selectedAbsenceTime === 'custom') {
                startTimeValue = document.getElementById('absence-start-time').value;
                endTimeValue = document.getElementById('absence-end-time').value;
                timeText = `${startTimeValue} - ${endTimeValue}`;
            } else {
                const timeOption = absenceOptions.times.find(t => t.id === selectedAbsenceTime);
                timeText = timeOption.name.substring(timeOption.name.indexOf('(') + 1, timeOption.name.indexOf(')'));
                startTimeValue = customAbsenceStartTime;
                endTimeValue = customAbsenceEndTime;
            }
            
            // Показываем подтверждение
            document.getElementById('absence-confirmation-text').innerHTML = 
                `Дата: <strong>${dateText}</strong><br>Время: <strong>${timeText}</strong>`;
            
            document.getElementById('absence-custom-time').style.display = 'none';
            document.getElementById('absence-confirmation-section').style.display = 'block';
        }
        
        async function submitAbsence() {
            try {
                // Если выбрано свое время, получаем значения из полей
                if (selectedAbsenceTime === 'custom') {
                    customAbsenceStartTime = document.getElementById('absence-start-time').value;
                    customAbsenceEndTime = document.getElementById('absence-end-time').value;
                    
                    if (!customAbsenceStartTime || !customAbsenceEndTime) {
                        tg.showAlert('Пожалуйста, укажите время начала и окончания');
                        return;
                    }
                }
                
                // Определяем дату
                let dateValue = '';
                
                if (selectedAbsenceDate === 'custom') {
                    dateValue = customAbsenceDate;
                }
                
                const response = await fetch('http://localhost:5000/api/absence', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        date_option: selectedAbsenceDate,
                        custom_date: dateValue,
                        time_option: selectedAbsenceTime,
                        start_time: customAbsenceStartTime,
                        end_time: customAbsenceEndTime
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    tg.showAlert(result.message);
                    showMainApp();
                } else {
                    tg.showAlert('Ошибка: ' + result.error);
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Произошла ошибка при сохранении');
            }
        }

        async function showWorkModeModal() {
            try {
                // Загружаем опции режима работы
                const response = await fetch('http://localhost:5000/api/work-mode', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки данных');
                }

                workModeOptions = await response.json();
                
                // Показываем модальное окно
                document.getElementById('app').style.display = 'none';
                document.getElementById('work-mode-modal').style.display = 'block';
                
                // Заполняем режимы работы
                const modesContainer = document.getElementById('work-modes');
                modesContainer.innerHTML = '';
                
                workModeOptions.modes.forEach(mode => {
                    const button = document.createElement('button');
                    button.className = 'btn';
                    button.innerHTML = `<span class="dot dot-mode"></span><span>${mode.name}</span>`;
                    button.onclick = () => selectWorkMode(mode.id);
                    modesContainer.appendChild(button);
                });
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Ошибка загрузки данных');
            }
        }

        function selectWorkMode(mode) {
            selectedMode = mode;
            
            // Показываем секцию выбора периода
            document.getElementById('period-section').style.display = 'block';
            document.getElementById('work-periods').style.display = 'grid';
            
            // Заполняем периоды
            const periodsContainer = document.getElementById('work-periods');
            periodsContainer.innerHTML = '';
            
            workModeOptions.periods.forEach(period => {
                const button = document.createElement('button');
                button.className = 'btn';
                button.innerHTML = `<span class="dot dot-holiday"></span><span>${period.name}</span>`;
                button.onclick = () => selectPeriod(period.id);
                periodsContainer.appendChild(button);
            });
        }

        function selectPeriod(period) {
            selectedPeriod = period;
            
            if (period === 'custom') {
                // Показываем поля для ввода дат
                document.getElementById('custom-period').style.display = 'block';
                document.getElementById('confirmation-section').style.display = 'none';
            } else {
                // Показываем подтверждение
                showConfirmation();
            }
        }

        function showConfirmation() {
            const modeText = workModeOptions.modes.find(m => m.id === selectedMode).name;
            const periodText = workModeOptions.periods.find(p => p.id === selectedPeriod).name;
            
            document.getElementById('confirmation-text').innerHTML = 
                `Режим: <strong>${modeText}</strong><br>Период: <strong>${periodText}</strong>`;
            
            document.getElementById('custom-period').style.display = 'none';
            document.getElementById('confirmation-section').style.display = 'block';
        }

        async function submitWorkMode() {
            try {
                let startDate = null;
                let endDate = null;
                
                if (selectedPeriod === 'custom') {
                    startDate = document.getElementById('start-date').value;
                    endDate = document.getElementById('end-date').value;
                    
                    if (!startDate || !endDate) {
                        tg.showAlert('Пожалуйста, укажите даты');
                        return;
                    }
                }
                
                const response = await fetch('http://localhost:5000/api/work-mode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        mode: selectedMode,
                        period: selectedPeriod,
                        start_date: startDate,
                        end_date: endDate
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    tg.showAlert(result.message);
                    showMainApp();
                } else {
                    tg.showAlert('Ошибка: ' + result.error);
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Произошла ошибка при сохранении');
                        }
        }
        
        async function showSosMenuModal() {
            try {
                // Останавливаем автообновление диалога
                stopDialogAutoRefresh();
                
                // Скрываем все модальные окна
                document.getElementById('app').style.display = 'none';
                document.getElementById('sos-modal').style.display = 'none';
                
                // Показываем модальное окно меню SOS
                document.getElementById('sos-menu-modal').style.display = 'block';
                
                // Загружаем список обращений
                await loadMyIssues();
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Ошибка загрузки меню SOS');
            }
        }
        
        async function loadMyIssues() {
            try {
                const response = await fetch(`http://localhost:5000/api/my-issues?initData=${encodeURIComponent(tg.initData)}`, {
                    method: 'GET'
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки обращений');
                }

                const data = await response.json();
                displayMyIssuesList(data.issues);
                
            } catch (error) {
                console.error('Ошибка:', error);
                document.getElementById('sos-issues-list').innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">Ошибка загрузки обращений</div>';
            }
        }
        
        function displayMyIssuesList(issues) {
            const container = document.getElementById('sos-issues-list');
            
            if (!issues || issues.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">У вас пока нет обращений</div>';
                return;
            }
            
            let html = '<div style="padding: 10px;">';
            
            issues.forEach(issue => {
                let statusIcon = '🟡';
                let statusText = 'Активно';
                let statusColor = '#ffa500';
                if (issue.status === 'closed') {
                    statusIcon = '🔴';
                    statusText = 'Закрыто';
                    statusColor = '#ff4757';
                } else if (issue.status === 'resolved') {
                    statusIcon = '🟢';
                    statusText = 'Решено';
                    statusColor = '#2ed573';
                }
                
                const typeIcon = issue.type === 'personal' ? '💔' : '🖥';
                const typeText = issue.type === 'personal' ? 'Личная проблема' : 'Техническая проблема';
                const anonymityText = issue.is_anonymous ? ` (${issue.pseudonym || 'Анонимно'})` : '';
                
                // Индикатор новых ответов
                const newResponsesBadge = issue.has_new_responses ? 
                    '<span style="background: #ff4757; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: 5px;">НОВЫЕ ОТВЕТЫ</span>' : '';
                
                // Для закрытых обращений убираем возможность клика
                const clickHandler = issue.status === 'closed' ? '' : 'onclick="openMyIssueDialog(' + issue.id + ')"';
                const cursorStyle = issue.status === 'closed' ? 'cursor: not-allowed; opacity: 0.6;' : 'cursor: pointer;';
                
                html += '<div style="background: rgba(255,255,255,0.1); margin: 10px 0; padding: 15px; border-radius: 8px; ' + cursorStyle + '" ' + clickHandler + '>';
                html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">';
                html += '<div style="font-weight: bold;">' + typeIcon + ' Обращение #' + issue.id + anonymityText + newResponsesBadge + '</div>';
                html += '<div style="font-size: 12px; color: ' + statusColor + ';">' + statusIcon + ' ' + statusText + '</div>';
                html += '</div>';
                html += '<div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-bottom: 5px;">' + typeText + '</div>';
                html += '<div style="font-size: 14px; margin-bottom: 8px;">' + issue.description + '</div>';
                
                if (issue.status === 'closed') {
                    html += '<div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-bottom: 5px;">🔒 Обращение закрыто - просмотр недоступен</div>';
                }
                
                html += '<div style="font-size: 12px; color: rgba(255,255,255,0.6);">Создано: ' + new Date(issue.created_at).toLocaleString('ru-RU') + '</div>';
                
                if (issue.admin_response_count > 0) {
                    html += '<div style="font-size: 12px; color: rgba(255,255,255,0.6);">Ответов администратора: ' + issue.admin_response_count + '</div>';
                }
                
                if (issue.last_admin_response_preview) {
                    html += '<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.2);">';
                    html += '<div style="font-size: 12px; color: rgba(255,255,255,0.6);">Последний ответ администратора:</div>';
                    html += '<div style="font-size: 13px; color: rgba(255,255,255,0.8);">' + issue.last_admin_response_preview + '</div>';
                    html += '</div>';
                }
                
                html += '</div>';
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        let currentMyIssueId = null;
        let dialogRefreshInterval = null;
        let currentDialogMessagesCount = 0;
        let lastDialogData = null;
        let currentUserData = null;
        let dialogOpenedFromNotification = false;
        
        function startDialogAutoRefresh() {
            // Останавливаем предыдущий интервал, если он есть
            if (dialogRefreshInterval) {
                clearInterval(dialogRefreshInterval);
            }
            
            // Запускаем автообновление каждые 3 секунды
            dialogRefreshInterval = setInterval(async () => {
                try {
                    // Проверяем, какой диалог открыт
                    if (currentMyIssueId && document.getElementById('my-issue-dialog-modal').style.display === 'block') {
                        // Пользовательский диалог - умное обновление
                        await smartUpdateDialog(currentMyIssueId, true);
                    } else if (currentIssueId && document.getElementById('issue-dialog-modal').style.display === 'block') {
                        // Админский диалог - умное обновление
                        await smartUpdateDialog(currentIssueId, false);
                    }
                } catch (error) {
                    console.error('Ошибка автообновления диалога:', error);
                }
            }, 3000);
        }
        
        function stopDialogAutoRefresh() {
            if (dialogRefreshInterval) {
                clearInterval(dialogRefreshInterval);
                dialogRefreshInterval = null;
            }
            // Сбрасываем состояние диалога
            currentDialogMessagesCount = 0;
            lastDialogData = null;
        }
        
        // Умное обновление диалога - добавляет только новые сообщения
        async function smartUpdateDialog(issueId, isUserDialog = true) {
            try {
                const apiUrl = isUserDialog 
                    ? `/api/my-issue/${issueId}/dialog?initData=${encodeURIComponent(tg.initData)}`
                    : `/api/admin/issue/${issueId}/dialog?initData=${encodeURIComponent(tg.initData)}`;
                
                const response = await fetch(apiUrl, { method: 'GET' });
                
                if (!response.ok) {
                    return;
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    return;
                }
                
                // Проверяем, изменилось ли количество сообщений
                const newMessagesCount = data.responses ? data.responses.length : 0;
                
                if (newMessagesCount === currentDialogMessagesCount) {
                    // Нет новых сообщений, не обновляем
                    return;
                }
                
                if (currentDialogMessagesCount === 0 || !lastDialogData) {
                    // Первая загрузка или полное обновление
                    if (isUserDialog) {
                        displayMyIssueDialog(data);
                    } else {
                        displayIssueDialog(data);
                    }
                    currentDialogMessagesCount = newMessagesCount;
                    lastDialogData = data;
                    return;
                }
                
                // Добавляем только новые сообщения
                if (newMessagesCount > currentDialogMessagesCount) {
                    const newMessages = data.responses.slice(currentDialogMessagesCount);
                    appendNewMessages(newMessages, isUserDialog, data.issue.employee_phone);
                    currentDialogMessagesCount = newMessagesCount;
                    lastDialogData = data;
                }
                
            } catch (error) {
                console.error('Ошибка умного обновления диалога:', error);
            }
        }
        
        // Добавляет одно новое сообщение в диалог
        function addMessageToDialog(messageText, isFromCurrentUser, isUserDialog) {
            const containerId = isUserDialog ? 'my-issue-dialog-content' : 'issue-dialog-content';
            const container = document.getElementById(containerId);
            
            if (!container) return;
            
            // Находим контейнер с сообщениями
            let messagesContainer = container.querySelector('.dialog-messages');
            if (!messagesContainer) {
                // Если контейнера нет, создаем его в конце основного контейнера
                messagesContainer = document.createElement('div');
                messagesContainer.className = 'dialog-messages';
                messagesContainer.style.cssText = 'margin-bottom: 20px; max-height: 300px; overflow-y: auto;';
                container.appendChild(messagesContainer);
            }
            
            // Создаем новое сообщение
            const messageDiv = document.createElement('div');
            const currentTime = new Date().toLocaleString('ru-RU');
            
            if (isUserDialog) {
                // Пользовательский диалог
                const bgColor = isFromCurrentUser ? 'rgba(255, 255, 255, 0.1)' : 'rgba(46, 213, 115, 0.2)';
                const align = isFromCurrentUser ? 'margin-right: 20px;' : 'margin-left: 20px;';
                const senderText = isFromCurrentUser ? '👤 Вы' : '👨‍💼 Администратор';
                
                messageDiv.style.cssText = `background: ${bgColor}; padding: 12px; border-radius: 8px; margin-bottom: 10px; ${align}`;
                messageDiv.innerHTML = `
                    <div style="font-size: 14px; margin-bottom: 5px;">${messageText}</div>
                    <div style="font-size: 11px; color: rgba(255,255,255,0.6); text-align: right;">
                        ${senderText} • ${currentTime}
                    </div>
                `;
            } else {
                // Админский диалог
                const bgColor = isFromCurrentUser ? 'rgba(46, 213, 115, 0.2)' : 'rgba(255, 255, 255, 0.1)';
                const align = isFromCurrentUser ? 'margin-left: 20px;' : 'margin-right: 20px;';
                const senderText = isFromCurrentUser ? '👨‍💼 Администратор' : '👤 Сотрудник';
                
                messageDiv.style.cssText = `background: ${bgColor}; padding: 12px; border-radius: 8px; margin-bottom: 10px; ${align}`;
                messageDiv.innerHTML = `
                    <div style="font-size: 14px; margin-bottom: 5px;">${messageText}</div>
                    <div style="font-size: 11px; color: rgba(255,255,255,0.6); text-align: right;">
                        ${senderText} • ${currentTime}
                    </div>
                `;
            }
            
            // Добавляем сообщение в конец
            messagesContainer.appendChild(messageDiv);
            
            // Прокручиваем к последнему сообщению
            setTimeout(() => {
                // Прокручиваем новое сообщение в видимую область
                messageDiv.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'end',
                    inline: 'nearest'
                });
            }, 100);
        }

        // Добавляет новые сообщения в конец диалога
        function appendNewMessages(newMessages, isUserDialog, employeePhone) {
            const containerId = isUserDialog ? 'my-issue-dialog-content' : 'issue-dialog-content';
            const container = document.getElementById(containerId);
            
            if (!container) return;
            
            // Находим контейнер с сообщениями
            let messagesContainer = container.querySelector('.dialog-messages');
            if (!messagesContainer) {
                // Если контейнера нет, создаем его
                messagesContainer = document.createElement('div');
                messagesContainer.className = 'dialog-messages';
                container.appendChild(messagesContainer);
            }
            
            newMessages.forEach(response => {
                const messageDiv = document.createElement('div');
                const isFromEmployee = response.responder_phone === employeePhone;
                const messageClass = isFromEmployee ? 'user-message' : 'admin-message';
                
                messageDiv.className = `message ${messageClass}`;
                messageDiv.style.cssText = `
                    margin: 10px 0;
                    padding: 12px 15px;
                    border-radius: 12px;
                    max-width: 80%;
                    word-wrap: break-word;
                    ${isFromEmployee ? 
                        'background: linear-gradient(45deg, #667eea, #764ba2); color: white; margin-left: auto; text-align: right;' : 
                        'background: rgba(255,255,255,0.1); color: white; margin-right: auto;'
                    }
                `;
                
                const senderName = isFromEmployee ? 'Сотрудник' : 'Администратор';
                const messageTime = new Date(response.created_at).toLocaleString('ru-RU');
                
                messageDiv.innerHTML = `
                    <div style="font-size: 12px; opacity: 0.7; margin-bottom: 5px;">
                        👤 ${senderName} • ${messageTime}
                    </div>
                    <div>${response.response_text}</div>
                `;
                
                messagesContainer.appendChild(messageDiv);
            });
            
            // Прокручиваем к последнему сообщению
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        async function openMyIssueDialog(issueId) {
            try {
                currentMyIssueId = issueId;
                
                // Скрываем все окна
                document.getElementById('app').style.display = 'none';
                document.getElementById('sos-menu-modal').style.display = 'none';
                
                // Показываем модальное окно диалога
                document.getElementById('my-issue-dialog-modal').style.display = 'block';
                
                // Загружаем историю диалога
                await loadMyIssueDialog(issueId);
                
                // Отмечаем ответы как прочитанные
                await markResponsesAsRead(issueId);
                
                // Запускаем автообновление диалога
                startDialogAutoRefresh();
                
            } catch (error) {
                console.error('Ошибка открытия диалога:', error);
                tg.showAlert('Ошибка открытия диалога с обращением');
            }
        }
        
        async function loadMyIssueDialog(issueId) {
            try {
                const container = document.getElementById('my-issue-dialog-content');
                container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">Загрузка диалога...</div>';
                
                const response = await fetch(`/api/my-issue/${issueId}/dialog?initData=${encodeURIComponent(tg.initData)}`, {
                    method: 'GET'
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки диалога');
                }

                const data = await response.json();
                
                // Проверяем статус обращения - если закрыто, блокируем доступ для пользователей
                if (data.issue && data.issue.status === 'closed') {
                    container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">' +
                        '<div style="font-size: 18px; margin-bottom: 10px;">🔒</div>' +
                        '<div>Это обращение закрыто</div>' +
                        '<div style="font-size: 14px; margin-top: 10px; color: rgba(255,255,255,0.5);">Вы не можете добавлять новые сообщения в закрытое обращение</div>' +
                        '</div>';
                    
                    // Скрываем поле ввода для закрытых обращений
                    const inputContainer = document.querySelector('#my-issue-dialog-modal div[style*="position: fixed"]');
                    if (inputContainer) {
                        inputContainer.style.display = 'none';
                    }
                    return;
                }
                
                displayMyIssueDialog(data);
                
                // Показываем поле ввода для активных обращений
                const inputContainer = document.querySelector('#my-issue-dialog-modal div[style*="position: fixed"]');
                if (inputContainer) {
                    inputContainer.style.display = 'block';
                }
                
                // Инициализируем счетчик сообщений для умного обновления
                currentDialogMessagesCount = data.responses ? data.responses.length : 0;
                lastDialogData = data;
                
            } catch (error) {
                console.error('Ошибка загрузки диалога:', error);
                document.getElementById('my-issue-dialog-content').innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">Ошибка загрузки диалога</div>';
            }
        }
        
        function displayMyIssueDialog(data) {
            const container = document.getElementById('my-issue-dialog-content');
            const issue = data.issue;
            const responses = data.responses || [];
            
            let html = '<div style="margin-bottom: 20px;">';
            
            // Информация об обращении
            const typeIcon = issue.type === 'personal' ? '💔' : '🖥';
            const typeText = issue.type === 'personal' ? 'Личная проблема' : 'Техническая проблема';
            const anonymityText = issue.is_anonymous ? ` (${issue.pseudonym || 'Анонимно'})` : '';
            
            html += '<div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">';
            html += '<div style="font-weight: bold; margin-bottom: 10px;">' + typeIcon + ' Обращение #' + issue.id + anonymityText + '</div>';
            html += '<div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-bottom: 5px;">' + typeText + '</div>';
            html += '<div style="font-size: 14px; margin-bottom: 8px;">' + issue.description + '</div>';
            html += '<div style="font-size: 12px; color: rgba(255,255,255,0.6);">Создано: ' + new Date(issue.created_at).toLocaleString('ru-RU') + '</div>';
            html += '</div>';
            
            // История ответов
            if (responses.length > 0) {
                html += '<div class="dialog-messages" style="margin-bottom: 20px; max-height: 300px; overflow-y: auto;">';
                html += '<div style="font-weight: bold; margin-bottom: 15px;">История диалога:</div>';
                
                responses.forEach(response => {
                    const isAdmin = response.responder_phone === 'admin';
                    const bgColor = isAdmin ? 'rgba(46, 213, 115, 0.2)' : 'rgba(255, 255, 255, 0.1)';
                    const align = isAdmin ? 'margin-left: 20px;' : 'margin-right: 20px;';
                    
                    html += '<div style="background: ' + bgColor + '; padding: 12px; border-radius: 8px; margin-bottom: 10px; ' + align + '">';
                    html += '<div style="font-size: 14px; margin-bottom: 5px;">' + response.response_text + '</div>';
                    html += '<div style="font-size: 11px; color: rgba(255,255,255,0.6); text-align: right;">';
                    html += (isAdmin ? '👨‍💼 Администратор' : '👤 Вы') + ' • ' + new Date(response.created_at).toLocaleString('ru-RU');
                    html += '</div>';
                    html += '</div>';
                });
                
                html += '</div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
            
            // Прокручиваем вниз к последним сообщениям
            setTimeout(() => {
                const scrollableContainer = document.getElementById('my-issue-dialog-scroll');
                if (scrollableContainer) {
                    console.log('Прокручиваем диалог пользователя вниз');
                    scrollableContainer.scrollTop = scrollableContainer.scrollHeight;
                } else {
                    console.log('Контейнер my-issue-dialog-scroll не найден');
                }
            }, 100);
        }
        
        async function sendMyResponse() {
            try {
                const input = document.getElementById('my-response-input');
                const responseText = input.value.trim();
                
                if (!responseText) {
                    tg.showAlert('Введите текст ответа');
                    return;
                }
                
                const response = await fetch(`/api/my-issue/${currentMyIssueId}/respond`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        response_text: responseText
                    })
                });

                if (!response.ok) {
                    throw new Error('Ошибка отправки ответа');
                }

                // Добавляем сообщение в диалог локально
                addMessageToDialog(responseText, true, true);
                
                // Очищаем поле ввода
                input.value = '';
                
                // Увеличиваем счетчик сообщений (добавили новое сообщение)
                currentDialogMessagesCount++;
                
            } catch (error) {
                console.error('Ошибка отправки ответа:', error);
                tg.showAlert('Ошибка отправки ответа');
            }
        }
        
        function handleMyResponseEnterKey(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendMyResponse();
            }
        }
        
        
        async function showIssueChat(issueId) {
            try {
                currentIssueId = issueId;
                
                // Загружаем данные чата
                const response = await fetch(`/api/issue-chat/${issueId}?initData=${encodeURIComponent(tg.initData)}`, {
                    method: 'GET'
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки чата');
                }

                const chatData = await response.json();
                
                // Показываем модальное окно чата
                document.getElementById('app').style.display = 'none';
                document.getElementById('work-mode-modal').style.display = 'none';
                document.getElementById('absence-modal').style.display = 'none';
                document.getElementById('sos-modal').style.display = 'none';
                document.getElementById('sos-menu-modal').style.display = 'none';
                document.getElementById('sick-leave-modal').style.display = 'none';
                document.getElementById('issue-chat-modal').style.display = 'block';
                
                // Заполняем информацию об обращении
                const issue = chatData.issue;
                document.getElementById('chat-title').textContent = `💬 Обращение #${issue.id}`;
                
                let issueTypeText = issue.type === 'personal' ? '💔 Личная проблема' : '🖥 Техническая проблема';
                if (issue.is_anonymous) {
                    issueTypeText += ' (анонимно)';
                    if (issue.pseudonym) {
                        issueTypeText += ` - ${issue.pseudonym}`;
                    }
                }
                
                document.getElementById('issue-title').textContent = issueTypeText;
                document.getElementById('issue-description').textContent = issue.description;
                
                // Отображаем сообщения
                displayChatMessages(chatData.messages);
                
                // Проверяем статус обращения
                if (issue.status === 'closed') {
                    // Обращение закрыто - скрываем поле ввода и показываем сообщение
                    document.getElementById('chat-input-area').style.display = 'none';
                    document.getElementById('chat-closed-message').style.display = 'block';
                } else {
                    // Обращение активно - показываем поле ввода
                    document.getElementById('chat-input-area').style.display = 'flex';
                    document.getElementById('chat-closed-message').style.display = 'none';
                    
                    // Запускаем автообновление чата
                    if (chatRefreshInterval) {
                        clearInterval(chatRefreshInterval);
                    }
                    chatRefreshInterval = setInterval(() => {
                        refreshChat();
                    }, 3000); // Обновляем каждые 3 секунды
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Ошибка загрузки чата');
            }
        }
        
        function displayChatMessages(messages) {
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = '';
            
            messages.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.style.marginBottom = '15px';
                
                const isFromAdmin = message.from_admin;
                const alignment = isFromAdmin ? 'left' : 'right';
                const bgColor = isFromAdmin ? 'rgba(74, 144, 226, 0.3)' : 'rgba(76, 205, 196, 0.3)';
                const textAlign = isFromAdmin ? 'left' : 'right';
                
                messageDiv.innerHTML = `
                    <div style="text-align: ${textAlign};">
                        <div style="display: inline-block; max-width: 70%; padding: 10px 15px; background: ${bgColor}; border-radius: 12px; text-align: left;">
                            <div style="font-weight: bold; margin-bottom: 5px; color: rgba(255,255,255,0.8); font-size: 12px;">
                                ${isFromAdmin ? '👨‍💼 Администратор' : '👤 Вы'}
                            </div>
                            <div style="color: white;">
                                ${message.text}
                            </div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 5px;">
                                ${new Date(message.timestamp).toLocaleString('ru-RU')}
                            </div>
                        </div>
                    </div>
                `;
                
                messagesContainer.appendChild(messageDiv);
            });
            
            // Прокручиваем к последнему сообщению
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        async function refreshChat() {
            if (!currentIssueId) return;
            
            try {
                const response = await fetch(`/api/issue-chat/${currentIssueId}?initData=${encodeURIComponent(tg.initData)}`, {
                    method: 'GET'
                });

                if (response.ok) {
                    const chatData = await response.json();
                    displayChatMessages(chatData.messages);
                }
            } catch (error) {
                console.error('Ошибка обновления чата:', error);
            }
        }
        
        async function sendChatMessage() {
            if (!currentIssueId) return;
            
            const messageInput = document.getElementById('chat-message-input');
            const messageText = messageInput.value.trim();
            
            if (!messageText) {
                tg.showAlert('Введите сообщение');
                return;
            }
            
            try {
                const response = await fetch(`/api/issue-chat/${currentIssueId}/message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        message: messageText
                    })
                });

                if (response.ok) {
                    messageInput.value = '';
                    // Обновляем чат
                    await refreshChat();
                } else {
                    const result = await response.json();
                    tg.showAlert('Ошибка: ' + result.error);
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Произошла ошибка при отправке сообщения');
            }
        }
        
        // Обработка Enter в поле ввода сообщения
        // Принудительное обновление кеша
        if (window.performance && window.performance.navigation.type === 1) {
            // Страница была перезагружена - очищаем кеш
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                });
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Скрываем индикатор дизайна через 3 секунды
            setTimeout(() => {
                const indicator = document.getElementById('design-indicator');
                if (indicator) {
                    indicator.style.opacity = '0';
                    indicator.style.transition = 'opacity 0.5s ease';
                    setTimeout(() => indicator.style.display = 'none', 500);
                }
            }, 3000);
            const messageInput = document.getElementById('chat-message-input');
            if (messageInput) {
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendChatMessage();
                    }
                });
            }
            
            // Уведомления отключены
            // checkNewResponsesOnLoad();
            // setInterval(checkNewResponsesOnLoad, 30000);
        });
        
        // Проверка новых ответов при загрузке
        async function checkNewResponsesOnLoad() {
            try {
                console.log('Проверяем новые ответы...');
                const response = await fetch(`/api/check-new-responses?initData=${encodeURIComponent(tg.initData)}`, {
                    method: 'GET'
                });

                if (!response.ok) {
                    console.log('Ошибка проверки новых ответов:', response.status);
                    return; // Не показываем ошибку, если проверка не удалась
                }

                const data = await response.json();
                console.log('Ответ API check-new-responses:', data);
                
                if (data.success && data.total_count > 0) {
                    // Показываем popup с новыми ответами
                    let message;
                    
                    if (data.issues_with_new_responses.length === 1) {
                        // Одно обращение
                        const issue = data.issues_with_new_responses[0];
                        const typeIcon = issue.issue_type === 'personal' ? '💔' : '🖥';
                        message = `${typeIcon} Обращение #${issue.issue_id}\n`;
                        message += `${issue.description}\n\n`;
                        message += `Новых ответов: ${issue.new_responses_count}`;
                    } else {
                        // Несколько обращений
                        message = `У вас ${data.total_count} новых ответов на обращения:\n\n`;
                        
                        data.issues_with_new_responses.forEach(issue => {
                            const typeIcon = issue.issue_type === 'personal' ? '💔' : '🖥';
                            message += `${typeIcon} Обращение #${issue.issue_id}\n`;
                            message += `${issue.description}\n`;
                            message += `Новых ответов: ${issue.new_responses_count}\n\n`;
                        });
                    }
                    
                    const buttonText = data.issues_with_new_responses.length === 1 ? 'Открыть диалог' : 'Посмотреть все';
                    
                    tg.showPopup({
                        title: '📩 Новые ответы!',
                        message: message,
                        buttons: [
                            {id: 'view', type: 'default', text: buttonText},
                            {id: 'later', type: 'cancel', text: 'Позже'}
                        ]
                    }, function(buttonId) {
                        if (buttonId === 'view') {
                            // Проверяем роль пользователя
                            const isAdmin = currentUserData && currentUserData.user && currentUserData.user.is_admin;
                            
                            if (isAdmin) {
                                // Админ переходит в управление обращениями
                                if (data.issues_with_new_responses.length === 1) {
                                    const issueId = data.issues_with_new_responses[0].issue_id;
                                    // Устанавливаем флаг, что диалог открыт из уведомления
                                    dialogOpenedFromNotification = true;
                                    // Открываем админский диалог
                                    openIssueDialog(issueId);
                                } else {
                                    // Показываем управление обращениями
                                    showIssuesManagement();
                                }
                            } else {
                                // Обычный пользователь переходит в свои обращения
                                if (data.issues_with_new_responses.length === 1) {
                                    const issueId = data.issues_with_new_responses[0].issue_id;
                                    // Устанавливаем флаг, что диалог открыт из уведомления
                                    dialogOpenedFromNotification = true;
                                    // Открываем пользовательский диалог
                                    openMyIssueDialog(issueId);
                                } else {
                                    // Показываем список "Мои обращения"
                                    showSosMenuModal();
                                }
                            }
                        }
                    });
                }
                
            } catch (error) {
                console.error('Ошибка проверки новых ответов:', error);
                // Не показываем ошибку пользователю
            }
        }
        
        // Отметить ответы как прочитанные
        async function markResponsesAsRead(issueId) {
            try {
                console.log('Отмечаем ответы как прочитанные для обращения:', issueId);
                const response = await fetch(`/api/mark-responses-read/${issueId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData
                    })
                });
            } catch (error) {
                console.error('Ошибка отметки как прочитанное:', error);
            }
        }
        
        function closeMyIssueDialog() {
            // Останавливаем автообновление диалога
            stopDialogAutoRefresh();
            
            // Скрываем диалог
            document.getElementById('my-issue-dialog-modal').style.display = 'none';
            
            // Очищаем поле ввода ответа
            const responseInput = document.getElementById('my-response-input');
            if (responseInput) {
                responseInput.value = '';
            }
            
            // Проверяем, откуда был открыт диалог
            if (dialogOpenedFromNotification) {
                // Если из уведомления - возвращаемся к главному экрану
                dialogOpenedFromNotification = false;
                showMainApp();
            } else {
                // Если из списка обращений - возвращаемся к списку
                showSosMenuModal();
            }
        }
        
        function closeIssueDialog() {
            // Останавливаем автообновление диалога
            stopDialogAutoRefresh();
            
            // Скрываем диалог
            document.getElementById('issue-dialog-modal').style.display = 'none';
            
            // Очищаем поле ввода ответа
            const responseInput = document.getElementById('admin-response-input');
            if (responseInput) {
                responseInput.value = '';
            }
            
            // Проверяем, откуда был открыт диалог
            if (dialogOpenedFromNotification) {
                // Если из уведомления - возвращаемся к главному экрану
                dialogOpenedFromNotification = false;
                showMainApp();
            } else {
                // Если из списка обращений - возвращаемся к списку
                showIssuesManagement();
            }
        }

        function showSosMenuModal() {
            // Останавливаем автообновление диалога
            stopDialogAutoRefresh();
            
            // Скрываем все окна
            document.getElementById('app').style.display = 'none';
            document.getElementById('sos-modal').style.display = 'none';
            document.getElementById('my-issue-dialog-modal').style.display = 'none';
            
            // Очищаем поле ввода ответа
            const responseInput = document.getElementById('my-response-input');
            if (responseInput) {
                responseInput.value = '';
            }
            
            // Показываем SOS меню "Мои обращения"
            document.getElementById('sos-menu-modal').style.display = 'block';
            
            // Перезагружаем список обращений
            loadMyIssues();
        }
        
        function showMainApp() {
            // Останавливаем автообновление диалога
            stopDialogAutoRefresh();
            
            // Добавляем анимацию исчезновения для модальных окон
            const modals = [
                'work-mode-modal', 'absence-modal', 'sos-modal', 'sos-menu-modal',
                'sick-leave-modal', 'issue-chat-modal', 'admin-menu-modal'
            ];
            
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal && modal.style.display !== 'none') {
                    modal.classList.add('animate-slide-out');
                    setTimeout(() => {
                        modal.style.display = 'none';
                        modal.classList.remove('animate-slide-out');
                    }, 300);
                } else if (modal) {
                    modal.style.display = 'none';
                }
            });
            
            // Показываем главное приложение с анимацией
            const app = document.getElementById('app');
            app.style.display = 'block';
            app.classList.add('animate-fade-in');
            document.getElementById('employees-management-modal').style.display = 'none';
            document.getElementById('issues-management-modal').style.display = 'none';
            document.getElementById('broadcast-modal').style.display = 'none';
            document.getElementById('add-employee-modal').style.display = 'none';
            document.getElementById('edit-employee-modal').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            
            // Останавливаем автообновление чата
            if (chatRefreshInterval) {
                clearInterval(chatRefreshInterval);
                chatRefreshInterval = null;
            }
            currentIssueId = null;
            
            // Сброс состояния режима работы
            selectedMode = null;
            selectedPeriod = null;
            document.getElementById('period-section').style.display = 'none';
            document.getElementById('work-periods').style.display = 'none';
            document.getElementById('custom-period').style.display = 'none';
            document.getElementById('confirmation-section').style.display = 'none';
            
            // Сброс состояния отсутствия
            selectedAbsenceDate = null;
            selectedAbsenceTime = null;
            customAbsenceDate = null;
            customAbsenceStartTime = null;
            customAbsenceEndTime = null;
            
            // Сброс состояния SOS
            selectedIssueType = null;
            selectedAnonymity = null;
            sosPseudonym = null;
            sosDescription = null;
            
            // Сброс состояния больничного
            selectedLeaveType = null;
        }

        // Загружаем данные пользователя при загрузке страницы
        loadUserData();

        // Адаптивный дизайн
        (function(){
            function applyCompact() {
                const w = window.innerWidth; 
                const h = window.innerHeight;
                // Убираем компактный режим - всегда используем полный размер
                const compact = false;
                document.body.classList.toggle('compact', compact);
                document.documentElement.style.setProperty('--vh', `${h * 0.01}px`);
            }
            window.addEventListener('resize', applyCompact, { passive: true });
            applyCompact();
        })();
    </script>
</body>
</html>
