<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="cache-control" content="no-cache">
    <meta name="cache-bust" content="maria-bot-v1.12.32-20250918">
    <meta name="version" content="maria-bot-v1.12.32">
    <meta http-equiv="Last-Modified" content="0">
    <meta http-equiv="If-Modified-Since" content="0">
    <title>NBtender — Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // Принудительная очистка всех видов кеша
        (function() {
            // Очистка localStoage
            try { localStorage.clear(); } catch(e) {}
            
            // Очистка sesionStorage  
            try { sessionStorage.clear(); } catch(e) {}
            
            // Очистка Service Worker кеша
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    for(let registration of registrations) {
                        registration.unregister();
                    }
                });
            }
             
            // Очистка Cache API
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    for (let name of names) {
                        caches.delete(name);
                    }
                });
            }
            
            // Принудительная перезагрузка стилей
            const timestamp = new Date().getTime();
            const links = document.querySelectorAll('link[rel="stylesheet"]');
            links.forEach(link => {
                const href = link.href.split('?')[0];
                link.href = href + '?v=' + timestamp;
            });
        })();
    </script>
    <style>
        :root {
            --bg: #eff6ff;
            --ink: #0f172a;
            --muted: #64748b;
            --graphite-700: #474A51;
            --navy-700: #1e3a5f;
            --navy-600: #274b7a;
            --accent: #4338ca;
            --danger: #ef4444;

            --fs-base: 16px;
            --btn-h: 52px;
            --radius: 14px;
            --pad: 16px;
            --dot: 8px;

            --shadow: 0 6px 18px rgba(2, 6, 23, .12);
            --shadow-strong: 0 10px 26px rgba(2, 6, 23, .18);
        }
 
        body {
            margin: 0; 
            font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; 
            background: #eff6ff; 
            color: var(--ink); 
            font-size: var(--fs-base); 
            min-height: 100vh;
        }
  
        .wrap { 
            max-width: 440px; 
            margin: 0 auto;
            padding: var(--pad) var(--pad) var(--pad); 
            box-sizing: border-box; 
            min-height: 100vh;
        }

        header { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            margin-bottom: 8px; 
        }

        .avatar {
            width: 44px; 
            height: 44px; 
            border-radius: 50%;
            background: #d1d5db; 
            overflow: hidden; 
        }

        .title { 
            font-weight: 700; 
            font-size: 17px; 
        }

        .subtitle { 
            font-size: 12px; 
            color: var(--muted); 
        }

        .stack { 
            display: grid; 
            gap: 10px; 
            margin: 8px 0 16px; 
        }

        .card { 
            background: var(--graphite-700); 
            color: #f1f5f9; 
            border-radius: var(--radius); 
            padding: 12px 14px; 
            box-shadow: var(--shadow); 
        }

        .card h3 { 
            margin: 0 0 4px; 
            font-size: 14px; 
            font-weight: 800; 
            letter-spacing: .2px; 
        }

        .card p { 
            margin: 0; 
            font-size: 13px; 
            color: #cbd5e1; 
        }

        .actions { 
            display: grid; 
            gap: 12px; 
        }

        .btn { 
            position: relative; 
            height: var(--btn-h); 
            display: inline-flex; 
            align-items: center;
            justify-content: center; 
            gap: 8px;
            border: 0; 
            border-radius: var(--radius); 
            background: var(--navy-700); 
            color: #eef2ff; 
            font-size: 15px; 
            font-weight: 700; 
            box-shadow: var(--shadow); 
            cursor: pointer; 
            padding: 0 16px; 
            text-align: center;
            min-width: 280px;
            max-width: 350px;
            width: 100%;
            box-sizing: border-box;
        }

        .btn:after { 
            content:""; 
            position:absolute; 
            inset:0; 
            border-radius: inherit; 
            pointer-events:none;
            background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,0) 40%); 
        }

        .btn:hover { 
            background: var(--navy-600); 
            box-shadow: var(--shadow-strong); 
        }

        .btn:active { 
            transform: translateY(1px); 
        }

        .dot { 
            display:inline-block; 
            width: var(--dot); 
            height: var(--dot); 
            border-radius: 50%;
        }

        .dot-holiday{ background:#f59e0b; }
        .dot-mode{ background:#10b981; }
        .dot-absence{ background:#ef4444; }
        .dot-sick{ background:#8b5cf6; }
        .dot-crocotime{ background:#eab308; }

        .btn-accent { 
            background: var(--accent); 
        }

        /* SOS кнопка в общем стиле - как все остальные */

        .footer { 
            text-align:center; 
            margin-top: 10px; 
            color:#94a3b8; 
            font-size:12px; 
        }

        .compact .wrap { 
            padding: var(--pad) var(--pad) 96px; 
        }

        .compact .card { 
            padding: 12px 14px; 
        }

        .compact .btn { 
            height: var(--btn-h); 
            font-size: 15px; 
        }

        .compact .title { 
            font-size: 17px; 
        }

        .compact header { 
            gap: 12px; 
        }

        .compact .avatar { 
            width: 44px; 
            height: 44px; 
        }

        /* Modal styles for back buttons */
        .back-button {
            background: none;
            border: none;
            color: var(--ink);
            font-size: 24px;
            padding: 8px;
            cursor: pointer;
            border-radius: var(--radius);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        .back-button:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .back-button:active {
            background: rgba(0, 0, 0, 0.1);
            transform: scale(0.95);
        }

        .modal-header {
            display: flex;
            align-items: center;
            padding: 16px;
            background: var(--bg);
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .modal-title {
            flex: 1;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            color: var(--ink);
            margin: 0;
        }

        .modal-content {
            background: var(--bg);
            min-height: 100vh;
            padding-bottom: 100px;
        }

        /* Главное меню - голубой фон на весь экран */
        #app {
            background: #eff6ff;
            min-height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
        }

        /* Модальные окна - голубой фон и фиксированная структура */
        #work-mode-modal,
        #absence-modal,
        #sick-leave-modal,
        #admin-menu-modal,
        #sos-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #eff6ff;
            z-index: 1000;
            overflow-y: auto;
        }

        /* Все модальные окна имеют одинаковую структуру */
        #work-mode-modal .wrap,
        #absence-modal .wrap,
        #sick-leave-modal .wrap,
        #admin-menu-modal .wrap,
        #sos-modal .wrap {
            max-width: 440px;
            margin: 0 auto;
            padding: var(--pad) var(--pad) var(--pad);
            box-sizing: border-box;
            min-height: 100vh;
        }

        /* Все кнопки одинаковой ширины - уже в основном правиле .btn */
        
        /* Контейнеры кнопок - центрированные */
        .actions {
            display: grid;
            gap: 12px;
            justify-items: center;
        }
        
        /* Стандартный отступ для кнопок анонимности в SOS */
        #sos-anonymity-options.actions {
            gap: 12px !important;
        }
        
        /* Дополнительное правило для кнопок анонимности */
        #sos-anonymity-options {
            display: grid !important;
            gap: 12px !important;
            justify-items: center !important;
        }
        
        /* ПРИНУДИТЕЛЬНО УСТАНАВЛИВАЕМ ЦВЕТ ТЕКСТА ДЛЯ ВСЕХ ПОЛЕЙ ВВОДА */
        input[type="text"], input[type="date"], input[type="time"], textarea {
            color: white !important;
            background: #1e293b !important;
        }
        
        /* Специально для полей ввода в чатах */
        #my-response-input, #admin-response-input, #chat-message-input {
            color: white !important;
            background: #1e293b !important;
        }
    </style>
</head>
<body>
    <!-- Индикатор версии для проверки -->
    <div style="position: fixed; top: 10px; right: 10px; background: var(--accent); color: white; padding: 4px 8px; border-radius: 8px; font-size: 10px; z-index: 9999;">
        Maria Bot v1.12.32
    </div>
    
     
    <div class="wrap">
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Загружаем ваш профиль...</p>
        </div>

        <div id="error" class="error" style="display: none;">
            <p>Произошла ошибка при загрузке данных</p>
        </div>

        <div id="app" style="display: none;">
            <header>
                <div class="avatar" id="avatar"></div>
                <div>
                    <div class="title">Привет, <span id="name">Aleksei</span></div>
                    <div class="subtitle">Пользователь</div>
            </div>
            </header>

            <div class="stack">
                <div class="card" style="background: #065f46;"><h3>Сегодня</h3><p id="today-status">Удалённая работа</p></div>
                <div class="card" style="background: #ea580c;"><h3>Следующий отпуск</h3><p id="next-vacation">Отпуск не запланирован</p></div>
                <div class="card" style="background: #3730a3;"><h3>В этот день</h3><p id="today-message">Добро пожаловать в Maria Bot!</p></div>
                </div>

            <div class="actions">
                <button class="btn" onclick="handleAction('vacation')"><span class="dot dot-holiday"></span><span>Мой отпуск</span></button>
                <button class="btn" onclick="handleAction('work_mode')"><span class="dot dot-mode"></span><span>Режим работы</span></button>
                <button class="btn" onclick="handleAction('absence')"><span class="dot dot-absence"></span><span>Отсутствие</span></button>
                <button class="btn" onclick="handleAction('sick_leave')"><span class="dot dot-sick"></span><span>Больничный</span></button>
                <button class="btn" onclick="handleAction('crocotime')"><span class="dot dot-crocotime"></span><span>Мой Crocotime</span></button>
                <button class="btn" onclick="handleAction('sos')"><span class="dot dot-absence"></span><span>Нужна помощь</span></button>
                <button class="btn btn-accent" id="admin-btn" onclick="handleAction('admin')" style="display: none;">Меню администратора</button>
                    </div>
            <div class="footer">@NBtender_bot</div>
        </div>

        <!-- Work Mode Modal -->
        <div id="work-mode-modal" style="display: none;">
            <div class="wrap">
                <header style="margin-bottom: 20px;">
                    <button onclick="showMainApp()" class="back-button" style="background: none; border: none; color: var(--ink); font-size: 24px; padding: 8px; cursor: pointer; border-radius: var(--radius);">←</button>
                    <div style="flex: 1; text-align: center;">
                        <div class="title" style="margin: 0;">Режим работы</div>
            </div>
                    <div style="width: 40px;"></div>
                </header>

                <div class="stack" style="margin-bottom: 20px;">
                    <div class="card">
                        <h3>Выбери режим работы</h3>
                        <p>Установи твой текущий режим работы</p>
                    </div>
                </div>

                <div id="work-modes" class="actions">
                    <!-- Режимы работы будут загружены динамически -->
                </div>

                <div id="period-section" class="stack" style="display: none; margin-top: 20px;">
                    <div class="card">
                        <h3>Выбери период</h3>
                        <p>Укажи период действия режима</p>
                    </div>
                </div>

                <div id="work-periods" class="actions" style="display: none;">
                    <!-- Периоды будут загружены динамически -->
                </div>

                <div id="custom-period" class="stack" style="display: none; margin-top: 20px;">
                    <div class="card">
                        <h3>Укажи период</h3>
                        <div style="margin-top: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">Дата начала:</label>
                            <input type="date" id="start-date" style="width: calc(100% - 24px); padding: 12px; border-radius: var(--radius); border: 1px solid #a8a29e; background: #a8a29e; color: white; margin-bottom: 15px; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">
                            
                            <label style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">Дата окончания:</label>
                            <input type="date" id="end-date" style="width: calc(100% - 24px); padding: 12px; border-radius: var(--radius); border: 1px solid #a8a29e; background: #a8a29e; color: white; margin-bottom: 20px; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">
                        </div>
                    </div>
                    <button onclick="submitWorkMode()" class="btn" style="background: #0d9488; width: 100%;">
                        <span class="dot" style="background: #10b981;"></span>
                        <span>Подтвердить</span>
                    </button>
                </div>

                <div id="confirmation-section" class="stack" style="display: none; margin-top: 20px;">
                    <div class="card" style="background: #474A51; margin-bottom: 20px;">
                        <h3>Подтверждение</h3>
                        <p id="confirmation-text" style="font-size: 16px; line-height: 1.4;"><!-- Текст подтверждения --></p>
                        </div>
                    <div class="actions">
                        <button onclick="confirmWorkMode()" class="btn" style="background: #0d9488;">
                            <span class="dot" style="background: #10b981;"></span>
                            <span>Подтвердить</span>
                            </button>
                        <button onclick="showMainApp()" class="btn" style="background: #7f1d1d;">
                            <span class="dot" style="background: #ef4444;"></span>
                            <span>Отменить</span>
                            </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Absence Modal -->
        <div id="absence-modal" style="display: none;">
            <div class="wrap">
                <header style="margin-bottom: 20px;">
                    <button onclick="showMainApp()" class="back-button" style="background: none; border: none; color: var(--ink); font-size: 24px; padding: 8px; cursor: pointer; border-radius: var(--radius);">←</button>
                    <div style="flex: 1; text-align: center;">
                        <div class="title" style="margin: 0;">Отсутствие</div>
            </div>
                    <div style="width: 40px;"></div>
                </header>

                <div class="stack" style="margin-bottom: 20px;">
                    <div class="card" style="background: var(--danger); color: white;">
                        <h3>⚠️ Важно!</h3>
                        <p><strong>СНАЧАЛА СОГЛАСУЙ С РУКОВОДИТЕЛЕМ, ЧТОБЫ ОН ЗНАЛ, ЧТО ТЫ ОТСУТСТВУЕШЬ!</strong></p>
                </div>
                    <div class="card" id="absence-date-section">
                        <h3>Выберите дату</h3>
                        <p>Укажите дату вашего отсутствия</p>
                    </div>
                </div>

                <div id="absence-dates" class="actions">
                    <!-- Даты будут загружены динамически -->
                </div>

                <div id="absence-time-section" class="stack" style="display: none; margin-top: 20px;">
                    <div class="card">
                        <h3>Выберите время</h3>
                        <p>Укажите время вашего отсутствия</p>
                    </div>
                </div>

                <div id="absence-times" class="actions" style="display: none;">
                    <!-- Времена будут загружены динамически -->
                </div>

                <div id="absence-custom-date" class="stack" style="display: none; margin-top: 20px;">
                    <div class="card">
                        <h3>Укажите дату</h3>
                        <div style="margin-top: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">Дата отсутствия:</label>
                            <input type="date" id="absence-date" style="width: calc(100% - 24px); padding: 12px; border-radius: var(--radius); border: 1px solid #a8a29e; background: #a8a29e; color: white; margin-bottom: 20px; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">
                        </div>
                    </div>
                    <button onclick="selectAbsenceCustomDate()" class="btn" style="background: #0d9488; width: 100%;">
                        <span class="dot" style="background: #10b981;"></span>
                        <span>Подтвердить</span>
                    </button>
                </div>

                <div id="absence-custom-time" class="stack" style="display: none; margin-top: 20px;">
                    <div class="card">
                        <h3>Укажите время</h3>
                        <div style="margin-top: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">Время начала:</label>
                            <input type="time" id="absence-start-time" style="width: calc(100% - 24px); padding: 12px; border-radius: var(--radius); border: 1px solid #a8a29e; background: #a8a29e; color: white; margin-bottom: 15px; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">
                            
                            <label style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">Время окончания:</label>
                            <input type="time" id="absence-end-time" style="width: calc(100% - 24px); padding: 12px; border-radius: var(--radius); border: 1px solid #a8a29e; background: #a8a29e; color: white; margin-bottom: 20px; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">
                        </div>
                    </div>
                    <button onclick="submitAbsence()" class="btn" style="background: #0d9488; width: 100%;">
                        <span class="dot" style="background: #10b981;"></span>
                        <span>Подтвердить</span>
                    </button>
                </div>

                <div id="absence-confirmation-section" class="stack" style="display: none; margin-top: 20px;">
                    <div class="card" style="background: #474A51; margin-bottom: 20px;">
                        <h3>Подтверждение</h3>
                        <p id="absence-confirmation-text" style="font-size: 16px; line-height: 1.4;"><!-- Текст подтверждения --></p>
                        </div>
                    <div class="actions">
                        <button onclick="confirmAbsence()" class="btn" style="background: #0d9488;">
                            <span class="dot" style="background: #10b981;"></span>
                            <span>Подтвердить</span>
                            </button>
                        <button onclick="showMainApp()" class="btn" style="background: #7f1d1d;">
                            <span class="dot" style="background: #ef4444;"></span>
                            <span>Отменить</span>
                            </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SOS Modal -->
        <div id="sos-modal" style="display: none;">
            <div class="wrap">
                <header style="margin-bottom: 20px;">
                    <button onclick="showMainApp()" class="back-button" style="background: none; border: none; color: var(--ink); font-size: 24px; padding: 8px; cursor: pointer; border-radius: var(--radius);">←</button>
                    <div style="flex: 1; text-align: center;">
                        <div class="title" style="margin: 0;">Нужна помощь</div>
                    </div>
                    <div style="width: 40px;"></div>
                </header>

                <div class="stack" style="margin-bottom: 20px;">
                    <div class="card">
                        <h3>Выбери тип проблемы</h3>
                        <p>Укажи, с чем связана твоя проблема</p>
                    </div>
                </div>

                <div id="sos-issue-types" class="actions">
                    <!-- Типы проблем будут загружены динамически -->
                </div>

                <!-- Кнопка "Мои обращения" -->
                <div class="actions" style="margin-top: 20px;">
                    <button onclick="showSosMenuModal()" class="btn" style="background: #667eea;">
                        <span class="dot" style="background: #764ba2;"></span>
                        <span>Мои обращения</span>
                    </button>
                </div>

                <div id="sos-anonymity-section" class="stack" style="display: none; margin-top: 20px;">
                    <div class="card">
                        <h3>Как ты хочешь обратиться?</h3>
                        <p>Выбери способ обращения</p>
                    </div>
                </div>

                <div id="sos-anonymity-options" class="actions" style="display: none; margin-top: 20px;">
                    <!-- Опции анонимности будут загружены динамически -->
                </div>

                <div id="sos-pseudonym-section" class="stack" style="display: none; margin-top: 20px;">
                    <div class="card">
                        <h3>Укажи псевдоним</h3>
                        <div style="margin-top: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">Псевдоним:</label>
                            <input type="text" id="sos-pseudonym" placeholder="Введи псевдоним" style="width: calc(100% - 24px); padding: 12px; border-radius: var(--radius); border: 1px solid #a8a29e; background: #a8a29e; color: white; margin-bottom: 15px; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">
                        </div>
                    </div>
                    
                    <div class="actions">
                        <button onclick="selectSosPseudonym()" class="btn" style="background: #0d9488;">
                            <span class="dot" style="background: #10b981;"></span>
                            <span>Продолжить</span>
                        </button>
                        <button onclick="showMainApp()" class="btn" style="background: #7f1d1d;">
                            <span class="dot" style="background: #ef4444;"></span>
                            <span>Отменить</span>
                        </button>
                    </div>
                </div>

                <div id="sos-description-section" class="stack" style="display: none; margin-top: 20px;">
                    <div class="card">
                        <h3>Опиши проблему</h3>
                        <div style="margin-top: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">Описание проблемы:</label>
                            <textarea id="sos-description" placeholder="Подробно опиши твою проблему (минимум 10 символов)" style="width: calc(100% - 24px); height: 120px; padding: 12px; border-radius: var(--radius); border: 1px solid #a8a29e; background: #a8a29e; color: white; margin-bottom: 15px; resize: vertical; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;"></textarea>
                        </div>
                    </div>
                    
                    <div class="actions">
                        <button onclick="submitSos()" class="btn" style="background: #0d9488;">
                            <span class="dot" style="background: #10b981;"></span>
                            <span>Подтвердить</span>
                        </button>
                        <button onclick="showMainApp()" class="btn" style="background: #7f1d1d;">
                            <span class="dot" style="background: #ef4444;"></span>
                            <span>Отменить</span>
                        </button>
                    </div>
                </div>

                <div id="sos-confirmation-section" class="stack" style="display: none; margin-top: 20px;">
                    <div class="card" style="background: #474A51; margin-bottom: 20px;">
                        <h3>Подтверждение</h3>
                        <p id="sos-confirmation-text" style="font-size: 16px; line-height: 1.4;"><!-- Текст подтверждения --></p>
                    </div>
                    <div class="actions">
                        <button onclick="confirmSos()" class="btn" style="background: #0d9488;">
                            <span class="dot" style="background: #10b981;"></span>
                            <span>Отправить</span>
                        </button>
                        <button onclick="showMainApp()" class="btn" style="background: #7f1d1d;">
                            <span class="dot" style="background: #ef4444;"></span>
                            <span>Отменить</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sick Leave Modal -->
        <div id="sick-leave-modal" style="display: none;">
            <div class="wrap">
                <header style="margin-bottom: 20px;">
                    <button onclick="showMainApp()" class="back-button" style="background: none; border: none; color: var(--ink); font-size: 24px; padding: 8px; cursor: pointer; border-radius: var(--radius);">←</button>
                    <div style="flex: 1; text-align: center;">
                        <div class="title" style="margin: 0;">Больничный лист</div>
                    </div>
                    <div style="width: 40px;"></div>
                </header>

                <div class="stack" style="margin-bottom: 20px;">
                    <div class="card" style="background: #8b5cf6; color: white;">
                        <h3>Мне очень жаль, что ты заболел(а)</h3>
                        <p>Давай внесем данные по больничному листу (ЭЛН)</p>
                    </div>

                    <div class="card">
                        <h3>Выбери тип больничного</h3>
                        <p>Укажи тип твоего больничного листа</p>
                    </div>
                </div>

                <div id="sick-leave-types" class="actions">
                    <!-- Типы больничного будут загружены динамически -->
                </div>

                <div id="sick-leave-form-section" class="stack" style="display: none; margin-top: 20px;">
                    <div class="card">
                        <h3>Данные больничного</h3>
                        <div style="margin-top: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">Номер ЭЛН:</label>
                            <input type="text" id="sick-leave-number" placeholder="Введите номер электронного листка нетрудоспособности" style="width: calc(100% - 24px); padding: 12px; border-radius: var(--radius); border: 1px solid #a8a29e; background: #a8a29e; color: white; margin-bottom: 15px; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">
                            
                            <label style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">Дата начала:</label>
                            <input type="date" id="sick-leave-start-date" style="width: calc(100% - 24px); padding: 12px; border-radius: var(--radius); border: 1px solid #a8a29e; background: #a8a29e; color: white; margin-bottom: 15px; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">
                            
                            <label style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">Дата окончания:</label>
                            <input type="date" id="sick-leave-end-date" style="width: calc(100% - 24px); padding: 12px; border-radius: var(--radius); border: 1px solid #a8a29e; background: #a8a29e; color: white; margin-bottom: 20px; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">
                        </div>
                    </div>
                    
                    <div class="actions">
                        <button onclick="submitSickLeave()" class="btn" style="background: #0d9488;">
                            <span class="dot" style="background: #10b981;"></span>
                            <span>Подтвердить</span>
                        </button>
                        <button onclick="showMainApp()" class="btn" style="background: #7f1d1d;">
                            <span class="dot" style="background: #ef4444;"></span>
                            <span>Отменить</span>
                        </button>
                    </div>
                </div>

                <div id="sick-leave-confirmation-section" class="stack" style="display: none; margin-top: 20px;">
                    <div class="card" style="background: #474A51; margin-bottom: 20px;">
                        <h3>Подтверждение</h3>
                        <p id="sick-leave-confirmation-text" style="font-size: 16px; line-height: 1.4;"><!-- Текст подтверждения --></p>
                    </div>
                    <div class="actions">
                        <button onclick="confirmSickLeave()" class="btn" style="background: #0d9488;">
                            <span class="dot" style="background: #10b981;"></span>
                            <span>Подтвердить</span>
                        </button>
                        <button onclick="cancelSickLeave()" class="btn" style="background: #7f1d1d;">
                            <span class="dot" style="background: #ef4444;"></span>
                            <span>Отменить</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SOS Menu Modal -->
        <div id="sos-menu-modal" style="display: none;">
            <div class="wrap">
                <header style="margin-bottom: 20px;">
                    <button onclick="showMainApp()" class="back-button" style="background: none; border: none; color: var(--ink); font-size: 24px; padding: 8px; cursor: pointer; border-radius: var(--radius);">←</button>
                    <div style="flex: 1; text-align: center;">
                        <div class="title" style="margin: 0;">Мои обращения</div>
            </div>
                    <div style="width: 40px;"></div>
                </header>

                <div class="stack" style="margin-bottom: 20px;">
                    <!-- Информация о разделе -->
                    <div class="card" style="background: #065f46; margin-bottom: 20px;">
                        <h3 style="font-size: 16px; line-height: 1.4;">📋 Ваши обращения</h3>
                        <p style="margin: 0; color: rgba(255,255,255,0.8); font-size: 14px;">
                        Здесь вы можете продолжить диалоги или создать новое обращение
                        </p>
                </div>

                    <!-- Список обращений -->
                    <div class="card" style="background: #474A51;">
                        <h3 style="font-size: 16px; line-height: 1.4;">💬 Список обращений</h3>
                        <div id="sos-issues-list">
                            <div style="text-align: center; color: var(--muted); padding: 20px;">
                                <div style="font-size: 16px;">📈 Загрузка обращений...</div>
                                <div style="font-size: 12px; margin-top: 8px;">Получение данных из базы</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- My Issue Dialog Modal -->
        <div id="my-issue-dialog-modal" style="display: none;">
            <div class="wrap">
                <header style="margin-bottom: 20px;">
                    <button onclick="closeMyIssueDialog()" class="back-button" style="background: none; border: none; color: var(--ink); font-size: 24px; padding: 8px; cursor: pointer; border-radius: var(--radius);">←</button>
                    <div style="flex: 1; text-align: center;">
                        <div class="title" style="margin: 0;">💬 Мое обращение</div>
            </div>
                    <div style="width: 40px;"></div>
                </header>

                <div class="stack" style="margin-bottom: 80px;">
                    <div class="card" style="background: #474A51; min-height: 60vh; max-height: 70vh; overflow-y: auto;">
                <div id="my-issue-dialog-content">
                    <div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">
                                <div style="font-size: 16px;">📈 Загрузка диалога...</div>
                                <div style="font-size: 12px; margin-top: 8px;">Получение данных из базы</div>
                            </div>
                    </div>
                </div>
            </div>
            
                <div style="position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg); padding: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div style="display: flex; gap: 10px; max-width: 100%; margin: 0 auto;">
                        <input type="text" id="my-response-input" placeholder="Введите ответ..." onkeypress="handleMyResponseEnterKey(event)" oninput="handleUserTyping()" 
                               style="flex: 1; padding: 12px 15px; border: none; border-radius: var(--radius); background: #1e293b; color: white; font-size: 14px; border: 1px solid rgba(255,255,255,0.2);">
                        <button onclick="sendMyResponse()" class="btn" 
                                style="background: var(--accent); color: white; border: none; padding: 12px 20px; border-radius: var(--radius); cursor: pointer; font-weight: 600; min-width: 100px;">
                            Отправить
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Employees Management Modal -->
        <div id="employees-management-modal" style="display: none;">
            <div class="wrap">
                <header style="margin-bottom: 20px;">
                    <button onclick="showAdminMenuModal()" class="back-button" style="background: none; border: none; color: var(--ink); font-size: 24px; padding: 8px; cursor: pointer; border-radius: var(--radius);">←</button>
                    <div style="flex: 1; text-align: center;">
                        <div class="title" style="margin: 0;">Управление сотрудниками</div>
                    </div>
                    <div style="width: 40px;"></div>
                </header>

                <div class="stack" style="margin-bottom: 20px;">
                    <div class="card">
                        <h3>Управление сотрудниками</h3>
                        <p>Добавление, редактирование и управление сотрудниками</p>
                    </div>
                </div>

                <div class="actions" style="margin-bottom: 20px;">
                    <button onclick="showAddEmployeeModal()" class="btn" style="background: #0d9488;">
                        <span class="dot" style="background: #10b981;"></span>
                        <span>Добавить сотрудника</span>
                    </button>
                </div>

                <div class="stack" style="margin-bottom: 20px;">
                    <div class="card">
                        <h3>Поиск и фильтры</h3>
                        <div style="margin-top: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">Поиск:</label>
                            <input type="text" id="employee-search" placeholder="Поиск по имени, фамилии..." 
                                   oninput="filterEmployees()" 
                                   style="width: calc(100% - 24px); padding: 12px; border-radius: var(--radius); border: 1px solid #a8a29e; background: #a8a29e; color: white; margin-bottom: 15px; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">
                            
                            <label style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">Статус:</label>
                            <select id="employee-status-filter" onchange="filterEmployees()" 
                                    style="width: calc(100% - 24px); padding: 12px; border-radius: var(--radius); border: 1px solid #a8a29e; background: #a8a29e; color: white; margin-bottom: 15px; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">
                                <option value="all" style="background: var(--bg); color: white;">Все статусы</option>
                                <option value="active" style="background: var(--bg); color: white;">Активные</option>
                                <option value="blocked" style="background: var(--bg); color: white;">Заблокированные</option>
                                <option value="admin" style="background: var(--bg); color: white;">Администраторы</option>
                            </select>
                            
                            <label style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">Роль:</label>
                            <select id="employee-type-filter" onchange="filterEmployees()" 
                                    style="width: calc(100% - 24px); padding: 12px; border-radius: var(--radius); border: 1px solid #a8a29e; background: #a8a29e; color: white; margin-bottom: 20px; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">
                                <option value="all" style="background: var(--bg); color: white;">Все роли</option>
                                <option value="admin" style="background: var(--bg); color: white;">Администраторы</option>
                                <option value="user" style="background: var(--bg); color: white;">Пользователи</option>
                            </select>
                        </div>
                        <div id="search-results-count" style="font-size: 12px; color: rgba(255, 255, 255, 0.6); margin-top: 10px;">
                            <!-- Счетчик результатов поиска -->
                        </div>
                        </div>
                    </div>

                <div class="stack">
                    <div class="card">
                        <h3>Список сотрудников</h3>
                        <div id="employees-list">
                            <div style="text-align: center; color: var(--muted); padding: 20px;">
                                <div style="font-size: 16px;">📈 Загрузка списка сотрудников...</div>
                                <div style="font-size: 12px; margin-top: 8px;">Получение данных из базы</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Employee Modal -->
        <div id="add-employee-modal" style="display: none;">
            <div class="wrap">
                <header style="margin-bottom: 20px;">
                    <button onclick="showEmployeesManagement()" class="back-button" style="background: none; border: none; color: var(--ink); font-size: 24px; padding: 8px; cursor: pointer; border-radius: var(--radius);">←</button>
                    <div style="flex: 1; text-align: center;">
                        <div class="title" style="margin: 0;">Добавить сотрудника</div>
                    </div>
                    <div style="width: 40px;"></div>
                </header>

                <div class="stack" style="margin-bottom: 20px;">
                    <div class="card" style="background: #474A51; margin-bottom: 20px;">
                        <h3 style="font-size: 16px; line-height: 1.4;">ℹ️ Информация</h3>
                        <p style="font-size: 16px; line-height: 1.4; color: rgba(255, 255, 255, 0.8);">Добавьте нового сотрудника в систему. После добавления он сможет авторизоваться в боте по номеру телефона.</p>
                    </div>

                    <div class="card">
                        <h3>Форма добавления</h3>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">Номер телефона:</label>
                            <input type="tel" id="add-phone" placeholder="+7XXXXXXXXXX" 
                                   style="width: calc(100% - 24px); padding: 12px; border-radius: var(--radius); border: 1px solid #a8a29e; background: #a8a29e; color: white; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin-bottom: 15px;">
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">Имя:</label>
                            <input type="text" id="add-first-name" placeholder="Введите имя" 
                                   style="width: calc(100% - 24px); padding: 12px; border-radius: var(--radius); border: 1px solid #a8a29e; background: #a8a29e; color: white; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin-bottom: 15px;">
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">Фамилия:</label>
                            <input type="text" id="add-last-name" placeholder="Введите фамилию" 
                                   style="width: calc(100% - 24px); padding: 12px; border-radius: var(--radius); border: 1px solid #a8a29e; background: #a8a29e; color: white; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin-bottom: 20px;">
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: flex; align-items: center; color: var(--text); cursor: pointer;">
                                <input type="checkbox" id="add-is-admin" style="margin-right: 10px; transform: scale(1.2);">
                                <span style="font-weight: bold;">Права администратора</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="actions">
                    <button onclick="addEmployee()" class="btn" style="height: var(--btn-h); font-size: 15px; font-weight: 700; background: #0d9488;">
                        <span class="dot" style="background: #10b981;"></span>
                        <span>Добавить сотрудника</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Edit Employee Modal -->
        <div id="edit-employee-modal" style="display: none;">
            <div class="wrap">
                <header style="margin-bottom: 20px;">
                    <button onclick="showEmployeesManagement()" class="back-button" style="background: none; border: none; color: var(--ink); font-size: 24px; padding: 8px; cursor: pointer; border-radius: var(--radius);">←</button>
                    <div style="flex: 1; text-align: center;">
                        <div class="title" style="margin: 0;">Редактировать сотрудника</div>
                    </div>
                    <div style="width: 40px;"></div>
                </header>

                <div class="stack" style="margin-bottom: 20px;">
                    <div class="card" style="background: #474A51; margin-bottom: 20px;">
                        <h3 style="font-size: 16px; line-height: 1.4;">⚠️ Внимание</h3>
                        <p style="font-size: 16px; line-height: 1.4; color: rgba(255, 255, 255, 0.8);">Изменение данных сотрудника повлияет на его доступ к системе</p>
                    </div>

                    <div class="card">
                        <h3>Форма редактирования</h3>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">Номер телефона:</label>
                            <input type="tel" id="edit-phone" readonly 
                                   style="width: calc(100% - 24px); padding: 12px; border-radius: var(--radius); border: 1px solid #6b7280; background: #6b7280; color: rgba(255,255,255,0.7); font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin-bottom: 15px;">
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">Имя:</label>
                            <input type="text" id="edit-first-name" placeholder="Введите имя" 
                                   style="width: calc(100% - 24px); padding: 12px; border-radius: var(--radius); border: 1px solid #a8a29e; background: #a8a29e; color: white; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin-bottom: 15px;">
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: #cbd5e1; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">Фамилия:</label>
                            <input type="text" id="edit-last-name" placeholder="Введите фамилию" 
                                   style="width: calc(100% - 24px); padding: 12px; border-radius: var(--radius); border: 1px solid #a8a29e; background: #a8a29e; color: white; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin-bottom: 20px;">
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: flex; align-items: center; color: var(--text); cursor: pointer;">
                                <input type="checkbox" id="edit-is-admin" style="margin-right: 10px; transform: scale(1.2);">
                                <span style="font-weight: bold;">Права администратора</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="actions">
                    <button onclick="saveEmployeeChanges()" class="btn" style="height: var(--btn-h); font-size: 15px; font-weight: 700; background: #f59e0b;">
                        <span class="dot" style="background: #fbbf24;"></span>
                        <span>Сохранить изменения</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Issues Management Modal -->
        <div id="issues-management-modal" style="display: none;">
            <div class="wrap">
                <header style="margin-bottom: 20px;">
                    <button onclick="showAdminMenuModal()" class="back-button" style="background: none; border: none; color: var(--ink); font-size: 24px; padding: 8px; cursor: pointer; border-radius: var(--radius);">←</button>
                    <div style="flex: 1; text-align: center;">
                        <div class="title" style="margin: 0;">Управление обращениями</div>
                    </div>
                    <div style="width: 40px;"></div>
                </header>

                <div class="stack" style="margin-bottom: 20px;">
                    <!-- Поиск и фильтры -->
                    <div class="card" style="background: #474A51; margin-bottom: 20px;">
                        <h3 style="font-size: 16px; line-height: 1.4;">🔍 Поиск и фильтры</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
                            <input type="text" id="issues-search" placeholder="Поиск по тексту..." 
                                   oninput="filterIssues()" 
                                   style="width: 100%; height: var(--btn-h); padding: 0 12px; border-radius: var(--radius); border: 1px solid #a8a29e; 
                                          background: #a8a29e; color: white; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; box-sizing: border-box;">
                            <div style="display: flex; gap: 10px;">
                            <select id="issues-status-filter" onchange="filterIssues()" 
                                        style="flex: 1; height: var(--btn-h); padding: 0 12px; border-radius: var(--radius); border: 1px solid #a8a29e; 
                                               background: #a8a29e; color: white; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; box-sizing: border-box;">
                                <option value="all">Все статусы</option>
                                <option value="open">Открытые</option>
                                <option value="in_progress">В работе</option>
                                <option value="closed">Закрытые</option>
                            </select>
                            <select id="issues-type-filter" onchange="filterIssues()" 
                                        style="flex: 1; height: var(--btn-h); padding: 0 12px; border-radius: var(--radius); border: 1px solid #a8a29e; 
                                               background: #a8a29e; color: white; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; box-sizing: border-box;">
                                <option value="all">Все типы</option>
                                <option value="technical">Технические</option>
                                <option value="personal">Личные</option>
                            </select>
                            </div>
                        </div>
                        <div id="issues-results-count" style="font-size: 12px; color: rgba(255, 255, 255, 0.6);">
                            <!-- Счетчик результатов поиска -->
                        </div>
                    </div>

                    <!-- Список обращений -->
                    <div class="card">
                        <h3>📋 Список обращений</h3>
                        <div id="issues-list">
                            <div style="text-align: center; color: var(--muted); padding: 20px;">
                                <div style="font-size: 16px;">📈 Загрузка списка обращений...</div>
                                <div style="font-size: 12px; margin-top: 8px;">Получение данных из базы</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Issue Dialog Modal -->
        <div id="issue-dialog-modal" style="display: none;">
            <div class="wrap">
                <header style="margin-bottom: 20px;">
                    <button onclick="closeIssueDialog()" class="back-button" style="background: none; border: none; color: var(--ink); font-size: 24px; padding: 8px; cursor: pointer; border-radius: var(--radius);">←</button>
                    <div style="flex: 1; text-align: center;">
                        <div class="title" style="margin: 0;">💬 Диалог с обращением</div>
            </div>
                    <div style="width: 40px;"></div>
                </header>

                <div class="stack" style="margin-bottom: 80px;">
                    <div class="card" style="background: #474A51; min-height: 60vh; max-height: 70vh; overflow-y: auto;">
                <div id="issue-dialog-content">
                    <div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">
                                <div style="font-size: 16px;">📈 Загрузка диалога...</div>
                                <div style="font-size: 12px; margin-top: 8px;">Получение данных из базы</div>
                            </div>
                    </div>
                </div>
            </div>
            
                <div style="position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg); padding: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div style="display: flex; gap: 10px; max-width: 100%; margin: 0 auto;">
                        <input type="text" id="admin-response-input" placeholder="Введите ответ..." onkeypress="handleEnterKey(event)" oninput="handleAdminTyping()"
                               style="flex: 1; padding: 12px 15px; border: none; border-radius: var(--radius); background: #1e293b; color: white; font-size: 14px; border: 1px solid rgba(255,255,255,0.2);">
                        <button onclick="sendAdminResponse()" class="btn" 
                                style="background: var(--accent); color: white; border: none; padding: 12px 20px; border-radius: var(--radius); cursor: pointer; font-weight: 600; min-width: 100px;">
                            Отправить
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Messaging Menu Modal -->
        <div id="messaging-menu-modal" style="display: none;">
            <div class="wrap">
                <header style="margin-bottom: 20px;">
                    <button onclick="showAdminMenuModal()" class="back-button" style="background: none; border: none; color: var(--ink); font-size: 24px; padding: 8px; cursor: pointer; border-radius: var(--radius);">←</button>
                    <div style="flex: 1; text-align: center;">
                        <div class="title" style="margin: 0;">Сообщение сотрудникам</div>
                    </div>
                    <div style="width: 40px;"></div>
                </header>

                <div class="actions">
                    <button onclick="showBroadcastMessage()" class="btn" style="height: var(--btn-h); font-size: 15px; font-weight: 700;">
                        <span class="dot" style="background: #ef4444;"></span>
                        <span>Сообщение всем</span>
                    </button>
                    <button onclick="showEmployeeMessageMenu()" class="btn" style="height: var(--btn-h); font-size: 15px; font-weight: 700;">
                        <span class="dot" style="background: #3b82f6;"></span>
                        <span>Сообщение сотруднику</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Broadcast Message Modal -->
        <div id="broadcast-modal" style="display: none;">
            <div class="wrap">
                <header style="margin-bottom: 20px;">
                    <button onclick="showMessagingMenu()" class="back-button" style="background: none; border: none; color: var(--ink); font-size: 24px; padding: 8px; cursor: pointer; border-radius: var(--radius);">←</button>
                    <div style="flex: 1; text-align: center;">
                        <div class="title" style="margin: 0;">Сообщение всем</div>
                    </div>
                    <div style="width: 40px;"></div>
                </header>

                <div class="stack" style="margin-bottom: 20px;">
                    <div class="card" style="background: #474A51; margin-bottom: 20px;">
                        <h3 style="font-size: 16px; line-height: 1.4;">⚠️ Внимание</h3>
                        <p style="font-size: 16px; line-height: 1.4; color: rgba(255, 255, 255, 0.8);">Сообщение будет отправлено всем сотрудникам, зарегистрированным в системе</p>
                    </div>

                    <div class="card">
                        <h3>Текст сообщения</h3>
                        <textarea id="broadcast-message" placeholder="Введите сообщение для рассылки..." 
                                  style="width: calc(100% - 24px); height: 120px; padding: 12px; border-radius: var(--radius); border: 1px solid #a8a29e; background: #a8a29e; color: white; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; resize: vertical; margin-bottom: 15px;"></textarea>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: rgba(255, 255, 255, 0.9); font-size: 14px; font-weight: 600;">📎 Прикрепить файл (необязательно)</label>
                            <div style="position: relative; width: calc(100% - 24px);">
                                <input type="file" id="broadcast-file" accept="*/*" 
                                       style="position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 2;"
                                       onchange="updateBroadcastFileInfo()">
                                <div id="broadcast-file-button" style="
                                    width: 100%; 
                                    padding: 12px; 
                                    border-radius: var(--radius); 
                                    border: 2px dashed rgba(255, 255, 255, 0.3); 
                                    background: rgba(255, 255, 255, 0.05); 
                                    color: rgba(255, 255, 255, 0.7); 
                                    font-size: 14px; 
                                    font-weight: 600; 
                                    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
                                    text-align: center;
                                    cursor: pointer;
                                    transition: all 0.2s ease;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    gap: 8px;
                                ">
                                    <span>📎</span>
                                    <span id="broadcast-file-button-text">Выбрать файл</span>
                                </div>
                            </div>
                            <div id="broadcast-file-info" style="margin-top: 8px; font-size: 12px; color: rgba(255, 255, 255, 0.7); display: none;">
                                <!-- Информация о выбранном файле -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="actions">
                    <button onclick="sendBroadcastMessage()" class="btn" style="height: var(--btn-h); font-size: 15px; font-weight: 700; background: #0d9488;">
                        <span class="dot" style="background: #10b981;"></span>
                        <span>Отправить всем</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Employee Message Modal -->
        <div id="employee-message-modal" style="display: none;">
            <div class="wrap">
                <header style="margin-bottom: 20px;">
                    <button onclick="showMessagingMenu()" class="back-button" style="background: none; border: none; color: var(--ink); font-size: 24px; padding: 8px; cursor: pointer; border-radius: var(--radius);">←</button>
                    <div style="flex: 1; text-align: center;">
                        <div class="title" style="margin: 0;">Сообщение сотруднику</div>
                    </div>
                    <div style="width: 40px;"></div>
                </header>

                <div class="stack" style="margin-bottom: 20px;">
                    <div class="card" style="background: #474A51; margin-bottom: 20px;">
                        <h3 style="font-size: 16px; line-height: 1.4;">👤 Выбор сотрудника</h3>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <input type="text" id="employee-message-search" placeholder="Поиск по имени, фамилии..." 
                                   oninput="filterEmployeesForMessage()" 
                                   style="flex: 1; padding: 12px; border-radius: var(--radius); border: 1px solid #a8a29e; 
                                          background: #a8a29e; color: white; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;">
                        </div>
                    </div>

                    <div class="card">
                        <h3>👥 Список сотрудников</h3>
                        <div id="employee-message-list">
                            <div style="text-align: center; color: var(--muted); padding: 20px;">
                                <div style="font-size: 16px;">📈 Загрузка списка сотрудников...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Send Message to Employee Modal -->
        <div id="send-employee-message-modal" style="display: none;">
            <div class="wrap">
                <header style="margin-bottom: 20px;">
                    <button onclick="showEmployeeMessageMenu()" class="back-button" style="background: none; border: none; color: var(--ink); font-size: 24px; padding: 8px; cursor: pointer; border-radius: var(--radius);">←</button>
                    <div style="flex: 1; text-align: center;">
                        <div class="title" style="margin: 0;" id="employee-message-title">Сообщение сотруднику</div>
                    </div>
                    <div style="width: 40px;"></div>
                </header>

                <div class="stack" style="margin-bottom: 20px;">
                    <div class="card" style="background: #474A51; margin-bottom: 20px;">
                        <h3 style="font-size: 16px; line-height: 1.4;">💬 Получатель</h3>
                        <p style="font-size: 16px; line-height: 1.4; color: rgba(255, 255, 255, 0.8);" id="selected-employee-info">Выбранный сотрудник</p>
                    </div>

                    <div class="card">
                        <h3>Текст сообщения</h3>
                        <textarea id="employee-message-text" placeholder="Введите сообщение для сотрудника..." 
                                  style="width: calc(100% - 24px); height: 120px; padding: 12px; border-radius: var(--radius); border: 1px solid #a8a29e; background: #a8a29e; color: white; font-size: 15px; font-weight: 700; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; resize: vertical; margin-bottom: 15px;"></textarea>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; color: rgba(255, 255, 255, 0.9); font-size: 14px; font-weight: 600;">📎 Прикрепить файл (необязательно)</label>
                            <div style="position: relative; width: calc(100% - 24px);">
                                <input type="file" id="employee-message-file" accept="*/*" 
                                       style="position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 2;"
                                       onchange="updateEmployeeFileInfo()">
                                <div id="employee-file-button" style="
                                    width: 100%; 
                                    padding: 12px; 
                                    border-radius: var(--radius); 
                                    border: 2px dashed rgba(255, 255, 255, 0.3); 
                                    background: rgba(255, 255, 255, 0.05); 
                                    color: rgba(255, 255, 255, 0.7); 
                                    font-size: 14px; 
                                    font-weight: 600; 
                                    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
                                    text-align: center;
                                    cursor: pointer;
                                    transition: all 0.2s ease;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    gap: 8px;
                                ">
                                    <span>📎</span>
                                    <span id="file-button-text">Выбрать файл</span>
                                </div>
                            </div>
                            <div id="employee-file-info" style="margin-top: 8px; font-size: 12px; color: rgba(255, 255, 255, 0.7); display: none;">
                                <!-- Информация о выбранном файле -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="actions">
                    <button onclick="sendEmployeeMessage()" class="btn" style="height: var(--btn-h); font-size: 15px; font-weight: 700; background: #0d9488;">
                        <span class="dot" style="background: #10b981;"></span>
                        <span>Отправить сообщение</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Admin Menu Modal -->
        <div id="admin-menu-modal" style="display: none;">
            <div class="wrap">
                <header>
                    <button onclick="showMainApp()" class="back-button">←</button>
                    <div>
                        <div class="title">👑 Меню администратора</div>
                        <div class="subtitle">Управление системой</div>
            </div>
                </header>

                <div class="stack">
                    <div class="card">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                            <h3 style="margin: 0;">📊 Общая статистика системы</h3>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="font-size: 12px; color: var(--muted);">Обновлено: <span id="stats-update-time">загрузка...</span></div>
                                <button onclick="loadAdminStats()" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); color: #3b82f6; border-radius: 6px; padding: 4px 8px; font-size: 12px; cursor: pointer;">🔄</button>
                            </div>
                        </div>
                        <div id="admin-stats-content">
                            <div style="text-align: center; padding: 20px; color: var(--muted);">
                                <div style="font-size: 16px;">📈 Загрузка статистики...</div>
                                <div style="font-size: 12px; margin-top: 8px;">Получение данных из базы</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="actions">
                    <button onclick="showEmployeesManagement()" class="btn">
                        <span class="dot" style="background: #10b981;"></span>
                        <span>Управление сотрудниками</span>
                    </button>
                    <button onclick="showIssuesManagement()" class="btn">
                        <span class="dot" style="background: #f59e0b;"></span>
                        <span>Управление обращениями</span>
                    </button>
                    <button onclick="sendStatsToChannel()" class="btn">
                        <span class="dot" style="background: #3b82f6;"></span>
                        <span>Отправить статистику в канал</span>
                    </button>
                    <button onclick="showMessagingMenu()" class="btn">
                        <span class="dot" style="background: #ef4444;"></span>
                        <span>Сообщение сотрудникам</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Issue Chat Modal -->
        <div id="issue-chat-modal" style="display: none;">
            <div class="header">
                <button onclick="showSosMenuModal()" style="background: none; border: none; color: white; font-size: 24px; float: left;">←</button>
                <h2 style="text-align: center; margin: 0;" id="chat-title">💬 Чат по обращению</h2>
            </div>

            <div style="padding: 20px; height: calc(100vh - 120px); display: flex; flex-direction: column;">
                <!-- Информация об обращении -->
                <div class="info-card" id="issue-info" style="margin-bottom: 15px;">
                    <div class="card-header">
                        <span class="card-icon">📋</span>
                        <span class="card-title" id="issue-title">Обращение</span>
                    </div>
                    <div class="card-content" id="issue-description">
                        <!-- Описание обращения -->
                    </div>
                </div>

                <!-- Область сообщений -->
                <div id="chat-messages" style="flex: 1; overflow-y: auto; background: rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                    <!-- Сообщения будут загружены динамически -->
                </div>

                <!-- Поле ввода сообщения -->
                <div id="chat-input-area" style="display: flex; gap: 10px;">
                    <input type="text" id="chat-message-input" placeholder="Введите сообщение..." style="flex: 1; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: #1e293b; color: white;">
                    <button onclick="sendChatMessage()" style="padding: 12px 20px; background: linear-gradient(45deg, #4ecdc4, #44a08d); border: none; border-radius: 8px; color: white; font-weight: bold;">
                        📤
                    </button>
                </div>
                
                <!-- Сообщение о закрытом обращении -->
                <div id="chat-closed-message" style="display: none; text-align: center; padding: 15px; background: rgba(255, 71, 87, 0.2); border-radius: 8px; color: #ff4757;">
                    <div style="font-size: 16px; font-weight: bold; margin-bottom: 5px;">🔴 Обращение закрыто</div>
                    <div style="font-size: 14px;">Администратор завершил это обращение. Вы не можете отправлять новые сообщения.</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        
        // Инициализируем Web App
        tg.ready();
        tg.expand();
        
        // Применяем тему Telegram
        document.body.style.backgroundColor = tg.themeParams.bg_color || '#667eea';

        async function showAdminMenuModal() {
            try {
                // Скрываем все модальные окна
                document.getElementById('app').style.display = 'none';
                document.getElementById('employees-management-modal').style.display = 'none';
                document.getElementById('issues-management-modal').style.display = 'none';
                document.getElementById('broadcast-modal').style.display = 'none';
                document.getElementById('messaging-menu-modal').style.display = 'none';
                document.getElementById('employee-message-modal').style.display = 'none';
                document.getElementById('send-employee-message-modal').style.display = 'none';
                document.getElementById('add-employee-modal').style.display = 'none';
                document.getElementById('edit-employee-modal').style.display = 'none';
                
                // Показываем админ-меню
                document.getElementById('admin-menu-modal').style.display = 'block';
                
                // Загружаем статистику
                await loadAdminStats();
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Ошибка загрузки админ-меню');
            }
        }
        
        async function loadAdminStats() {
            try {
                const response = await fetch(`http://localhost:5000/api/admin/stats?initData=${encodeURIComponent(tg.initData)}`, {
                    method: 'GET'
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки статистики');
                }

                const data = await response.json();
                const stats = data.stats;
                
                // Обновляем время последнего обновления
                const now = new Date();
                const timeString = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                document.getElementById('stats-update-time').textContent = timeString;
                
                const statsContent = document.getElementById('admin-stats-content');
                statsContent.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <!-- Основные показатели -->
                        <div style="text-align: center; padding: 15px; background: rgba(16, 185, 129, 0.15); border-radius: var(--radius); border: 1px solid rgba(16, 185, 129, 0.3);">
                            <div style="font-size: 28px; font-weight: bold; color: #10b981;">${stats.total_employees}</div>
                            <div style="font-size: 14px; color: var(--text); font-weight: 500; margin-top: 4px;">Всего сотрудников</div>
                            <div style="font-size: 11px; color: var(--muted); margin-top: 2px;">Активных: ${stats.active_employees || stats.total_employees}</div>
                        </div>
                        
                        <div style="text-align: center; padding: 15px; background: rgba(245, 158, 11, 0.15); border-radius: var(--radius); border: 1px solid rgba(245, 158, 11, 0.3);">
                            <div style="font-size: 28px; font-weight: bold; color: #f59e0b;">${stats.active_issues}</div>
                            <div style="font-size: 14px; color: var(--text); font-weight: 500; margin-top: 4px;">Активных обращений</div>
                            <div style="font-size: 11px; color: var(--muted); margin-top: 2px;">Сегодня: ${stats.issues_today || 0}</div>
                        </div>
                        
                        <div style="text-align: center; padding: 15px; background: rgba(59, 130, 246, 0.15); border-radius: var(--radius); border: 1px solid rgba(59, 130, 246, 0.3);">
                            <div style="font-size: 28px; font-weight: bold; color: #3b82f6;">${stats.issues_this_week}</div>
                            <div style="font-size: 14px; color: var(--text); font-weight: 500; margin-top: 4px;">Обращений за неделю</div>
                            <div style="font-size: 11px; color: var(--muted); margin-top: 2px;">Решено: ${stats.resolved_issues_week || 0}</div>
                        </div>
                        
                        <div style="text-align: center; padding: 15px; background: rgba(239, 68, 68, 0.15); border-radius: var(--radius); border: 1px solid rgba(239, 68, 68, 0.3);">
                            <div style="font-size: 28px; font-weight: bold; color: #ef4444;">${stats.current_sick_leaves}</div>
                            <div style="font-size: 14px; color: var(--text); font-weight: 500; margin-top: 4px;">На больничном</div>
                            <div style="font-size: 11px; color: var(--muted); margin-top: 2px;">Сейчас</div>
                        </div>
                        
                        <!-- Дополнительные показатели -->
                        <div style="text-align: center; padding: 15px; background: rgba(139, 92, 246, 0.15); border-radius: var(--radius); border: 1px solid rgba(139, 92, 246, 0.3);">
                            <div style="font-size: 28px; font-weight: bold; color: #8b5cf6;">${stats.users_with_bot || 0}</div>
                            <div style="font-size: 14px; color: var(--text); font-weight: 500; margin-top: 4px;">Пользователей бота</div>
                            <div style="font-size: 11px; color: var(--muted); margin-top: 2px;">${Math.round((stats.users_with_bot || 0)/(stats.total_employees || 1)*100)}% от всех</div>
                        </div>
                        
                        <div style="text-align: center; padding: 15px; background: rgba(168, 85, 247, 0.15); border-radius: var(--radius); border: 1px solid rgba(168, 85, 247, 0.3);">
                            <div style="font-size: 20px; font-weight: bold; color: #a855f7;">${(stats.technical_issues_month || 0)}/${(stats.personal_issues_month || 0)}</div>
                            <div style="font-size: 14px; color: var(--text); font-weight: 500; margin-top: 4px;">Тех./Личн. за месяц</div>
                            <div style="font-size: 11px; color: var(--muted); margin-top: 2px;">Всего: ${(stats.technical_issues_month || 0) + (stats.personal_issues_month || 0)}</div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Ошибка:', error);
                document.getElementById('admin-stats-content').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #ef4444;">
                        <div style="font-size: 16px;">❌ Ошибка загрузки статистики</div>
                        <div style="font-size: 12px; margin-top: 8px; color: var(--muted);">${error.message}</div>
                        <button onclick="loadAdminStats()" style="margin-top: 10px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; border-radius: var(--radius); padding: 8px 16px; font-size: 12px; cursor: pointer;">Повторить</button>
                    </div>
                `;
                document.getElementById('stats-update-time').textContent = 'ошибка';
            }
        }
        
        async function showEmployeesManagement() {
            try {
                // Скрываем все модальные окна
                document.getElementById('admin-menu-modal').style.display = 'none';
                document.getElementById('add-employee-modal').style.display = 'none';
                document.getElementById('edit-employee-modal').style.display = 'none';
                document.getElementById('issues-management-modal').style.display = 'none';
                document.getElementById('broadcast-modal').style.display = 'none';
                document.getElementById('messaging-menu-modal').style.display = 'none';
                document.getElementById('employee-message-modal').style.display = 'none';
                document.getElementById('send-employee-message-modal').style.display = 'none';
                
                // Показываем управление сотрудниками
                document.getElementById('employees-management-modal').style.display = 'block';
                await loadEmployeesList();
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Ошибка загрузки списка сотрудников');
            }
        }
        
        async function loadEmployeesList() {
            try {
                const response = await fetch(`http://localhost:5000/api/admin/employees?initData=${encodeURIComponent(tg.initData)}`, {
                    method: 'GET'
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки сотрудников');
                }

                const data = await response.json();
                
                // Сохраняем всех сотрудников для поиска
                allEmployees = data.employees;
                filteredEmployees = [...allEmployees];
                
                // Обновляем статистику
                updateEmployeesStats(allEmployees);
                
                // Очищаем поле поиска
                document.getElementById('employee-search').value = '';
                
                displayEmployeesList(filteredEmployees);
                updateSearchResultsCount();
                
            } catch (error) {
                console.error('Ошибка:', error);
                document.getElementById('employees-list').innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">Ошибка загрузки сотрудников</div>';
            }
        }
        
        function displayEmployeesList(employees) {
            const container = document.getElementById('employees-list');
            if (!employees || employees.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 20px;">Сотрудники не найдены</div>';
                return;
            }
            
            container.innerHTML = '';
            employees.forEach(emp => {
                const empDiv = document.createElement('div');
                empDiv.style.cssText = `
                    background: rgba(255,255,255,0.1);
                    border: 1px solid rgba(255,255,255,0.2);
                    border-radius: var(--radius);
                    padding: 12px;
                    margin-bottom: 12px;
                    transition: all 0.2s ease;
                    width: 100%;
                    box-sizing: border-box;
                    max-width: 100%;
                    overflow: hidden;
                `;
                
                const statusIcon = emp.is_blocked ? '🔴' : '🟢';
                const statusText = emp.is_blocked ? 'Заблокирован' : 'Активен';
                const statusColor = emp.is_blocked ? '#ef4444' : '#10b981';
                const adminBadge = emp.is_admin ? '<span style="background: var(--accent); color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px; font-weight: 600;">АДМИН</span>' : '';
                const botStatus = emp.chat_id ? '✅ В боте' : '⚠️ Не авторизован';
                const botStatusColor = emp.chat_id ? '#10b981' : '#f59e0b';
                
                empDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; width: 100%; overflow: hidden;">
                        <div style="flex: 1; min-width: 0; margin-right: 8px; overflow: hidden;">
                            <div style="font-size: 14px; font-weight: 600; color: white; margin-bottom: 3px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; line-height: 1.3;">
                                👤 ${emp.first_name} ${emp.last_name}${adminBadge}
                            </div>
                            <div style="font-size: 12px; color: rgba(255, 255, 255, 0.8); margin-bottom: 3px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">📞 ${emp.phone}</div>
                            <div style="font-size: 11px; color: ${botStatusColor}; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${botStatus}</div>
                        </div>
                        <div style="text-align: right; flex-shrink: 0; max-width: 100px;">
                            <div style="font-size: 10px; color: ${statusColor}; font-weight: 600; padding: 3px 6px; background: rgba(255,255,255,0.1); border-radius: var(--radius); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${statusIcon} ${statusText}</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 6px; width: 100%;">
                        <button onclick="toggleEmployeeBlock('${emp.phone}', ${!emp.is_blocked})" 
                                class="btn" style="padding: 6px 8px; background: ${emp.is_blocked ? '#10b981' : '#ef4444'}; border: none; border-radius: var(--radius); color: white; font-size: 11px; cursor: pointer; transition: all 0.2s; flex: 1; font-weight: 600; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            ${emp.is_blocked ? '✅' : '🔒'}
                        </button>
                        <button onclick="editEmployee('${emp.phone}', '${emp.first_name}', '${emp.last_name}', ${emp.is_admin})" 
                                class="btn" style="padding: 6px 8px; background: #f59e0b; border: none; border-radius: var(--radius); color: white; font-size: 11px; cursor: pointer; transition: all 0.2s; flex: 1; font-weight: 600; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            ✏️
                        </button>
                        <button onclick="deleteEmployee('${emp.phone}', '${emp.first_name}', '${emp.last_name}')" 
                                class="btn" style="padding: 6px 8px; background: #ef4444; border: none; border-radius: var(--radius); color: white; font-size: 11px; cursor: pointer; transition: all 0.2s; flex: 1; font-weight: 600; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            🗑️
                        </button>
                    </div>
                `;
                
                // Добавляем hover эффект
                empDiv.addEventListener('mouseenter', () => {
                    empDiv.style.borderColor = 'rgba(255,255,255,0.4)';
                    empDiv.style.transform = 'translateY(-1px)';
                    empDiv.style.background = 'rgba(255,255,255,0.15)';
                });
                empDiv.addEventListener('mouseleave', () => {
                    empDiv.style.borderColor = 'rgba(255,255,255,0.2)';
                    empDiv.style.transform = 'translateY(0)';
                    empDiv.style.background = 'rgba(255,255,255,0.1)';
                });
                
                container.appendChild(empDiv);
            });
        }
        
        function updateEmployeesStats(employees) {
            const total = employees.length;
            const active = employees.filter(emp => !emp.is_blocked).length;
            const blocked = employees.filter(emp => emp.is_blocked).length;
            
            // Обновляем счетчики (если они есть)
            const totalElement = document.getElementById('total-employees-count');
            const activeElement = document.getElementById('active-employees-count');
            const blockedElement = document.getElementById('blocked-employees-count');
            
            if (totalElement) totalElement.textContent = total;
            if (activeElement) activeElement.textContent = active;
            if (blockedElement) blockedElement.textContent = blocked;
        }
        
        function filterEmployees() {
            const searchTerm = document.getElementById('employee-search').value.toLowerCase();
            const statusFilter = document.getElementById('employee-status-filter').value;
            
            filteredEmployees = allEmployees.filter(emp => {
                // Фильтр по поиску
                const matchesSearch = !searchTerm || 
                    emp.first_name.toLowerCase().includes(searchTerm) ||
                    emp.last_name.toLowerCase().includes(searchTerm) ||
                    emp.phone.includes(searchTerm);
                
                // Фильтр по статусу
                let matchesStatus = true;
                if (statusFilter === 'active') {
                    matchesStatus = !emp.is_blocked;
                } else if (statusFilter === 'blocked') {
                    matchesStatus = emp.is_blocked;
                } else if (statusFilter === 'admin') {
                    matchesStatus = emp.is_admin;
                }
                
                return matchesSearch && matchesStatus;
            });
            
            displayEmployeesList(filteredEmployees);
            updateSearchResultsCount();
        }
        
        function updateSearchResultsCount() {
            const total = allEmployees ? allEmployees.length : 0;
            const filtered = filteredEmployees ? filteredEmployees.length : 0;
            const countElement = document.getElementById('search-results-count');
            
            if (filtered === total) {
                countElement.textContent = `Показано ${filtered} сотрудников`;
            } else {
                countElement.textContent = `Найдено ${filtered} из ${total} сотрудников`;
            }
        }
        
        async function toggleEmployeeBlock(phone, isBlocked) {
            try {
                const response = await fetch('http://localhost:5000/api/admin/employee/block', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        employee_phone: phone,
                        is_blocked: isBlocked
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    tg.showAlert(result.message);
                    await loadEmployeesList(); // Перезагружаем список
                } else {
                    tg.showAlert('Ошибка: ' + result.error);
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Ошибка изменения статуса сотрудника');
            }
        }
        
        async function showIssuesManagement() {
            console.log('showIssuesManagement вызвана');
            try {
                // Останавливаем автообновление диалога
                stopDialogAutoRefresh();
                
                // Скрываем все модальные окна
                document.getElementById('admin-menu-modal').style.display = 'none';
                document.getElementById('employees-management-modal').style.display = 'none';
                document.getElementById('broadcast-modal').style.display = 'none';
                document.getElementById('messaging-menu-modal').style.display = 'none';
                document.getElementById('employee-message-modal').style.display = 'none';
                document.getElementById('send-employee-message-modal').style.display = 'none';
                document.getElementById('issue-dialog-modal').style.display = 'none';
                
                // Очищаем поле ввода ответа
                const responseInput = document.getElementById('admin-response-input');
                if (responseInput) {
                    responseInput.value = '';
                }
                
                // Показываем управление обращениями
                document.getElementById('issues-management-modal').style.display = 'block';
                console.log('Модальное окно показано, вызываем loadIssuesList');
                
                // Если список уже загружен, не загружаем заново
                if (!issuesListCache) {
                    await loadIssuesList();
                }
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Ошибка загрузки списка обращений');
            }
        }
        
        async function loadIssuesList(forceReload = false) {
            const container = document.getElementById('issues-list');
            
            // Если есть кэш и не требуется принудительная перезагрузка
            if (issuesListCache && !forceReload) {
                displayCachedIssuesList();
                return;
            }
            
            // Очищаем контейнер сразу
            container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">Загрузка обращений...</div>';
            
            try {
                const response = await fetch(`http://localhost:5000/api/admin/issues/all?initData=${encodeURIComponent(tg.initData)}`, {
                    method: 'GET'
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки обращений');
                }

                const data = await response.json();
                
                // Сохраняем в кэш
                issuesListCache = data.issues;
                allIssues = [...issuesListCache];
                filteredIssues = [...allIssues];
                
                // Обновляем статистику
                updateIssuesStats(allIssues);
                
                // Отображаем
                displayIssuesList(filteredIssues);
                
            } catch (error) {
                console.error('Ошибка в loadIssuesList:', error);
                document.getElementById('issues-list').innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">Ошибка загрузки обращений</div>';
            }
        }
        
        function updateIssuesStats(issues) {
            const active = issues.filter(issue => issue.status !== 'closed').length;
            const closed = issues.filter(issue => issue.status === 'closed').length;
            const technical = issues.filter(issue => issue.type === 'technical').length;
            const personal = issues.filter(issue => issue.type === 'personal').length;
            
            // Обновляем счетчики (если они есть)
            const activeElement = document.getElementById('active-issues-count');
            const closedElement = document.getElementById('closed-issues-count');
            const technicalElement = document.getElementById('technical-issues-count');
            const personalElement = document.getElementById('personal-issues-count');
            
            if (activeElement) activeElement.textContent = active;
            if (closedElement) closedElement.textContent = closed;
            if (technicalElement) technicalElement.textContent = technical;
            if (personalElement) personalElement.textContent = personal;
        }
        
        function filterIssues() {
            const searchTerm = document.getElementById('issues-search').value.toLowerCase();
            const statusFilter = document.getElementById('issues-status-filter').value;
            const typeFilter = document.getElementById('issues-type-filter').value;
            
            filteredIssues = allIssues.filter(issue => {
                // Фильтр по поиску
                const matchesSearch = !searchTerm || 
                    issue.description.toLowerCase().includes(searchTerm) ||
                    issue.employee_name.toLowerCase().includes(searchTerm) ||
                    (issue.pseudonym && issue.pseudonym.toLowerCase().includes(searchTerm));
                
                // Фильтр по статусу
                let matchesStatus = true;
                if (statusFilter === 'open') {
                    matchesStatus = issue.status === 'open';
                } else if (statusFilter === 'in_progress') {
                    matchesStatus = issue.status === 'in_progress';
                } else if (statusFilter === 'closed') {
                    matchesStatus = issue.status === 'closed';
                }
                
                // Фильтр по типу
                let matchesType = true;
                if (typeFilter === 'technical') {
                    matchesType = issue.type === 'technical';
                } else if (typeFilter === 'personal') {
                    matchesType = issue.type === 'personal';
                }
                
                return matchesSearch && matchesStatus && matchesType;
            });
            
            displayIssuesList(filteredIssues);
            updateIssuesResultsCount();
        }
        
        function updateIssuesResultsCount() {
            const total = allIssues ? allIssues.length : 0;
            const filtered = filteredIssues ? filteredIssues.length : 0;
            const countElement = document.getElementById('issues-results-count');
            
            if (filtered === total) {
                countElement.textContent = `Показано ${filtered} обращений`;
            } else {
                countElement.textContent = `Найдено ${filtered} из ${total} обращений`;
            }
        }
        
        function displayIssuesList(issues) {
            const container = document.getElementById('issues-list');
            
            if (!issues || issues.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 20px;">Обращения не найдены</div>';
                return;
            }

            container.innerHTML = '';
            issues.forEach(issue => {
                const issueDiv = document.createElement('div');
                issueDiv.style.cssText = `
                    background: #8b5cf6;
                    border: 1px solid #7c3aed;
                    border-radius: var(--radius);
                    padding: 16px;
                    margin-bottom: 12px;
                    transition: all 0.2s ease;
                    box-shadow: 0 2px 8px rgba(139, 92, 246, 0.2);
                `;
                
                let statusIcon = '🟡';
                let statusText = 'Открыто';
                let statusColor = '#f59e0b';
                
                if (issue.status === 'closed') {
                    statusIcon = '🔴';
                    statusText = 'Закрыто';
                    statusColor = '#ef4444';
                } else if (issue.status === 'in_progress') {
                    statusIcon = '🟠';
                    statusText = 'В работе';
                    statusColor = '#f97316';
                } else if (issue.status === 'resolved') {
                    statusIcon = '🟢';
                    statusText = 'Решено';
                    statusColor = '#10b981';
                }
                
                const typeIcon = issue.type === 'personal' ? '💔' : '🖥';
                const typeText = issue.type === 'personal' ? 'Личная проблема' : 'Техническая проблема';
                const typeColor = issue.type === 'personal' ? '#8b5cf6' : '#3b82f6';
                const anonymityText = issue.is_anonymous ? ` (${issue.pseudonym || 'Анонимно'})` : '';
                
                // Определяем кнопки в зависимости от статуса
                let buttonsHtml = '';
                if (issue.status === 'closed') {
                    buttonsHtml = `
                        <button onclick="openIssueDialog(${issue.id})" 
                                style="padding: 6px 12px; background: #6366f1; border: none; border-radius: 6px; color: white; font-size: 12px; cursor: pointer; transition: opacity 0.2s;">
                            👁️ Просмотр
                        </button>
                    `;
                } else {
                    buttonsHtml = `
                        <button onclick="openIssueDialog(${issue.id})" 
                                style="padding: 6px 12px; background: #10b981; border: none; border-radius: 6px; color: white; font-size: 12px; cursor: pointer; margin-right: 8px; transition: opacity 0.2s;">
                            💬 Ответить
                        </button>
                        <button onclick="closeIssue(${issue.id})" 
                                style="padding: 6px 12px; background: #ef4444; border: none; border-radius: 6px; color: white; font-size: 12px; cursor: pointer; transition: opacity 0.2s;">
                            ✅ Закрыть
                        </button>
                    `;
                }

                issueDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                        <div>
                            <div style="font-size: 16px; font-weight: 600; color: white; margin-bottom: 4px;">
                                ${typeIcon} Обращение #${issue.id}${anonymityText}
                            </div>
                            <div style="font-size: 12px; color: ${typeColor === '#8b5cf6' ? '#e9d5ff' : '#bfdbfe'}; margin-bottom: 8px;">${typeText}</div>
                            <div style="font-size: 14px; color: rgba(255, 255, 255, 0.9); margin-bottom: 8px; line-height: 1.4;">${issue.description}</div>
                            <div style="font-size: 12px; color: rgba(255, 255, 255, 0.7);">
                                👤 ${issue.employee_name} • 📅 ${new Date(issue.created_at).toLocaleString('ru-RU')}
                                ${issue.response_count > 0 ? ` • 💬 ${issue.response_count} ответов` : ''}
                            </div>
                            ${issue.last_response_preview ? `
                                <div style="margin-top: 8px; padding: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 6px; border-left: 3px solid rgba(255, 255, 255, 0.3);">
                                    <div style="font-size: 11px; color: rgba(255, 255, 255, 0.6); margin-bottom: 2px;">Последний ответ:</div>
                                    <div style="font-size: 12px; color: rgba(255, 255, 255, 0.9);">${issue.last_response_preview}</div>
                                </div>
                            ` : ''}
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 12px; color: ${statusColor === '#10b981' ? '#a7f3d0' : statusColor === '#ef4444' ? '#fca5a5' : '#fed7aa'}; font-weight: 500; margin-bottom: 8px;">${statusIcon} ${statusText}</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        ${buttonsHtml.replace(/background: #10b981/g, 'background: rgba(16, 185, 129, 0.8)').replace(/background: #ef4444/g, 'background: rgba(239, 68, 68, 0.8)').replace(/background: #6366f1/g, 'background: rgba(99, 102, 241, 0.8)')}
                    </div>
                `;
                
                // Добавляем hover эффект
                issueDiv.addEventListener('mouseenter', () => {
                    issueDiv.style.borderColor = '#a855f7';
                    issueDiv.style.transform = 'translateY(-1px)';
                    issueDiv.style.boxShadow = '0 4px 12px rgba(139, 92, 246, 0.3)';
                });
                issueDiv.addEventListener('mouseleave', () => {
                    issueDiv.style.borderColor = '#7c3aed';
                    issueDiv.style.transform = 'translateY(0)';
                    issueDiv.style.boxShadow = '0 2px 8px rgba(139, 92, 246, 0.2)';
                });
                
                container.appendChild(issueDiv);
            });
        }
        
        let currentIssueId = null;
        let issuesListCache = null;
        
        async function openIssueDialog(issueId) {
            try {
                currentIssueId = issueId;
                
                // Скрываем все окна
                document.getElementById('app').style.display = 'none';
                document.getElementById('issues-management-modal').style.display = 'none';
                
                // Показываем модальное окно диалога с обращением
                document.getElementById('issue-dialog-modal').style.display = 'block';
                
                // Загружаем историю диалога
                await loadIssueDialog(issueId);
                
                // Запускаем автообновление диалога
                startDialogAutoRefresh();
                
                // Отмечаем ответы как прочитанные
                await markResponsesAsRead(issueId);
                
            } catch (error) {
                console.error('Ошибка открытия диалога:', error);
                tg.showAlert('Ошибка открытия диалога с обращением');
            }
        }
        
        async function loadIssueDialog(issueId) {
            try {
                const container = document.getElementById('issue-dialog-content');
                container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">Загрузка диалога...</div>';
                
                const response = await fetch(`http://localhost:5000/api/admin/issue/${issueId}/dialog?initData=${encodeURIComponent(tg.initData)}`, {
                    method: 'GET'
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки диалога');
                }

                const data = await response.json();
                displayIssueDialog(data);
                
                // Инициализируем счетчик сообщений для умного обновления
                currentDialogMessagesCount = data.responses ? data.responses.length : 0;
                lastDialogData = data;
                
            } catch (error) {
                console.error('Ошибка загрузки диалога:', error);
                document.getElementById('issue-dialog-content').innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">Ошибка загрузки диалога</div>';
            }
        }
        
        function displayIssueDialog(data) {
            const container = document.getElementById('issue-dialog-content');
            const issue = data.issue;
            const responses = data.responses || [];
            
            // Информация об обращении
            const typeIcon = issue.issue_type === 'personal' ? '💔' : '🖥';
            const typeText = issue.issue_type === 'personal' ? 'Личная проблема' : 'Техническая проблема';
            const anonymityText = issue.is_anonymous ? ` (${issue.pseudonym || 'Анонимно'})` : '';
            
            // Определяем статус
            let statusIcon = '🟡';
            let statusText = 'Активно';
            let statusColor = '#ffa500';
            if (issue.status === 'closed') {
                statusIcon = '🔴';
                statusText = 'Закрыто';
                statusColor = '#ff4757';
            } else if (issue.status === 'resolved') {
                statusIcon = '🟢';
                statusText = 'Решено';
                statusColor = '#2ed573';
            }
            
            let html = '';
            
            // Информационная карточка об обращении
            html += '<div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: var(--radius); margin-bottom: 15px;">';
            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">';
            html += '<h3 style="margin: 0; font-size: 16px; line-height: 1.4;">' + typeIcon + ' Обращение #' + issue.id + anonymityText + '</h3>';
            html += '<div style="font-size: 12px; color: ' + statusColor + '; font-weight: 600;">' + statusIcon + ' ' + statusText + '</div>';
            html += '</div>';
            html += '<div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-bottom: 8px;">' + typeText + '</div>';
            html += '<div style="font-size: 14px; margin-bottom: 12px; line-height: 1.4;">' + issue.description + '</div>';
            html += '<div style="font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 4px;">👤 От: ' + issue.employee_name + '</div>';
            html += '<div style="font-size: 12px; color: rgba(255,255,255,0.6);">🕐 Создано: ' + new Date(issue.created_at).toLocaleString('ru-RU') + '</div>';
            
            // Если обращение закрыто, показываем предупреждение для админа
            if (issue.status === 'closed') {
                html += '<div style="margin-top: 12px; padding: 10px; background: rgba(255, 71, 87, 0.2); border-radius: var(--radius); font-size: 12px; color: rgba(255,255,255,0.9);">';
                html += '🔒 Это обращение закрыто. Вы можете просматривать историю, но новые ответы добавлять запрещено.';
                html += '</div>';
            }
            
            html += '</div>';
            
            // История ответов
            if (responses.length > 0) {
                html += '<div class="dialog-messages" style="margin-bottom: 15px;">';
                html += '<h3 style="font-size: 16px; line-height: 1.4; margin-bottom: 15px;">💬 История диалога</h3>';
                
                responses.forEach(response => {
                    const isAdmin = response.responder_phone === 'admin';
                    const messageStyle = isAdmin 
                        ? 'background: linear-gradient(45deg, #667eea, #764ba2); color: white; margin-left: auto; text-align: right;'
                        : 'background: rgba(255,255,255,0.1); color: white; margin-right: auto;';
                    
                    html += '<div style="margin: 10px 0; padding: 12px 15px; border-radius: 12px; max-width: 80%; word-wrap: break-word; ' + messageStyle + '">';
                    html += '<div style="font-size: 14px; margin-bottom: 6px; line-height: 1.4;">' + response.response_text + '</div>';
                    html += '<div style="font-size: 11px; opacity: 0.8;">';
                    html += (isAdmin ? '👨‍💼 Администратор' : '👤 Сотрудник') + ' • ' + new Date(response.created_at).toLocaleString('ru-RU');
                    html += '</div>';
                    html += '</div>';
                });
                
                html += '</div>';
            } else {
                html += '<div style="text-align: center; color: rgba(255,255,255,0.6); padding: 20px; font-style: italic;">';
                html += '💭 Пока нет ответов. Станьте первым, кто ответит на это обращение!';
                html += '</div>';
            }
            
            container.innerHTML = html;
            
            // Управляем видимостью поля ввода в зависимости от статуса обращения
            const inputContainer = document.querySelector('#issue-dialog-modal div[style*="position: fixed"]');
            if (inputContainer) {
                const input = document.getElementById('admin-response-input');
                const button = inputContainer.querySelector('button');
                
                if (issue.status === 'closed') {
                    // Для закрытых обращений делаем поле ввода полупрозрачным и добавляем предупреждение
                    inputContainer.style.opacity = '0.6';
                    if (input) {
                        input.placeholder = 'Обращение закрыто - ответы запрещены';
                        input.style.background = 'rgba(255, 71, 87, 0.2)';
                        input.disabled = true;
                    }
                    if (button) {
                        button.style.background = '#ff4757';
                        button.innerHTML = '🔒 Закрыто';
                        button.disabled = true;
                    }
                } else {
                    // Для активных обращений возвращаем обычный вид
                    inputContainer.style.opacity = '1';
                    if (input) {
                        input.placeholder = 'Введите ответ...';
                        input.style.background = 'rgba(255,255,255,0.1)';
                        input.disabled = false;
                    }
                    if (button) {
                        button.style.background = 'var(--accent)';
                        button.innerHTML = 'Отправить';
                        button.disabled = false;
                    }
                }
            }
            
            // Прокручиваем вниз к последним сообщениям
            setTimeout(() => {
                const scrollableContainer = document.querySelector('#issue-dialog-modal .card');
                if (scrollableContainer) {
                    console.log('Прокручиваем админский диалог вниз');
                    scrollableContainer.scrollTop = scrollableContainer.scrollHeight;
                } else {
                    console.log('Контейнер диалога не найден');
                }
            }, 100);
        }
        
        async function sendAdminResponse() {
            try {
                const input = document.getElementById('admin-response-input');
                const responseText = input.value.trim();
                
                if (!responseText) {
                    tg.showAlert('Введите текст ответа');
                    return;
                }
                
                const response = await fetch(`http://localhost:5000/api/admin/issue/${currentIssueId}/respond`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        response_text: responseText
                    })
                });

                if (!response.ok) {
                    if (response.status === 403) {
                        const errorData = await response.json();
                        if (errorData.error === 'Cannot respond to closed issue') {
                            tg.showAlert('Нельзя отвечать в закрытое обращение');
                            return;
                        }
                    }
                    throw new Error('Ошибка отправки ответа');
                }

                // Добавляем сообщение в диалог локально
                addMessageToDialog(responseText, true, false);
                
                // Прокручиваем к низу диалога
                setTimeout(() => {
                    scrollToBottom(false); // false = админский диалог
                }, 150);
                
                // Очищаем поле ввода
                input.value = '';
                
                // Сбрасываем кэш списка обращений (так как добавился новый ответ)
                issuesListCache = null;
                
                // Увеличиваем счетчик сообщений (добавили новое сообщение)
                adminDialogMessagesCount++;
                
            } catch (error) {
                console.error('Ошибка отправки ответа:', error);
                tg.showAlert('Ошибка отправки ответа');
            }
        }
        
        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendAdminResponse();
            }
        }
        
        async function closeIssue(issueId) {
            try {
                const response = await fetch(`http://localhost:5000/api/admin/issue/${issueId}/close`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    tg.showAlert(result.message);
                    // Сбрасываем кэш и перезагружаем список
                    issuesListCache = null;
                    await loadIssuesList(true); // Принудительная перезагрузка
                } else {
                    tg.showAlert('Ошибка: ' + result.error);
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Ошибка закрытия обращения');
            }
        }
        
        async function sendStatsToChannel() {
            try {
                const response = await fetch('http://localhost:5000/api/admin/send-stats', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    tg.showAlert(result.message);
                } else {
                    tg.showAlert('Ошибка: ' + result.error);
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Ошибка отправки статистики');
            }
        }
        
        function showMessagingMenu() {
            // Скрываем все модальные окна
            document.getElementById('admin-menu-modal').style.display = 'none';
            document.getElementById('employees-management-modal').style.display = 'none';
            document.getElementById('issues-management-modal').style.display = 'none';
            document.getElementById('broadcast-modal').style.display = 'none';
            document.getElementById('employee-message-modal').style.display = 'none';
            document.getElementById('send-employee-message-modal').style.display = 'none';
            
            // Показываем меню выбора типа сообщения
            document.getElementById('messaging-menu-modal').style.display = 'block';
        }
        
        function showBroadcastMessage() {
            // Скрываем все модальные окна
            document.getElementById('messaging-menu-modal').style.display = 'none';
            document.getElementById('employee-message-modal').style.display = 'none';
            document.getElementById('send-employee-message-modal').style.display = 'none';
            
            // Показываем модальное окно рассылки
            document.getElementById('broadcast-modal').style.display = 'block';
            document.getElementById('broadcast-message').value = '';
            document.getElementById('broadcast-file').value = '';
            document.getElementById('broadcast-file-info').style.display = 'none';
            
            // Сбрасываем стиль кнопки файла
            const broadcastFileButton = document.getElementById('broadcast-file-button');
            const broadcastFileButtonText = document.getElementById('broadcast-file-button-text');
            if (broadcastFileButton && broadcastFileButtonText) {
                broadcastFileButton.style.border = '2px dashed rgba(255, 255, 255, 0.3)';
                broadcastFileButton.style.background = 'rgba(255, 255, 255, 0.05)';
                broadcastFileButton.style.color = 'rgba(255, 255, 255, 0.7)';
                broadcastFileButtonText.textContent = 'Выбрать файл';
            }
        }
        
        async function showEmployeeMessageMenu() {
            try {
                // Скрываем все модальные окна
                document.getElementById('messaging-menu-modal').style.display = 'none';
                document.getElementById('broadcast-modal').style.display = 'none';
                document.getElementById('send-employee-message-modal').style.display = 'none';
                
                // Сбрасываем состояние формы отправки сообщения
                document.getElementById('employee-message-text').value = '';
                document.getElementById('employee-message-file').value = '';
                document.getElementById('employee-file-info').style.display = 'none';
                updateEmployeeFileInfo(); // Сбрасываем стиль кнопки файла
                selectedEmployeeForMessage = null;
                
                // Показываем модальное окно выбора сотрудника
                document.getElementById('employee-message-modal').style.display = 'block';
                
                // Загружаем список сотрудников
                await loadEmployeesForMessage();
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Ошибка загрузки списка сотрудников');
            }
        }
        
        async function sendBroadcastMessage() {
            try {
                const messageText = document.getElementById('broadcast-message').value.trim();
                const fileInput = document.getElementById('broadcast-file');
                const file = fileInput.files[0];
                
                if (!messageText && !file) {
                    tg.showAlert('Введите текст сообщения или выберите файл');
                    return;
                }
                
                // Если есть файл, отправляем через FormData
                if (file) {
                    const formData = new FormData();
                    formData.append('initData', tg.initData);
                    formData.append('message', messageText || '');
                    formData.append('file', file);
                    formData.append('target', 'all');
                    
                    const response = await fetch('http://localhost:5000/api/admin/send-file', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        tg.showAlert('Сообщение с файлом отправлено всем сотрудникам');
                        document.getElementById('broadcast-message').value = '';
                        fileInput.value = '';
                        updateBroadcastFileInfo(); // Сбрасываем стиль кнопки
                        showAdminMenuModal();
                    } else {
                        tg.showAlert('Ошибка: ' + result.error);
                    }
                } else {
                    // Отправляем только текст
                    const response = await fetch('http://localhost:5000/api/admin/broadcast', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            initData: tg.initData,
                            message: messageText
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        tg.showAlert(result.message);
                        document.getElementById('broadcast-message').value = '';
                        showAdminMenuModal();
                    } else {
                        tg.showAlert('Ошибка: ' + result.error);
                    }
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Ошибка отправки сообщения');
            }
        }
        
        let allEmployeesForMessage = [];
        let filteredEmployeesForMessage = [];
        let selectedEmployeeForMessage = null;
        
        async function loadEmployeesForMessage() {
            try {
                const response = await fetch(`http://localhost:5000/api/admin/employees?initData=${encodeURIComponent(tg.initData)}`);
                
                if (!response.ok) {
                    throw new Error('Ошибка загрузки данных');
                }
                
                const data = await response.json();
                allEmployeesForMessage = data.employees || [];
                filteredEmployeesForMessage = [...allEmployeesForMessage];
                
                // Очищаем поле поиска
                document.getElementById('employee-message-search').value = '';
                
                displayEmployeesForMessage(filteredEmployeesForMessage);
                
            } catch (error) {
                console.error('Ошибка:', error);
                document.getElementById('employee-message-list').innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">Ошибка загрузки сотрудников</div>';
            }
        }
        
        function displayEmployeesForMessage(employees) {
            const container = document.getElementById('employee-message-list');
            if (!employees || employees.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 20px;">Сотрудники не найдены</div>';
                return;
            }
            
            container.innerHTML = '';
            employees.forEach(emp => {
                // Показываем всех сотрудников (используем phone вместо chat_id)
                // if (!emp.chat_id) {
                //     return;
                // }
                
                const empDiv = document.createElement('div');
                empDiv.style.cssText = `
                    background: #8b5cf6;
                    border: 1px solid #7c3aed;
                    border-radius: var(--radius);
                    padding: 12px 14px;
                    margin-bottom: 12px;
                    transition: all 0.2s ease;
                    box-shadow: 0 2px 8px rgba(139, 92, 246, 0.2);
                    cursor: pointer;
                    width: 100%;
                    box-sizing: border-box;
                    max-width: 100%;
                `;
                
                const statusIcon = emp.is_blocked ? '🔴' : '🟢';
                const statusText = emp.is_blocked ? 'Заблокирован' : 'Активен';
                const adminBadge = emp.is_admin ? '<span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">АДМИН</span>' : '';
                
                empDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <div style="flex: 1; min-width: 0; margin-right: 8px;">
                            <div style="font-size: 14px; font-weight: 600; color: white; margin-bottom: 2px; word-wrap: break-word;">
                                👤 ${emp.first_name} ${emp.last_name}${adminBadge}
                            </div>
                            <div style="font-size: 12px; color: rgba(255, 255, 255, 0.8); margin-bottom: 2px; word-wrap: break-word;">📞 ${emp.phone}</div>
                            <div style="font-size: 11px; color: rgba(255, 255, 255, 0.7);">✅ В боте</div>
                        </div>
                        <div style="text-align: right; flex-shrink: 0;">
                            <div style="font-size: 11px; color: ${emp.is_blocked ? '#fca5a5' : '#a7f3d0'}; font-weight: 500;">${statusIcon} ${statusText}</div>
                        </div>
                    </div>
                `;
                
                // Добавляем hover эффект
                empDiv.addEventListener('mouseenter', () => {
                    empDiv.style.borderColor = '#a855f7';
                    empDiv.style.transform = 'translateY(-1px)';
                    empDiv.style.boxShadow = '0 4px 12px rgba(139, 92, 246, 0.3)';
                });
                empDiv.addEventListener('mouseleave', () => {
                    empDiv.style.borderColor = '#7c3aed';
                    empDiv.style.transform = 'translateY(0)';
                    empDiv.style.boxShadow = '0 2px 8px rgba(139, 92, 246, 0.2)';
                });
                
                // Обработчик клика
                empDiv.addEventListener('click', () => {
                    selectEmployeeForMessage(emp);
                });
                
                container.appendChild(empDiv);
            });
        }
        
        function filterEmployeesForMessage() {
            const searchTerm = document.getElementById('employee-message-search').value.toLowerCase().trim();
            
            if (!searchTerm) {
                filteredEmployeesForMessage = [...allEmployeesForMessage];
            } else {
                filteredEmployeesForMessage = allEmployeesForMessage.filter(emp => {
                    const fullName = `${emp.first_name} ${emp.last_name}`.toLowerCase();
                    const phone = emp.phone.toLowerCase();
                    
                    return fullName.includes(searchTerm) || 
                           emp.first_name.toLowerCase().includes(searchTerm) ||
                           emp.last_name.toLowerCase().includes(searchTerm) ||
                           phone.includes(searchTerm);
                });
            }
            
            displayEmployeesForMessage(filteredEmployeesForMessage);
        }
        
        function selectEmployeeForMessage(employee) {
            selectedEmployeeForMessage = employee;
            
            // Скрываем модальное окно выбора сотрудника
            document.getElementById('employee-message-modal').style.display = 'none';
            
            // Показываем модальное окно отправки сообщения
            document.getElementById('send-employee-message-modal').style.display = 'block';
            
            // Обновляем информацию о выбранном сотруднике
            document.getElementById('employee-message-title').textContent = `Сообщение для ${employee.first_name} ${employee.last_name}`;
            document.getElementById('selected-employee-info').textContent = `${employee.first_name} ${employee.last_name} (${employee.phone})`;
            
            // Очищаем поля сообщения и файла
            document.getElementById('employee-message-text').value = '';
            document.getElementById('employee-message-file').value = '';
            document.getElementById('employee-file-info').style.display = 'none';
            updateEmployeeFileInfo(); // Сбрасываем стиль кнопки файла
        }
        
        async function sendEmployeeMessage() {
            try {
                if (!selectedEmployeeForMessage) {
                    tg.showAlert('Не выбран сотрудник');
                    return;
                }
                
                const messageText = document.getElementById('employee-message-text').value.trim();
                const fileInput = document.getElementById('employee-message-file');
                const file = fileInput.files[0];
                
                if (!messageText && !file) {
                    tg.showAlert('Введите текст сообщения или выберите файл');
                    return;
                }
                
                // Если есть файл, отправляем через FormData
                if (file) {
                    const formData = new FormData();
                    formData.append('initData', tg.initData);
                    formData.append('message', messageText || '');
                    formData.append('file', file);
                    formData.append('target', 'one');
                    formData.append('employee_phone', selectedEmployeeForMessage.phone);
                    
                    const response = await fetch('http://localhost:5000/api/admin/send-file', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        tg.showAlert(`Сообщение с файлом отправлено ${selectedEmployeeForMessage.first_name} ${selectedEmployeeForMessage.last_name}`);
                        document.getElementById('employee-message-text').value = '';
                        fileInput.value = '';
                        document.getElementById('employee-file-info').style.display = 'none';
                        selectedEmployeeForMessage = null;
                        showAdminMenuModal();
                    } else {
                        tg.showAlert('Ошибка: ' + result.error);
                    }
                } else {
                    // Отправляем только текст через broadcast API с указанием конкретного сотрудника
                    const response = await fetch('http://localhost:5000/api/admin/broadcast', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            initData: tg.initData,
                            message: messageText,
                            target_employee_phone: selectedEmployeeForMessage.phone
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        tg.showAlert(`Сообщение отправлено ${selectedEmployeeForMessage.first_name} ${selectedEmployeeForMessage.last_name}`);
                        document.getElementById('employee-message-text').value = '';
                        selectedEmployeeForMessage = null;
                        showAdminMenuModal();
                    } else {
                        tg.showAlert('Ошибка: ' + result.error);
                    }
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Ошибка отправки сообщения');
            }
        }
        
        function updateEmployeeFileInfo() {
            const fileInput = document.getElementById('employee-message-file');
            const fileInfo = document.getElementById('employee-file-info');
            const fileButton = document.getElementById('employee-file-button');
            const fileButtonText = document.getElementById('file-button-text');
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const fileSize = (file.size / 1024 / 1024).toFixed(2);
                
                fileInfo.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 6px;">
                        <span style="color: #10b981;">📎</span>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 12px; color: #10b981; font-weight: 600; word-wrap: break-word;">${file.name}</div>
                            <div style="font-size: 11px; color: rgba(16, 185, 129, 0.8);">${fileSize} МБ</div>
                        </div>
                        <button onclick="clearEmployeeFile()" style="background: none; border: none; color: rgba(255, 255, 255, 0.5); cursor: pointer; padding: 2px; font-size: 14px;">✕</button>
                    </div>
                `;
                fileInfo.style.display = 'block';
                
                // Обновляем стиль кнопки
                fileButton.style.border = '2px solid #10b981';
                fileButton.style.background = 'rgba(16, 185, 129, 0.1)';
                fileButton.style.color = '#10b981';
                fileButtonText.textContent = 'Файл выбран';
            } else {
                fileInfo.style.display = 'none';
                fileButton.style.border = '2px dashed rgba(255, 255, 255, 0.3)';
                fileButton.style.background = 'rgba(255, 255, 255, 0.05)';
                fileButton.style.color = 'rgba(255, 255, 255, 0.7)';
                fileButtonText.textContent = 'Выбрать файл';
            }
        }
        
        function clearEmployeeFile() {
            const fileInput = document.getElementById('employee-message-file');
            fileInput.value = '';
            updateEmployeeFileInfo();
        }
        
        function updateBroadcastFileInfo() {
            const fileInput = document.getElementById('broadcast-file');
            const fileInfo = document.getElementById('broadcast-file-info');
            const fileButton = document.getElementById('broadcast-file-button');
            const fileButtonText = document.getElementById('broadcast-file-button-text');
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const fileSize = (file.size / 1024 / 1024).toFixed(2);
                
                fileInfo.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 6px;">
                        <span style="color: #10b981;">📎</span>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 12px; color: #10b981; font-weight: 600; word-wrap: break-word;">${file.name}</div>
                            <div style="font-size: 11px; color: rgba(16, 185, 129, 0.8);">${fileSize} МБ</div>
                        </div>
                        <button onclick="clearBroadcastFile()" style="background: none; border: none; color: rgba(255, 255, 255, 0.5); cursor: pointer; padding: 2px; font-size: 14px;">✕</button>
                    </div>
                `;
                fileInfo.style.display = 'block';
                
                // Обновляем стиль кнопки
                fileButton.style.border = '2px solid #10b981';
                fileButton.style.background = 'rgba(16, 185, 129, 0.1)';
                fileButton.style.color = '#10b981';
                fileButtonText.textContent = 'Файл выбран';
            } else {
                fileInfo.style.display = 'none';
                fileButton.style.border = '2px dashed rgba(255, 255, 255, 0.3)';
                fileButton.style.background = 'rgba(255, 255, 255, 0.05)';
                fileButton.style.color = 'rgba(255, 255, 255, 0.7)';
                fileButtonText.textContent = 'Выбрать файл';
            }
        }
        
        function clearBroadcastFile() {
            const fileInput = document.getElementById('broadcast-file');
            fileInput.value = '';
            updateBroadcastFileInfo();
        }
        
        // Обработчики для полей выбора файлов
        document.addEventListener('DOMContentLoaded', function() {
            // Обработчик для поля файла в рассылке всем
            const broadcastFileInput = document.getElementById('broadcast-file');
            if (broadcastFileInput) {
                broadcastFileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    const infoDiv = document.getElementById('broadcast-file-info');
                    
                    if (file) {
                        const fileSize = (file.size / 1024 / 1024).toFixed(2);
                        infoDiv.innerHTML = `📄 ${file.name} (${fileSize} MB)`;
                        infoDiv.style.display = 'block';
                    } else {
                        infoDiv.style.display = 'none';
                    }
                });
            }
            
            // Обработчик для поля файла в сообщении сотруднику
            const employeeFileInput = document.getElementById('employee-message-file');
            if (employeeFileInput) {
                employeeFileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    const infoDiv = document.getElementById('employee-file-info');
                    
                    if (file) {
                        const fileSize = (file.size / 1024 / 1024).toFixed(2);
                        infoDiv.innerHTML = `📄 ${file.name} (${fileSize} MB)`;
                        infoDiv.style.display = 'block';
                    } else {
                        infoDiv.style.display = 'none';
                    }
                });
            }
        });
        
        function showAddEmployeeModal() {
            // Скрываем все модальные окна
            document.getElementById('employees-management-modal').style.display = 'none';
            document.getElementById('edit-employee-modal').style.display = 'none';
            document.getElementById('admin-menu-modal').style.display = 'none';
            
            // Показываем модальное окно добавления
            document.getElementById('add-employee-modal').style.display = 'block';
            
            // Очищаем поля
            document.getElementById('add-phone').value = '';
            document.getElementById('add-first-name').value = '';
            document.getElementById('add-last-name').value = '';
            document.getElementById('add-is-admin').checked = false;
        }
        
        async function addEmployee() {
            try {
                const phoneNumber = document.getElementById('add-phone').value.trim();
                const firstName = document.getElementById('add-first-name').value.trim();
                const lastName = document.getElementById('add-last-name').value.trim();
                const isAdmin = document.getElementById('add-is-admin').checked;
                
                if (!phoneNumber || !firstName || !lastName) {
                    tg.showAlert('Заполните все поля');
                    return;
                }
                
                const response = await fetch('http://localhost:5000/api/admin/employee/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        phone_number: phoneNumber,
                        first_name: firstName,
                        last_name: lastName,
                        is_admin: isAdmin
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    tg.showAlert(result.message);
                    showEmployeesManagement(); // Возвращаемся к списку и обновляем его
                } else {
                    tg.showAlert('Ошибка: ' + result.error);
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Ошибка добавления сотрудника');
            }
        }
        
        function editEmployee(phone, firstName, lastName, isAdmin) {
            // Скрываем все модальные окна
            document.getElementById('employees-management-modal').style.display = 'none';
            document.getElementById('add-employee-modal').style.display = 'none';
            document.getElementById('admin-menu-modal').style.display = 'none';
            
            // Показываем модальное окно редактирования
            document.getElementById('edit-employee-modal').style.display = 'block';
            
            // Заполняем поля
            document.getElementById('edit-phone').value = phone;
            document.getElementById('edit-first-name').value = firstName;
            document.getElementById('edit-last-name').value = lastName;
            document.getElementById('edit-is-admin').checked = isAdmin;
        }
        
        async function saveEmployeeChanges() {
            try {
                const phoneNumber = document.getElementById('edit-phone').value.trim();
                const firstName = document.getElementById('edit-first-name').value.trim();
                const lastName = document.getElementById('edit-last-name').value.trim();
                const isAdmin = document.getElementById('edit-is-admin').checked;
                
                if (!firstName || !lastName) {
                    tg.showAlert('Заполните все поля');
                    return;
                }
                
                const response = await fetch('http://localhost:5000/api/admin/employee/edit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        phone_number: phoneNumber,
                        first_name: firstName,
                        last_name: lastName,
                        is_admin: isAdmin
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    tg.showAlert(result.message);
                    showEmployeesManagement(); // Возвращаемся к списку и обновляем его
                } else {
                    tg.showAlert('Ошибка: ' + result.error);
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Ошибка сохранения изменений');
            }
        }
        
        async function deleteEmployee(phone, firstName, lastName) {
            try {
                // Подтверждение удаления
                if (!confirm(`Вы уверены, что хотите удалить сотрудника ${firstName} ${lastName}?\n\nЭто действие нельзя отменить. Будут удалены все данные сотрудника: режимы работы, отсутствия, больничные, обращения.`)) {
                    return;
                }
                
                const response = await fetch('http://localhost:5000/api/admin/employee/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        phone_number: phone
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    tg.showAlert(result.message);
                    await loadEmployeesList(); // Обновляем список
                } else {
                    tg.showAlert('Ошибка: ' + result.error);
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Ошибка удаления сотрудника');
            }
        }
        
        function filterEmployees() {
            const searchTerm = document.getElementById('employee-search').value.toLowerCase().trim();
            
            if (!searchTerm) {
                // Если поиск пустой, показываем всех сотрудников
                filteredEmployees = [...allEmployees];
            } else {
                // Фильтруем по имени, фамилии или номеру телефона
                filteredEmployees = allEmployees.filter(emp => {
                    const fullName = `${emp.first_name} ${emp.last_name}`.toLowerCase();
                    const phone = emp.phone.toLowerCase();
                    
                    return fullName.includes(searchTerm) || 
                           emp.first_name.toLowerCase().includes(searchTerm) ||
                           emp.last_name.toLowerCase().includes(searchTerm) ||
                           phone.includes(searchTerm);
                });
            }
            
            displayEmployeesList(filteredEmployees);
            updateSearchResultsCount();
        }
        
        function updateSearchResultsCount() {
            const searchTerm = document.getElementById('employee-search').value.trim();
            const countElement = document.getElementById('search-results-count');
            
            if (!searchTerm) {
                countElement.textContent = '';
                countElement.style.color = 'rgba(255,255,255,0.6)';
            } else {
                if (filteredEmployees.length === 0) {
                    countElement.textContent = 'Сотрудники не найдены';
                    countElement.style.color = 'rgba(255, 71, 87, 0.8)';
                } else if (filteredEmployees.length === 1) {
                    countElement.textContent = 'Найден 1 сотрудник';
                    countElement.style.color = 'rgba(46, 213, 115, 0.8)';
                } else {
                    countElement.textContent = `Найдено ${filteredEmployees.length} сотрудников`;
                    countElement.style.color = 'rgba(46, 213, 115, 0.8)';
                }
            }
        }
        
        async function loadUserAvatar() {
            try {
                const user = tg.initDataUnsafe?.user;
                console.log('Загрузка аватарки для пользователя:', user);
                console.log('Полные данные tg.initDataUnsafe:', tg.initDataUnsafe);
                console.log('tg.initData:', tg.initData);
                
                if (!user) {
                    console.log('Нет данных пользователя');
                    return;
                }
                
                const avatarEl = document.getElementById('avatar');
                
                // Проверяем, есть ли photo_url в данных пользователя от Telegram
                if (user.photo_url) {
                    console.log('Найдена аватарка в данных Telegram:', user.photo_url);
                    avatarEl.innerHTML = `<img src="${user.photo_url}" alt="Avatar">`;
                    return;
                }
                
                // Если нет photo_url, пытаемся получить через tg.initDataUnsafe
                const initData = tg.initDataUnsafe;
                if (initData && initData.user && initData.user.photo_url) {
                    console.log('Найдена аватарка в initDataUnsafe:', initData.user.photo_url);
                    avatarEl.innerHTML = `<img src="${initData.user.photo_url}" alt="Avatar">`;
                    return;
                }
                
                // Пытаемся загрузить через Flask API
                console.log('Пытаемся загрузить аватарку через API...');
                try {
                    const apiResponse = await fetch(`http://localhost:5000/api/user-avatar?user_id=${user.id}`, {
                        method: 'GET'
                    });
                    
                    console.log('Ответ API аватарки:', apiResponse.status);
                    
                    if (apiResponse.ok) {
                        const apiData = await apiResponse.json();
                        console.log('Данные аватарки от API:', apiData);
                        
                        if (apiData.avatar_url) {
                            console.log('Устанавливаем аватарку от API:', apiData.avatar_url);
                            avatarEl.innerHTML = `<img src="${apiData.avatar_url}" alt="Avatar">`;
                            return;
                        }
                    }
                } catch (apiError) {
                    console.log('Ошибка API аватарки:', apiError);
                }
                
                // Если API не сработал, оставляем пустой круг с градиентом
                console.log('Аватарка не найдена, оставляем пустой круг');
                avatarEl.innerHTML = '';
                avatarEl.textContent = '';
                
            } catch (error) {
                console.error('Ошибка загрузки аватарки:', error);
                // В случае ошибки оставляем пустой круг
                const avatarEl = document.getElementById('avatar');
                avatarEl.innerHTML = '';
                avatarEl.textContent = '';
            }
        }
        
        async function loadUserData() {
            try {
                // Возвращаем API вызов для получения данных пользователя
                const response = await fetch('http://localhost:5000/api/user-info', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData
                    })
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки данных');
                }

                const data = await response.json();
                
                // Сохраняем данные пользователя глобально
                currentUserData = data;
                
                // Обновляем интерфейс
                document.getElementById('name').textContent = data.user.first_name || 'Aleksei';
                
                // Загружаем аватарку пользователя (или показываем инициалы)
                loadUserAvatar();
                
                // Для демо-режима показываем базовую информацию
                const workStatusEl = document.getElementById('work-status');
                if (workStatusEl) workStatusEl.textContent = 'Удаленная работа';
                
                const vacationInfoEl = document.getElementById('vacation-info');
                if (vacationInfoEl) vacationInfoEl.textContent = 'Отпуск не запланирован';
                
                const dailyFactEl = document.getElementById('daily-fact');
                if (dailyFactEl) dailyFactEl.textContent = 'Добро пожаловать в Maria Bot!';
                
                // Показываем админское меню, если пользователь администратор
                if (data.user.is_admin) {
                    const adminBtnEl = document.getElementById('admin-btn');
                    if (adminBtnEl) adminBtnEl.style.display = 'inline-flex';
                }
                
                // Показываем приложение
                document.getElementById('loading').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                
            } catch (error) {
                console.error('Ошибка:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
            }
        }

        // Переменные для режима работы
        let selectedMode = null;
        let selectedPeriod = null;
        let workModeOptions = null;
        
        // Переменные для отсутствия
        let absenceOptions = null;
        let selectedAbsenceDate = null;
        let selectedAbsenceTime = null;
        let customAbsenceDate = null;
        let customAbsenceStartTime = null;
        let customAbsenceEndTime = null;
        
        // Переменные для SOS
        let sosOptions = null;
        let selectedIssueType = null;
        let selectedAnonymity = null;
        let sosPseudonym = null;
        let sosDescription = null;
        
        // Переменные для больничного
        let sickLeaveOptions = null;
        let selectedLeaveType = null;
        
        // Переменные для чата
        let chatRefreshInterval = null;
        
        // Переменные для поиска сотрудников
        let allEmployees = [];
        let filteredEmployees = [];
        
        // Переменные для обращений
        let allIssues = [];
        let filteredIssues = [];

        async function handleAction(action) {
            try {
                if (action === 'vacation') {
                    tg.showAlert('Функция "Мой отпуск" в разработке');
                    return;
                }
                
                if (action === 'work_mode') {
                    await showWorkModeModal();
                    return;
                }
                
                if (action === 'absence') {
                    await showAbsenceModal();
                    return;
                }
                
                if (action === 'sick_leave') {
                    await showSickLeaveModal();
                    return;
                }
                
                if (action === 'crocotime') {
                    tg.showAlert('Функция "Мой Crocotime" в разработке');
                    return;
                }
                
                if (action === 'admin' || action === 'admin_menu') {
                    await showAdminMenuModal();
                    return;
                }
                
                if (action === 'sos') {
                    await showSosModal();
                    return;
                }
                
                if (action === 'sos_menu') {
                    await showSosMenuModal();
                    return;
                }
                
                // Показываем индикатор загрузки
                tg.showAlert('Обрабатываем запрос...');
                
                const response = await fetch('http://localhost:5000/api/actions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        action: action
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    if (result.redirect) {
                        if (result.action === 'work_mode') {
                            await showWorkModeModal();
                        } else if (result.action === 'absence') {
                            await showAbsenceModal();
                        } else if (result.action === 'sos') {
                            await showSosModal();
                        } else if (result.action === 'sos_menu') {
                            await showSosMenuModal();
                        } else if (result.action === 'sick_leave') {
                            await showSickLeaveModal();
                        } else if (result.action === 'admin_menu') {
                            await showAdminMenuModal();
                        }
                    } else {
                        tg.showAlert(result.message || 'Действие выполнено');
                    }
                } else {
                    tg.showAlert('Ошибка: ' + result.error);
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Произошла ошибка при выполнении действия');
            }
        }
        
        async function showSosModal() {
            try {
                // Загружаем опции SOS
                const response = await fetch('http://localhost:5000/api/sos', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки данных');
                }

                sosOptions = await response.json();
                
                // Показываем модальное окно
                document.getElementById('app').style.display = 'none';
                document.getElementById('sos-menu-modal').style.display = 'none';
                document.getElementById('sos-modal').style.display = 'block';
                
                // Заполняем типы проблем
                const typesContainer = document.getElementById('sos-issue-types');
                typesContainer.innerHTML = '';
                
                sosOptions.issue_types.forEach((type, index) => {
                    const button = document.createElement('button');
                    button.className = 'btn';
                    const colors = ['#ef4444', '#f59e0b', '#10b981', '#8b5cf6', '#3b82f6'];
                    const color = colors[index % colors.length];
                    // Убираем эмодзи и переименовываем
                    let cleanName = type.name.replace(/[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu, '').trim();
                    if (cleanName.includes('Проблема личного характера')) cleanName = 'Личная проблема';
                    if (cleanName.includes('Техническая проблема')) cleanName = 'Техническая проблема';
                    button.innerHTML = `<span class="dot" style="background: ${color};"></span><span>${cleanName}</span>`;
                    button.onclick = () => selectIssueType(type.id, button);
                    button.dataset.typeId = type.id;
                    typesContainer.appendChild(button);
                });
                
                // Сбрасываем состояние
                selectedIssueType = null;
                selectedAnonymity = null;
                sosPseudonym = null;
                sosDescription = null;
                
                // Сбрасываем выделение всех кнопок
                setTimeout(() => {
                    const allButtons = document.querySelectorAll('#sos-issue-types .btn, #sos-anonymity-options .btn');
                    allButtons.forEach(btn => {
                        btn.style.background = 'var(--navy-700)';
                    });
                }, 100);
                
                // Скрываем все секции
                document.getElementById('sos-anonymity-section').style.display = 'none';
                document.getElementById('sos-anonymity-options').style.display = 'none';
                document.getElementById('sos-pseudonym-section').style.display = 'none';
                document.getElementById('sos-description-section').style.display = 'none';
                document.getElementById('sos-confirmation-section').style.display = 'none';
                
                // Очищаем поля ввода
                document.getElementById('sos-pseudonym').value = '';
                document.getElementById('sos-description').value = '';
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Ошибка загрузки данных');
            }
        }
        
        function selectIssueType(typeId, selectedButton) {
            selectedIssueType = typeId;
            
            // Сбрасываем стили всех кнопок типов проблем
            const typeButtons = document.querySelectorAll('#sos-issue-types .btn');
            typeButtons.forEach(btn => {
                btn.style.background = 'var(--navy-700)';
            });
            
            // Подсвечиваем выбранную кнопку
            if (selectedButton) {
                selectedButton.style.background = '#ea580c';
            }
            
            // Показываем секцию выбора анонимности
            document.getElementById('sos-anonymity-section').style.display = 'block';
            document.getElementById('sos-anonymity-options').style.display = 'block';
            
            // Заполняем опции анонимности
            const anonymityContainer = document.getElementById('sos-anonymity-options');
            anonymityContainer.innerHTML = '';
            
            sosOptions.anonymity_options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'btn';
                const colors = ['#10b981', '#f59e0b', '#8b5cf6'];
                const color = colors[index % colors.length];
                // Убираем эмодзи и переименовываем
                let cleanName = option.name.replace(/[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu, '').trim();
                if (cleanName.includes('Открыто (с именем)')) cleanName = 'Открыто';
                if (cleanName.includes('Анонимно')) cleanName = 'Анонимно';
                button.innerHTML = `<span class="dot" style="background: ${color};"></span><span>${cleanName}</span>`;
                button.onclick = () => selectAnonymity(option.id, button);
                button.dataset.anonymityId = option.id;
                anonymityContainer.appendChild(button);
            });
        }
        
        function selectAnonymity(anonymityId, selectedButton) {
            selectedAnonymity = anonymityId;
            
            // Сбрасываем стили всех кнопок анонимности
            const anonymityButtons = document.querySelectorAll('#sos-anonymity-options .btn');
            anonymityButtons.forEach(btn => {
                btn.style.background = 'var(--navy-700)';
            });
            
            // Подсвечиваем выбранную кнопку
            if (selectedButton) {
                selectedButton.style.background = '#ea580c';
            }
            
            if (anonymityId === 'anonymous') {
                // Показываем поле для ввода псевдонима
                document.getElementById('sos-pseudonym-section').style.display = 'block';
                document.getElementById('sos-description-section').style.display = 'none';
            } else {
                // Переходим сразу к описанию
                document.getElementById('sos-pseudonym-section').style.display = 'none';
                document.getElementById('sos-description-section').style.display = 'block';
            }
        }
        
        function selectSosPseudonym() {
            const pseudonymInput = document.getElementById('sos-pseudonym');
            sosPseudonym = pseudonymInput.value.trim();
            
            if (!sosPseudonym) {
                tg.showAlert('Пожалуйста, введите псевдоним');
                return;
            }
            
            // Переходим к описанию
            document.getElementById('sos-pseudonym-section').style.display = 'none';
            document.getElementById('sos-description-section').style.display = 'block';
        }
        
        async function submitSos() {
            // Получаем описание
            const descriptionInput = document.getElementById('sos-description');
            sosDescription = descriptionInput.value.trim();
            
            if (!sosDescription) {
                tg.showAlert('Пожалуйста, опиши проблему');
                return;
            }
            
            if (sosDescription.length < 10) {
                tg.showAlert('Описание должно содержать минимум 10 символов');
                return;
            }
            
            // Находим выбранный тип проблемы
            const selectedTypeButton = document.querySelector('#sos-issue-types .btn[style*="#ea580c"]');
            let typeName = 'Неизвестный тип';
            if (selectedTypeButton) {
                // Извлекаем только текст, исключая dot
                const textSpan = selectedTypeButton.querySelector('span:last-child');
                typeName = textSpan ? textSpan.textContent.trim() : selectedTypeButton.textContent.trim();
            }
            
            // Находим выбранный способ обращения
            const selectedAnonymityButton = document.querySelector('#sos-anonymity-options .btn[style*="#ea580c"]');
            let anonymityName = 'Неизвестно';
            if (selectedAnonymityButton) {
                // Извлекаем только текст, исключая dot
                const textSpan = selectedAnonymityButton.querySelector('span:last-child');
                anonymityName = textSpan ? textSpan.textContent.trim() : selectedAnonymityButton.textContent.trim();
            }
            
            // Формируем текст подтверждения
            let confirmationText = '';
            if (sosPseudonym) {
                confirmationText += `Псевдоним: ${sosPseudonym}\n`;
            }
            confirmationText += `Обращение: ${sosDescription}`;
            
            // Показываем подтверждение
            document.getElementById('sos-confirmation-text').textContent = confirmationText;
            document.getElementById('sos-description-section').style.display = 'none';
            document.getElementById('sos-pseudonym-section').style.display = 'none';
            document.getElementById('sos-confirmation-section').style.display = 'block';
        }
        
        async function confirmSos() {
            try {
                const response = await fetch('http://localhost:5000/api/sos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        issue_type: selectedIssueType,
                        anonymity: selectedAnonymity,
                        description: sosDescription,
                        pseudonym: sosPseudonym || ''
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    tg.showAlert('Юху 🎉! Готово!');
                    // После успешной отправки возвращаемся в меню "Сообщить о проблеме"
                        setTimeout(() => {
                        showSosModal();
                        }, 1000);
                } else {
                    tg.showAlert('Ошибка: ' + result.error);
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Произошла ошибка при отправке');
            }
        }
        
        async function showSickLeaveModal() {
            try {
                // Загружаем опции больничного
                const response = await fetch('http://localhost:5000/api/sick-leave', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки данных');
                }

                sickLeaveOptions = await response.json();
                
                // Показываем модальное окно
                document.getElementById('app').style.display = 'none';
                document.getElementById('sick-leave-modal').style.display = 'block';
                
                // Заполняем типы больничного
                const typesContainer = document.getElementById('sick-leave-types');
                typesContainer.innerHTML = '';
                
                sickLeaveOptions.leave_types.forEach((type, index) => {
                    const button = document.createElement('button');
                    button.className = 'btn';
                    const colors = ['#8b5cf6', '#f59e0b', '#ef4444', '#10b981', '#3b82f6'];
                    const color = colors[index % colors.length];
                    // Убираем эмодзи и переименовываем
                    let cleanName = type.name.replace(/[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu, '').trim();
                    if (cleanName.includes('Первичный больничный')) cleanName = 'Первичный';
                    if (cleanName.includes('Продление больничного')) cleanName = 'Продление';
                    button.innerHTML = `<span class="dot" style="background: ${color};"></span><span>${cleanName}</span>`;
                    button.onclick = () => selectLeaveType(type.id, button);
                    button.dataset.typeId = type.id;
                    typesContainer.appendChild(button);
                });
                
                // Сбрасываем состояние
                selectedLeaveType = null;
                document.getElementById('sick-leave-form-section').style.display = 'none';
                
                // Очищаем форму
                document.getElementById('sick-leave-number').value = '';
                document.getElementById('sick-leave-start-date').value = '';
                document.getElementById('sick-leave-end-date').value = '';
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Ошибка загрузки данных');
            }
        }
        
        function selectLeaveType(typeId, selectedButton) {
            selectedLeaveType = typeId;
            
            // Сбрасываем стили всех кнопок типов больничного
            const typeButtons = document.querySelectorAll('#sick-leave-types .btn');
            typeButtons.forEach(btn => {
                btn.style.background = 'var(--navy-700)';
            });
            
            // Подсвечиваем выбранную кнопку
            if (selectedButton) {
                selectedButton.style.background = '#ea580c';
            }
            
            // Показываем форму
            document.getElementById('sick-leave-form-section').style.display = 'block';
            
            // Устанавливаем сегодняшнюю дату по умолчанию
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('sick-leave-start-date').value = today;
            document.getElementById('sick-leave-end-date').value = today;
        }
        
        
        async function submitSickLeave() {
            console.log('🔍 submitSickLeave() вызвана');
            console.log('🔍 selectedLeaveType:', selectedLeaveType);
            
            const leaveNumber = document.getElementById('sick-leave-number').value.trim();
            const startDate = document.getElementById('sick-leave-start-date').value;
            const endDate = document.getElementById('sick-leave-end-date').value;
            
            console.log('🔍 Данные формы:', { leaveNumber, startDate, endDate });
            
            if (!leaveNumber) {
                tg.showAlert('Пожалуйста, введи номер ЭЛН');
                return;
            }
            
            if (!startDate || !endDate) {
                tg.showAlert('Пожалуйста, укажи даты больничного');
                return;
            }
            
            if (startDate > endDate) {
                tg.showAlert('Дата начала не может быть позже даты окончания');
                return;
            }
            
            // Находим выбранный тип больничного
            const selectedTypeButton = document.querySelector('#sick-leave-types .btn[style*="#ea580c"]');
            let typeName = 'Неизвестный тип';
            
            if (selectedTypeButton) {
                // Извлекаем текст из span внутри кнопки
                const textSpan = selectedTypeButton.querySelector('span:last-child');
                typeName = textSpan ? textSpan.textContent.trim() : selectedTypeButton.textContent.trim();
            } else if (selectedLeaveType) {
                // Если кнопка не найдена, но есть selectedLeaveType, найдем по dataset
                const typeButton = document.querySelector(`#sick-leave-types .btn[data-type-id="${selectedLeaveType}"]`);
                if (typeButton) {
                    const textSpan = typeButton.querySelector('span:last-child');
                    typeName = textSpan ? textSpan.textContent.trim() : typeButton.textContent.trim();
                }
            }
            
            // Форматируем даты
            const startDateFormatted = new Date(startDate).toLocaleDateString('ru-RU');
            const endDateFormatted = new Date(endDate).toLocaleDateString('ru-RU');
            
            // Формируем текст подтверждения
            const confirmationText = `Тип: ${typeName}\nНомер ЭЛН: ${leaveNumber}\nПериод: ${startDateFormatted} - ${endDateFormatted}`;
            
            // Показываем подтверждение
            document.getElementById('sick-leave-confirmation-text').textContent = confirmationText;
            document.getElementById('sick-leave-form-section').style.display = 'none';
            document.getElementById('sick-leave-confirmation-section').style.display = 'block';
        }
        
        function resetSickLeaveForm() {
            // Сбрасываем все состояние больничного
            selectedLeaveType = null;
            
            // Очищаем форму
            document.getElementById('sick-leave-number').value = '';
            document.getElementById('sick-leave-start-date').value = '';
            document.getElementById('sick-leave-end-date').value = '';
            
            // Скрываем все секции
            document.getElementById('sick-leave-form-section').style.display = 'none';
            document.getElementById('sick-leave-confirmation-section').style.display = 'none';
            
            // Сбрасываем стили кнопок типов
            const typeButtons = document.querySelectorAll('#sick-leave-types .btn');
            typeButtons.forEach(btn => {
                btn.style.background = 'var(--navy-700)';
            });
        }

        function cancelSickLeave() {
            // Сбрасываем форму при отмене
            resetSickLeaveForm();
            // Возвращаемся в главное меню
            showMainApp();
        }
        
        async function confirmSickLeave() {
            console.log('🔍 confirmSickLeave() вызвана');
            console.log('🔍 selectedLeaveType:', selectedLeaveType);
            try {
                const leaveNumber = document.getElementById('sick-leave-number').value.trim();
                const startDate = document.getElementById('sick-leave-start-date').value;
                const endDate = document.getElementById('sick-leave-end-date').value;
                
                console.log('🔍 Данные больничного:', { leaveNumber, startDate, endDate });
                
                const response = await fetch('http://localhost:5000/api/sick-leave', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        leave_type: selectedLeaveType,
                        leave_number: leaveNumber,
                        start_date: startDate,
                        end_date: endDate
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    resetSickLeaveForm(); // Сбрасываем форму после успешного сохранения
                    tg.showAlert('Юху 🎉! Готово!');
                    showMainApp();
                } else {
                    tg.showAlert('Ошибка: ' + result.error);
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Произошла ошибка при сохранении');
            }
        }
        
        async function showAbsenceModal() {
            try {
                // Загружаем опции отсутствия
                const response = await fetch('http://localhost:5000/api/absence', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки данных');
                }

                absenceOptions = await response.json();
                
                // Показываем модальное окно
                document.getElementById('app').style.display = 'none';
                document.getElementById('absence-modal').style.display = 'block';
                
                // Заполняем даты
                const datesContainer = document.getElementById('absence-dates');
                datesContainer.innerHTML = '';
                
                absenceOptions.dates.forEach(date => {
                    const button = document.createElement('button');
                    button.className = 'btn';
                    // Разные цвета для каждой кнопки даты
                    let dotColor = '#ef4444'; // красный для сегодня
                    if (date.id === 'tomorrow') {
                        dotColor = '#f59e0b'; // оранжевый для завтра
                    } else if (date.id === 'custom') {
                        dotColor = '#8b5cf6'; // фиолетовый для "своя дата"
                    }
                    button.innerHTML = `<span class="dot" style="background: ${dotColor};"></span><span>${date.name}</span>`;
                    button.onclick = () => selectAbsenceDate(date.id, date.date, button);
                    datesContainer.appendChild(button);
                });
                
                // Сбрасываем состояние
                selectedAbsenceDate = null;
                selectedAbsenceTime = null;
                customAbsenceDate = null;
                customAbsenceStartTime = null;
                customAbsenceEndTime = null;
                
                // Скрываем секции времени и подтверждения
                document.getElementById('absence-time-section').style.display = 'none';
                document.getElementById('absence-times').style.display = 'none';
                document.getElementById('absence-custom-date').style.display = 'none';
                document.getElementById('absence-custom-time').style.display = 'none';
                document.getElementById('absence-confirmation-section').style.display = 'none';
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Ошибка загрузки данных');
            }
        }
        
        function selectAbsenceDate(dateId, dateValue, selectedButton) {
            selectedAbsenceDate = dateId;
            
            // Убираем подсветку со всех кнопок дат (как в режиме работы)
            const allDateButtons = document.querySelectorAll('#absence-dates .btn');
            allDateButtons.forEach(btn => {
                btn.style.background = 'var(--navy-700)';
            });
            
            // Подсвечиваем выбранную кнопку оранжевым (как в режиме работы)
            selectedButton.style.background = '#ea580c';
            
            if (dateId === 'custom') {
                // Показываем поле для ввода даты
                document.getElementById('absence-custom-date').style.display = 'block';
                document.getElementById('absence-time-section').style.display = 'none';
                document.getElementById('absence-times').style.display = 'none';
            } else {
                // Показываем секцию выбора времени
                document.getElementById('absence-time-section').style.display = 'block';
                document.getElementById('absence-times').style.display = 'grid';
                document.getElementById('absence-custom-date').style.display = 'none';
                
                // Заполняем времена
                const timesContainer = document.getElementById('absence-times');
                timesContainer.innerHTML = '';
                
                absenceOptions.times.forEach(time => {
                    const button = document.createElement('button');
                    button.className = 'btn';
                    // Разные цвета для каждой кнопки времени
                    let dotColor = '#10b981'; // зеленый для утра
                    if (time.id === 'afternoon') {
                        dotColor = '#3b82f6'; // синий для дня
                    } else if (time.id === 'all_day') {
                        dotColor = '#06b6d4'; // голубой для всего дня
                    } else if (time.id === 'custom') {
                        dotColor = '#8b5cf6'; // фиолетовый для "свое время"
                    }
                    button.innerHTML = `<span class="dot" style="background: ${dotColor};"></span><span>${time.name}</span>`;
                    button.onclick = () => selectAbsenceTime(time.id, time.start, time.end, button);
                    timesContainer.appendChild(button);
                });
            }
        }
        
        function selectAbsenceCustomDate() {
            const dateInput = document.getElementById('absence-date');
            customAbsenceDate = dateInput.value;
            
            if (!customAbsenceDate) {
                tg.showAlert('Пожалуйста, выберите дату');
                return;
            }
            
            // Показываем секцию выбора времени
            document.getElementById('absence-time-section').style.display = 'block';
            document.getElementById('absence-times').style.display = 'grid';
            document.getElementById('absence-custom-date').style.display = 'none';
            
            // Заполняем времена
            const timesContainer = document.getElementById('absence-times');
            timesContainer.innerHTML = '';
            
            absenceOptions.times.forEach(time => {
                const button = document.createElement('button');
                button.className = 'btn';
                // Разные цвета для каждой кнопки времени
                let dotColor = '#10b981'; // зеленый для утра
                if (time.id === 'afternoon') {
                    dotColor = '#3b82f6'; // синий для дня
                } else if (time.id === 'all_day') {
                    dotColor = '#06b6d4'; // голубой для всего дня
                } else if (time.id === 'custom') {
                    dotColor = '#8b5cf6'; // фиолетовый для "свое время"
                }
                button.innerHTML = `<span class="dot" style="background: ${dotColor};"></span><span>${time.name}</span>`;
                button.onclick = () => selectAbsenceTime(time.id, time.start, time.end, button);
                timesContainer.appendChild(button);
            });
        }
        
        function selectAbsenceTime(timeId, startTime, endTime, selectedButton) {
            selectedAbsenceTime = timeId;
            
            // Убираем подсветку со всех кнопок времени (как в режиме работы)
            const allTimeButtons = document.querySelectorAll('#absence-times .btn');
            allTimeButtons.forEach(btn => {
                btn.style.background = 'var(--navy-700)';
            });
            
            // Подсвечиваем выбранную кнопку оранжевым (как в режиме работы)
            selectedButton.style.background = '#ea580c';
            
            if (timeId === 'custom') {
                // Показываем поля для ввода времени
                document.getElementById('absence-custom-time').style.display = 'block';
                document.getElementById('absence-confirmation-section').style.display = 'none';
            } else {
                customAbsenceStartTime = startTime;
                customAbsenceEndTime = endTime;
                
                // Показываем подтверждение
                showAbsenceConfirmation();
            }
        }
        
        function showAbsenceConfirmation() {
            // Определяем дату
            let dateText = '';
            let dateValue = '';
            
            if (selectedAbsenceDate === 'custom') {
                const date = new Date(customAbsenceDate);
                dateText = date.toLocaleDateString('ru-RU');
                dateValue = customAbsenceDate;
            } else {
                const dateOption = absenceOptions.dates.find(d => d.id === selectedAbsenceDate);
                dateText = dateOption.name.substring(dateOption.name.indexOf('(') + 1, dateOption.name.indexOf(')'));
                dateValue = dateOption.date;
            }
            
            // Определяем время
            let timeText = '';
            let startTimeValue = '';
            let endTimeValue = '';
            
            if (selectedAbsenceTime === 'custom') {
                startTimeValue = document.getElementById('absence-start-time').value;
                endTimeValue = document.getElementById('absence-end-time').value;
                timeText = `${startTimeValue} - ${endTimeValue}`;
            } else {
                const timeOption = absenceOptions.times.find(t => t.id === selectedAbsenceTime);
                timeText = timeOption.name.substring(timeOption.name.indexOf('(') + 1, timeOption.name.indexOf(')'));
                startTimeValue = customAbsenceStartTime;
                endTimeValue = customAbsenceEndTime;
            }
            
            // Показываем подтверждение
            document.getElementById('absence-confirmation-text').innerHTML = 
                `Дата: <strong>${dateText}</strong><br>Время: <strong>${timeText}</strong>`;
            
            document.getElementById('absence-custom-time').style.display = 'none';
            document.getElementById('absence-confirmation-section').style.display = 'block';
        }
        
        function confirmAbsence() {
            // Вызываем функцию отправки данных
            submitAbsence();
        }
        
        async function submitAbsence() {
            try {
                // Если выбрано свое время, получаем значения из полей
                if (selectedAbsenceTime === 'custom') {
                    customAbsenceStartTime = document.getElementById('absence-start-time').value;
                    customAbsenceEndTime = document.getElementById('absence-end-time').value;
                    
                    if (!customAbsenceStartTime || !customAbsenceEndTime) {
                        tg.showAlert('Пожалуйста, укажите время начала и окончания');
                        return;
                    }
                }
                
                // Определяем дату
                let dateValue = '';
                
                if (selectedAbsenceDate === 'custom') {
                    dateValue = customAbsenceDate;
                } else {
                    // Для today/tomorrow берем дату из absenceOptions
                    const dateOption = absenceOptions.dates.find(d => d.id === selectedAbsenceDate);
                    if (dateOption) {
                        dateValue = dateOption.date;
                    }
                }
                
                const response = await fetch('http://localhost:5000/api/absence', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        date_option: selectedAbsenceDate,
                        custom_date: dateValue,
                        time_option: selectedAbsenceTime,
                        start_time: customAbsenceStartTime,
                        end_time: customAbsenceEndTime
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    tg.showAlert(result.message);
                    showMainApp();
                } else {
                    tg.showAlert('Ошибка: ' + result.error);
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Произошла ошибка при сохранении');
            }
        }

        async function showWorkModeModal() {
            try {
                // Загружаем опции режима работы
                const response = await fetch('http://localhost:5000/api/work-mode', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки данных');
                }

                workModeOptions = await response.json();
                
                // Показываем модальное окно
                document.getElementById('app').style.display = 'none';
                document.getElementById('work-mode-modal').style.display = 'block';
                
                // Заполняем режимы работы
                const modesContainer = document.getElementById('work-modes');
                modesContainer.innerHTML = '';
                
                workModeOptions.modes.forEach((mode, index) => {
                    const button = document.createElement('button');
                    button.className = 'btn';
                    const colors = ['#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#3b82f6'];
                    const color = colors[index % colors.length];
                    // Убираем эмодзи и переименовываем
                    let cleanName = mode.name.replace(/[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu, '').trim();
                    if (cleanName.includes('Офисный формат работы')) cleanName = 'Офисный';
                    if (cleanName.includes('Удаленный формат работы') || cleanName.includes('Удалённый формат работы')) cleanName = 'Удалённый';
                    button.innerHTML = `<span class="dot" style="background: ${color};"></span><span>${cleanName}</span>`;
                    button.onclick = () => selectWorkMode(mode.id, button);
                    button.dataset.modeId = mode.id;
                    modesContainer.appendChild(button);
                });
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Ошибка загрузки данных');
            }
        }

        function selectWorkMode(mode, selectedButton) {
            selectedMode = mode;
            
            // Убираем подсветку со всех кнопок режимов
            const allModeButtons = document.querySelectorAll('#work-modes .btn');
            allModeButtons.forEach(btn => {
                btn.style.background = 'var(--navy-700)';
            });
            
            // Подсвечиваем выбранную кнопку
            selectedButton.style.background = '#ea580c';
            
            // Показываем секцию выбора периода
            document.getElementById('period-section').style.display = 'block';
            document.getElementById('work-periods').style.display = 'grid';
            
            // Заполняем периоды
            const periodsContainer = document.getElementById('work-periods');
            periodsContainer.innerHTML = '';
            
            workModeOptions.periods.forEach((period, index) => {
                const button = document.createElement('button');
                button.className = 'btn';
                const colors = ['#f59e0b', '#10b981', '#8b5cf6', '#3b82f6', '#ef4444'];
                const color = colors[index % colors.length];
                // Убираем эмодзи из названия
                const cleanName = period.name.replace(/[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu, '').trim();
                button.innerHTML = `<span class="dot" style="background: ${color};"></span><span>${cleanName}</span>`;
                button.onclick = () => selectPeriod(period.id, button);
                button.dataset.periodId = period.id;
                periodsContainer.appendChild(button);
            });
        }

        function selectPeriod(period, selectedButton) {
            selectedPeriod = period;
            
            // Убираем подсветку со всех кнопок периодов
            const allPeriodButtons = document.querySelectorAll('#work-periods .btn');
            allPeriodButtons.forEach(btn => {
                btn.style.background = 'var(--navy-700)';
            });
            
            // Подсвечиваем выбранную кнопку
            if (selectedButton) {
                selectedButton.style.background = '#ea580c';
            }
            
            if (period === 'custom') {
                // Показываем поля для ввода дат
                document.getElementById('custom-period').style.display = 'block';
                document.getElementById('confirmation-section').style.display = 'none';
            } else {
                // Показываем подтверждение
                showConfirmation();
            }
        }

        function showConfirmation() {
            const modeText = workModeOptions.modes.find(m => m.id === selectedMode).name;
            const periodText = workModeOptions.periods.find(p => p.id === selectedPeriod).name;
            
            document.getElementById('confirmation-text').innerHTML = 
                `Режим: <strong>${modeText}</strong><br>Период: <strong>${periodText}</strong>`;
            
            document.getElementById('custom-period').style.display = 'none';
            document.getElementById('confirmation-section').style.display = 'block';
        }
        
        function confirmWorkMode() {
            console.log('🔍 confirmWorkMode() вызвана');
            console.log('🔍 selectedMode:', selectedMode);
            console.log('🔍 selectedPeriod:', selectedPeriod);
            
            // Вызываем функцию отправки данных
            submitWorkMode();
        }

        async function submitWorkMode() {
            console.log('🔍 submitWorkMode() начата');
            try {
                let startDate = null;
                let endDate = null;
                
                if (selectedPeriod === 'custom') {
                    startDate = document.getElementById('start-date').value;
                    endDate = document.getElementById('end-date').value;
                    
                    if (!startDate || !endDate) {
                        tg.showAlert('Пожалуйста, укажите даты');
                        return;
                    }
                }
                
                const response = await fetch('http://localhost:5000/api/work-mode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        mode: selectedMode,
                        period: selectedPeriod,
                        start_date: startDate,
                        end_date: endDate
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    tg.showAlert('Юху 🎉! Готово!');
                    showMainApp();
                } else {
                    tg.showAlert('Ошибка: ' + result.error);
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Произошла ошибка при сохранении');
                        }
        }
        
        // Удалено дублирующееся определение showSosMenuModal()
        
        async function loadMyIssues() {
            try {
                const response = await fetch(`http://localhost:5000/api/my-issues?initData=${encodeURIComponent(tg.initData)}`, {
                    method: 'GET'
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки обращений');
                }

                const data = await response.json();
                displayMyIssuesList(data.issues);
                
            } catch (error) {
                console.error('Ошибка:', error);
                document.getElementById('sos-issues-list').innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">Ошибка загрузки обращений</div>';
            }
        }
        
        function displayMyIssuesList(issues) {
            const container = document.getElementById('sos-issues-list');
            
            if (!issues || issues.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">У вас пока нет обращений</div>';
                return;
            }
            
            let html = '<div style="padding: 10px;">';
            
            issues.forEach(issue => {
                let statusIcon = '🟡';
                let statusText = 'Активно';
                let statusColor = '#ffa500';
                if (issue.status === 'closed') {
                    statusIcon = '🔴';
                    statusText = 'Закрыто';
                    statusColor = '#ff4757';
                } else if (issue.status === 'resolved') {
                    statusIcon = '🟢';
                    statusText = 'Решено';
                    statusColor = '#2ed573';
                }
                
                const typeIcon = issue.type === 'personal' ? '💔' : '🖥';
                const typeText = issue.type === 'personal' ? 'Личная проблема' : 'Техническая проблема';
                const anonymityText = issue.is_anonymous ? ` (${issue.pseudonym || 'Анонимно'})` : '';
                
                // Индикатор новых ответов
                const newResponsesBadge = issue.has_new_responses ? 
                    '<span style="background: #ff4757; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: 5px;">НОВЫЕ ОТВЕТЫ</span>' : '';
                
                // Для закрытых обращений убираем возможность клика
                const clickHandler = issue.status === 'closed' ? '' : 'onclick="openMyIssueDialog(' + issue.id + ')"';
                const cursorStyle = issue.status === 'closed' ? 'cursor: not-allowed; opacity: 0.6;' : 'cursor: pointer;';
                
                html += '<div style="background: rgba(255,255,255,0.1); margin: 10px 0; padding: 15px; border-radius: 8px; ' + cursorStyle + '" ' + clickHandler + '>';
                html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">';
                html += '<div style="font-weight: bold;">' + typeIcon + ' Обращение #' + issue.id + anonymityText + newResponsesBadge + '</div>';
                html += '<div style="font-size: 12px; color: ' + statusColor + ';">' + statusIcon + ' ' + statusText + '</div>';
                html += '</div>';
                html += '<div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-bottom: 5px;">' + typeText + '</div>';
                html += '<div style="font-size: 14px; margin-bottom: 8px;">' + issue.description + '</div>';
                
                if (issue.status === 'closed') {
                    html += '<div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-bottom: 5px;">🔒 Обращение закрыто - просмотр недоступен</div>';
                }
                
                html += '<div style="font-size: 12px; color: rgba(255,255,255,0.6);">Создано: ' + new Date(issue.created_at).toLocaleString('ru-RU') + '</div>';
                
                if (issue.admin_response_count > 0) {
                    html += '<div style="font-size: 12px; color: rgba(255,255,255,0.6);">Ответов администратора: ' + issue.admin_response_count + '</div>';
                }
                
                if (issue.last_admin_response_preview) {
                    html += '<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.2);">';
                    html += '<div style="font-size: 12px; color: rgba(255,255,255,0.6);">Последний ответ администратора:</div>';
                    html += '<div style="font-size: 13px; color: rgba(255,255,255,0.8);">' + issue.last_admin_response_preview + '</div>';
                    html += '</div>';
                }
                
                html += '</div>';
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        let currentMyIssueId = null;
        let dialogRefreshInterval = null;
        let currentDialogMessagesCount = 0;
        let lastDialogData = null;
        let adminDialogMessagesCount = 0;
        let adminLastDialogData = null;
        let currentUserData = null;
        let dialogOpenedFromNotification = false;
        
        
        function startDialogAutoRefresh() {
            // Останавливаем предыдущий интервал, если он есть
            if (dialogRefreshInterval) {
                clearInterval(dialogRefreshInterval);
            }
            
            // Запускаем автообновление каждые 2 секунды для реального времени
            dialogRefreshInterval = setInterval(async () => {
                try {
                    // Проверяем, какой диалог открыт
                    const userDialogOpen = document.getElementById('my-issue-dialog-modal').style.display === 'block';
                    const adminDialogOpen = document.getElementById('issue-dialog-modal').style.display === 'block';
                    
                    if (currentMyIssueId && userDialogOpen) {
                        // Пользовательский диалог - умное обновление
                        await smartUpdateDialog(currentMyIssueId, true);
                    } else if (currentIssueId && adminDialogOpen) {
                        // Админский диалог - умное обновление
                        await smartUpdateDialog(currentIssueId, false);
                    }
                } catch (error) {
                    console.error('❌ Ошибка автообновления диалога:', error);
                }
            }, 2000); // Каждые 2 секунды
            
            console.log('✅ Автообновление запущено');
        }
        
        function stopDialogAutoRefresh() {
            if (dialogRefreshInterval) {
                clearInterval(dialogRefreshInterval);
                dialogRefreshInterval = null;
            }
            // Сбрасываем состояние диалогов
            currentDialogMessagesCount = 0;
            lastDialogData = null;
            adminDialogMessagesCount = 0;
            adminLastDialogData = null;
        }
        
        // Умное обновление диалога - добавляет только новые сообщения
        async function smartUpdateDialog(issueId, isUserDialog = true) {
            try {
                const apiUrl = isUserDialog 
                    ? `/api/my-issue/${issueId}/dialog?initData=${encodeURIComponent(tg.initData)}`
                    : `/api/admin/issue/${issueId}/dialog?initData=${encodeURIComponent(tg.initData)}`;
                
                const response = await fetch(apiUrl, { method: 'GET' });
                
                if (!response.ok) {
                    return;
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    return;
                }
                
                // Проверяем, изменилось ли количество сообщений
                const newMessagesCount = data.responses ? data.responses.length : 0;
                
                // Используем правильные переменные для каждого типа диалога
                const currentCount = isUserDialog ? currentDialogMessagesCount : adminDialogMessagesCount;
                const lastData = isUserDialog ? lastDialogData : adminLastDialogData;
                
                if (newMessagesCount === currentCount) {
                    // Нет новых сообщений, не обновляем
                    return;
                }
                
                if (currentCount === 0 || !lastData) {
                    // Первая загрузка или полное обновление
                    if (isUserDialog) {
                        displayMyIssueDialog(data);
                        currentDialogMessagesCount = newMessagesCount;
                        lastDialogData = data;
                    } else {
                        displayIssueDialog(data);
                        adminDialogMessagesCount = newMessagesCount;
                        adminLastDialogData = data;
                    }
                    return;
                }
                
                // Просто перерисовываем весь диалог при изменении количества сообщений
                // Это проще и надежнее, чем пытаться добавлять только новые сообщения
                if (isUserDialog) {
                    displayMyIssueDialog(data);
                    currentDialogMessagesCount = newMessagesCount;
                    lastDialogData = data;
                } else {
                    displayIssueDialog(data);
                    adminDialogMessagesCount = newMessagesCount;
                    adminLastDialogData = data;
                }
                
                // Прокручиваем к новым сообщениям
                setTimeout(() => scrollToBottom(isUserDialog), 100);
                
            } catch (error) {
                console.error('❌ Ошибка умного обновления диалога:', error);
            }
        }
        
        // Добавляет одно новое сообщение в диалог
        function addMessageToDialog(messageText, isFromCurrentUser, isUserDialog) {
            const containerId = isUserDialog ? 'my-issue-dialog-content' : 'issue-dialog-content';
            const container = document.getElementById(containerId);
            
            if (!container) return;
            
            // Находим контейнер с сообщениями
            let messagesContainer = container.querySelector('.dialog-messages');
            if (!messagesContainer) {
                // Если контейнера нет, создаем его в конце основного контейнера
                messagesContainer = document.createElement('div');
                messagesContainer.className = 'dialog-messages';
                messagesContainer.style.cssText = 'margin-bottom: 20px; max-height: 300px; overflow-y: auto;';
                container.appendChild(messagesContainer);
            }
            
            // Создаем новое сообщение
            const messageDiv = document.createElement('div');
            const currentTime = new Date().toLocaleString('ru-RU');
            
            if (isUserDialog) {
                // Пользовательский диалог
                const bgColor = isFromCurrentUser ? 'linear-gradient(45deg, #667eea, #764ba2)' : '#2ed573';
                const textColor = 'white';
                const align = isFromCurrentUser ? 'margin-left: auto; margin-right: 0;' : 'margin-right: auto; margin-left: 0;';
                const senderText = isFromCurrentUser ? '👤 Вы' : '👨‍💼 Администратор';
                
                messageDiv.style.cssText = `background: ${bgColor}; color: ${textColor}; padding: 12px 15px; border-radius: 12px; margin-bottom: 10px; max-width: 80%; word-wrap: break-word; ${align}`;
                messageDiv.innerHTML = `
                    <div style="font-size: 14px; margin-bottom: 5px;">${messageText}</div>
                    <div style="font-size: 11px; opacity: 0.7; text-align: right;">
                        ${senderText} • ${currentTime}
                    </div>
                `;
            } else {
                // Админский диалог
                const bgColor = isFromCurrentUser ? '#2ed573' : 'linear-gradient(45deg, #667eea, #764ba2)';
                const textColor = 'white';
                const align = isFromCurrentUser ? 'margin-left: auto; margin-right: 0;' : 'margin-right: auto; margin-left: 0;';
                const senderText = isFromCurrentUser ? '👨‍💼 Администратор' : '👤 Сотрудник';
                
                messageDiv.style.cssText = `background: ${bgColor}; color: ${textColor}; padding: 12px 15px; border-radius: 12px; margin-bottom: 10px; max-width: 80%; word-wrap: break-word; ${align}`;
                messageDiv.innerHTML = `
                    <div style="font-size: 14px; margin-bottom: 5px;">${messageText}</div>
                    <div style="font-size: 11px; opacity: 0.7; text-align: right;">
                        ${senderText} • ${currentTime}
                    </div>
                `;
            }
            
            // Добавляем сообщение в конец
            messagesContainer.appendChild(messageDiv);
            
            // Прокручиваем к последнему сообщению
            setTimeout(() => {
                // Прокручиваем новое сообщение в видимую область
                messageDiv.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'end',
                    inline: 'nearest'
                });
            }, 100);
        }

        
        // Плавная прокрутка к низу диалога
        function scrollToBottom(isUserDialog) {
            
            const containerId = isUserDialog ? 'my-issue-dialog-content' : 'issue-dialog-content';
            const container = document.getElementById(containerId);
            
            if (!container) {
                console.log('❌ Контейнер не найден:', containerId);
                return;
            }
            
            // Используем setTimeout для гарантии, что DOM обновился
            setTimeout(() => {
                // Прокручиваем основной скроллируемый контейнер
                if (!isUserDialog) {
                    // Админский диалог - ищем все возможные скроллируемые контейнеры
                    const scrollableCard = document.querySelector('#issue-dialog-modal .card');
                    const modalContent = document.querySelector('#issue-dialog-modal .wrap');
                    const dialogModal = document.getElementById('issue-dialog-modal');
                    
                    [scrollableCard, modalContent, dialogModal].forEach(element => {
                        if (element && element.scrollHeight > element.clientHeight) {
                            console.log('📜 Прокручиваем админский контейнер:', element.id || element.className);
                            element.scrollTo({
                                top: element.scrollHeight,
                                behavior: 'smooth'
                            });
                        }
                    });
                } else {
                    // Пользовательский диалог - ищем все возможные скроллируемые контейнеры
                    const scrollableContainer = document.getElementById('my-issue-dialog-scroll');
                    const modalContent = document.querySelector('#my-issue-dialog-modal .wrap');
                    const dialogModal = document.getElementById('my-issue-dialog-modal');
                    
                    [scrollableContainer, modalContent, dialogModal].forEach(element => {
                        if (element && element.scrollHeight > element.clientHeight) {
                            console.log('📜 Прокручиваем пользовательский контейнер:', element.id || element.className);
                            element.scrollTo({
                                top: element.scrollHeight,
                                behavior: 'smooth'
                            });
                        }
                    });
                }
                
                // Прокручиваем контейнер с сообщениями
                const messagesContainer = container.querySelector('.dialog-messages') || container;
                if (messagesContainer && messagesContainer.scrollHeight > messagesContainer.clientHeight) {
                    console.log('📜 Прокручиваем контейнер сообщений');
                    messagesContainer.scrollTo({
                        top: messagesContainer.scrollHeight,
                        behavior: 'smooth'
                    });
                }
                
                console.log('✅ Прокрутка завершена');
            }, 100);
        }
        
        async function openMyIssueDialog(issueId) {
            try {
                currentMyIssueId = issueId;
                
                // Скрываем все окна
                document.getElementById('app').style.display = 'none';
                document.getElementById('sos-menu-modal').style.display = 'none';
                
                // Показываем модальное окно диалога
                document.getElementById('my-issue-dialog-modal').style.display = 'block';
                
                // Загружаем историю диалога
                await loadMyIssueDialog(issueId);
                
                // Отмечаем ответы как прочитанные
                await markResponsesAsRead(issueId);
                
                // Запускаем автообновление диалога
                startDialogAutoRefresh();
                
            } catch (error) {
                console.error('Ошибка открытия диалога:', error);
                tg.showAlert('Ошибка открытия диалога с обращением');
            }
        }
        
        async function loadMyIssueDialog(issueId) {
            try {
                const container = document.getElementById('my-issue-dialog-content');
                container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">Загрузка диалога...</div>';
                
                const response = await fetch(`http://localhost:5000/api/my-issue/${issueId}/dialog?initData=${encodeURIComponent(tg.initData)}`, {
                    method: 'GET'
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки диалога');
                }

                const data = await response.json();
                
                // Проверяем статус обращения - если закрыто, блокируем доступ для пользователей
                if (data.issue && data.issue.status === 'closed') {
                    container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">' +
                        '<div style="font-size: 18px; margin-bottom: 10px;">🔒</div>' +
                        '<div>Это обращение закрыто</div>' +
                        '<div style="font-size: 14px; margin-top: 10px; color: rgba(255,255,255,0.5);">Вы не можете добавлять новые сообщения в закрытое обращение</div>' +
                        '</div>';
                    
                    // Скрываем поле ввода для закрытых обращений
                    const inputContainer = document.querySelector('#my-issue-dialog-modal div[style*="position: fixed"]');
                    if (inputContainer) {
                        inputContainer.style.display = 'none';
                    }
                    return;
                }
                
                displayMyIssueDialog(data);
                
                // Показываем поле ввода для активных обращений
                const inputContainer = document.querySelector('#my-issue-dialog-modal div[style*="position: fixed"]');
                if (inputContainer) {
                    inputContainer.style.display = 'block';
                }
                
                // Инициализируем счетчик сообщений для умного обновления
                currentDialogMessagesCount = data.responses ? data.responses.length : 0;
                lastDialogData = data;
                
            } catch (error) {
                console.error('Ошибка загрузки диалога:', error);
                document.getElementById('my-issue-dialog-content').innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">Ошибка загрузки диалога</div>';
            }
        }
        
        function displayMyIssueDialog(data) {
            const container = document.getElementById('my-issue-dialog-content');
            const issue = data.issue;
            const responses = data.responses || [];
            
            let html = '<div style="margin-bottom: 20px;">';
            
            // Информация об обращении
            const typeIcon = issue.type === 'personal' ? '💔' : '🖥';
            const typeText = issue.type === 'personal' ? 'Личная проблема' : 'Техническая проблема';
            const anonymityText = issue.is_anonymous ? ` (${issue.pseudonym || 'Анонимно'})` : '';
            
            html += '<div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">';
            html += '<div style="font-weight: bold; margin-bottom: 10px;">' + typeIcon + ' Обращение #' + issue.id + anonymityText + '</div>';
            html += '<div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-bottom: 5px;">' + typeText + '</div>';
            html += '<div style="font-size: 14px; margin-bottom: 8px;">' + issue.description + '</div>';
            html += '<div style="font-size: 12px; color: rgba(255,255,255,0.6);">Создано: ' + new Date(issue.created_at).toLocaleString('ru-RU') + '</div>';
            html += '</div>';
            
            // История ответов
            if (responses.length > 0) {
                html += '<div class="dialog-messages" style="margin-bottom: 20px; max-height: 300px; overflow-y: auto;">';
                html += '<div style="font-weight: bold; margin-bottom: 15px;">История диалога:</div>';
                
                responses.forEach(response => {
                    const isAdmin = response.responder_phone === 'admin';
                    const bgColor = isAdmin ? 'rgba(46, 213, 115, 0.2)' : 'rgba(255, 255, 255, 0.1)';
                    const align = isAdmin ? 'margin-left: 20px;' : 'margin-right: 20px;';
                    
                    html += '<div style="background: ' + bgColor + '; padding: 12px; border-radius: 8px; margin-bottom: 10px; ' + align + '">';
                    html += '<div style="font-size: 14px; margin-bottom: 5px;">' + response.response_text + '</div>';
                    html += '<div style="font-size: 11px; color: rgba(255,255,255,0.6); text-align: right;">';
                    html += (isAdmin ? '👨‍💼 Администратор' : '👤 Вы') + ' • ' + new Date(response.created_at).toLocaleString('ru-RU');
                    html += '</div>';
                    html += '</div>';
                });
                
                html += '</div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
            
            // Прокручиваем вниз к последним сообщениям
            setTimeout(() => {
                const scrollableContainer = document.getElementById('my-issue-dialog-scroll');
                if (scrollableContainer) {
                    console.log('Прокручиваем диалог пользователя вниз');
                    scrollableContainer.scrollTop = scrollableContainer.scrollHeight;
                } else {
                    console.log('Контейнер my-issue-dialog-scroll не найден');
                }
            }, 100);
        }
        
        
        function handleMyResponseEnterKey(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendMyResponse();
            }
        }
        
        
        async function showIssueChat(issueId) {
            try {
                currentIssueId = issueId;
                
                // Загружаем данные чата
                const response = await fetch(`http://localhost:5000/api/issue-chat/${issueId}?initData=${encodeURIComponent(tg.initData)}`, {
                    method: 'GET'
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки чата');
                }

                const chatData = await response.json();
                
                // Показываем модальное окно чата
                document.getElementById('app').style.display = 'none';
                document.getElementById('work-mode-modal').style.display = 'none';
                document.getElementById('absence-modal').style.display = 'none';
                document.getElementById('sos-modal').style.display = 'none';
                document.getElementById('sos-menu-modal').style.display = 'none';
                document.getElementById('sick-leave-modal').style.display = 'none';
                document.getElementById('issue-chat-modal').style.display = 'block';
                
                // Заполняем информацию об обращении
                const issue = chatData.issue;
                document.getElementById('chat-title').textContent = `💬 Обращение #${issue.id}`;
                
                let issueTypeText = issue.type === 'personal' ? '💔 Личная проблема' : '🖥 Техническая проблема';
                if (issue.is_anonymous) {
                    issueTypeText += ' (анонимно)';
                    if (issue.pseudonym) {
                        issueTypeText += ` - ${issue.pseudonym}`;
                    }
                }
                
                document.getElementById('issue-title').textContent = issueTypeText;
                document.getElementById('issue-description').textContent = issue.description;
                
                // Отображаем сообщения
                displayChatMessages(chatData.messages);
                
                // Проверяем статус обращения
                if (issue.status === 'closed') {
                    // Обращение закрыто - скрываем поле ввода и показываем сообщение
                    document.getElementById('chat-input-area').style.display = 'none';
                    document.getElementById('chat-closed-message').style.display = 'block';
                } else {
                    // Обращение активно - показываем поле ввода
                    document.getElementById('chat-input-area').style.display = 'flex';
                    document.getElementById('chat-closed-message').style.display = 'none';
                    
                    // Запускаем автообновление чата
                    if (chatRefreshInterval) {
                        clearInterval(chatRefreshInterval);
                    }
                    chatRefreshInterval = setInterval(() => {
                        refreshChat();
                    }, 3000); // Обновляем каждые 3 секунды
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Ошибка загрузки чата');
            }
        }
        
        function displayChatMessages(messages) {
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = '';
            
            messages.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.style.marginBottom = '15px';
                
                const isFromAdmin = message.from_admin;
                const alignment = isFromAdmin ? 'left' : 'right';
                const bgColor = isFromAdmin ? 'rgba(74, 144, 226, 0.3)' : 'rgba(76, 205, 196, 0.3)';
                const textAlign = isFromAdmin ? 'left' : 'right';
                
                messageDiv.innerHTML = `
                    <div style="text-align: ${textAlign};">
                        <div style="display: inline-block; max-width: 70%; padding: 10px 15px; background: ${bgColor}; border-radius: 12px; text-align: left;">
                            <div style="font-weight: bold; margin-bottom: 5px; color: rgba(255,255,255,0.8); font-size: 12px;">
                                ${isFromAdmin ? '👨‍💼 Администратор' : '👤 Вы'}
                            </div>
                            <div style="color: white;">
                                ${message.text}
                            </div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 5px;">
                                ${new Date(message.timestamp).toLocaleString('ru-RU')}
                            </div>
                        </div>
                    </div>
                `;
                
                messagesContainer.appendChild(messageDiv);
            });
            
            // Прокручиваем к последнему сообщению
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        async function refreshChat() {
            if (!currentIssueId) return;
            
            try {
                const response = await fetch(`http://localhost:5000/api/issue-chat/${currentIssueId}?initData=${encodeURIComponent(tg.initData)}`, {
                    method: 'GET'
                });

                if (response.ok) {
                    const chatData = await response.json();
                    displayChatMessages(chatData.messages);
                }
            } catch (error) {
                console.error('Ошибка обновления чата:', error);
            }
        }
        
        async function sendChatMessage() {
            if (!currentIssueId) return;
            
            const messageInput = document.getElementById('chat-message-input');
            const messageText = messageInput.value.trim();
            
            if (!messageText) {
                tg.showAlert('Введите сообщение');
                return;
            }
            
            try {
                const response = await fetch(`http://localhost:5000/api/issue-chat/${currentIssueId}/message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        message: messageText
                    })
                });

                if (response.ok) {
                    messageInput.value = '';
                    // Обновляем чат
                    await refreshChat();
                } else {
                    const result = await response.json();
                    tg.showAlert('Ошибка: ' + result.error);
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                tg.showAlert('Произошла ошибка при отправке сообщения');
            }
        }
        
        // Обработка Enter в поле ввода сообщения
        // Принудительное обновление кеша
        if (window.performance && window.performance.navigation.type === 1) {
            // Страница была перезагружена - очищаем кеш
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                });
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Скрываем индикатор дизайна через 3 секунды
            setTimeout(() => {
                const indicator = document.getElementById('design-indicator');
                if (indicator) {
                    indicator.style.opacity = '0';
                    indicator.style.transition = 'opacity 0.5s ease';
                    setTimeout(() => indicator.style.display = 'none', 500);
                }
            }, 3000);
            const messageInput = document.getElementById('chat-message-input');
            if (messageInput) {
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendChatMessage();
                    }
                });
            }
            
            // Уведомления отключены
            // checkNewResponsesOnLoad();
            // setInterval(checkNewResponsesOnLoad, 30000);
        });
        
        // Проверка новых ответов при загрузке
        async function checkNewResponsesOnLoad() {
            try {
                console.log('Проверяем новые ответы...');
                const response = await fetch(`http://localhost:5000/api/check-new-responses?initData=${encodeURIComponent(tg.initData)}`, {
                    method: 'GET'
                });

                if (!response.ok) {
                    console.log('Ошибка проверки новых ответов:', response.status);
                    return; // Не показываем ошибку, если проверка не удалась
                }

                const data = await response.json();
                console.log('Ответ API check-new-responses:', data);
                
                if (data.success && data.total_count > 0) {
                    // Показываем popup с новыми ответами
                    let message;
                    
                    if (data.issues_with_new_responses.length === 1) {
                        // Одно обращение
                        const issue = data.issues_with_new_responses[0];
                        const typeIcon = issue.issue_type === 'personal' ? '💔' : '🖥';
                        message = `${typeIcon} Обращение #${issue.issue_id}\n`;
                        message += `${issue.description}\n\n`;
                        message += `Новых ответов: ${issue.new_responses_count}`;
                    } else {
                        // Несколько обращений
                        message = `У вас ${data.total_count} новых ответов на обращения:\n\n`;
                        
                        data.issues_with_new_responses.forEach(issue => {
                            const typeIcon = issue.issue_type === 'personal' ? '💔' : '🖥';
                            message += `${typeIcon} Обращение #${issue.issue_id}\n`;
                            message += `${issue.description}\n`;
                            message += `Новых ответов: ${issue.new_responses_count}\n\n`;
                        });
                    }
                    
                    const buttonText = data.issues_with_new_responses.length === 1 ? 'Открыть диалог' : 'Посмотреть все';
                    
                    tg.showPopup({
                        title: '📩 Новые ответы!',
                        message: message,
                        buttons: [
                            {id: 'view', type: 'default', text: buttonText},
                            {id: 'later', type: 'cancel', text: 'Позже'}
                        ]
                    }, function(buttonId) {
                        if (buttonId === 'view') {
                            // Проверяем роль пользователя
                            const isAdmin = currentUserData && currentUserData.user && currentUserData.user.is_admin;
                            
                            if (isAdmin) {
                                // Админ переходит в управление обращениями
                                if (data.issues_with_new_responses.length === 1) {
                                    const issueId = data.issues_with_new_responses[0].issue_id;
                                    // Устанавливаем флаг, что диалог открыт из уведомления
                                    dialogOpenedFromNotification = true;
                                    // Открываем админский диалог
                                    openIssueDialog(issueId);
                                } else {
                                    // Показываем управление обращениями
                                    showIssuesManagement();
                                }
                            } else {
                                // Обычный пользователь переходит в свои обращения
                                if (data.issues_with_new_responses.length === 1) {
                                    const issueId = data.issues_with_new_responses[0].issue_id;
                                    // Устанавливаем флаг, что диалог открыт из уведомления
                                    dialogOpenedFromNotification = true;
                                    // Открываем пользовательский диалог
                                    openMyIssueDialog(issueId);
                                } else {
                                    // Показываем список "Мои обращения"
                                    showSosMenuModal();
                                }
                            }
                        }
                    });
                }
                
            } catch (error) {
                console.error('Ошибка проверки новых ответов:', error);
                // Не показываем ошибку пользователю
            }
        }
        
        // Отметить ответы как прочитанные
        async function markResponsesAsRead(issueId) {
            try {
                console.log('Отмечаем ответы как прочитанные для обращения:', issueId);
                const response = await fetch(`http://localhost:5000/api/mark-responses-read/${issueId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData
                    })
                });
            } catch (error) {
                console.error('Ошибка отметки как прочитанное:', error);
            }
        }
        
        function closeMyIssueDialog() {
            // Останавливаем автообновление диалога
            stopDialogAutoRefresh();
            
            // Скрываем диалог
            document.getElementById('my-issue-dialog-modal').style.display = 'none';
            
            // Очищаем поле ввода ответа
            const responseInput = document.getElementById('my-response-input');
            if (responseInput) {
                responseInput.value = '';
            }
            
            // Проверяем, откуда был открыт диалог
            if (dialogOpenedFromNotification) {
                // Если из уведомления - возвращаемся к главному экрану
                dialogOpenedFromNotification = false;
                showMainApp();
            } else {
                // Если из списка обращений - возвращаемся к списку
                showSosMenuModal();
            }
        }
        
        function closeIssueDialog() {
            // Останавливаем автообновление диалога
            stopDialogAutoRefresh();
            
            // Скрываем диалог
            document.getElementById('issue-dialog-modal').style.display = 'none';
            
            // Очищаем поле ввода ответа
            const responseInput = document.getElementById('admin-response-input');
            if (responseInput) {
                responseInput.value = '';
            }
            
            // Проверяем, откуда был открыт диалог
            if (dialogOpenedFromNotification) {
                // Если из уведомления - возвращаемся к главному экрану
                dialogOpenedFromNotification = false;
                showMainApp();
            } else {
                // Если из списка обращений - возвращаемся к списку
                showIssuesManagement();
            }
        }

        // Удалено второе дублирующееся определение showSosMenuModal()
        
        function showMainApp() {
            // Останавливаем автообновление диалога
            stopDialogAutoRefresh();
            
            // Добавляем анимацию исчезновения для модальных окон
            const modals = [
                'work-mode-modal', 'absence-modal', 'sos-modal', 'sos-menu-modal',
                'sick-leave-modal', 'issue-chat-modal', 'admin-menu-modal'
            ];
            
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal && modal.style.display !== 'none') {
                    modal.classList.add('animate-slide-out');
                    setTimeout(() => {
                        modal.style.display = 'none';
                        modal.classList.remove('animate-slide-out');
                    }, 300);
                } else if (modal) {
                    modal.style.display = 'none';
                }
            });
            
            // Показываем главное приложение с анимацией
            const app = document.getElementById('app');
            app.style.display = 'block';
            app.classList.add('animate-fade-in');
            document.getElementById('employees-management-modal').style.display = 'none';
            document.getElementById('issues-management-modal').style.display = 'none';
            document.getElementById('broadcast-modal').style.display = 'none';
            document.getElementById('messaging-menu-modal').style.display = 'none';
            document.getElementById('employee-message-modal').style.display = 'none';
            document.getElementById('send-employee-message-modal').style.display = 'none';
            document.getElementById('add-employee-modal').style.display = 'none';
            document.getElementById('edit-employee-modal').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            
            // Останавливаем автообновление чата
            if (chatRefreshInterval) {
                clearInterval(chatRefreshInterval);
                chatRefreshInterval = null;
            }
            currentIssueId = null;
            
            // Сброс состояния режима работы
            selectedMode = null;
            selectedPeriod = null;
            document.getElementById('period-section').style.display = 'none';
            document.getElementById('work-periods').style.display = 'none';
            document.getElementById('custom-period').style.display = 'none';
            document.getElementById('confirmation-section').style.display = 'none';
            
            // Сброс состояния отсутствия
            selectedAbsenceDate = null;
            selectedAbsenceTime = null;
            customAbsenceDate = null;
            customAbsenceStartTime = null;
            customAbsenceEndTime = null;
            
            // Сброс состояния SOS
            selectedIssueType = null;
            selectedAnonymity = null;
            sosPseudonym = null;
            sosDescription = null;
            
            // Сброс состояния больничного
            selectedLeaveType = null;
        }

        // ============================================================================
        // ФУНКЦИИ ДЛЯ РАБОТЫ С ОБРАЩЕНИЯМИ ПОЛЬЗОВАТЕЛЯ
        // ============================================================================
        
        function showSosMenuModal() {
            // Скрываем главное приложение
            document.getElementById('app').style.display = 'none';
            
            // Скрываем другие модальные окна
            const modalsToHide = [
                'work-mode-modal', 'absence-modal', 'sos-modal', 
                'sick-leave-modal', 'issue-chat-modal', 'admin-menu-modal',
                'my-issue-dialog-modal', 'issue-dialog-modal'
            ];
            
            modalsToHide.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                }
            });
            
            // Показываем модальное окно "Мои обращения"
            document.getElementById('sos-menu-modal').style.display = 'block';
            
            // Загружаем список обращений
            loadMyIssues();
        }
        
        async function loadMyIssues() {
            try {
                const container = document.getElementById('sos-issues-list');
                container.innerHTML = `
                    <div style="text-align: center; color: var(--muted); padding: 20px;">
                        <div style="font-size: 16px;">📈 Загрузка обращений...</div>
                        <div style="font-size: 12px; margin-top: 8px;">Получение данных из базы</div>
                    </div>
                `;
                
                const response = await fetch(`http://localhost:5000/api/my-issues?initData=${encodeURIComponent(tg.initData)}`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    displayMyIssues(data.issues);
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; color: #ff6b6b; padding: 20px;">
                            <div style="font-size: 16px;">❌ Ошибка загрузки</div>
                            <div style="font-size: 12px; margin-top: 8px;">${data.error || 'Неизвестная ошибка'}</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Ошибка загрузки обращений:', error);
                const container = document.getElementById('sos-issues-list');
                container.innerHTML = `
                    <div style="text-align: center; color: #ff6b6b; padding: 20px;">
                        <div style="font-size: 16px;">❌ Ошибка сети</div>
                        <div style="font-size: 12px; margin-top: 8px;">Проверьте подключение к интернету</div>
                    </div>
                `;
            }
        }
        
        function displayMyIssues(issues) {
            const container = document.getElementById('sos-issues-list');
            
            if (!issues || issues.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: var(--muted); padding: 30px;">
                        <div style="font-size: 48px; margin-bottom: 15px;">📝</div>
                        <div style="font-size: 16px; margin-bottom: 8px;">У вас пока нет обращений</div>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.6);">Создайте новое обращение через меню "Нужна помощь"</div>
                        <div style="margin-top: 20px;">
                            <button onclick="showSosModal()" style="background: #2ed573; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                                Создать обращение
                            </button>
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            issues.forEach(issue => {
                const statusColor = issue.status === 'open' ? '#2ed573' : 
                                  issue.status === 'in_progress' ? '#ffa502' : '#ff6b6b';
                const statusText = issue.status === 'open' ? 'Открыто' : 
                                 issue.status === 'in_progress' ? 'В работе' : 'Закрыто';
                
                const hasNewResponses = issue.has_new_responses;
                const newResponsesBadge = hasNewResponses ? 
                    `<span style="background: #ff6b6b; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 8px;">НОВОЕ</span>` : '';
                
                html += `
                    <div onclick="openMyIssueDialog(${issue.id})" style="
                        background: rgba(255,255,255,0.1); 
                        padding: 15px; 
                        border-radius: 8px; 
                        margin-bottom: 10px; 
                        cursor: pointer;
                        border-left: 4px solid ${statusColor};
                        transition: all 0.2s ease;
                    " onmouseover="this.style.background='rgba(255,255,255,0.15)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                            <div style="font-weight: bold; font-size: 14px;">
                                ${issue.type === 'technical' ? '🖥️ Техническая проблема' : '💔 Личная проблема'}
                                ${newResponsesBadge}
                            </div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.6);">
                                #${issue.id}
                            </div>
                        </div>
                        <div style="font-size: 13px; color: rgba(255,255,255,0.8); margin-bottom: 8px; line-height: 1.4;">
                            ${issue.description}
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 11px;">
                            <div style="color: ${statusColor}; font-weight: bold;">
                                ● ${statusText}
                            </div>
                            <div style="color: rgba(255,255,255,0.6);">
                                ${new Date(issue.created_at).toLocaleDateString('ru-RU')}
                            </div>
                        </div>
                        ${issue.admin_response_count > 0 ? `
                            <div style="margin-top: 8px; padding: 8px; background: rgba(46, 213, 115, 0.2); border-radius: 4px; font-size: 12px;">
                                💬 Ответов администратора: ${issue.admin_response_count}
                                ${issue.unread_admin_responses > 0 ? `<span style="color: #ff6b6b; font-weight: bold;"> (новых: ${issue.unread_admin_responses})</span>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function openMyIssueDialog(issueId) {
            // Скрываем меню обращений
            document.getElementById('sos-menu-modal').style.display = 'none';
            
            // Показываем диалог обращения
            document.getElementById('my-issue-dialog-modal').style.display = 'block';
            
            // Загружаем диалог
            loadMyIssueDialog(issueId);
            
            // Сохраняем ID текущего обращения
            currentMyIssueId = issueId;
        }
        
        async function loadMyIssueDialog(issueId) {
            try {
                const container = document.getElementById('my-issue-dialog-content');
                container.innerHTML = `
                    <div style="text-align: center; color: rgba(255,255,255,0.7); padding: 20px;">
                        Загрузка диалога...
                    </div>
                `;
                
                const response = await fetch(`http://localhost:5000/api/my-issue/${issueId}/dialog?initData=${encodeURIComponent(tg.initData)}`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    displayMyIssueDialog(data);
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; color: #ff6b6b; padding: 20px;">
                            <div style="font-size: 16px;">❌ Ошибка загрузки диалога</div>
                            <div style="font-size: 12px; margin-top: 8px;">${data.error || 'Неизвестная ошибка'}</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Ошибка загрузки диалога:', error);
                const container = document.getElementById('my-issue-dialog-content');
                container.innerHTML = `
                    <div style="text-align: center; color: #ff6b6b; padding: 20px;">
                        <div style="font-size: 16px;">❌ Ошибка сети</div>
                        <div style="font-size: 12px; margin-top: 8px;">Проверьте подключение к интернету</div>
                    </div>
                `;
            }
        }
        
        function displayMyIssueDialog(data) {
            const container = document.getElementById('my-issue-dialog-content');
            const issue = data.issue;
            const responses = data.responses || [];
            
            let html = `
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="font-weight: bold; margin-bottom: 8px;">
                        ${issue.issue_type === 'technical' ? '🖥️ Техническая проблема' : '💔 Личная проблема'} #${issue.id}
                    </div>
                    <div style="font-size: 14px; margin-bottom: 8px; line-height: 1.4;">
                        ${issue.description}
                    </div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6);">
                        Создано: ${new Date(issue.created_at).toLocaleString('ru-RU')}
                    </div>
                </div>
            `;
            
            if (responses.length > 0) {
                html += '<div style="margin-bottom: 20px;"><h4>История диалога:</h4></div>';
                
                responses.forEach(response => {
                    const isAdmin = response.responder_phone === 'admin';
                    const bgColor = isAdmin ? 'rgba(46, 213, 115, 0.2)' : 'rgba(255, 255, 255, 0.1)';
                    const align = isAdmin ? 'margin-left: 20px;' : 'margin-right: 20px;';
                    
                    html += `
                        <div style="background: ${bgColor}; padding: 12px; border-radius: 8px; margin-bottom: 10px; ${align}">
                            <div style="font-size: 14px; margin-bottom: 5px;">${response.response_text}</div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.6); text-align: right;">
                                ${isAdmin ? '👨‍💼 Администратор' : '👤 Вы'} • ${new Date(response.created_at).toLocaleString('ru-RU')}
                            </div>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
            
            // Отмечаем ответы как прочитанные
            markResponsesAsRead(issue.id);
        }
        
        function closeMyIssueDialog() {
            // Останавливаем автообновление диалога
            stopDialogAutoRefresh();
            
            document.getElementById('my-issue-dialog-modal').style.display = 'none';
            document.getElementById('sos-menu-modal').style.display = 'block';
            
            // Сбрасываем ID текущего обращения
            currentMyIssueId = null;
            
            // Перезагружаем список обращений чтобы обновить счетчики
            loadMyIssues();
        }
        
        async function sendMyResponse() {
            const input = document.getElementById('my-response-input');
            const responseText = input.value.trim();
            
            if (!responseText) {
                tg.showAlert('Введите текст ответа');
                return;
            }
            
            if (!currentMyIssueId) {
                tg.showAlert('Ошибка: ID обращения не найден');
                return;
            }
            
            try {
                // Отправляем сообщение на сервер
                const response = await fetch(`http://localhost:5000/api/my-issue/${currentMyIssueId}/respond`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        response_text: responseText
                    })
                });
                
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    // Если отправка не удалась, показываем ошибку
                    tg.showAlert('Ошибка отправки: ' + (result.error || 'Неизвестная ошибка'));
                    return;
                }
                
                // Только после успешной отправки добавляем сообщение локально
                addMessageToDialog(responseText, true, true);
                
                // Прокручиваем к низу диалога
                setTimeout(() => {
                    scrollToBottom(true); // true = пользовательский диалог
                }, 150);
                
                // Очищаем поле ввода
                input.value = '';
                
                // Увеличиваем счетчик сообщений (добавили новое сообщение)
                currentDialogMessagesCount++;
                
            } catch (error) {
                console.error('Ошибка отправки ответа:', error);
                tg.showAlert('Ошибка сети при отправке ответа');
            }
        }
        
        // Добавляет временное сообщение с индикатором отправки
        function addTemporaryMessage(message, isFromUser) {
            const container = document.getElementById('my-issue-dialog-content');
            if (!container) return;
            
            let messagesContainer = container.querySelector('.dialog-messages');
            if (!messagesContainer) {
                messagesContainer = document.createElement('div');
                messagesContainer.className = 'dialog-messages';
                container.appendChild(messagesContainer);
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message temp-message';
            messageDiv.style.cssText = `
                margin: 10px 0;
                padding: 12px 15px;
                border-radius: 12px;
                max-width: 80%;
                word-wrap: break-word;
                background: linear-gradient(45deg, #667eea, #764ba2);
                color: white;
                margin-left: auto;
                text-align: right;
                opacity: 0.7;
                border: 2px dashed rgba(255,255,255,0.3);
            `;
            
            messageDiv.innerHTML = `
                <div style="font-size: 12px; opacity: 0.7; margin-bottom: 5px;">
                    👤 Вы • Отправляется...
                </div>
                <div>${message.response_text}</div>
                <div style="margin-top: 5px; font-size: 11px; opacity: 0.6;">
                    <span class="sending-dots">●●●</span>
                </div>
            `;
            
            // Добавляем CSS для анимации отправки
            const style = document.createElement('style');
            style.textContent = `
                .sending-dots {
                    animation: sending-pulse 1s infinite;
                }
                @keyframes sending-pulse {
                    0%, 100% { opacity: 0.3; }
                    50% { opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            messagesContainer.appendChild(messageDiv);
            scrollToBottom(true);
        }
        
        // Удаляет временное сообщение
        function removeTemporaryMessage() {
            const tempMessage = document.querySelector('.temp-message');
            if (tempMessage) {
                tempMessage.style.opacity = '0';
                tempMessage.style.transform = 'translateY(-10px)';
                
                setTimeout(() => {
                    if (tempMessage.parentNode) {
                        tempMessage.parentNode.removeChild(tempMessage);
                    }
                }, 300);
            }
        }
        
        function handleMyResponseEnterKey(event) {
            if (event.key === 'Enter') {
                sendMyResponse();
            }
        }
        
        // Индикатор набора текста
        let typingTimeout = null;
        
        // Переменные для отслеживания печати
        let userTypingTimeout = null;
        let adminTypingTimeout = null;
        
        function handleUserTyping() {
            // Пользователь печатает - НЕ показываем индикатор в его чате
            // Здесь можно добавить отправку уведомления админу
            console.log('Пользователь печатает...');
            
            // Сбрасываем предыдущий таймер
            if (userTypingTimeout) {
                clearTimeout(userTypingTimeout);
            }
            
            // Через 2 секунды бездействия убираем статус печати
            userTypingTimeout = setTimeout(() => {
                console.log('Пользователь перестал печатать');
            }, 2000);
        }
        
        function handleAdminTyping() {
            // Админ печатает - показываем индикатор пользователю
            showUserTypingIndicator(true);
            
            // Сбрасываем предыдущий таймер
            if (adminTypingTimeout) {
                clearTimeout(adminTypingTimeout);
            }
            
            // Скрываем индикатор через 2 секунды бездействия
            adminTypingTimeout = setTimeout(() => {
                showUserTypingIndicator(false);
            }, 2000);
        }
        
        function showUserTypingIndicator(show) {
            const container = document.getElementById('my-issue-dialog-content');
            if (!container) return;
            
            let indicator = container.querySelector('.typing-indicator');
            
            if (show && !indicator) {
                // Создаем индикатор
                indicator = document.createElement('div');
                indicator.className = 'typing-indicator';
                indicator.style.cssText = `
                    background: rgba(255,255,255,0.1);
                    padding: 10px 15px;
                    border-radius: 12px;
                    margin: 10px 0;
                    max-width: 80%;
                    margin-right: auto;
                    opacity: 0;
                    transform: translateY(10px);
                    transition: all 0.3s ease;
                `;
                
                indicator.innerHTML = `
                    <div style="font-size: 12px; opacity: 0.7; margin-bottom: 5px;">
                        👨‍💼 Администратор печатает...
                    </div>
                    <div style="display: flex; align-items: center;">
                        <div class="typing-dots">
                            <span>●</span>
                            <span>●</span>
                            <span>●</span>
                        </div>
                    </div>
                `;
                
                // Добавляем CSS для анимации точек
                const style = document.createElement('style');
                style.textContent = `
                    .typing-dots span {
                        display: inline-block;
                        margin: 0 2px;
                        opacity: 0.4;
                        animation: typing-pulse 1.4s infinite;
                    }
                    .typing-dots span:nth-child(2) {
                        animation-delay: 0.2s;
                    }
                    .typing-dots span:nth-child(3) {
                        animation-delay: 0.4s;
                    }
                    @keyframes typing-pulse {
                        0%, 60%, 100% { opacity: 0.4; }
                        30% { opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
                
                container.appendChild(indicator);
                
                // Анимация появления
                setTimeout(() => {
                    indicator.style.opacity = '1';
                    indicator.style.transform = 'translateY(0)';
                }, 10);
                
                scrollToBottom(true);
                
            } else if (!show && indicator) {
                // Скрываем индикатор
                indicator.style.opacity = '0';
                indicator.style.transform = 'translateY(-10px)';
                
                setTimeout(() => {
                    if (indicator.parentNode) {
                        indicator.parentNode.removeChild(indicator);
                    }
                }, 300);
            }
        }
        
        async function markResponsesAsRead(issueId) {
            try {
                await fetch(`http://localhost:5000/api/mark-responses-read/${issueId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData
                    })
                });
            } catch (error) {
                console.error('Ошибка отметки как прочитанное:', error);
            }
        }

        // Загружаем данные пользователя при загрузке страницы
        loadUserData();

        // Адаптивный дизайн
        (function(){
            function applyCompact() {
                const w = window.innerWidth; 
                const h = window.innerHeight;
                // Убираем компактный режим - всегда используем полный размер
                const compact = false;
                document.body.classList.toggle('compact', compact);
                document.documentElement.style.setProperty('--vh', `${h * 0.01}px`);
            }
            window.addEventListener('resize', applyCompact, { passive: true });
            applyCompact();
        })();
        
        // Функция для показа индикатора "пользователь печатает" в чате админа
        function showAdminTypingIndicator(show) {
            const container = document.getElementById('issue-dialog-content');
            if (!container) return;
            
            let indicator = container.querySelector('.admin-typing-indicator');
            
            if (show && !indicator) {
                // Создаем индикатор
                indicator = document.createElement('div');
                indicator.className = 'admin-typing-indicator';
                indicator.style.cssText = `
                    background: rgba(255,255,255,0.1);
                    padding: 10px 15px;
                    border-radius: 12px;
                    margin: 10px 0;
                    max-width: 80%;
                    margin-left: auto;
                    opacity: 0;
                    transform: translateY(10px);
                    transition: all 0.3s ease;
                `;
                
                indicator.innerHTML = `
                    <div style="font-size: 12px; opacity: 0.7; margin-bottom: 5px; text-align: right;">
                        👤 Пользователь печатает...
                    </div>
                    <div style="display: flex; align-items: center; justify-content: flex-end;">
                        <div class="typing-dots">
                            <span>●</span>
                            <span>●</span>
                            <span>●</span>
                        </div>
                    </div>
                `;
                
                container.appendChild(indicator);
                
                // Анимация появления
                setTimeout(() => {
                    indicator.style.opacity = '1';
                    indicator.style.transform = 'translateY(0)';
                }, 10);
                
                scrollToBottom(true);
                
            } else if (!show && indicator) {
                // Скрываем индикатор
                indicator.style.opacity = '0';
                indicator.style.transform = 'translateY(-10px)';
                
                setTimeout(() => {
                    if (indicator.parentNode) {
                        indicator.parentNode.removeChild(indicator);
                    }
                }, 300);
            }
        }
    </script>
</body>
</html>
